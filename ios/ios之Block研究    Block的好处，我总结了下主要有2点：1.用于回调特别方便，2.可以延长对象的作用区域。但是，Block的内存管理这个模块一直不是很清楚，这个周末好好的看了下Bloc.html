<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2015-10-19T05:45:43Z"/><meta name="updated" content="2015-10-19T10:14:58Z"/><title>ios之Block研究    Block的好处，我总结了下主要有2点：1.用于回调特别方便，2.可以延长对象的作用区域。但是，Block的内存管理这个模块一直不是很清楚，这个周末好好的看了下Bloc</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><h1 class="postTitle" style="margin:0px 0px 15px;padding:0px 0px 0px 5px;font-size:16px;float:left;line-height:1.5em;width:1317.5px;clear:both;color:#464646;font-family:verdana, 'ms song', Arial, Helvetica, sans-serif;"><a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/wustlj/p/3252152.html" style="margin:0px;padding:0px;color:#6466b3;text-decoration:none;">ios之Block研究</a></h1>
<div class="clear" style="margin:0px;padding:0px;clear:both;color:#464646;font-family:verdana, 'ms song', Arial, Helvetica, sans-serif;font-size:12px;"></div>
<div class="postBody" style="margin:0px;padding:5px 2px 5px 5px;line-height:1.5;color:#393939;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:black;font-family:verdana, 'ms song', Arial, Helvetica, sans-serif;"><div id="cnblogs_post_body" style="margin:0px 0px 20px;padding:0px;word-break:break-word;"><p style="margin:10px auto;padding:0px;">Block的好处，我总结了下主要有2点：1.用于回调特别方便，2.可以延长对象的作用区域。但是，Block的内存管理这个模块一直不是很清楚，这个周末好好的看了下Block的原理，有些许心得。</p>
<p style="margin:10px auto;padding:0px;">为了性能，默认Block都是分配在stack上面的，所以它的作用区域就是当前函数。</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;color:#000000;font-family:'Courier New' !important;font-size:12px !important;"><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;">#include &lt;stdio.h&gt;<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> main()
{
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> i = <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">1024</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (^blk)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>) = ^<span style="margin:0px;padding:0px;line-height:1.5 !important;"> {
        printf(</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">%d\n</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">, i);
    };
    blk();
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span> <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
}</span></pre><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
</div>
<p style="margin:10px auto;padding:0px;">&nbsp;在blk这个block里面是不能修改i的。Why？我们可以通过clang看看编译器处理后的这块代码</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;color:#000000;font-family:'Courier New' !important;font-size:12px !important;"><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;"><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __main_block_impl_0 {
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __block_impl impl;
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_desc_0*<span style="margin:0px;padding:0px;line-height:1.5 !important;"> Desc;
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> i;
  __main_block_impl_0(</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *fp, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_desc_0 *desc, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> _i, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> flags=<span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">) : i(_i) {
    impl.isa </span>= &amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;">_NSConcreteStackBlock;
    impl.Flags </span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;"> flags;
    impl.FuncPtr </span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;"> fp;
    Desc </span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;"> desc;
  }
};</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> __main_block_func_0(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_impl_0 *<span style="margin:0px;padding:0px;line-height:1.5 !important;">__cself) {
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> i = __cself-&gt;i; <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> bound by copy</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">         printf(</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">%d\n</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">, i);
    }</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __main_block_desc_0 {
  unsigned </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">long</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> reserved;
  unsigned </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">long</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> Block_size;
} __main_block_desc_0_DATA </span>= { <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span>, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">sizeof</span>(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __main_block_impl_0)};</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> main()
{
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> i = <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">1024</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*blk)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>) = (<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>))&amp;__main_block_impl_0((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *)__main_block_func_0, &amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;">__main_block_desc_0_DATA, i);
    ((</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __block_impl *))((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __block_impl *)blk)-&gt;FuncPtr)((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __block_impl *<span style="margin:0px;padding:0px;line-height:1.5 !important;">)blk);
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span> <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
}</span></pre><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
</div>
<div style="margin:0px;padding:0px;"><div id="highlighter_43605" class="syntaxhighlighter nogutter objc" style="padding:0px;margin:1em 0px !important;width:100% !important;position:relative !important;overflow:auto !important;font-size:1em !important;"><table border="0" cellpadding="0" cellspacing="0" style="border-spacing:0px;word-break:break-word;margin:0px !important;padding:0px !important;border-top-left-radius:0px !important;border-top-right-radius:0px !important;border-bottom-right-radius:0px !important;border-bottom-left-radius:0px !important;background-image:none !important;border:0px !important;bottom:auto !important;float:none !important;height:auto !important;left:auto !important;line-height:1.1em !important;outline:0px !important;overflow:visible !important;position:static !important;right:auto !important;top:auto !important;vertical-align:baseline !important;width:100% !important;box-sizing:content-box !important;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace !important;font-size:12px !important;min-height:inherit !important;"><tbody style="margin:0px !important;padding:0px !important;border-top-left-radius:0px !important;border-top-right-radius:0px !important;border-bottom-right-radius:0px !important;border-bottom-left-radius:0px !important;background-image:none !important;border:0px !important;bottom:auto !important;float:none !important;height:auto !important;left:auto !important;line-height:1.1em !important;outline:0px !important;overflow:visible !important;position:static !important;right:auto !important;top:auto !important;vertical-align:baseline !important;width:auto !important;box-sizing:content-box !important;min-height:inherit !important;"><tr style="margin:0px !important;padding:0px !important;border-top-left-radius:0px !important;border-top-right-radius:0px !important;border-bottom-right-radius:0px !important;border-bottom-left-radius:0px !important;background-image:none !important;border:0px !important;bottom:auto !important;float:none !important;height:auto !important;left:auto !important;line-height:1.1em !important;outline:0px !important;overflow:visible !important;position:static !important;right:auto !important;top:auto !important;vertical-align:baseline !important;width:auto !important;box-sizing:content-box !important;min-height:inherit !important;"><td class="code" style="border-collapse:collapse;margin:0px !important;padding:0px !important;border-top-left-radius:0px !important;border-top-right-radius:0px !important;border-bottom-right-radius:0px !important;border-bottom-left-radius:0px !important;background-image:none !important;border:0px !important;bottom:auto !important;float:none !important;height:auto !important;left:auto !important;line-height:1.1em !important;outline:0px !important;overflow:visible !important;position:static !important;right:auto !important;top:auto !important;vertical-align:baseline !important;width:auto !important;box-sizing:content-box !important;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace !important;min-height:inherit !important;"><div class="container" style="margin:0px !important;padding:0px !important;border-top-left-radius:0px !important;border-top-right-radius:0px !important;border-bottom-right-radius:0px !important;border-bottom-left-radius:0px !important;background-image:none !important;border:0px !important;bottom:auto !important;float:none !important;height:auto !important;left:auto !important;line-height:1.1em !important;outline:0px !important;overflow:visible !important;position:relative !important;right:auto !important;top:auto !important;vertical-align:baseline !important;width:auto !important;box-sizing:content-box !important;min-height:inherit !important;"><div class="line number1 index0 alt2" style="margin:0px !important;padding:0px 1em 0px 0px !important;border-top-left-radius:0px !important;border-top-right-radius:0px !important;border-bottom-right-radius:0px !important;border-bottom-left-radius:0px !important;background-image:none !important;background-color:#f4f4f4 !important;border:0px !important;bottom:auto !important;float:none !important;height:auto !important;left:auto !important;line-height:1.8em !important;outline:0px !important;overflow:visible !important;position:static !important;right:auto !important;top:auto !important;vertical-align:baseline !important;width:auto !important;box-sizing:content-box !important;min-height:inherit !important;"><code class="objc keyword" style="white-space:pre-wrap;margin:0px !important;padding:0px !important;border-top-left-radius:0px !important;border-top-right-radius:0px !important;border-bottom-right-radius:0px !important;border-bottom-left-radius:0px !important;background-image:none !important;border:0px !important;bottom:auto !important;float:none !important;height:auto !important;left:auto !important;line-height:1.8em !important;outline:0px !important;overflow:visible !important;position:static !important;right:auto !important;top:auto !important;vertical-align:baseline !important;width:auto !important;box-sizing:content-box !important;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace !important;min-height:inherit !important;color:#0000ff !important;">struct</code>&nbsp;<code class="objc plain" style="white-space:pre-wrap;margin:0px !important;padding:0px !important;border-top-left-radius:0px !important;border-top-right-radius:0px !important;border-bottom-right-radius:0px !important;border-bottom-left-radius:0px !important;background-image:none !important;border:0px !important;bottom:auto !important;float:none !important;height:auto !important;left:auto !important;line-height:1.8em !important;outline:0px !important;overflow:visible !important;position:static !important;right:auto !important;top:auto !important;vertical-align:baseline !important;width:auto !important;box-sizing:content-box !important;font-family:Consolas, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace !important;min-height:inherit !important;">__block_impl是Block的一个内部结构体，原型是</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;color:#000000;font-family:'Courier New' !important;font-size:12px !important;"><pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;"><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __block_impl {
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *<span style="margin:0px;padding:0px;line-height:1.5 !important;">isa;
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> Flags;
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> Reserved;
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *<span style="margin:0px;padding:0px;line-height:1.5 !important;">FuncPtr;
};</span></pre></div>
<p style="margin:10px auto;padding:0px;">每个block都有个默认的构造函数</p>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;"><span style="margin:0px;padding:0px;">__main_block_impl_0(</span><span style="margin:0px;padding:0px;">void</span> *fp, <span style="margin:0px;padding:0px;">struct</span> __main_block_desc_0 *desc, <span style="margin:0px;padding:0px;">int</span> _i, <span style="margin:0px;padding:0px;">int</span> flags=<span style="margin:0px;padding:0px;">0</span><span style="margin:0px;padding:0px;">) : i(_i) 所以只能读取i,而不能修改i，当你试图修改它时，编译器就在预处理阶段直接报错。</span></pre><p style="margin:10px auto;padding:0px;">只要在i前加__Block变量就可以在Block里面修改i值了，此时由值类型变为引用类型</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;color:#000000;font-family:'Courier New' !important;font-size:12px !important;"><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;"><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __main_block_impl_0 {
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __block_impl impl;
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_desc_0*<span style="margin:0px;padding:0px;line-height:1.5 !important;"> Desc;
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> *<span style="margin:0px;padding:0px;line-height:1.5 !important;">i;
  __main_block_impl_0(</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *fp, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_desc_0 *desc, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> *_i, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> flags=<span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">) : i(_i) {
    impl.isa </span>= &amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;">_NSConcreteStackBlock;
    impl.Flags </span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;"> flags;
    impl.FuncPtr </span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;"> fp;
    Desc </span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;"> desc;
  }
};</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> __main_block_func_0(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_impl_0 *<span style="margin:0px;padding:0px;line-height:1.5 !important;">__cself) {
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> *i = __cself-&gt;i; <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> bound by copy</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">         printf(</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">%d\n</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span>, (*<span style="margin:0px;padding:0px;line-height:1.5 !important;">i));
    }</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __main_block_desc_0 {
  unsigned </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">long</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> reserved;
  unsigned </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">long</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> Block_size;
} __main_block_desc_0_DATA </span>= { <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span>, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">sizeof</span>(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __main_block_impl_0)};</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> main()
{
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> i = <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">1024</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*blk)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>) = (<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>))&amp;__main_block_impl_0((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;">i);
    ((</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __block_impl *))((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __block_impl *)blk)-&gt;FuncPtr)((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __block_impl *<span style="margin:0px;padding:0px;line-height:1.5 !important;">)blk);
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span> <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
}</span></pre><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
</div>
<p style="margin:10px auto;padding:0px;">上面的代码块是将int i的类型修改为__Block int i = 1024;后编译器生成代码块，可以看到__main_block_impl_0中的 i类型已经改变为int *，所以我们可以修改它的值。</p>
<p style="margin:10px auto;padding:0px;"><span style="margin:0px;padding:0px;background-color:#ff0000;"><strong style="margin:0px;padding:0px;">所以只要没对Block进行copy操作，它一直存在stack里面。不管是否有__block修饰符</strong></span></p>
<p style="margin:10px auto;padding:0px;"><strong style="margin:0px;padding:0px;">要想延长Block的作于域，我们可以对它进行copy操作，apple提供的接口是Block_Copy()方法</strong></p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;color:#000000;font-family:'Courier New' !important;font-size:12px !important;"><img id="code_img_opened_2961808a-17b6-4833-b9c4-992d669a0725" class="code_img_opened" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" style="margin:0px;padding:0px 5px 0px 0px;border:0px;vertical-align:middle;" /><div id="cnblogs_code_open_2961808a-17b6-4833-b9c4-992d669a0725" class="cnblogs_code_hide" style="margin:0px;padding:0px;"><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;"><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">/*</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> Copy, or bump refcount, of a block.  If really copying, call the copy helper if present. </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">*/</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *_Block_copy_internal(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *arg, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> flags) {
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> Block_layout *<span style="margin:0px;padding:0px;line-height:1.5 !important;">aBlock;
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">bool</span> wantsOne = (WANTS_ONE &amp; flags) ==<span style="margin:0px;padding:0px;line-height:1.5 !important;"> WANTS_ONE;

    </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">printf("_Block_copy_internal(%p, %x)\n", arg, flags);    </span>     <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span> (!arg) <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> NULL;
    
    
    </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> The following would be better done as a switch statement</span>     aBlock = (<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> Block_layout *<span style="margin:0px;padding:0px;line-height:1.5 !important;">)arg;
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span> (aBlock-&gt;flags &amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;"> BLOCK_NEEDS_FREE) {
        </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> latches on high</span>         latching_incr_int(&amp;aBlock-&gt;<span style="margin:0px;padding:0px;line-height:1.5 !important;">flags);
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> aBlock;
    }
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">else</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span> (aBlock-&gt;flags &amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;"> BLOCK_IS_GC) {
        </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> GC refcounting is expensive so do most refcounting here.</span>         <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span> (wantsOne &amp;&amp; ((latching_incr_int(&amp;aBlock-&gt;flags) &amp; BLOCK_REFCOUNT_MASK) == <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">1</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">)) {
            </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> Tell collector to hang on this - it will bump the GC refcount version</span>             _Block_setHasRefcount(aBlock, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">true</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">);
        }
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> aBlock;
    }
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">else</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span> (aBlock-&gt;flags &amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;"> BLOCK_IS_GLOBAL) {
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> aBlock;
    }

    </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> Its a stack block.  Make a copy.</span>     <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span> (!<span style="margin:0px;padding:0px;line-height:1.5 !important;">isGC) {
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> Block_layout *result = malloc(aBlock-&gt;descriptor-&gt;<span style="margin:0px;padding:0px;line-height:1.5 !important;">size);
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span> (!result) <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span> (<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *)<span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
        memmove(result, aBlock, aBlock</span>-&gt;descriptor-&gt;size); <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> bitcopy first
        </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> reset refcount</span>         result-&gt;flags &amp;= ~(BLOCK_REFCOUNT_MASK);    <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> XXX not needed</span>         result-&gt;flags |= BLOCK_NEEDS_FREE | <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">1</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
        result</span>-&gt;isa =<span style="margin:0px;padding:0px;line-height:1.5 !important;"> _NSConcreteMallocBlock;
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span> (result-&gt;flags &amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;"> BLOCK_HAS_COPY_DISPOSE) {
            </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">printf("calling block copy helper %p(%p, %p)...\n", aBlock-&gt;descriptor-&gt;copy, result, aBlock);</span>             (*aBlock-&gt;descriptor-&gt;copy)(result, aBlock); <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> do fixup</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">        }
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> result;
    }
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">else</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> {
        </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> Under GC want allocation with refcount 1 so we ask for "true" if wantsOne
        </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> This allows the copy helper routines to make non-refcounted block copies under GC</span>         unsigned <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">long</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> flags = aBlock-&gt;<span style="margin:0px;padding:0px;line-height:1.5 !important;">flags;
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">bool</span> hasCTOR = (flags &amp; BLOCK_HAS_CTOR) != <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> Block_layout *result = _Block_allocator(aBlock-&gt;descriptor-&gt;<span style="margin:0px;padding:0px;line-height:1.5 !important;">size, wantsOne, hasCTOR);
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span> (!result) <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span> (<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *)<span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
        memmove(result, aBlock, aBlock</span>-&gt;descriptor-&gt;size); <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> bitcopy first
        </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> reset refcount
        </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> if we copy a malloc block to a GC block then we need to clear NEEDS_FREE.</span>         flags &amp;= ~(BLOCK_NEEDS_FREE|BLOCK_REFCOUNT_MASK);   <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> XXX not needed</span>         <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> (wantsOne)
            flags </span>|= BLOCK_IS_GC | <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">1</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">else</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">             flags </span>|=<span style="margin:0px;padding:0px;line-height:1.5 !important;"> BLOCK_IS_GC;
        result</span>-&gt;flags =<span style="margin:0px;padding:0px;line-height:1.5 !important;"> flags;
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span> (flags &amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;"> BLOCK_HAS_COPY_DISPOSE) {
            </span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">printf("calling block copy helper...\n");</span>             (*aBlock-&gt;descriptor-&gt;copy)(result, aBlock); <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> do fixup</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">        }
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">if</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> (hasCTOR) {
            result</span>-&gt;isa =<span style="margin:0px;padding:0px;line-height:1.5 !important;"> _NSConcreteFinalizingBlock;
        }
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">else</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> {
            result</span>-&gt;isa =<span style="margin:0px;padding:0px;line-height:1.5 !important;"> _NSConcreteAutoBlock;
        }
        </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> result;
    }
}</span></pre><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
</div>
</div>
<p style="margin:10px auto;padding:0px;">通过观察apple提供的block源码，我们可以看到copy方法将block从statck拷贝到heap里面，所以它的作用区域延长了</p>
<p style="margin:10px auto;padding:0px;">待完成：1.block与oc的混合</p>
<p style="margin:10px auto;padding:0px;">　　　　2.__block修饰符与oc的混合</p>
<p style="margin:10px auto;padding:0px;"><span style="margin:0px;padding:0px;background-color:#ff0000;"><strong style="margin:0px;padding:0px;">总结</strong></span></p>
<p style="margin:10px auto;padding:0px;"><span style="margin:0px;padding:0px;background-color:#ff0000;"><strong style="margin:0px;padding:0px;">1.block默认都是分配在stack，当copy后，它移到heap里</strong></span></p>
<p style="margin:10px auto;padding:0px;"><span style="margin:0px;padding:0px;background-color:#ff0000;"><strong style="margin:0px;padding:0px;">2.block中的变量默认是不能修改的，只有添加__Block修饰符后才能修改</strong></span></p>
<p style="margin:10px auto;padding:0px;"><span style="margin:0px;padding:0px;background-color:#ff0000;"><strong style="margin:0px;padding:0px;">3.block中有oc对象时，会_Block_retain_object(object)，直到block销毁后才会_Block_release_object(object);</strong></span></p>
<p style="margin:10px auto;padding:0px;"><span style="margin:0px;padding:0px;background-color:#ff0000;"><strong style="margin:0px;padding:0px;">4.对block进行copy时</strong></span></p>
<ul class="ul" style="margin:0px 0px 0px 30px;padding:0px;word-break:break-all;"><li class="li" style="margin:0px 0px 1em;padding:0px;list-style:inherit !important;"><p style="margin:10px auto;padding:0px;"><span style="margin:0px;padding:0px;background-color:#ff0000;"><strong style="margin:0px;padding:0px;">If you access an instance variable by reference, a strong reference is made to&nbsp;<code style="margin:0px;padding:0px;">self</code>;</strong></span></p>
</li>
<li class="li" style="margin:0px 0px 1em;padding:0px;list-style:inherit !important;"><p style="margin:10px auto;padding:0px;"><span style="margin:0px;padding:0px;background-color:#ff0000;"><strong style="margin:0px;padding:0px;">If you access an instance variable by value, a strong reference is made to the variable.</strong></span></p>
</li>
</ul>
<p style="margin:10px auto;padding:0px;"><span style="margin:0px;padding:0px;background-color:#ff0000;"><strong style="margin:0px;padding:0px;">它会将self进行copy，此时改对象的dealloc方法不会执行（因为它的引用计数归0），解决此问题有2种方法：在block执行完成后面立即Block_Release(),或者将改变量声明为__Block类型（Why？）</strong></span></p>
<p style="margin:10px auto;padding:0px;">&nbsp;</p>
<p style="margin:10px auto;padding:0px;">继续补充block的oc的混合</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;color:#000000;font-family:'Courier New' !important;font-size:12px !important;"><img id="code_img_opened_b0ade384-c6a3-4a8e-b2ef-82f20834eb52" class="code_img_opened" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" style="margin:0px;padding:0px 5px 0px 0px;border:0px;vertical-align:middle;" /><div id="cnblogs_code_open_b0ade384-c6a3-4a8e-b2ef-82f20834eb52" class="cnblogs_code_hide" style="margin:0px;padding:0px;"><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;"><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span> <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">  main.m</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">  block</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span> <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">  Created by lijian on 13-8-9.</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">  Copyright (c) 2013年 YOUKU. All rights reserved.</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">#import</span> &lt;Foundation/Foundation.h&gt;<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> main (<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> argc, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">char</span> *<span style="margin:0px;padding:0px;line-height:1.5 !important;"> argv[]) {
    
    NSMutableString </span>*str = [NSMutableString stringWithFormat:<span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">@"</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">lijian</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">];
    
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (^blk)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>) = ^<span style="margin:0px;padding:0px;line-height:1.5 !important;"> {
        NSLog(</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">@"</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">%@</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">, str);
    };
    blk();
    
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span> <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
}</span></pre><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
</div>
</div>
<p style="margin:10px auto;padding:0px;">编译器生成代码为</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;color:#000000;font-family:'Courier New' !important;font-size:12px !important;"><img id="code_img_opened_af653fea-2fc5-426a-b10d-7de49e3d8923" class="code_img_opened" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" style="margin:0px;padding:0px 5px 0px 0px;border:0px;vertical-align:middle;" /><div id="cnblogs_code_open_af653fea-2fc5-426a-b10d-7de49e3d8923" class="cnblogs_code_hide" style="margin:0px;padding:0px;"><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;"><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span> <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">  main.m</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">  block</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span> <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">  Created by lijian on 13-8-9.</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">  Copyright (c) 2013年 lijian. All rights reserved.</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> #include </span>&lt;Foundation/Foundation.h&gt;<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> main(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span>, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">char</span> **<span style="margin:0px;padding:0px;line-height:1.5 !important;">);</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __main_block_impl_0 {
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __block_impl impl;
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_desc_0*<span style="margin:0px;padding:0px;line-height:1.5 !important;"> Desc;
  NSMutableString </span>*<span style="margin:0px;padding:0px;line-height:1.5 !important;">str;
  __main_block_impl_0(</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *fp, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_desc_0 *desc, NSMutableString *_str, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> flags=<span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">) : str(_str) {
    impl.isa </span>= &amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;">_NSConcreteStackBlock;
    impl.Flags </span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;"> flags;
    impl.FuncPtr </span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;"> fp;
    Desc </span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;"> desc;
  }
};</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> __main_block_func_0(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_impl_0 *<span style="margin:0px;padding:0px;line-height:1.5 !important;">__cself) {
  NSMutableString </span>*str = __cself-&gt;str; <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> bound by copy</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">         NSLog((NSString </span>*)&amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;">__NSConstantStringImpl_main_m_1, str);
    }</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> __main_block_copy_0(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_impl_0*dst, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_impl_0*src) {_Block_object_assign((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>*)&amp;dst-&gt;str, (<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>*)src-&gt;str, <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">3</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">/*</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">BLOCK_FIELD_IS_OBJECT</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">*/</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">);}</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> __main_block_dispose_0(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_impl_0*src) {_Block_object_dispose((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>*)src-&gt;str, <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">3</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">/*</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">BLOCK_FIELD_IS_OBJECT</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">*/</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">);}</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __main_block_desc_0 {
  unsigned </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">long</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> reserved;
  unsigned </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">long</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> Block_size;
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*copy)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_impl_0*, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_impl_0*<span style="margin:0px;padding:0px;line-height:1.5 !important;">);
  </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*dispose)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __main_block_impl_0*<span style="margin:0px;padding:0px;line-height:1.5 !important;">);
} __main_block_desc_0_DATA </span>= { <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span>, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">sizeof</span>(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0};</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> main (<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> argc, <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">const</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">char</span> *<span style="margin:0px;padding:0px;line-height:1.5 !important;"> argv[]) {
    
    NSMutableString </span>*str = ((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">id</span> (*)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">id</span>, SEL, NSString *, ...))(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *)objc_msgSend)(objc_getClass(<span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">NSMutableString</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span>), sel_registerName(<span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">stringWithFormat:</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">"</span>), (NSString *)&amp;<span style="margin:0px;padding:0px;line-height:1.5 !important;">__NSConstantStringImpl_main_m_0);
    
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*blk)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>) = (<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span>))&amp;__main_block_impl_0((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, str, <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">570425344</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">);
    ((</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span> (*)(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __block_impl *))((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __block_impl *)blk)-&gt;FuncPtr)((<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">struct</span> __block_impl *<span style="margin:0px;padding:0px;line-height:1.5 !important;">)blk);
    
    </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">return</span> <span style="margin:0px;padding:0px;color:#800080;line-height:1.5 !important;">0</span><span style="margin:0px;padding:0px;line-height:1.5 !important;">;
}</span></pre><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;color:#6466b3;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;border:none !important;" /></a></span></div>
</div>
</div>
<p style="margin:10px auto;padding:0px;">blk的原型为</p>
<p style="margin:10px auto;padding:0px;">&nbsp; &nbsp;&nbsp;<span style="margin:0px;padding:0px;">void</span>&nbsp;(*blk)(<span style="margin:0px;padding:0px;">void</span>) = (<span style="margin:0px;padding:0px;">void</span>&nbsp;(*)(<span style="margin:0px;padding:0px;">void</span>))&amp;__main_block_impl_0((<span style="margin:0px;padding:0px;">void</span>&nbsp;*)__main_block_func_0, &amp;__main_block_desc_0_DATA, str, 570425344);</p>
<p style="margin:10px auto;padding:0px;">其中570425344 =&nbsp;BLOCK_HAS_COPY_DISPOSE |&nbsp;BLOCK_HAS_DESCRIPTOR；</p>
<p style="margin:10px auto;padding:0px;">通过构造函数，我们看到仍然是值传递，所以blk中是能不修改str的。</p>
<p style="margin:10px auto;padding:0px;">至于上面的__main_block_copy_0和__main_block_dispose_0 就是用于Block_Copy()和Block_Release();</p>
<p style="margin:10px auto;padding:0px;">当我将str的类型修改为__block NSMutableString时，生成如下代码</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;color:#000000;font-family:'Courier New' !important;font-size:12px !important;"><img id="code_img_closed_17f25f5a-093a-4f09-8ebe-478cac6cb22d" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="margin:0px;padding:0px 5px 0px 0px;border:0px;vertical-align:middle;" />&nbsp;<span class="cnblogs_code_collapse" style="margin:0px;padding:2px;border:1px solid gray;background-color:#ffffff;line-height:1.5 !important;">View Code&nbsp;</span></div>
<p style="margin:10px auto;padding:0px;">可以看到str的类型实际上是__Block_byref_str_0，其中33554432 =&nbsp;BLOCK_HAS_COPY_DISPOSE = (1 &lt;&lt; 25)</p>
<p style="margin:10px auto;padding:0px;">而blk的构造函数中传递的是__Block_byref_str_0类型的指针，所以我们能在blk中修改str</p>
</div>
</div></body></html>