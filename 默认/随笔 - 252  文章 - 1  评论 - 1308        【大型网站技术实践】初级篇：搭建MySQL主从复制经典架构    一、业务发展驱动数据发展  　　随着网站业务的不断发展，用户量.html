<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-06-11T11:07:21Z"/><meta name="updated" content="2017-06-11T11:07:23Z"/><title>随笔 - 252  文章 - 1  评论 - 1308        【大型网站技术实践】初级篇：搭建MySQL主从复制经典架构    一、业务发展驱动数据发展  　　随着网站业务的不断发展，用户量</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div id="header" style="margin:0px 0px 15px;padding:0px 0px 0px 45px;font-family:微软雅黑;font-size:12px;"><div id="navigator" style="margin:0px;padding:0px;"><div class="blogStats" style="margin:0px;padding:0px;text-align:right;color:gray;"><div id="blog_stats" style="margin:0px;padding:0px;"><span id="stats_post_count" style="margin:0px;padding:0px;">随笔 - 252&nbsp;&nbsp;</span><span id="stats_article_count" style="margin:0px;padding:0px;">文章 - 1&nbsp;&nbsp;</span><span id="stats-comment_count" style="margin:0px;padding:0px;">评论 - 1308</span></div>
</div>
</div>
</div>
<div id="main" style="margin:0px;padding:0px 0px 0px 25px;overflow:auto;font-family:微软雅黑;font-size:12px;"><div id="mainContent" style="margin:0px;padding:0px;float:left;width:650px;"><div class="forFlow" style="margin:0px;padding:0px;"><div id="post_detail" style="margin:0px;padding:0px;"><div id="topics" style="margin:0px 0px 10px;padding:0px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#000000;width:810px;"><div class="post" style="margin:0px;padding:0px;"><h1 class="postTitle" style="margin:0px 0px 10px;padding:0px 15px;font-size:12px;font-weight:normal;background-image:url(http://www.cnblogs.com/skins/iMetro/images/logo.png);line-height:1.5;width:810px;background-position:-10px 0px;background-repeat:no-repeat repeat;"><a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/edisonchou/p/4133148.html" style="margin:0px;padding:0px;font-size:24px;color:#000000;text-decoration:none;width:810px;">【大型网站技术实践】初级篇：搭建MySQL主从复制经典架构</a></h1>
<div class="clear" style="margin:0px;padding:0px;clear:both;"></div>
<div class="postBody" style="margin:0px 0px 5px;padding:0px 15px;font-size:13.920000076293945px;"><div id="cnblogs_post_body" style="margin:0px 0px 30px;padding:0px;word-break:break-word;overflow:auto;width:810px;"><h1 style="padding:5px 0px 5px 20px;font-size:17px;line-height:25px;background-color:#2b6695;border-top-left-radius:6px;border-top-right-radius:6px;border-bottom-right-radius:6px;border-bottom-left-radius:6px;box-shadow:#5f5a4b 0px 0px 0px 1px, rgba(10, 10, 0, 0.498039) 1px 1px 6px 1px;color:white;font-family:微软雅黑, 宋体, 黑体, Arial;height:25px;text-shadow:#222222 2px 2px 3px;width:785.6875px;margin:15px 0px !important;">一、业务发展驱动数据发展</h1>
<p style="margin:10px auto;padding:0px;">　　随着网站业务的不断发展，用户量的不断增加，数据量成倍地增长，数据库的访问量也呈线性地增长。特别是在用户访问高峰期间，并发访问量突然增大，数据库的负载压力也会增大，如果架构方案不够健壮，那么数据库服务器很有可能在高并发访问负载压力下宕机，造成数据访问服务的失效，从而导致网站的业务中断，给公司和用户造成双重损失。那么，有木有一种方案能够解决此问题，使得数据库不再因为负载压力过高而成为网站的瓶颈呢？答案肯定是有的。</p>
<p style="margin:10px auto;padding:0px;">　　目前，大部分的主流关系型数据库都提供了主从热备功能，通过配置两台（或多台）数据库的主从关系，可以将一台数据库服务器的数据更新同步到另一台服务器上。网站可以利用数据库的这一功能，<strong style="margin:0px;padding:0px;">实现数据库的读写分离，从而改善数据库的负载压力</strong>。</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/i/381412/201407/120151330823289.jpg" alt="master-slave" width="566" height="332" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　利用数据库的读写分离，Web服务器在写数据的时候，访问主数据库（Master），主数据库通过<strong style="margin:0px;padding:0px;">主从复制机制</strong>将数据更新同步到从数据库（Slave），这样当Web服务器读数据的时候，就可以通过从数据库获得数据。这一方案使得在大量读操作的Web应用可以轻松地读取数据，而主数据库也只会承受少量的写入操作，还可以实现数据热备份，可谓是<strong style="margin:0px;padding:0px;"><em style="margin:0px;padding:0px;">一举两得</em></strong>的方案。</p>
<h1 style="padding:5px 0px 5px 20px;font-size:17px;line-height:25px;background-color:#2b6695;border-top-left-radius:6px;border-top-right-radius:6px;border-bottom-right-radius:6px;border-bottom-left-radius:6px;box-shadow:#5f5a4b 0px 0px 0px 1px, rgba(10, 10, 0, 0.498039) 1px 1px 6px 1px;color:white;font-family:微软雅黑, 宋体, 黑体, Arial;height:25px;text-shadow:#222222 2px 2px 3px;width:785.6875px;margin:15px 0px !important;">二、MySQL数据复制原理</h1>
<p style="margin:10px auto;padding:0px;">　　刚刚我们了解了关系型数据库的读写分离能够实现数据库的主从架构，那么主从架构中最重要的数据复制又是怎么一回事呢？MySQL作为最流行的关系型数据库之一，通过了解MySQL的数据复制流程，会使得我们对主从复制的认知会有一定的帮助。</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/i/381412/201408/010009149159053.jpg" alt="mysql" width="506" height="339" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　从上图来看，整体上有如下三个步凑：</p>
<p style="margin:10px auto;padding:0px;">　　（1）Master将改变记录到二进制日志(binary log)中（这些记录叫做二进制日志事件，binary log events）；</p>
<p style="margin:10px auto;padding:0px;">　　（2）Slave将Master的二进制日志事件(binary log events)拷贝到它的中继日志(relay log)；</p>
<blockquote style="margin:20px 0px;padding:15px 20px 15px 60px;background-image:url(http://images.cnblogs.com/cnblogs_com/wangiqngpei557/417984/o_title.png);background-color:#ffffa3;border:2px solid #efefef;color:#333333;border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-right-radius:10px;border-bottom-left-radius:10px;min-height:35px;line-height:1.6em;font-size:15px;font-family:'Microsoft Yahei';box-shadow:#aaaaaa 0px 0px 8px;clear:both;background-position:9px 0px;background-repeat:no-repeat no-repeat;"><p style="margin:10px auto;padding:0px;"><strong style="margin:0px;padding:0px;">PS：</strong>从图中可以看出，Slave服务器中有一个I/O线程(I/O Thread)在不停地监听Master的二进制日志(Binary Log)是否有更新：如果没有它会睡眠等待Master产生新的日志事件；如果有新的日志事件(Log Events)，则会将其拷贝至Slave服务器中的中继日志(Relay Log)。</p>
</blockquote>
<p style="margin:10px auto;padding:0px;">　　（3）Slave重做中继日志(Relay Log)中的事件，将Master上的改变反映到它自己的数据库中。</p>
<blockquote style="margin:20px 0px;padding:15px 20px 15px 60px;background-image:url(http://images.cnblogs.com/cnblogs_com/wangiqngpei557/417984/o_title.png);background-color:#ffffa3;border:2px solid #efefef;color:#333333;border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-right-radius:10px;border-bottom-left-radius:10px;min-height:35px;line-height:1.6em;font-size:15px;font-family:'Microsoft Yahei';box-shadow:#aaaaaa 0px 0px 8px;clear:both;background-position:9px 0px;background-repeat:no-repeat no-repeat;"><p style="margin:10px auto;padding:0px;"><strong style="margin:0px;padding:0px;">PS：</strong>从图中可以看出，Slave服务器中有一个SQL线程(SQL Thread)从中继日志读取事件，并重做其中的事件从而更新Slave的数据，使其与Master中的数据一致。只要该线程与I/O线程保持一致，中继日志通常会位于OS的缓存中，所以中继日志的开销很小。</p>
</blockquote>
<h1 style="padding:5px 0px 5px 20px;font-size:17px;line-height:25px;background-color:#2b6695;border-top-left-radius:6px;border-top-right-radius:6px;border-bottom-right-radius:6px;border-bottom-left-radius:6px;box-shadow:#5f5a4b 0px 0px 0px 1px, rgba(10, 10, 0, 0.498039) 1px 1px 6px 1px;color:white;font-family:微软雅黑, 宋体, 黑体, Arial;height:25px;text-shadow:#222222 2px 2px 3px;width:785.6875px;margin:15px 0px !important;">三、MySQL主从复制实战</h1>
<h2 style="margin:10px 0px;padding:0px;font-size:21px;line-height:1.5;">3.1 实验环境总览与准备工作</h2>
<p style="margin:10px auto;padding:0px;">　　（1）实验环境</p>
<p style="margin:10px auto;padding:0px;">　　①服务器环境：本次我们主要借助VMware Workstation搭建一个三台Windows Server 2003组成的MySQL服务器集群，其中一台作为Master服务器（IP：192.168.80.10），其余两台均作为Slave服务器（IP：192.168.80.11,192.168.80.12）。</p>
<p style="margin:10px auto;padding:0px;">　　②客户机环境：本次我们在Windows 7宿主机（IP：192.168.80.1）编写一个C#控制台程序，对MySQL服务器进行基本的CRUD访问测试。</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/301738329652309.jpg" alt="" width="580" height="395" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（2）准备工作</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/301646254659777.jpg" alt="" width="235" height="152" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　　　下载MySQL文件：<a href="http://dev.mysql.com/downloads/mysql/5.5.html#downloads" target="_blank" style="margin:0px;padding:1px 3px;color:green;text-decoration:none;">http://dev.mysql.com/downloads/mysql/5.5.html#downloads</a></p>
<p style="margin:10px auto;padding:0px;">　　　　这里我们选择5.5版本，为了节省时间，直接选择了Archive免安装版本。又由于虚拟机中的Windows Server 2003是32位，所以选择了32-bit的Archive版本进行使用。</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/301649351211636.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　　　下载完成后，将三个压缩包分别拷贝至Master（IP：192.168.80.10）、Slave1（IP：192.168.80.11）及Slave2（IP：192.168.80.12）中。</p>
<h2 style="margin:10px 0px;padding:0px;font-size:21px;line-height:1.5;">3.2 配置MySQL主服务器</h2>
<p style="margin:10px auto;padding:0px;">　　（1）将MySQL文件拷贝到Master服务器，并解压到一个指定文件夹。这里我放在了：C:\MySQLServer\mysql-5.5.40-win32</p>
<p style="margin:10px auto;padding:0px;">　　（2）新建一个配置文件，取名为：my-master.ini，添加以下内容：</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;"><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:1px 3px;color:green;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:800px;border:none !important;" /></a></span></div>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;"><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 1</span> <span style="margin:0px;padding:0px;color:#800000;font-weight:bold;line-height:1.5 !important;">[</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">client</span><span style="margin:0px;padding:0px;color:#800000;font-weight:bold;line-height:1.5 !important;">]</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 2</span> port=3306<span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 3</span> default-character-set=<span style="margin:0px;padding:0px;line-height:1.5 !important;">utf8</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 4</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 5</span> <span style="margin:0px;padding:0px;color:#800000;font-weight:bold;line-height:1.5 !important;">[</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">mysqld</span><span style="margin:0px;padding:0px;color:#800000;font-weight:bold;line-height:1.5 !important;">]</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 6</span> port=3306<span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 7</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 8</span> #character_set_server=utf8 一定要这样写<span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">;</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 9</span> character_set_server=<span style="margin:0px;padding:0px;line-height:1.5 !important;">utf8</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">10</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">11</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">#解压目录</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">12</span> basedir=C:\MySQLServer\mysql-5.5.40<span style="margin:0px;padding:0px;line-height:1.5 !important;">-win32</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">13</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">14</span> #解压目录下data目录,<span style="margin:0px;padding:0px;line-height:1.5 !important;">必须为data目录</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">15</span> datadir=C:\MySQLServer\mysql-5.5.40<span style="margin:0px;padding:0px;line-height:1.5 !important;">-win32\data</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">16</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">17</span> #sql_mode=NO_ENGINE_SUBSTITUTION,<span style="margin:0px;padding:0px;line-height:1.5 !important;">STRICT_TRANS_TABLES 这个有问题，在创建完新用户登录时报错</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">18</span> sql_mode=NO_AUTO_CREATE_USER,<span style="margin:0px;padding:0px;line-height:1.5 !important;">NO_ENGINE_SUBSTITUTION</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">19</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">20</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">#主服务器的配置</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">21</span> #01<span style="margin:0px;padding:0px;line-height:1.5 !important;">.开启二进制日志</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">22</span> log-bin=<span style="margin:0px;padding:0px;line-height:1.5 !important;">master-bin</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">23</span> #02<span style="margin:0px;padding:0px;line-height:1.5 !important;">.使用二进制日志的索引文件</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">24</span> log-bin-index=<span style="margin:0px;padding:0px;line-height:1.5 !important;">master.bin.index</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">25</span> #03<span style="margin:0px;padding:0px;line-height:1.5 !important;">.为服务器添加唯一的编号</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">26</span> server-id=1</pre><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:1px 3px;color:green;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:800px;border:none !important;" /></a></span></div>
</div>
<p style="margin:10px auto;padding:0px;">　　（3）将my-master.ini传送到Master服务器中mysql所在的文件夹中，并在命令行中将其注册为Windows服务：（这里要转到mysql的bin文件夹中进行操作，因为没有设置环境变量）</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/301724521844362.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（4）启动mysql服务，并设为自启动类型；</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/301727519022158.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（5）使用root账号登陆mysql，创建一个具有<strong style="margin:0px;padding:0px;">复制权限</strong>的用户；（此时root是没有密码的，直接回车即可）</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/301742522461930.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（6）在Slave1或Slave2上通过远程登录Master上的mysql测试新建用户是否可以登录；</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/301745121377326.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<h2 style="margin:10px 0px;padding:0px;font-size:21px;line-height:1.5;">3.3 配置MySQL从服务器</h2>
<p style="margin:10px auto;padding:0px;">　　（1）同Master服务器，将MySQL文件拷贝解压到指定文件夹下；</p>
<p style="margin:10px auto;padding:0px;">　　（2）新建一个配置文件，取名为：my-slave.ini，添加以下内容：</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;"><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:1px 3px;color:green;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:800px;border:none !important;" /></a></span></div>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;"><span style="margin:0px;padding:0px;color:#800000;font-weight:bold;line-height:1.5 !important;">[</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">client</span><span style="margin:0px;padding:0px;color:#800000;font-weight:bold;line-height:1.5 !important;">]</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> port</span>=3306<span style="margin:0px;padding:0px;line-height:1.5 !important;"> default-character-set</span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;">utf8</span><span style="margin:0px;padding:0px;color:#800000;font-weight:bold;line-height:1.5 !important;">[</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">mysqld</span><span style="margin:0px;padding:0px;color:#800000;font-weight:bold;line-height:1.5 !important;">]</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> port</span>=3306<span style="margin:0px;padding:0px;line-height:1.5 !important;"> #character_set_server</span>=utf8 一定要这样写<span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">;</span>character_set_server=<span style="margin:0px;padding:0px;line-height:1.5 !important;">utf8

#解压目录
basedir</span>=C:\MySQLServer\mysql-5.5.40<span style="margin:0px;padding:0px;line-height:1.5 !important;">-win32

#解压目录下data目录</span>,<span style="margin:0px;padding:0px;line-height:1.5 !important;">必须为data目录
datadir</span>=C:\MySQLServer\mysql-5.5.40<span style="margin:0px;padding:0px;line-height:1.5 !important;">-win32\data


#sql_mode</span>=NO_ENGINE_SUBSTITUTION,<span style="margin:0px;padding:0px;line-height:1.5 !important;">STRICT_TRANS_TABLES 这个有问题，在创建完新用户登录时报错
sql_mode</span>=NO_AUTO_CREATE_USER,<span style="margin:0px;padding:0px;line-height:1.5 !important;">NO_ENGINE_SUBSTITUTION

#从服务器的配置
#</span>01<span style="margin:0px;padding:0px;line-height:1.5 !important;">.为服务器添加唯一的编号
server-id</span>=2<span style="margin:0px;padding:0px;line-height:1.5 !important;"> #</span>02<span style="margin:0px;padding:0px;line-height:1.5 !important;">.开启中继日志
relay-log</span>=<span style="margin:0px;padding:0px;line-height:1.5 !important;">slave-relay-log-bin
#</span>03<span style="margin:0px;padding:0px;line-height:1.5 !important;">.使用中继日志的索引文件
relay-log-index</span>=slave-relay-log-bin.index</pre><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:1px 3px;color:green;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:800px;border:none !important;" /></a></span></div>
</div>
<blockquote style="margin:20px 0px;padding:15px 20px 15px 60px;background-image:url(http://images.cnblogs.com/cnblogs_com/wangiqngpei557/417984/o_title.png);background-color:#ffffa3;border:2px solid #efefef;color:#333333;border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-right-radius:10px;border-bottom-left-radius:10px;min-height:35px;line-height:1.6em;font-size:15px;font-family:'Microsoft Yahei';box-shadow:#aaaaaa 0px 0px 8px;clear:both;background-position:9px 0px;background-repeat:no-repeat no-repeat;"><p style="margin:10px auto;padding:0px;"><strong style="margin:0px;padding:0px;">PS：</strong>这里server-id要确保唯一，我们这里Master（192.168.80.10）的server-id=1，那么Slave1（192.168.80.11）就设置其server-id=2，Slave2（192.168.80.12）则设置其server-id=3。</p>
</blockquote>
<p style="margin:10px auto;padding:0px;">　　（3）将my-slave.ini传送到Slave1和Slave2服务器中mysql所在的文件夹中，并在命令行中将其注册为Windows服务：（这里要转到mysql的bin文件夹中进行操作，因为没有设置环境变量）</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/301753107313914.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（4）分别启动两台Slave的mysql服务，步凑同master所述；当然，也可以在cmd中输入命令：net start MySQL</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/301727519022158.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（5）分别使用两台Slave的root账号登陆mysql，通过指定的语句配置主从关系设置；</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/301757393871171.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（6） 为了方便后面的测试，这里我们在Master上通过root进入mysql，创建一个测试用的数据库和数据表；</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/302015202157141.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/302014013404471.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（7）还要创建一个用户，这个用户具有对所有数据库的增删查改的权限，以便用来进行测试；</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/302033060749349.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<h2 style="margin:10px 0px;padding:0px;font-size:21px;line-height:1.5;">3.4 编写C#程序测试主从复制结构</h2>
<p style="margin:10px auto;padding:0px;">　　（1）下载mysql for .net开发包，添加对mysql.data.dll的引用</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/302021399023745.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（2）在控制台程序中写代码访问Master服务器，并查看程序运行结果；</p>
<p style="margin:10px auto;padding:0px;">　　①数据库连接部分：</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;"><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:1px 3px;color:green;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:800px;border:none !important;" /></a></span></div>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;"><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&lt;?</span><span style="margin:0px;padding:0px;color:#ff00ff;line-height:1.5 !important;">xml version="1.0" encoding="utf-8" </span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">?&gt;</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&lt;</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">configuration</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&gt;</span>     <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&lt;</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">connectionStrings</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&gt;</span>         <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&lt;</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">add </span><span style="margin:0px;padding:0px;color:#ff0000;line-height:1.5 !important;">name</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">="mysqlmaster"</span><span style="margin:0px;padding:0px;color:#ff0000;line-height:1.5 !important;"> 
         connectionString</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">="server=192.168.80.10;database=dbtest;uid=sa;password=123456"</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">/&gt;</span>     <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&lt;/</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">connectionStrings</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&gt;</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&lt;/</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">configuration</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&gt;</span></pre><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:1px 3px;color:green;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:800px;border:none !important;" /></a></span></div>
</div>
<p style="margin:10px auto;padding:0px;">　　②程序代码部分：在程序中首先显示user表内容（这时表是空的），然后会添加5条user信息，其中会修改第3条user信息的name为Edison Chou，最后会删除第5条user信息；</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;"><img id="code_img_closed_0cd92c4a-63c9-4358-8d65-5d7a581bf1eb" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="margin:0px;padding:0px 5px 0px 0px;border:0px;vertical-align:middle;max-width:800px;" />&nbsp;<span class="cnblogs_code_collapse" style="margin:0px;padding:2px;border:1px solid gray;background-color:#ffffff;line-height:1.5 !important;">View Code</span></div>
<p style="margin:10px auto;padding:0px;">　　③程序运行结果：</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/302043039346432.jpg" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（3）在Slave1（192.168.80.11）和Slave2（192.168.80.12）上查看user表是否自动进行了数据同步；</p>
<p style="margin:10px auto;padding:0px;">　　①首先在Master上查看user表还剩哪些信息？</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/302054181848845.png" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　②其次在Slave1上查看user表是否进行了同步：</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/302057250591921.png" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　③最后在Slave2上查看user表是否进行了同步：</p>
<p style="margin:10px auto;padding:0px;"><img src="http://images.cnitblog.com/blog/381412/201411/302059434025590.png" alt="" style="margin:0px auto;padding:0px;border:0px;max-width:800px;display:block;" /></p>
<p style="margin:10px auto;padding:0px;">　　（4）初步尝试读写分离：<strong style="margin:0px;padding:0px;">一主一从</strong>模式的一个最简单的实现方式</p>
<p style="margin:10px auto;padding:0px;">　　①在Slave1上新建一个只具有读（select）权限的用户，这里取名为reader：</p>
<p style="margin:10px auto;padding:0px;">　　　　create user reader;</p>
<p style="margin:10px auto;padding:0px;">　　　　grant select on *.* to reader identified by '123456';</p>
<p style="margin:10px auto;padding:0px;">　　②新增一个mysqlslave的数据库连接字符串：</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;"><pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;">    <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&lt;</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">connectionStrings</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&gt;</span>         <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&lt;</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">add </span><span style="margin:0px;padding:0px;color:#ff0000;line-height:1.5 !important;">name</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">="mysqlmaster"</span><span style="margin:0px;padding:0px;color:#ff0000;line-height:1.5 !important;"> 
             connectionString</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">="server=192.168.80.10;database=dbtest;uid=sa;password=123456"</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">/&gt;</span>         <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&lt;</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">add </span><span style="margin:0px;padding:0px;color:#ff0000;line-height:1.5 !important;">name</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">="mysqlslave"</span><span style="margin:0px;padding:0px;color:#ff0000;line-height:1.5 !important;">              connectionString</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">="server=192.168.80.11;database=dbtest;uid=reader;password=123456"</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">/&gt;</span>     <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&lt;/</span><span style="margin:0px;padding:0px;color:#800000;line-height:1.5 !important;">connectionStrings</span><span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">&gt;</span></pre></div>
<p style="margin:10px auto;padding:0px;">　　③新增一个枚举DbCommandType来记录读操作和写操作：</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;"><pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;">    <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">enum</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> DbCommandType
    {
        Read,
        Write
    }</span></pre></div>
<p style="margin:10px auto;padding:0px;">　　④修改读取数据表的代码判断是读操作还是写操作：</p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;"><img id="code_img_closed_078bd84f-84d6-4b72-a87e-2bafa5d2372f" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" style="margin:0px;padding:0px 5px 0px 0px;border:0px;vertical-align:middle;max-width:800px;" />&nbsp;<span class="cnblogs_code_collapse" style="margin:0px;padding:2px;border:1px solid gray;background-color:#ffffff;line-height:1.5 !important;">View Code</span></div>
<blockquote style="margin:20px 0px;padding:15px 20px 15px 60px;background-image:url(http://images.cnblogs.com/cnblogs_com/wangiqngpei557/417984/o_title.png);background-color:#ffffa3;border:2px solid #efefef;color:#333333;border-top-left-radius:10px;border-top-right-radius:10px;border-bottom-right-radius:10px;border-bottom-left-radius:10px;min-height:35px;line-height:1.6em;font-size:15px;font-family:'Microsoft Yahei';box-shadow:#aaaaaa 0px 0px 8px;clear:both;background-position:9px 0px;background-repeat:no-repeat no-repeat;"><p style="margin:10px auto;padding:0px;"><strong style="margin:0px;padding:0px;">PS：</strong>关于MySQL的读写分离实现，主要有以下几种方式：</p>
<p style="margin:10px auto;padding:0px;">一种是基于MySQL-Proxy做调度服务器模式，另一种是借助阿里巴巴开源项目<span lang="EN-US" style="margin:0px;padding:0px;"><strong style="margin:0px;padding:0px;">Amoeba</strong>(变形虫<span lang="EN-US" style="margin:0px;padding:0px;">)项目实现（这种方式貌似用的比较多），另外呢就是自己写一个类似于哈希算法的程序库来选择目标数据库；</span></span></p>
</blockquote>
<h1 style="padding:5px 0px 5px 20px;font-size:17px;line-height:25px;background-color:#2b6695;border-top-left-radius:6px;border-top-right-radius:6px;border-bottom-right-radius:6px;border-bottom-left-radius:6px;box-shadow:#5f5a4b 0px 0px 0px 1px, rgba(10, 10, 0, 0.498039) 1px 1px 6px 1px;color:white;font-family:微软雅黑, 宋体, 黑体, Arial;height:25px;text-shadow:#222222 2px 2px 3px;width:785.6875px;margin:15px 0px !important;">学习小结</h1>
<p style="margin:10px auto;padding:0px;">　　此次我们主要简单地学习了主从复制的一些相关概念，了解了MySQL在Windows下搭建主从复制架构的过程，最后通过改变程序方式使得一主一从模式下实现读写分离（虽然是很简单很粗陋的实现）。后续有空时，我会尝试在Linux下借助阿里巴巴开源项目Amoeba搭建真正的MySQL读写分离模式，到时也会将搭建的过程分享出来。虽然，我没有相关的真实实践经验，也有很多人跟我说“你这是在纸上谈兵”，我也知道“纸上得来终觉浅，绝知此事要躬行”，但在没毕业之前，我还是会做一些相关的初步了解性质的实践学习，也许以后到了公司，就会有真正的战场在等着我了。当然，如果你觉得我写这篇博客花了点心思，那就麻烦点个赞，谢谢啦！</p>
<h1 style="padding:5px 0px 5px 20px;font-size:17px;line-height:25px;background-color:#2b6695;border-top-left-radius:6px;border-top-right-radius:6px;border-bottom-right-radius:6px;border-bottom-left-radius:6px;box-shadow:#5f5a4b 0px 0px 0px 1px, rgba(10, 10, 0, 0.498039) 1px 1px 6px 1px;color:white;font-family:微软雅黑, 宋体, 黑体, Arial;height:25px;text-shadow:#222222 2px 2px 3px;width:785.6875px;margin:15px 0px !important;">参考资料</h1>
<p style="margin:10px auto;padding:0px;">　　（1）李智慧，《大型网站技术架构-核心原理与案例分析》：<a href="http://item.jd.com/11322972.html" target="_blank" style="margin:0px;padding:1px 3px;color:green;text-decoration:none;">http://item.jd.com/11322972.html</a></p>
<p style="margin:10px auto;padding:0px;">　　（2）guisu，《高性能Mysql主从架构的复制原理及配置详解》：<a href="http://blog.csdn.net/hguisu/article/details/7325124" target="_blank" style="margin:0px;padding:1px 3px;color:green;text-decoration:none;">http://blog.csdn.net/hguisu/article/details/7325124</a></p>
<p style="margin:10px auto;padding:0px;">　　（3）Ghost，《高性能的MySQL主从复制架构》：<a href="http://www.uml.org.cn/sjjm/201211061.asp" target="_blank" style="margin:0px;padding:1px 3px;color:green;text-decoration:none;">http://www.uml.org.cn/sjjm/201211061.asp</a></p>
<p style="margin:10px auto;padding:0px;">　　（4）飞鸿无痕，《Amoeba搞定MySQL读写分离》：<a href="http://blog.chinaunix.net/uid-20639775-id-154600.html" target="_blank" style="margin:0px;padding:1px 3px;color:green;text-decoration:none;">http://blog.chinaunix.net/uid-20639775-id-154600.html</a>&nbsp;（<strong style="margin:0px;padding:0px;">此文讲解了如何借助Amoeba构建MySQL主从复制读写分离，值得阅读</strong>）</p>
<h1 style="padding:5px 0px 5px 20px;font-size:17px;line-height:25px;background-color:#2b6695;border-top-left-radius:6px;border-top-right-radius:6px;border-bottom-right-radius:6px;border-bottom-left-radius:6px;box-shadow:#5f5a4b 0px 0px 0px 1px, rgba(10, 10, 0, 0.498039) 1px 1px 6px 1px;color:white;font-family:微软雅黑, 宋体, 黑体, Arial;height:25px;text-shadow:#222222 2px 2px 3px;width:785.6875px;margin:15px 0px !important;">附件下载</h1>
<p style="margin:10px auto;padding:0px;">　　（1）mysql-5.5.40（Archive版本）：<a href="http://pan.baidu.com/s/1c0u6X80" target="_blank" style="margin:0px;padding:1px 3px;color:green;text-decoration:none;">http://pan.baidu.com/s/1c0u6X80</a></p>
<p style="margin:10px auto;padding:0px;">　　（2）相关配置文件（master与slave）：<a href="http://pan.baidu.com/s/1dDENI73" target="_blank" style="margin:0px;padding:1px 3px;color:green;text-decoration:none;">http://pan.baidu.com/s/1dDENI73</a></p>
<p style="margin:10px auto;padding:0px;">　　（3）C#测试程序DEMO：<a href="http://pan.baidu.com/s/1kT42gAz" target="_blank" style="margin:0px;padding:1px 3px;color:green;text-decoration:none;">http://pan.baidu.com/s/1kT42gAz</a></p>
<p style="margin:10px auto;padding:0px;">&nbsp;</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div></body></html>