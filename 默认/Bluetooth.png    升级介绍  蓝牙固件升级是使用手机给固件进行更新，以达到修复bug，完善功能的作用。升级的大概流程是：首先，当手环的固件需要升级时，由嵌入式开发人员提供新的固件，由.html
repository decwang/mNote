<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-03-24T12:57:19Z"/><meta name="updated" content="2017-03-24T12:57:20Z"/><title>Bluetooth.png    升级介绍  蓝牙固件升级是使用手机给固件进行更新，以达到修复bug，完善功能的作用。升级的大概流程是：首先，当手环的固件需要升级时，由嵌入式开发人员提供新的固件，由</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div class="image-package" style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><img src="http://upload-images.jianshu.io/upload_images/1059465-3f9893059e8e70ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/1059465-3f9893059e8e70ff.png?imageMogr2/auto-orient/strip%7CimageView2/2" style="box-sizing:border-box;border:0px;vertical-align:middle;height:auto;cursor:zoom-in;transition:all 0.25s ease-in-out;-webkit-transition:all 0.25s ease-in-out;" /><br style="box-sizing:border-box;" />
<div class="image-caption" style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid #d9d9d9;font-size:14px;color:#969696;line-height:1.7;">Bluetooth.png</div>
</div>
<h3 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:22px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">升级介绍</h3>
<blockquote style="box-sizing:border-box;padding:20px;margin:0px 0px 25px;font-size:16px;border-left-width:6px;border-left-style:solid;border-left-color:#b4b4b4;background-color:#f7f7f7;word-break:break-word;line-height:30px;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;word-break:break-word;line-height:1.7;">蓝牙固件升级是使用手机给固件进行更新，以达到修复bug，完善功能的作用。升级的大概流程是：首先，当手环的固件需要升级时，由嵌入式开发人员提供新的固件，由服务器管理人员将固件放到服务器上，此时，用户打开手机APP的时候会检测到服务器有更新，请求更新手环固件，确认更新后，手机会从服务器下载固件。下载完毕后，APP会读取固件内容，并根据升级协议将内容传到手环里，完成升级。</p>
</blockquote>
<ul style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;padding:0px;word-break:break-word;margin-left:22px;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">DFU = Device Firmware Update （设备固件更新）</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">OTA = Over The Air （空中升级）</li>
</ul>
<h3 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:22px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">升级流程</h3>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">各个蓝牙设备不尽相同，以下是我测试设备的升级流程：</p>
<h6 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:16px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">OTA下载固件</h6>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">从云端下载的固件为.bin后缀的文件，文件名会有一定的格式，含有固件版本号和文件CRC32校验值。</p>
<h6 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:16px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">数据分块</h6>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">规定一个数据块大小比如2048字节，然后把升级数据进行分块，不够的就剩余多少作为一块。蓝牙一次发送的数据量是有限的，所以每次发送20字节的数据。这个数据要遵循升级数据格式，带指令头和校验和，下载包的数据只是这20字节中的一部分。所有包内数据都携带在每条升级数据指令中。</p>
<h6 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:16px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">升级过程</h6>
<ul style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;padding:0px;word-break:break-word;margin-left:22px;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">连接设备，发送升级请求。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">待蓝牙确认之后，开始发送数据头告知蓝牙此次发送的数据量和CRC校验。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">开始发送升级数据。（每条数据之间间隔20ms为了蓝牙能够方便处理）</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">待一个块发送完就发送块结束命令</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">蓝牙确认发送下一个块，返回错误则终止此次升级</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">发完所有数据之后发送升级完成</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">蓝牙确认则升级完成，返回错误则升级失败</li>
</ul>
<h6 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:16px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">流程图</h6>
<div class="image-package" style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><img src="http://upload-images.jianshu.io/upload_images/1059465-fe149f35edab6e56.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/1059465-fe149f35edab6e56.png?imageMogr2/auto-orient/strip%7CimageView2/2" style="box-sizing:border-box;border:0px;vertical-align:middle;height:auto;cursor:zoom-in;transition:all 0.25s ease-in-out;-webkit-transition:all 0.25s ease-in-out;" /><br style="box-sizing:border-box;" />
<div class="image-caption" style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid #d9d9d9;font-size:14px;color:#969696;line-height:1.7;">upgrade.png</div>
</div>
<h3 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:22px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">总结</h3>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">蓝牙升级最复杂的就在升级过程，大量的数据与蓝牙交互，这时最好记录发送到升级数据的那一部分，可以给用户展示升级的进程。</p></body></html>