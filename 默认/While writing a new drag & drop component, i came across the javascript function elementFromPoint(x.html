<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2016-12-15T08:28:36Z"/><meta name="updated" content="2016-12-15T08:28:39Z"/><title>While writing a new drag & drop component, i came across the javascript function elementFromPoint(x</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">While writing a new drag &amp; drop component, i came across the javascript function elementFromPoint(x,y).</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">The elementFromPoint method returns the DOM node located at the coordinates x,y. This method is truly helpful when it comes to detecting a drop target. You simply get the node at the mouse position with elementFromPoint at the coordinates the drop occured and walk up through the DOM tree untill you find a valid drop target. From a jQuery point of view, this means only using $(nodeUnderPointXY).closest('myDropTargetSelector') on the node.</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">For more information on this elementFromPoint, see quirksmode’s&nbsp;<a target="_blank" href="http://www.quirksmode.org/dom/w3c_cssom.html#documentview" style="color:#f87070;text-decoration:none;">compatibility table</a>&nbsp;and a&nbsp;<a target="_blank" href="http://www.quirksmode.org/dom/tests/elementfrompoint.html" style="color:#f87070;text-decoration:none;">demo</a>.</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;"></p>
<span style="font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">But unfotunately there is a big drawback !!!</span><p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">I.e. there are incompatibilities between browsers in wether to use the&nbsp;<em>absolute document coordinates&nbsp;</em>or the&nbsp;<em>relative window coordinates</em>&nbsp;to detect the element.</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">Safari 4 and Opera 10.10 need the absolute coordinates, whereas IE and Firefox need the the relative ones. In case of a mouse event, this means the difference between&nbsp;<em>pageY&nbsp;</em>and&nbsp;<em>clientY</em>. clientY is the relative value which is measured from to the top left corner of the viewport. pageY is the absolute value, which is measured from the top left corner of the document. The following picture demonstrates the difference.</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">As you can see, there won’t be any problems if the page is not scrolled. In this case pageY and clientY are pointing to the same point of the document. But the moment the page is scrolled, both values get out of sync.</p>
<span style="font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">A solution to the problem</span><p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">Of course we could check browsers &amp; versions and then decide which coordinates to pass to the method. But the better way will always be feature detection. In the following i try to demonstrate a way on how to detect which coordinates are needed and then wrap these results in a new elementFromPoint method. At first we take a look at the w3c specification on the elementFromPoint method.</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">The&nbsp;<a target="_blank" href="http://dev.w3.org/csswg/cssom-view/#dom-document-elementfrompoint" style="color:#f87070;text-decoration:none;">w3c specification</a>&nbsp;says:</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">The elementFromPoint(x, y) method, when invoked,&nbsp;<strong>must</strong>&nbsp;return the element at coordinates x,y in the&nbsp;<em>viewport</em>. The element to be returned is determined through hit testing. If either argument is negative, x is greater than the&nbsp;<em>viewport</em>&nbsp;width excluding the size of a rendered scroll bar (if any), or y is greather than the viewport height excluding the size of a rendered scroll bar (if any), the method&nbsp;<strong>must</strong>&nbsp;return null. If there is no element at the given position the method&nbsp;<strong>must</strong>&nbsp;return the&nbsp;<em>root</em>element, if any, or null otherwise.</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">Two things are important.<br />
First: passing relative coordinates (viewport) is the&nbsp;<em>default&nbsp;</em>solution.<br />
And second: if you pass coordinates which are out of the bounds of the viewport, the method&nbsp;<strong>must&nbsp;</strong>return null, whereas if the coordinates are inside the viewport’s bounds, it will&nbsp;<strong>at least&nbsp;</strong>return the root element.</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">This is where we start with our feature detector:</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">In case the document&nbsp;<strong>isn’t scrolled&nbsp;</strong>we don’t have to do any checks, as clientY and pageY will always point to the same location.</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">In case the page&nbsp;<strong>is scrolled&nbsp;</strong>we take the scrollamount, add it to the viewport’s height and then substract 1px. In jQuery this means $(document).scrollTop() + $(window).height() -1. This coordinate points to the bottom-most location of the viewport, if absolute coordinates are used, but exceeds the viewport, if relative coordinates are used. So if document.elementFromPoint( 0, $(document).scrollTop() + $(window).height() -1 ) returns null, the browser uses relative coordinates (clientY), and if the browser returns at least some node (possibly the root node), the browsers uses absolute coordinates (pageY).</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">And here are all these thoughst joined into a script:</p>
<span style="font-variant-ligatures:normal;orphans:2;widows:2;color:#454545;font-family:tahoma, helvetica, arial;line-height:21px;">(function ($){ var check=false, isRelative=true; $.elementFromPoint = function(x,y) { if(!document.elementFromPoint) return null; if(!check) { var sl; if((sl = $(document).scrollTop()) &gt;0) { isRelative = (document.elementFromPoint(0, sl + $(window).height() -1) == null); } else if((sl = $(document).scrollLeft()) &gt;0) { isRelative = (document.elementFromPoint(sl + $(window).width() -1, 0) == null); } check = (sl&gt;0); } if(!isRelative) { x += $(document).scrollLeft(); y += $(document).scrollTop(); } return document.elementFromPoint(x,y); }})(jQuery);</span></body></html>