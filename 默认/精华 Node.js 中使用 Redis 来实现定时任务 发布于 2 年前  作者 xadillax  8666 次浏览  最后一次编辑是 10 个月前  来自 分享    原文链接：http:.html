<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-07-20T04:10:20Z"/><meta name="updated" content="2017-07-20T04:10:23Z"/><title>精华 Node.js 中使用 Redis 来实现定时任务 发布于 2 年前  作者 xadillax  8666 次浏览  最后一次编辑是 10 个月前  来自 分享    原文链接：http://</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div class="panel" style="margin-bottom:13px;color:#333333;font-family:'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#e1e1e1;"><div class="header topic_header" style="padding:10px;background-color:#ffffff;border-radius:3px 3px 0px 0px;"><span class="topic_full_title" style="font-size:22px;font-weight:700;margin:8px 0px;display:inline-block;vertical-align:bottom;width:806.25px;line-height:28.6px;"><span class="put_good" style="background:#80bd01;padding:2px 4px;border-radius:3px;color:#ffffff;font-size:12px;">精华</span>&nbsp;Node.js 中使用 Redis 来实现定时任务</span><div class="changes" style="overflow:hidden;font-size:12px;color:#838383;">&nbsp;发布于 2 年前&nbsp;&nbsp;作者&nbsp;<a href="https://cnodejs.org/user/xadillax" style="color:inherit;text-decoration:none;">xadillax</a>&nbsp;&nbsp;8666 次浏览&nbsp;&nbsp;最后一次编辑是 10 个月前&nbsp;&nbsp;来自 分享</div>
</div>
<div class="inner topic" style="line-height:2em;background-color:#ffffff;padding:10px;border-radius:0px 0px 3px 3px;border-top:1px solid #e5e5e5;"><div class="topic_content" style="margin:0px 10px;"><div class="markdown-text"><blockquote style="padding:0px 0px 0px 15px;margin:0px 0px 20px;border-left:5px solid #eeeeee;"><p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;line-height:1.7em;white-space:pre-wrap;word-wrap:break-word;overflow:auto;">原文链接：<a href="http://xcoder.in/2015/06/05/scheduled-task-using-redis/" target="_blank" style="color:#0088cc;text-decoration:none;">http://xcoder.in/2015/06/05/scheduled-task-using-redis/</a></p>
</blockquote>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">好久没写博文了，最近在跟随着公司大牛们的脚步秘密研发新产品中。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">不过前几天有一个小需求的东西可以提出来写一点点小干货儿跟大家分享分享。米娜桑会的就可以忽略了，反正我也是随便写的；如果觉得本文对你有用的话还请多多支持喵。(●´ω｀●)ゞ</p>
<h2 style="margin:30px 0px 15px;font-family:inherit;line-height:40px;color:inherit;text-rendering:optimizeLegibility;font-size:26px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;">序</h2>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">本文所说的定时任务或者说计划任务并不是很多人想象中的那样，比如说每天凌晨三点自动运行起来跑一个脚本。这种都已经烂大街了，随便一个 <span style="font-weight:700;"><a href="https://wiki.archlinux.org/index.php/Cron" target="_blank" style="color:#0088cc;text-decoration:none;">Crontab</a></span> 就能搞定了。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">这里所说的定时任务可以说是计时器任务，比如说用户触发了某个动作，那么从这个点开始过二十四小时我们要对这个动作做点什么。那么如果有 1000 个用户触发了这个动作，就会有 1000 个定时任务。于是这就不是 <span style="font-weight:700;">Cron</span> 范畴里面的内容了。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">举个最简单的例子，一个用户推荐了另一个用户，我们定一个二十四小时之后的任务，看看被推荐的用户有没有来注册，如果没注册就给他搞一条短信过去。Σ&gt;―(〃°ω°〃)♡→</p>
<h2 style="margin:30px 0px 15px;font-family:inherit;line-height:40px;color:inherit;text-rendering:optimizeLegibility;font-size:26px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;">最初的设想</h2>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">一开始我是想把这个计时器做在内存里面直接调用的。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">考虑到 Node.js 的定时并不是那么准确（无论是 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">setTimeout</code> 还是 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">setInterval</code>），所以本来打算自己维护这个定时器队列。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">又考虑到 Node.js 原生对象比较耗内存。之前我用 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">JSON</code> 对象存了一本字典，约十二万多的词条，原文件大概也就五六兆，用 Node.js 的原生对象一存居然有五六百兆的内存占用——所以打算这个定时器队列用 C++ 来写 addon。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">考虑到任何时候插入的任务都有可能在已有的任务之前或者之后，所以本来想用 C++ 来写一个<a href="http://zh.wikipedia.org/wiki/%E6%9C%80%E5%A4%A7%E2%80%94%E6%9C%80%E5%B0%8F%E5%A0%86" target="_blank" style="color:#0088cc;text-decoration:none;">小根堆</a>。每次用户来一个任务的时候就将这个任务插入到堆中。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">如果按照上述方法的话，再加上对时间要求掐得也不是那么紧，于是就是一个不断的 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">process.nextTick()</code> 的过程。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">在 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">process.nextTick()</code> 当中执行这么一个函数：</p>
<ol style="padding:0px;margin:0px 0px 10px 25px;"><li style="line-height:2em;">从小根堆中不断获取堆顶的任务并处理，一直处理到堆顶任务的执行时间大于当前时间为止。</li>
<li style="line-height:2em;">继续&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">process.nextTick()</code>&nbsp;来让下一个 tick 执行步骤 1 中的流程。</li>
</ol>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">所以最后就是一边往小根堆插入任务，另一边通过不断 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">process.nextTick()</code> 消费任务的这么一个过程。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">最后，为了考虑到程序重启的时候内存数据会丢失，还应该做一个持久化的事情——在每次插入任务的时候顺便往持久化中间件中插一条副本，比如 MySQL、MongoDB、Redis、Riak 等等任何三方依赖。消费任务的时候顺便把中间件中的这条任务数据给删除。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">也就是说中间件中永远存的就是当前尚未完成的任务。每当程序重启的时候都先从中间件中把所有任务读取进来重建一下堆，然后就能继续工作了。</p>
<blockquote style="padding:0px 0px 0px 15px;margin:0px 0px 20px;border-left:5px solid #eeeeee;"><p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;line-height:1.7em;white-space:pre-wrap;word-wrap:break-word;overflow:auto;">如果当时我没有发现 Redis 的这个妙用的话，上述的流程将会是我实现我们定时任务的流程了。</p>
</blockquote>
<h2 style="margin:30px 0px 15px;font-family:inherit;line-height:40px;color:inherit;text-rendering:optimizeLegibility;font-size:26px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;">Redis 妙用</h2>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">在 Redis 的 2.8.0 版本之后，其推出了一个新的特性——键空间消息（<a href="http://redis.io/topics/notifications" target="_blank" style="color:#0088cc;text-decoration:none;">Redis Keyspace Notifications</a>），它配合 2.0.0 版本之后的 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">SUBSCRIBE</code> 就能完成这个定时任务的操作了，<span style="font-weight:700;">不过定时的单位是秒</span>。</p>
<h3 style="margin:30px 0px 15px;font-family:inherit;line-height:40px;color:inherit;text-rendering:optimizeLegibility;font-size:24.5px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;">Publish / Subscribe</h3>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">Redis 在 2.0.0 之后推出了 <a href="http://redis.io/topics/pubsub" target="_blank" style="color:#0088cc;text-decoration:none;">Pub / Sub</a> 的指令，大致就是说一边给 Redis 的特定频道发送消息，另一边从 Redis 的特定频道取值——形成了一个简易的消息队列</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">比如我们可以往 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">foo</code> 频道推一个消息 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">bar</code>，那么就可以直接：</p>
<pre class="prettyprint" style="line-height:22px;white-space:pre-wrap;padding:0px 15px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:20px -10px;word-break:break-all;word-wrap:break-word;background-color:#f7f7f7;border-width:1px 0px;border-style:none;tab-size:4;background-position:initial initial;background-repeat:initial initial;"><code style="padding:0px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:12px;color:inherit;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:0px;"><span class="pln" style="color:#000000;">PUBLISH foo bar</span></code></pre><p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">另一边我们在客户端订阅 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">foo</code> 频道就能接受到这个消息了。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">举个例子，如果在 Node.js 里面使用 <a href="https://github.com/luin/ioredis" target="_blank" style="color:#0088cc;text-decoration:none;">ioredis</a> 这个包那么看起来就会像这样：</p>
<pre class="prettyprint language-javascript" style="line-height:22px;white-space:pre-wrap;padding:0px 15px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:20px -10px;word-break:break-all;word-wrap:break-word;background-color:#f7f7f7;border-width:1px 0px;border-style:none;tab-size:4;background-position:initial initial;background-repeat:initial initial;"><code style="padding:0px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:12px;color:inherit;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:0px;"><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> </span><span class="typ" style="color:#660066;">Redis</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">require</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"ioredis"</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">sub</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">new</span><span class="pln" style="color:#000000;"> </span><span class="typ" style="color:#660066;">Redis</span><span class="pun" style="color:#666600;">(</span><span class="com" style="color:#880000;">/** 连接信息 */</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">sub</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">once</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"connect"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">()</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// 假设我们需要选择 redis 的 db，因为实际上我们不会去污染默认的 db 0</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">sub</span><span class="pun" style="color:#666600;">.</span><span class="kwd" style="color:#000088;">select</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">DB_NUMBER</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">err</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">         </span><span class="kwd" style="color:#000088;">if</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">err</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> process</span><span class="pun" style="color:#666600;">.</span><span class="kwd" style="color:#000088;">exit</span><span class="pun" style="color:#666600;">(</span><span class="lit" style="color:#006666;">4</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">         </span><span class="kwd" style="color:#000088;">sub</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">subscribe</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"foo"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">()</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">             </span><span class="com" style="color:#880000;">//... 订阅频道成功</span><span class="pln" style="color:#000000;">         </span><span class="pun" style="color:#666600;">});</span><span class="pln" style="color:#000000;">     </span><span class="pun" style="color:#666600;">});</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">});</span><span class="pln" style="color:#000000;"> </span><span class="com" style="color:#880000;">// 监听从 `foo` 来的消息</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">sub</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">on</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"message"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">channel</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> msg</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">     console</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">log</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">channel</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> msg</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">});</span></code></pre><h3 style="margin:30px 0px 15px;font-family:inherit;line-height:40px;color:inherit;text-rendering:optimizeLegibility;font-size:24.5px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;">Redis Keyspace Notifications</h3>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">在 Redis 里面有一些事件，比如键到期、键被删除等。然后我们可以通过配置一些东西来让 Redis 一旦触发这些事件的时候就往特定的 Channel 推一条消息。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">本文所涉及到的需求的话我们所需要关心的事件是 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">EXPIRE</code> 即过期事件。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">大致的流程就是我们给 Redis 的某一个 db 设置过期事件，使其键一旦过期就会往特定频道推消息，我在自己的客户端这边就一直消费这个频道就好了。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">以后一来一条定时任务，我们就把这个任务状态压缩成一个键，并且过期时间为距这个任务执行的时间差。那么当键一旦到期，就到了任务该执行的时间，Redis 自然会把过期消息推去，我们的客户端就能接收到了。这样一来就起到了定时任务的作用。</p>
<h4 style="margin:30px 0px 15px;font-family:inherit;line-height:20px;color:inherit;text-rendering:optimizeLegibility;font-size:17.5px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;">消息类型</h4>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">当达到一定条件后，有两种类型的这种消息会被触发，用哪个需要自己选了。举个例子，我们删除了在 db 0 中一个叫 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">foo</code> 的键，那么系统会往两个频道推消息，一个是 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">del</code> 事件频道推 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">foo</code> 消息，另一个是 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">foo</code> 频道推 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">del</code> 消息，它们小俩口被系统推送的指令分别等价于：</p>
<pre class="prettyprint" style="line-height:22px;white-space:pre-wrap;padding:0px 15px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:20px -10px;word-break:break-all;word-wrap:break-word;background-color:#f7f7f7;border-width:1px 0px;border-style:none;tab-size:4;background-position:initial initial;background-repeat:initial initial;"><code style="padding:0px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:12px;color:inherit;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:0px;"><span class="pln" style="color:#000000;">PUBLISH __keyspace@0__</span><span class="pun" style="color:#666600;">:</span><span class="pln" style="color:#000000;">foo </span><span class="kwd" style="color:#000088;">del</span><span class="pln" style="color:#000000;"> PUBLISH __keyevent@0__</span><span class="pun" style="color:#666600;">:</span><span class="kwd" style="color:#000088;">del</span><span class="pln" style="color:#000000;"> foo</span></code></pre><p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">其中往 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">foo</code> 推送 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">del</code> 的频道名为 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">__keyspace@0__:foo</code>，即是 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">"__keyspace@" + DB_NUMBER + "__:" + KEY_NAME</code>；而 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">del</code> 的频道名为 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">"__keyevent@" + DB_NUMBER + "__:" + EVENT_NAME</code>。</p>
<h4 style="margin:30px 0px 15px;font-family:inherit;line-height:20px;color:inherit;text-rendering:optimizeLegibility;font-size:17.5px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;">配置</h4>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">即使你的 Redis 版本达标了，但是 Redis 默认是关闭这个功能的，你需要修改配置文件来打开它，或者直接在 CLI 里面通过指令修改。这里就说说配置文件的修改吧。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">如果不想看我在这里罗里吧嗦的，也可以直接去看 Redis 的<a href="http://redis.io/topics/notifications#configuration" target="_blank" style="color:#0088cc;text-decoration:none;">相关文档</a>。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">首先打开 Redis 的配置文件，在不同的系统和安装方式下文件位置可能不同，比如通过 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">brew</code> 安装的 MacOS 下可能是在 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">/usr/local/etc/redis.conf</code> 下面，通过 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">apt-get</code> 安装的 Ubuntu 下可能是在 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">/etc/redis/redis.conf</code> 下，总之找到配置文件。<span style="font-weight:700;">或者自己写一个配置文件，启动的时候指定配置文件地址就好。</span></p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">然后找到一项叫 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">notify-keyspace-events</code> 的地方，如果找不到则自行添加，其值可以是 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">Ex</code>、<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">Klg</code> 等等。这些字母的具体含义如下所示：</p>
<ul style="padding:0px;margin:0px 0px 10px 25px;"><li style="line-height:2em;"><span style="font-weight:700;">K</span>，表示&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">keyspace</code>&nbsp;事件，有这个字母表示会往&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">__keyspace@&lt;db&gt;__</code>&nbsp;频道推消息。</li>
<li style="line-height:2em;"><span style="font-weight:700;">E</span>，表示&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">keyevent</code>&nbsp;事件，有这个字母表示会往&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">__keyevent@&lt;db&gt;__</code>&nbsp;频道推消息。</li>
<li style="line-height:2em;"><span style="font-weight:700;">g</span>，表示一些通用指令事件支持，如&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">DEL</code>、<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">EXPIRE</code>、<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">RENAME</code>&nbsp;等等。</li>
<li style="line-height:2em;"><span style="font-weight:700;">$</span>，表示字符串（String）相关指令的事件支持。</li>
<li style="line-height:2em;"><span style="font-weight:700;">l</span>，表示列表（List）相关指令事件支持。</li>
<li style="line-height:2em;"><span style="font-weight:700;">s</span>，表示集合（Set）相关指令事件支持。</li>
<li style="line-height:2em;"><span style="font-weight:700;">h</span>，哈希（Hash）相关指令事件支持。</li>
<li style="line-height:2em;"><span style="font-weight:700;">z</span>，有序集（Sorted Set）相关指令事件支持。</li>
<li style="line-height:2em;"><span style="font-weight:700;">x</span>，过期事件，与&nbsp;<span style="font-weight:700;">g</span>&nbsp;中的&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">EXPIRE</code>&nbsp;不同的是，<span style="font-weight:700;">g</span>&nbsp;的&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">EXPIRE</code>&nbsp;是指执行&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">EXPIRE key ttl</code>&nbsp;这条指令的时候顺便触发的事件，而这里是指那个&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">key</code>&nbsp;刚好过期的这个时间点触发的事件。</li>
<li style="line-height:2em;"><span style="font-weight:700;">e</span>，驱逐事件，一个&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">key</code>&nbsp;由于内存上限而被驱逐的时候会触发的事件。</li>
<li style="line-height:2em;"><span style="font-weight:700;">A</span>，<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">g$lshzxe</code>&nbsp;的别名。也就是说&nbsp;<code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:3px;white-space:nowrap;background-color:#fcfafa;border:none;">AKE</code>&nbsp;的意思就代表了所有的事件。</li>
</ul>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">结合上述列表我们就能拼凑出自己所需要的事件支持字符串了，在我的需求中我只需要 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">Ex</code> 就可以满足了，所以配置项就是这样的：</p>
<pre class="prettyprint" style="line-height:22px;white-space:pre-wrap;padding:0px 15px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:20px -10px;word-break:break-all;word-wrap:break-word;background-color:#f7f7f7;border-width:1px 0px;border-style:none;tab-size:4;background-position:initial initial;background-repeat:initial initial;"><code style="padding:0px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:12px;color:inherit;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:0px;"><span class="pln" style="color:#000000;">notify</span><span class="pun" style="color:#666600;">-</span><span class="pln" style="color:#000000;">keyspace</span><span class="pun" style="color:#666600;">-</span><span class="pln" style="color:#000000;">events </span><span class="typ" style="color:#660066;">Ex</span></code></pre><p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">然后保存配置文件，启动 Redis 就启用了过期事件的支持了。</p>
<h4 style="margin:30px 0px 15px;font-family:inherit;line-height:20px;color:inherit;text-rendering:optimizeLegibility;font-size:17.5px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;">实践</h4>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">我们先说任务的创造者吧。由于这里 <span style="font-weight:700;">Redis</span> 的事件只会传键名，并不会传键值，而过期事件触发的时候那个键已经没了，你也无法获取键值，加上我的主系统和任务系统是分布式的，所以就把所有需要的信息往键名塞。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">一个最简单的键名设计就是 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">任务类型 + ":" + JSON.stringify 化后的参数数组</code>；更有甚者可以直接把任务类型替换成所需的函数路径，比如需要执行这个任务的函数在 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">task/foo/bar</code> 文件下面的 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">baz</code> 函数，参数 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">arguments</code> 数组为 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">[ 1, 2 ]</code>，那么键名的设计可以是 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">task/foo/bar.baz:[1,2]</code>，反正我们只需要触发这个键，用不着去查询这个键。等到真正过期了任务系统接收到这个键名的时候再一一解析，得到需要执行 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">task/foo/bar.baz</code> 这个消息，并且网函数里面传入 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">[1,2]</code> 这个 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">arguments</code>。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">所以当接收到一个定时任务的时候，我们得到消息、函数名、过期时间参数，这个函数可以如下设计：</p>
<pre class="prettyprint language-javascript" style="line-height:22px;white-space:pre-wrap;padding:0px 15px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:20px -10px;word-break:break-all;word-wrap:break-word;background-color:#f7f7f7;border-width:1px 0px;border-style:none;tab-size:4;background-position:initial initial;background-repeat:initial initial;"><code style="padding:0px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:12px;color:inherit;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:0px;"><span class="com" style="color:#880000;">/** 我们假设 redis 是一个 ioredis 的对象 */</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> sampleTaskMaker </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">message</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> func</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> timeout</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">     message </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> JSON</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">stringify</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">message</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">     console</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">log</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"Received a new task:"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> func</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> message</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="str" style="color:#008800;">"after "</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">+</span><span class="pln" style="color:#000000;"> timeout </span><span class="pun" style="color:#666600;">+</span><span class="pln" style="color:#000000;"> </span><span class="str" style="color:#008800;">"."</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// 这里的 uuid 是 npm 一个包</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// 生成一个唯一 uuid 的目的是为了防止两个任务用了相同的函数和参数，那么</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// 键名可能会重复并覆盖的情况</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// uuid 的文档为 https://www.npmjs.com/package/node-uuid</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">//</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// 这里的 ❤️ 是一个分隔符，冒号是分割 uuid 和后面内容的，而 ❤️ 是分割函数名</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// 和消息的</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> key </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> uuid</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">v1</span><span class="pun" style="color:#666600;">().</span><span class="pln" style="color:#000000;">replace</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">/-/</span><span class="pln" style="color:#000000;">g</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="str" style="color:#008800;">""</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">+</span><span class="pln" style="color:#000000;">         </span><span class="str" style="color:#008800;">":❤️"</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">+</span><span class="pln" style="color:#000000;"> func </span><span class="pun" style="color:#666600;">+</span><span class="pln" style="color:#000000;"> </span><span class="str" style="color:#008800;">"❤️"</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">+</span><span class="pln" style="color:#000000;"> message</span><span class="pun" style="color:#666600;">;</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> content </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> </span><span class="str" style="color:#008800;">""</span><span class="pun" style="color:#666600;">;</span><span class="pln" style="color:#000000;">     redis</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">multi</span><span class="pun" style="color:#666600;">()</span><span class="pln" style="color:#000000;">         </span><span class="pun" style="color:#666600;">.</span><span class="kwd" style="color:#000088;">set</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">key</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> content</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;">         </span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">expire</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">key</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> timeout</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;">         </span><span class="pun" style="color:#666600;">.</span><span class="kwd" style="color:#000088;">exec</span><span class="pun" style="color:#666600;">(</span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">err</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">             </span><span class="kwd" style="color:#000088;">if</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">err</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">                 console</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">error</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"Failed to publish EXPIRE EVENT for "</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">+</span><span class="pln" style="color:#000000;"> content</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">                 console</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">error</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">err</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">                 </span><span class="kwd" style="color:#000088;">return</span><span class="pun" style="color:#666600;">;</span><span class="pln" style="color:#000000;">             </span><span class="pun" style="color:#666600;">}</span><span class="pln" style="color:#000000;">         </span><span class="pun" style="color:#666600;">});</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">};</span></code></pre><blockquote style="padding:0px 0px 0px 15px;margin:0px 0px 20px;border-left:5px solid #eeeeee;"><p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;line-height:1.7em;white-space:pre-wrap;word-wrap:break-word;overflow:auto;">Ioredis 的稳定可以<a href="https://github.com/luin/ioredis" target="_blank" style="color:#0088cc;text-decoration:none;">点此</a>查看。</p>
</blockquote>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">然后在任务系统里面的一开始监听这个过期频道：</p>
<pre class="prettyprint language-javascript" style="line-height:22px;white-space:pre-wrap;padding:0px 15px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:20px -10px;word-break:break-all;word-wrap:break-word;background-color:#f7f7f7;border-width:1px 0px;border-style:none;tab-size:4;background-position:initial initial;background-repeat:initial initial;"><code style="padding:0px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:12px;color:inherit;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:0px;"><span class="com" style="color:#880000;">// assign 是 sugarjs 里面的函数</span><span class="pln" style="color:#000000;"> </span><span class="com" style="color:#880000;">// 把 db 塞到字符串里面的 {db} 里去</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> subscribeKey </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> </span><span class="str" style="color:#008800;">"__keyevent@{db}__:expired"</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">assign</span><span class="pun" style="color:#666600;">({</span><span class="pln" style="color:#000000;"> db</span><span class="pun" style="color:#666600;">:</span><span class="pln" style="color:#000000;"> </span><span class="lit" style="color:#006666;">1</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">});</span><span class="pln" style="color:#000000;"> </span><span class="com" style="color:#880000;">// 假设 sub 是 ioredis 的对象</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">sub</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">once</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"connect"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">()</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// 假设我们需要选择 redis 的 db，因为实际上我们不会去污染默认的 db 0</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">sub</span><span class="pun" style="color:#666600;">.</span><span class="kwd" style="color:#000088;">select</span><span class="pun" style="color:#666600;">(</span><span class="lit" style="color:#006666;">1</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">err</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">         </span><span class="kwd" style="color:#000088;">if</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">err</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> process</span><span class="pun" style="color:#666600;">.</span><span class="kwd" style="color:#000088;">exit</span><span class="pun" style="color:#666600;">(</span><span class="lit" style="color:#006666;">4</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">         </span><span class="kwd" style="color:#000088;">sub</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">subscribe</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"foo"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">()</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">             </span><span class="com" style="color:#880000;">//... 订阅频道成功</span><span class="pln" style="color:#000000;">         </span><span class="pun" style="color:#666600;">});</span><span class="pln" style="color:#000000;">     </span><span class="pun" style="color:#666600;">});</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">});</span><span class="pln" style="color:#000000;"> </span><span class="com" style="color:#880000;">// 监听从 `foo` 来的消息</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">sub</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">on</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"message"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> sampleOnExpired</span><span class="pun" style="color:#666600;">);</span></code></pre><blockquote style="padding:0px 0px 0px 15px;margin:0px 0px 20px;border-left:5px solid #eeeeee;"><p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;line-height:1.7em;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="font-weight:700;">注意：</span> 我们这里选择 db 1 是因为一旦开启过期事件监听，那么这个 db 的所有过期事件都会被发送。为了不跟正常使用的 redis 过期键混淆，我们为这个事情专门用一个新的 db。比如我们在自己正常使用的 db 0 里面监听了，那么不是我们任务触发的过期事件也会传过来，这个时候我们解析的键名就不对了。</p>
</blockquote>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">最后就是我们的 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">sampleOnExpired</code> 函数了。</p>
<pre class="prettyprint language-javascript" style="line-height:22px;white-space:pre-wrap;padding:0px 15px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:20px -10px;word-break:break-all;word-wrap:break-word;background-color:#f7f7f7;border-width:1px 0px;border-style:none;tab-size:4;background-position:initial initial;background-repeat:initial initial;"><code style="padding:0px;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:12px;color:inherit;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:0px;"><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> sampleOnExpired </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">channel</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> key</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// UUID:❤️func❤️params</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> body </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> key</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">split</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"❤️"</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">if</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">body</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">length </span><span class="pun" style="color:#666600;">&lt;</span><span class="pln" style="color:#000000;"> </span><span class="lit" style="color:#006666;">3</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">return</span><span class="pun" style="color:#666600;">;</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// 取出 body 第一位为 func</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> func </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> body</span><span class="pun" style="color:#666600;">[</span><span class="lit" style="color:#006666;">1</span><span class="pun" style="color:#666600;">];</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// 推出前两位，后面剩下的有可能是参数里面自带 ❤️ 而被分割，所以要拼回去</span><span class="pln" style="color:#000000;">     body</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">shift</span><span class="pun" style="color:#666600;">();</span><span class="pln" style="color:#000000;"> body</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">shift</span><span class="pun" style="color:#666600;">();</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">params</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> body</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">join</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"❤️"</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// 然后把 params 传入 func 去执行</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">// func:</span><span class="pln" style="color:#000000;">     </span><span class="com" style="color:#880000;">//   path1/path2.func</span><span class="pln" style="color:#000000;">     func </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> func</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">split</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"."</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">if</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">func</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">length </span><span class="pun" style="color:#666600;">!==</span><span class="pln" style="color:#000000;"> </span><span class="lit" style="color:#006666;">2</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">         console</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">error</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"Bad params for task:"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> func</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">join</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"."</span><span class="pun" style="color:#666600;">),</span><span class="pln" style="color:#000000;"> </span><span class="str" style="color:#008800;">"-"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">params</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">         </span><span class="kwd" style="color:#000088;">return</span><span class="pun" style="color:#666600;">;</span><span class="pln" style="color:#000000;">     </span><span class="pun" style="color:#666600;">}</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> path </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> func</span><span class="pun" style="color:#666600;">[</span><span class="lit" style="color:#006666;">0</span><span class="pun" style="color:#666600;">];</span><span class="pln" style="color:#000000;">     func </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> func</span><span class="pun" style="color:#666600;">[</span><span class="lit" style="color:#006666;">1</span><span class="pun" style="color:#666600;">];</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">var</span><span class="pln" style="color:#000000;"> mod</span><span class="pun" style="color:#666600;">;</span><span class="pln" style="color:#000000;">     </span><span class="kwd" style="color:#000088;">try</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">         mod </span><span class="pun" style="color:#666600;">=</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">require</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"./tasks/"</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">+</span><span class="pln" style="color:#000000;"> path</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">     </span><span class="pun" style="color:#666600;">}</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">catch</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">e</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">         console</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">error</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"Failed to load module"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> path</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">         console</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">error</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">e</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">stack</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">         </span><span class="kwd" style="color:#000088;">return</span><span class="pun" style="color:#666600;">;</span><span class="pln" style="color:#000000;">     </span><span class="pun" style="color:#666600;">}</span><span class="pln" style="color:#000000;">     process</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">nextTick</span><span class="pun" style="color:#666600;">(</span><span class="kwd" style="color:#000088;">function</span><span class="pun" style="color:#666600;">()</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">         </span><span class="kwd" style="color:#000088;">try</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">             mod</span><span class="pun" style="color:#666600;">[</span><span class="pln" style="color:#000000;">func</span><span class="pun" style="color:#666600;">].</span><span class="pln" style="color:#000000;">apply</span><span class="pun" style="color:#666600;">(</span><span class="kwd" style="color:#000088;">null</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> JSON</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">parse</span><span class="pun" style="color:#666600;">(</span><span class="kwd" style="color:#000088;">params</span><span class="pun" style="color:#666600;">));</span><span class="pln" style="color:#000000;">         </span><span class="pun" style="color:#666600;">}</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">catch</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">e</span><span class="pun" style="color:#666600;">)</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">{</span><span class="pln" style="color:#000000;">             console</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">error</span><span class="pun" style="color:#666600;">(</span><span class="str" style="color:#008800;">"Failed to call function"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> path</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="str" style="color:#008800;">"-"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> func</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="str" style="color:#008800;">"-"</span><span class="pun" style="color:#666600;">,</span><span class="pln" style="color:#000000;"> </span><span class="kwd" style="color:#000088;">params</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">             console</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">error</span><span class="pun" style="color:#666600;">(</span><span class="pln" style="color:#000000;">e</span><span class="pun" style="color:#666600;">.</span><span class="pln" style="color:#000000;">stack</span><span class="pun" style="color:#666600;">);</span><span class="pln" style="color:#000000;">         </span><span class="pun" style="color:#666600;">}</span><span class="pln" style="color:#000000;">     </span><span class="pun" style="color:#666600;">});</span><span class="pln" style="color:#000000;"> </span><span class="pun" style="color:#666600;">};</span></code></pre><p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">这个简易的架子搭好后，你只需要去写一堆任务执行函数，然后在生成任务的时候把相应参数传给 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">sampleTaskMaker</code> 就好了。Redis 会自动过期并且触发事件给你的 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">sampleOnExpired</code> 函数，然后就会去执行相应的任务处理函数了。</p>
<h2 style="margin:30px 0px 15px;font-family:inherit;line-height:40px;color:inherit;text-rendering:optimizeLegibility;font-size:26px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;">小结</h2>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">其实这个需求在我们项目目前就是给用户定时发提醒短信用的。如果没有发现 Redis 的这个妙用，我还是会去用<a href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#%E6%9C%80%E5%88%9D%E7%9A%84%E8%AE%BE%E6%83%B3" target="_blank" style="color:#0088cc;text-decoration:none;">第二节</a>里面的方法来写的。其实这期间也有考虑过用 RabbitMQ，不过貌似它的定时消息需要做一些 Hack，比较麻烦，最后就放弃了。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">Redis 的这个方法其实是我在谷歌搜出来的，别人在 StackOverflow 回答的答案。我参考了之后用我自己的方法实现了出来，并且把代码的关键部分提取出来整理成这篇小文，还希望能给各位看官一些用吧，望打赏。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">如果没有什么用也憋喷我，毕竟我是个蒟蒻。有更好的方法希望留个言，望告知。谢谢。(´,•ω•,)♡</p>
</div>
</div>
</div>
</div>
<div class="panel" style="margin-bottom:13px;color:#333333;font-family:'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#e1e1e1;"><div class="header" style="padding:10px;background-color:#f6f6f6;border-radius:3px 3px 0px 0px;"><span class="col_fade" style="color:#444444;">41 回复</span></div>
<div class="cell reply_area reply_item " reply_id="5577b576c4e7fbea6e9a33cb" reply_to_id="" id="5577b576c4e7fbea6e9a33cb" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/i5ting" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/3118295?v=3&amp;s=120" title="i5ting" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/i5ting" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">i5ting</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577b576c4e7fbea6e9a33cb" style="color:#0088cc;text-decoration:none;font-size:11px;">1楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;">&nbsp;<span class="up-count" style="color:gray;">1</span></div>
</div>
<div class="reply_content from-i5ting" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">不错的文章</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="http://mp.weixin.qq.com/s?__biz=MzAxMTU0NTc4Nw==&amp;mid=222697939&amp;idx=1&amp;sn=443fa5fde783cfbe6331900dfb3e3c31#rd" target="_blank" style="color:#0088cc;text-decoration:none;">我写过的node调度</a></p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">一样的思路</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577b65fc4e7fbea6e9a33d0" reply_to_id="5577b576c4e7fbea6e9a33cb" id="5577b65fc4e7fbea6e9a33d0" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577b65fc4e7fbea6e9a33d0" style="color:#0088cc;text-decoration:none;font-size:11px;">2楼•2 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/i5ting" target="_blank" style="color:#0088cc;text-decoration:none;">@i5ting</a> 其实我更希望实现第二节的内容，毕竟我比较喜欢造轮子。奈何项目进度不允许。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577b848c4e7fbea6e9a33d4" reply_to_id="5577b65fc4e7fbea6e9a33d0" id="5577b848c4e7fbea6e9a33d4" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/i5ting" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/3118295?v=3&amp;s=120" title="i5ting" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/i5ting" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">i5ting</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577b848c4e7fbea6e9a33d4" style="color:#0088cc;text-decoration:none;font-size:11px;">3楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-i5ting" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/xadillax" target="_blank" style="color:#0088cc;text-decoration:none;">@xadillax</a> 借口，哈哈，永远都木有时间</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577c26cc4e7fbea6e9a33ee" reply_to_id="" id="5577c26cc4e7fbea6e9a33ee" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/alsotang" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars2.githubusercontent.com/u/1147375?v=3&amp;s=120" title="alsotang" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/alsotang" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">alsotang</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577c26cc4e7fbea6e9a33ee" style="color:#0088cc;text-decoration:none;font-size:11px;">4楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-alsotang" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">如果我来写，我的做法会是这样：</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">首先我在 redis 中维护一个 sorted set。score 的值为：YYYYMMDD+HOUR，如 2015061020。当 A 用户邀请了 B 用户之后，我就推算一下 24 小时后，是多少，把 B 用户的值写入 set 中。然后另外起个定时任务，每小时读一次这个 set，读出比当前时间小的 score，批量处理一次。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">请问我这个做法相比文中有哪些不足吗？</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577c2f7c4e7fbea6e9a33f0" reply_to_id="" id="5577c2f7c4e7fbea6e9a33f0" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/alsotang" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars2.githubusercontent.com/u/1147375?v=3&amp;s=120" title="alsotang" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/alsotang" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">alsotang</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577c2f7c4e7fbea6e9a33f0" style="color:#0088cc;text-decoration:none;font-size:11px;">5楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-alsotang" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">文中提到的自动过期以及事件提醒等等的功能，无非就是 sql 中的一个 where 语句？ <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">table_time &lt; current_time</code>。只是由于使用了 redis，所以要变着法子实现这个功能？</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577c907c4e7fbea6e9a33f7" reply_to_id="" id="5577c907c4e7fbea6e9a33f7" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/blackjack" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://gravatar.com/avatar/66f5e67f825ebdfcc60d3e22cb4e14b5?size=48" title="blackjack" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/blackjack" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">blackjack</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577c907c4e7fbea6e9a33f7" style="color:#0088cc;text-decoration:none;font-size:11px;">6楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-blackjack" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">请问 subscribeKey  在哪儿订阅的</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577ca13c4e7fbea6e9a33f9" reply_to_id="" id="5577ca13c4e7fbea6e9a33f9" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/buctyoyo" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/4994082?v=3&amp;s=120" title="buctyoyo" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/buctyoyo" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">buctyoyo</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577ca13c4e7fbea6e9a33f9" style="color:#0088cc;text-decoration:none;font-size:11px;">7楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-buctyoyo" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">赞</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577d7b8c4e7fbea6e9a3418" reply_to_id="5577c2f7c4e7fbea6e9a33f0" id="5577d7b8c4e7fbea6e9a3418" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577d7b8c4e7fbea6e9a3418" style="color:#0088cc;text-decoration:none;font-size:11px;">8楼•2 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/alsotang" target="_blank" style="color:#0088cc;text-decoration:none;">@alsotang</a> 不同点在于一个是主动轮询，一个是被动接收消息。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">Pull 和 Push 的区别——当前系统（除去外部依赖不谈）通常被动接收的效率比轮询高。这就是为什么网络通信有那么多方法，<a href="http://blog.codingnow.com/2006/04/iocp_kqueue_epoll.html" target="_blank" style="color:#0088cc;text-decoration:none;">epoll 和 IOCP</a> 这类效率高点的原因了。</p>
<blockquote style="padding:0px 0px 0px 15px;margin:0px 0px 20px;border-left:5px solid #eeeeee;"><p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;line-height:1.7em;white-space:pre-wrap;word-wrap:break-word;overflow:auto;">以陈榕的说法讲，这叫鬼子进村策略。一遍遍的询问“鬼子进村了吗？”，“鬼子进村了吗？”… 大量的 cpu 时间都耗了进去。使用 kqueue 这些，变成了派一些个人去站岗，鬼子来了就可以拿到通知，效率自然高了许多。</p>
</blockquote>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">以及考虑到可扩展性，时间不一定是二十四小时，任务也有很多，并且不是说一个小时跑一次脚本的那种。如果是这样的话 Cron 足矣。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577d8b0c4e7fbea6e9a341a" reply_to_id="5577c2f7c4e7fbea6e9a33f0" id="5577d8b0c4e7fbea6e9a341a" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577d8b0c4e7fbea6e9a341a" style="color:#0088cc;text-decoration:none;font-size:11px;">9楼•2 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/alsotang" target="_blank" style="color:#0088cc;text-decoration:none;">@alsotang</a> 哦看错了，你是脚本形式。我最开始也是考虑到脚本。但是考虑到任务的可扩展性，有很多任务只是要到点处理，而不是说到点之后一个小时内一次性批量处理。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">应用场景还是有所不同的。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577de35c4e7fbea6e9a342e" reply_to_id="5577d7b8c4e7fbea6e9a3418" id="5577de35c4e7fbea6e9a342e" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/alsotang" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars2.githubusercontent.com/u/1147375?v=3&amp;s=120" title="alsotang" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/alsotang" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">alsotang</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577de35c4e7fbea6e9a342e" style="color:#0088cc;text-decoration:none;font-size:11px;">10楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;">&nbsp;<span class="up-count" style="color:gray;">1</span></div>
</div>
<div class="reply_content from-alsotang" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/xadillax" target="_blank" style="color:#0088cc;text-decoration:none;">@xadillax</a></p>
<ol style="padding:0px;margin:0px 0px 10px 25px;"><li style="line-height:2em;">在这个地方，你觉得被动接收消息的效率比主动轮询高？效率怎么比？性能？CPU 占用，内存占用？我的方案至少还有的优势是【批量处理】。</li>
<li style="line-height:2em;">考虑到可拓展性，我方案中的 score 也可以细到毫秒粒度。你所说的到点处理，最终还是受时间粒度所限。一般这类可以延迟执行的任务，到秒级别的时间粒度也够用了吧？我的方案可以按秒级别来轮询 redis。与通过事件监听相比，两者性能我认为相当。</li>
</ol>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">我也不一定要用脚本形式，这个脚本可以写进 app 中，也可以单独提出来。Node 在 IO 上是非阻塞的，所以放哪里都差不多。但从解耦的角度来，app 负责写入任务，脚本负责处理任务，这样的架构我认为更好。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577de5ac4e7fbea6e9a3430" reply_to_id="" id="5577de5ac4e7fbea6e9a3430" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/alsotang" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars2.githubusercontent.com/u/1147375?v=3&amp;s=120" title="alsotang" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/alsotang" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">alsotang</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577de5ac4e7fbea6e9a3430" style="color:#0088cc;text-decoration:none;font-size:11px;">11楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-alsotang" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">文章中的方案，复杂度比我的方案高了一个量级。是否真的这个必要？</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577e266c4e7fbea6e9a3449" reply_to_id="" id="5577e266c4e7fbea6e9a3449" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/yessirpopesama" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars1.githubusercontent.com/u/2805666?v=4&amp;s=120" title="yessirpopesama" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/yessirpopesama" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">yessirpopesama</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577e266c4e7fbea6e9a3449" style="color:#0088cc;text-decoration:none;font-size:11px;">12楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-yessirpopesama" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">楼主holy high 学习学习</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577e846c4e7fbea6e9a3468" reply_to_id="5577de5ac4e7fbea6e9a3430" id="5577e846c4e7fbea6e9a3468" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577e846c4e7fbea6e9a3468" style="color:#0088cc;text-decoration:none;font-size:11px;">13楼•2 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/alsotang" target="_blank" style="color:#0088cc;text-decoration:none;">@alsotang</a> 我之前看错了，你的是脚本形式的，我有回复的。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">这两种方案是没有可比性的，我的任务系统也是独立的，并不是合在 app 里面的。只是面临的需求不同而已。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577e8c6c4e7fbea6e9a346a" reply_to_id="5577de5ac4e7fbea6e9a3430" id="5577e8c6c4e7fbea6e9a346a" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577e8c6c4e7fbea6e9a346a" style="color:#0088cc;text-decoration:none;font-size:11px;">14楼•2 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/alsotang" target="_blank" style="color:#0088cc;text-decoration:none;">@alsotang</a> 我在文章一开始就已经提到脚本的方法了，实际上就是 <code style="padding:4px 6px;font-family:Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#000000;border-radius:1px;white-space:nowrap;background:0px 0px #fcfafa;border:none;margin:0px 1px;">Cron</code> 大法，并且在一开始就说明了需求问题被我弃用了这个方法，转而将文章的重点放到 Redis 的过期事件当中。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577e98fc4e7fbea6e9a346c" reply_to_id="5577de5ac4e7fbea6e9a3430" id="5577e98fc4e7fbea6e9a346c" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577e98fc4e7fbea6e9a346c" style="color:#0088cc;text-decoration:none;font-size:11px;">15楼•2 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/alsotang" target="_blank" style="color:#0088cc;text-decoration:none;">@alsotang</a> 粒度是小时的方法可以类比为我在序中的 Cron 大法。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">而你说的把粒度调到秒的时候，就是我文章中的第二节的方法，本来是想用 C++ 来搞最小堆放在任务系统内部，这样还省了三方依赖的 IO 损耗。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">只不过最后一种方法才是我要介绍的。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5577f87cc4e7fbea6e9a348f" reply_to_id="" id="5577f87cc4e7fbea6e9a348f" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/coolicer" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://gravatar.com/avatar/06c787094a6d37ab8281d90b40a33a0e?size=48" title="coolicer" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/coolicer" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">coolicer</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5577f87cc4e7fbea6e9a348f" style="color:#0088cc;text-decoration:none;font-size:11px;">16楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-coolicer" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">好高级的样子</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="55781240e64058601b962783" reply_to_id="" id="55781240e64058601b962783" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/Joursion" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars3.githubusercontent.com/u/10599678?v=3&amp;s=120" title="Joursion" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/Joursion" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">Joursion</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#55781240e64058601b962783" style="color:#0088cc;text-decoration:none;font-size:11px;">17楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-Joursion" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">完全看不懂啊  什么时候才可以到达这样的高度。。
自豪地采用 <a href="https://github.com/lanceli/cnodejs-ionic" target="_blank" style="color:#0088cc;text-decoration:none;">CNodeJS ionic</a></p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5578f1efe3cc2f192486a963" reply_to_id="" id="5578f1efe3cc2f192486a963" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/42thcoder" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://gravatar.com/avatar/7ba062b59a726dd93c0774dce3e284ad?size=48" title="42thcoder" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/42thcoder" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">42thcoder</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5578f1efe3cc2f192486a963" style="color:#0088cc;text-decoration:none;font-size:11px;">18楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-42thcoder" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">最近也在做类似的东西, 批量定时任务 + 精确到秒, 不过我是拿 ruby 写得, 思路跟 <a href="https://cnodejs.org/user/alsotang" target="_blank" style="color:#0088cc;text-decoration:none;">@alsotang</a>  基本一致.</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">定时任务连 redis 都没放, 直接放 MySQL.</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">个人的想法是, 降低复杂度 + 可扩展性最重要, 性能够用就好. 过早优化是万恶之源, 对不?</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5578f2a0e3cc2f192486a966" reply_to_id="5578f1efe3cc2f192486a963" id="5578f2a0e3cc2f192486a966" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5578f2a0e3cc2f192486a966" style="color:#0088cc;text-decoration:none;font-size:11px;">19楼•2 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/42thcoder" target="_blank" style="color:#0088cc;text-decoration:none;">@42thcoder</a> 嗯，说的极是。我上面也是提供了三种解决方案，你做的跟我的第二种方法类似。我只是在循序渐进介绍可能的设计方案。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5578f795e3cc2f192486a96c" reply_to_id="5578f2a0e3cc2f192486a966" id="5578f795e3cc2f192486a96c" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/alsotang" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars2.githubusercontent.com/u/1147375?v=3&amp;s=120" title="alsotang" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/alsotang" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">alsotang</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5578f795e3cc2f192486a96c" style="color:#0088cc;text-decoration:none;font-size:11px;">20楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-alsotang" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/42thcoder" target="_blank" style="color:#0088cc;text-decoration:none;">@42thcoder</a>  <a href="https://cnodejs.org/user/xadillax" target="_blank" style="color:#0088cc;text-decoration:none;">@xadillax</a> 后来你们发送短信的实际需求是用的哪种方案。。？</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="5578fbdae3cc2f192486a974" reply_to_id="5578f795e3cc2f192486a96c" id="5578fbdae3cc2f192486a974" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#5578fbdae3cc2f192486a974" style="color:#0088cc;text-decoration:none;font-size:11px;">21楼•2 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/alsotang" target="_blank" style="color:#0088cc;text-decoration:none;">@alsotang</a> -。 - 短信只是其中一种需求啦，总之这是一个通用的类似的定时任务方案。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="55791127e3cc2f192486a9ab" reply_to_id="" id="55791127e3cc2f192486a9ab" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/chloe" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://gravatar.com/avatar/614b75c56af589905818f93216f6df56?s=48" title="chloe" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/chloe" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">chloe</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#55791127e3cc2f192486a9ab" style="color:#0088cc;text-decoration:none;font-size:11px;">22楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-chloe" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">其实rabbitmq也不麻烦，应该还要容易一些</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="557a971d16839d2d5393619a" reply_to_id="" id="557a971d16839d2d5393619a" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/shanelau" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars.githubusercontent.com/u/3140898?v=3&amp;s=120" title="shanelau" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/shanelau" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">shanelau</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#557a971d16839d2d5393619a" style="color:#0088cc;text-decoration:none;font-size:11px;">23楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-shanelau" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">一个简单的事情，被你说得好复杂。 主要是使用到了 这个功能吧  <a href="http://redisdoc.com/topic/notification.html" target="_blank" style="color:#0088cc;text-decoration:none;">http://redisdoc.com/topic/notification.html</a></p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">我的理解就是，</p>
<ol style="padding:0px;margin:0px 0px 1em 25px;"><li style="line-height:2em;">任务来了， 2 写入redis</li>
<li style="line-height:2em;">加上键值过期监听</li>
<li style="line-height:2em;">监听到过期，任务处理</li>
</ol>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="557a9a8516839d2d539361a7" reply_to_id="" id="557a9a8516839d2d539361a7" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/fish" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://gravatar.com/avatar/d24fc5b1c6b84dae95dd23ba1c7ebbcb?size=48" title="fish" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/fish" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">fish</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#557a9a8516839d2d539361a7" style="color:#0088cc;text-decoration:none;font-size:11px;">24楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-fish" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">蒟蒻。。。。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="557a9bd416839d2d539361ab" reply_to_id="557a971d16839d2d5393619a" id="557a9bd416839d2d539361ab" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#557a9bd416839d2d539361ab" style="color:#0088cc;text-decoration:none;font-size:11px;">25楼•2 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/shanelau" target="_blank" style="color:#0088cc;text-decoration:none;">@shanelau</a> -。 - 总得凑字数不是。而且前面的两种方法也是可以借鉴的。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="557a9be716839d2d539361ad" reply_to_id="557a9a8516839d2d539361a7" id="557a9be716839d2d539361ad" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#557a9be716839d2d539361ad" style="color:#0088cc;text-decoration:none;font-size:11px;">26楼•2 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/fish" target="_blank" style="color:#0088cc;text-decoration:none;">@fish</a> 对，蒟蒻就是本菜。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="568f53533b33070b66270953" reply_to_id="" id="568f53533b33070b66270953" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/lanyanai" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars2.githubusercontent.com/u/4944849?v=3&amp;s=120" title="lanyanai" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/lanyanai" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">lanyanai</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#568f53533b33070b66270953" style="color:#0088cc;text-decoration:none;font-size:11px;">27楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-lanyanai" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">不错，准备在事件回调url返回非2XX，后续重试的时候用这个实现，应该靠谱吧</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56908d193b33070b66270989" reply_to_id="" id="56908d193b33070b66270989" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/Einsy" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars3.githubusercontent.com/u/2882139?v=3&amp;s=120" title="Einsy" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/Einsy" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">Einsy</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56908d193b33070b66270989" style="color:#0088cc;text-decoration:none;font-size:11px;">28楼•2 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-Einsy" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">mark</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56bc3c6e24b0c1ec628ff275" reply_to_id="" id="56bc3c6e24b0c1ec628ff275" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/haibinpark" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars.githubusercontent.com/u/2077143?v=3&amp;s=120" title="haibinpark" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/haibinpark" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">haibinpark</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56bc3c6e24b0c1ec628ff275" style="color:#0088cc;text-decoration:none;font-size:11px;">29楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-haibinpark" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">很棒的贴</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">来自酷炫的 <a href="https://github.com/TakWolf/CNode-Material-Design" target="_blank" style="color:#0088cc;text-decoration:none;">CNodeMD</a></p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56bcaecd26d02fc6626bb548" reply_to_id="" id="56bcaecd26d02fc6626bb548" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/hapiman" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars3.githubusercontent.com/u/7567048?v=3&amp;s=120" title="hapiman" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/hapiman" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">hapiman</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56bcaecd26d02fc6626bb548" style="color:#0088cc;text-decoration:none;font-size:11px;">30楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-hapiman" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">mark</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56bde1e271204e03637a38b7" reply_to_id="" id="56bde1e271204e03637a38b7" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xujun52011" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://gravatar.com/avatar/8a35b19d170062e3dbf2feed6e257f1d?size=48" title="xujun52011" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xujun52011" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xujun52011</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56bde1e271204e03637a38b7" style="color:#0088cc;text-decoration:none;font-size:11px;">31楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xujun52011" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">Redis本身的key过期通知不是准时的，受制于Redis本身的过期算法（具体的算法就不详述了）。</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56c076c426d02fc6626bb597" reply_to_id="" id="56c076c426d02fc6626bb597" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/lonso" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars.githubusercontent.com/u/5660818?v=3&amp;s=120" title="lonso" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/lonso" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">lonso</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56c076c426d02fc6626bb597" style="color:#0088cc;text-decoration:none;font-size:11px;">32楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-lonso" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">mark</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56c11c7426d02fc6626bb5a4" reply_to_id="" id="56c11c7426d02fc6626bb5a4" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/chloe" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://gravatar.com/avatar/614b75c56af589905818f93216f6df56?s=48" title="chloe" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/chloe" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">chloe</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56c11c7426d02fc6626bb5a4" style="color:#0088cc;text-decoration:none;font-size:11px;">33楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-chloe" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="http://www.rabbitmq.com/dlx.html" target="_blank" style="color:#0088cc;text-decoration:none;">http://www.rabbitmq.com/dlx.html</a></p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56c15e0a26d02fc6626bb5ca" reply_to_id="" id="56c15e0a26d02fc6626bb5ca" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/think2011" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars2.githubusercontent.com/u/3961388?v=3&amp;s=120" title="think2011" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/think2011" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">think2011</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56c15e0a26d02fc6626bb5ca" style="color:#0088cc;text-decoration:none;font-size:11px;">34楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-think2011" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">死月大神又写了一篇我看不懂的文章，收藏先！🙊</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56c184f624b0c1ec628ff2e0" reply_to_id="" id="56c184f624b0c1ec628ff2e0" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56c184f624b0c1ec628ff2e0" style="color:#0088cc;text-decoration:none;font-size:11px;">35楼•1 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/think2011" target="_blank" style="color:#0088cc;text-decoration:none;">@think2011</a> 这坟挖的 -。 -</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56c18de971204e03637a3904" reply_to_id="" id="56c18de971204e03637a3904" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/holyselina" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars3.githubusercontent.com/u/6049595?v=3&amp;s=120" title="holyselina" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/holyselina" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">holyselina</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56c18de971204e03637a3904" style="color:#0088cc;text-decoration:none;font-size:11px;">36楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-holyselina" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">mark</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56c30e37db16d3343df34ab8" reply_to_id="" id="56c30e37db16d3343df34ab8" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/fangker" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars2.githubusercontent.com/u/16358646?v=3&amp;s=120" title="fangker" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/fangker" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">fangker</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56c30e37db16d3343df34ab8" style="color:#0088cc;text-decoration:none;font-size:11px;">37楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-fangker" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">mark</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56cbb76f66c88b5e490260b6" reply_to_id="" id="56cbb76f66c88b5e490260b6" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/imhered" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars5.githubusercontent.com/u/12947399?v=4&amp;s=120" title="imhered" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/imhered" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">imhered</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56cbb76f66c88b5e490260b6" style="color:#0088cc;text-decoration:none;font-size:11px;">38楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-imhered" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">mk</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56f743f53291db186f1a7c0c" reply_to_id="" id="56f743f53291db186f1a7c0c" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/jiangliqin" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars2.githubusercontent.com/u/12250847?v=3&amp;s=120" title="jiangliqin" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/jiangliqin" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">jiangliqin</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56f743f53291db186f1a7c0c" style="color:#0088cc;text-decoration:none;font-size:11px;">39楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-jiangliqin" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">把键值message存到键值名中，如果message这对象很大，岂不是很占用redis键值名空间吗？</p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56f74e429753c3386fd24f5d" reply_to_id="" id="56f74e429753c3386fd24f5d" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/fengmk2" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars3.githubusercontent.com/u/156269?v=3&amp;s=120" title="fengmk2" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/fengmk2" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">fengmk2</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56f74e429753c3386fd24f5d" style="color:#0088cc;text-decoration:none;font-size:11px;">40楼•1 年前</a></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-fengmk2" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">楼主现在还在用着这个方案么？万一redis挂了怎么办？
自豪地采用 <a href="https://github.com/lanceli/cnodejs-ionic" target="_blank" style="color:#0088cc;text-decoration:none;">CNodeJS ionic</a></p>
</div>
</div>
<div class="clearfix"><div class="reply2_area" style="margin-left:42px;"></div>
</div>
</div>
<div class="cell reply_area reply_item " reply_id="56f8a15532c4bdf531357295" reply_to_id="56f74e429753c3386fd24f5d" id="56f8a15532c4bdf531357295" style="overflow:hidden;position:relative;padding:10px;background-color:#ffffff;border-top-width:1px;border-top-style:solid;border-top-color:#f0f0f0;border-bottom-style:none;box-shadow:none;background-position:initial initial;background-repeat:initial initial;"><div class="author_content"><a href="https://cnodejs.org/user/xadillax" class="user_avatar" style="color:#0088cc;text-decoration:none;display:inline-block;float:left;"><img src="https://avatars0.githubusercontent.com/u/2842176?v=3&amp;s=120" title="xadillax" style="height:30px;vertical-align:middle;border:0px;width:30px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;" /></a><div class="user_info" style="margin-left:10px;display:inline-block;"><a class="dark reply_author" href="https://cnodejs.org/user/xadillax" style="color:#666666;text-decoration:none;font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;">xadillax</a>&nbsp;<a class="reply_time" href="https://cnodejs.org/topic/5577b493c4e7fbea6e9a33c9#56f8a15532c4bdf531357295" style="color:#0088cc;text-decoration:none;font-size:11px;">41楼•1 年前</a>&nbsp;<span class="reply_by_author" style="color:#ffffff;background-color:#6ba44e;padding:2px;font-size:12px;">作者</span></div>
<div class="user_action" style="float:right;margin-left:20px;font-size:15px;"></div>
</div>
<div class="reply_content from-xadillax" style="padding-left:50px;"><div class="markdown-text"><p style="margin-top:0px;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;"><a href="https://cnodejs.org/user/fengmk2" target="_blank" style="color:#0088cc;text-decoration:none;">@fengmk2</a> -。 - 那是前任公司的方案，现在不知道还用不用着。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">但是 redis 虽然是内存数据库，不过也有持久化（备份）吧？挂了之后重启的确是有可能丢失小部分数据，不过主要我之前的场景是允许丢失的。</p>
<p style="margin-top:1em;margin-bottom:1em;font-size:15px;word-break:break-word;white-space:pre-wrap;word-wrap:break-word;line-height:1.7em;overflow:auto;">其实我本来是想自己做一个定时 callback 的系统，专门接受外来的定时设置，做好持久化和备份等等，然后时间到就通知这些外部系统——只不过小公司你懂的（其实大公司应该也差不多吧），不会有这么多资源、时间和精力提供给你。</p>
</div>
</div>
</div>
</div></body></html>