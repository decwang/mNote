<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2016-12-03T05:50:26Z"/><meta name="updated" content="2016-12-03T05:50:30Z"/><title> iOS中https的证书验证    标签： https证书验证  2016-03-21 15:08 615人阅读 评论(0) 收藏 举报     分类：  iOS 功能（154）     文／大风</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div class="article_title" style="margin:5px 0px;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;font-size:20px;line-height:30px;font-family:'Microsoft YaHei';orphans:2;widows:2;">&nbsp;<h1 style="margin:0px;padding:0px;display:inline;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;font-weight:normal;font-size:20px;line-height:30px;vertical-align:middle;"><span class="link_title"><a href="http://blog.csdn.net/u012198553/article/details/50946685" style="color:#000000;text-decoration:none;">iOS中https的证书验证</a></span></h1>
</div>
<div class="article_manage clearfix" style="padding:0px 20px 5px;color:#999999;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;font-size:12px;line-height:22px;font-family:Arial;text-align:right;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#ededed;margin:0px -20px;overflow:hidden;orphans:2;widows:2;"><div class="article_l" style="width:708px;float:left;"><span class="link_categories" style="margin:0px 5px;float:left;">标签：&nbsp;<a href="http://www.csdn.net/tag/https" target="_blank" style="color:#336699;text-decoration:none;display:inline-block;margin-right:10px;">https</a><a href="http://www.csdn.net/tag/%e8%af%81%e4%b9%a6%e9%aa%8c%e8%af%81" target="_blank" style="color:#336699;text-decoration:none;display:inline-block;margin-right:10px;">证书验证</a></span></div>
<div class="article_r"><span class="link_postdate" style="margin:0px 5px 0px 0px;">2016-03-21 15:08</span>&nbsp;<span class="link_view" title="阅读次数" style="margin:0px 5px;padding:0px 0px 0px 14px;background:url(&quot;../../../images/ico_view.png&quot;) left center no-repeat;">615人阅读</span>&nbsp;<span class="link_comments" title="评论次数" style="margin:0px 5px;padding:0px 0px 0px 14px;background:url(&quot;../../../images/ico_comm.png&quot;) left center no-repeat;"><a href="http://blog.csdn.net/u012198553/article/details/50946685#comments" style="color:#336699;text-decoration:none;">评论</a>(0)</span>&nbsp;<span class="link_collect tracking-ad" data-mod="popu_171" style="margin:0px 5px;"><a title="收藏" target="_blank" style="color:#336699;">收藏</a></span>&nbsp;<span class="link_report" style="margin:0px 5px;"><a href="http://blog.csdn.net/u012198553/article/details/50946685#report" title="举报" style="color:#336699;text-decoration:none;">举报</a></span></div>
</div>
<div class="category clearfix" style="margin:0px -20px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#ededed;padding:5px 20px;color:#333333;font-family:Arial, Console, Verdana, 'Courier New';font-size:12px;font-variant-ligatures:normal;orphans:2;widows:2;"><div class="category_l" style="display:inline-block;font-size:14px;width:70px;float:left;line-height:28px;"><img src="http://static.blog.csdn.net/images/category_icon.jpg" style="border:none;vertical-align:middle;" />&nbsp;<span style="display:inline-block;vertical-align:middle;">分类：</span></div>
<div class="category_r" style="display:inline-block;font-size:14px;color:#df3434;float:left;width:637.188px;"><label style="display:inline-block;margin-left:15px;cursor:pointer;line-height:28px;position:relative;">iOS 功能（154）&nbsp;<img class="arrow-down" src="http://static.blog.csdn.net/images/arrow_triangle%20_down.jpg" style="border:none;display:inline;" /></label></div>
</div>
<div id="article_content" class="article_content" style="margin:20px 0px 0px;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;line-height:26px;font-family:Arial;color:#333333;orphans:2;widows:2;">文／大风歌飞鼎折覆餗（简书作者）<br />
原文链接：http://www.jianshu.com/p/f10f6df67d66<br />
著作权归作者所有，转载请联系作者获得授权，并标注“简书作者”。<br />
<br />
<blockquote><p>公司的服务器被人DDOS攻击了,后台改用自签证的证书,全部请求改用HTTPS. iOS的网络请求也需要全部改. 坑爹的是项目中有两套请求方案. 1,使用原始苹果自带的NSURLConnection 2, 是我接手以后改用的afnetworking. 要全部改的话一下子没那么多时间改的过来. 就只好两个方案都实现下HTTPS</p>
</blockquote>
<ul><li>afnetworking 使用字签证证书访问HTTPS<ul><li>把服务器给你的自签证的证书放入bundle一般是.cer文件</li>
<li>创建afnnetworking 安全策略对象,并设置发起请求manager的安全策略属性.设置了安全策略属性,afnnetworking会自动扫描bundl里的证书.</li>
<li>最坑的是 iOS9新出的App Transport Security 也就是要我们把所有请求从 HTTP改成HTTPS的家伙, 它竟然不认自签证的证书. 苹果大爷难道真是土豪惯了,以为我们开发者都会买ca的证书吗. 解决办法就是那里还是要设置在Info.plist中添加NSAppTransportSecurity类型Dictionary在NSAppTransportSecurity下添加NSAllowsArbitraryLoads类型 Boolean,值设为YES</li>
</ul>
</li>
</ul>
<pre class="hljs objectivec" name="code" style="white-space:pre-wrap;word-wrap:break-word;padding:0.5em;color:#000000;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec">   <span class="hljs-comment" style="color:#880000;">//创建安全策略对象</span>     AFSecurityPolicy * security = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeCertificate]; <span class="hljs-comment" style="color:#880000;">//设置证书</span>     security<span class="hljs-variable" style="color:#660066;">.allowInvalidCertificates</span> = <span class="hljs-literal" style="color:#006666;">YES</span>;  <span class="hljs-comment" style="color:#880000;">// 由于是自签证证书 afnnetworking 会认为是无效的 设置为允许</span>     security<span class="hljs-variable" style="color:#660066;">.validatesDomainName</span> = <span class="hljs-literal" style="color:#006666;">NO</span>; <span class="hljs-comment" style="color:#880000;">//验证证书绑定的域</span>     [[AFHTTPRequestOperationManager manager]setSecurityPolicy:security]; <span class="hljs-comment" style="color:#880000;">//</span>     <span class="hljs-comment" style="color:#880000;">//普通一样发起请求就可以</span>     [[AFHTTPRequestOperationManager manager] POST:<span class="hljs-string" style="color:#008800;">@"/test"</span> parameters:<span class="hljs-literal" style="color:#006666;">nil</span> success:^(AFHTTPRequestOperation *operation, <span class="hljs-keyword" style="color:#000088;">id</span> responseObject) {

    } failure:^(AFHTTPRequestOperation *operation, <span class="hljs-built_in" style="color:#660066;">NSError</span> *error) {

    }];</code></pre><ul><li>NSURLConnection 使用自签证证书支持HTTPS,只需要在实现NSURLConnection的代理方法即可. 这个解决方法转自<a target="_blank" href="https://gist.github.com/JacksonTian/5855751" style="color:#336699;text-decoration:none;">GitHub JacksonTian</a>&nbsp;他原文中有多了行释放代码 CFRelease(trust); ,多了这行代码在短时间重复请求,一个URL的时候trust 会提前释放导致crash,没有细究原因,直接注释掉了.</li>
</ul>
<pre class="hljs objectivec" name="code" style="white-space:pre-wrap;word-wrap:break-word;padding:0.5em;color:#000000;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec"><span class="hljs-preprocessor" style="color:#444444;">#pragma Support NSURLCONNECTION HTTPS</span> - (<span class="hljs-built_in" style="color:#660066;">BOOL</span>)connection:(<span class="hljs-built_in" style="color:#660066;">NSURLConnection</span> *)connection canAuthenticateAgainstProtectionSpace:(<span class="hljs-built_in" style="color:#660066;">NSURLProtectionSpace</span> *)protectionSpace{

    <span class="hljs-keyword" style="color:#000088;">return</span> [protectionSpace<span class="hljs-variable" style="color:#660066;">.authenticationMethod</span> isEqualToString:<span class="hljs-built_in" style="color:#660066;">NSURLAuthenticationMethodServerTrust</span>];
}

- (<span class="hljs-keyword" style="color:#000088;">void</span>)connection:(<span class="hljs-built_in" style="color:#660066;">NSURLConnection</span> *)connection didReceiveAuthenticationChallenge:(<span class="hljs-built_in" style="color:#660066;">NSURLAuthenticationChallenge</span> *)challenge
{
    <span class="hljs-keyword" style="color:#000088;">static</span> <span class="hljs-built_in" style="color:#660066;">CFArrayRef</span> certs;
    <span class="hljs-keyword" style="color:#000088;">if</span> (!certs) {
        <span class="hljs-comment" style="color:#880000;">//创建证书data</span>         <span class="hljs-built_in" style="color:#660066;">NSData</span>*certData =[<span class="hljs-built_in" style="color:#660066;">NSData</span> dataWithContentsOfFile:[[<span class="hljs-built_in" style="color:#660066;">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string" style="color:#008800;">@"HTTPS"</span> ofType:<span class="hljs-string" style="color:#008800;">@"cer"</span>]];

        SecCertificateRef rootcert = SecCertificateCreateWithData(k<span class="hljs-built_in" style="color:#660066;">CFAllocatorDefault</span>,<span class="hljs-built_in" style="color:#660066;">CFBridgingRetain</span>(certData));
        <span class="hljs-keyword" style="color:#000088;">const</span> <span class="hljs-keyword" style="color:#000088;">void</span> *array[<span class="hljs-number" style="color:#006666;">1</span>] = { rootcert };
        certs = <span class="hljs-built_in" style="color:#660066;">CFArrayCreate</span>(<span class="hljs-literal" style="color:#006666;">NULL</span>, array, <span class="hljs-number" style="color:#006666;">1</span>, &amp;k<span class="hljs-built_in" style="color:#660066;">CFTypeArrayCallBacks</span>);<span class="hljs-comment" style="color:#880000;">//        CFRelease(rootcert);    // for completeness, really does not matter</span>     }

    SecTrustRef trust = [[challenge protectionSpace] serverTrust];
    <span class="hljs-keyword" style="color:#000088;">int</span> err;
    SecTrustResultType trustResult = <span class="hljs-number" style="color:#006666;">0</span>;
    err = SecTrustSetAnchorCertificates(trust, certs);
    <span class="hljs-keyword" style="color:#000088;">if</span> (err == noErr) {
        err = SecTrustEvaluate(trust,&amp;trustResult);
    }<span class="hljs-comment" style="color:#880000;">//    BOOL trusted = (err == noErr) &amp;&amp; ((trustResult == kSecTrustResultProceed)||(trustResult == kSecTrustResultConfirm) || (trustResult == kSecTrustResultUnspecified));</span>     <span class="hljs-built_in" style="color:#660066;">BOOL</span> trusted = (err == noErr) &amp;&amp; ((trustResult == kSecTrustResultProceed) || (trustResult == kSecTrustResultUnspecified));

    <span class="hljs-keyword" style="color:#000088;">if</span> (trusted) {

        [challenge<span class="hljs-variable" style="color:#660066;">.sender</span> useCredential:[<span class="hljs-built_in" style="color:#660066;">NSURLCredential</span> credentialForTrust:challenge<span class="hljs-variable" style="color:#660066;">.protectionSpace</span><span class="hljs-variable" style="color:#660066;">.serverTrust</span>] forAuthenticationChallenge:challenge];
    }
    <span class="hljs-keyword" style="color:#000088;">else</span>{

        [challenge<span class="hljs-variable" style="color:#660066;">.sender</span> cancelAuthenticationChallenge:challenge];
    }<span class="hljs-comment" style="color:#880000;">//    CFRelease(trust);</span> }</code></pre><p><strong><em>**</em></strong>后面通过测试<strong>,&nbsp;</strong>不实现上面的委托<strong>, NSURLConnection&nbsp;</strong>也可以直接连接<strong>HTTPS</strong>服务器<strong>,&nbsp;</strong>这种是绕过了证书的<strong>. afnetworking&nbsp;</strong>不设置安全策略就无法访问<strong>HTTPS</strong>服务器<strong>.</strong>注<strong>:afnnetworking</strong>版本使用的是<strong>2.5.4 ,</strong>之前的版本关于安全策略的<strong>API</strong>有<strong>bug&nbsp;</strong>在<strong>afn</strong>的<strong>issue</strong>中看到<strong><em>**</em></strong></p>
</div></body></html>