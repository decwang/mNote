<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2016-11-16T09:45:03Z"/><meta name="updated" content="2016-11-16T09:45:06Z"/><title>谈谈UIView的几个layout方法-layoutSubviews、layoutIfNeeded、setNeedsLayout...  字数1201 阅读18278 评论35 喜欢148  最近在</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><h1 class="title" style="margin:10px 0px;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.5;color:#555555;text-rendering:optimizelegibility;font-size:32px;word-break:break-all;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;widows:1;">谈谈UIView的几个layout方法-layoutSubviews、layoutIfNeeded、setNeedsLayout...</h1>
<div class="meta-top" style="font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;margin:20px 0px;color:#555555;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;line-height:20px;widows:1;"><span class="wordage" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">字数1201</span>&nbsp;<span class="views-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">阅读18278</span>&nbsp;<span class="comments-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">评论35</span>&nbsp;<span class="likes-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">喜欢148</span></div>
<div class="show-content" style="color:#2f2f2f;font-size:16px;line-height:1.7;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;widows:1;"><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">最近在学习swift做动画，用到constraint的动画，用到layoutIfNeeded就去研究了下UIView的这几个布局的方法。</p>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;">下面是做得一个动画，下载地址：https:<span class="hljs-comment" style="color:#93a1a1;">//github.com/smalldu/IOS-Animations  </span> 中的AnimationDemo3</code></pre><div class="image-package imagebubble" widget="ImageBubble" style="margin:0px auto 20px;text-align:center;"><img src="http://upload-images.jianshu.io/upload_images/954071-0250322e5e3b5f0b.gif?imageMogr2/auto-orient/strip" data-original-src="http://upload-images.jianshu.io/upload_images/954071-0250322e5e3b5f0b.gif?imageMogr2/auto-orient/strip" class="imagebubble-image" style="height:auto;vertical-align:middle;border:0px;cursor:-webkit-zoom-in;transition:all 0.25s ease-in-out;-webkit-transition:all 0.25s ease-in-out;" /><br />
<div class="image-caption" style="min-width:20%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#d9d9d9;font-size:13px;color:#999999;font-style:italic;line-height:1.7;">动画</div>
</div>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">下面列举下iOS layout的相关方法:</p>
<ul style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;">layoutSubviews</li>
<li style="line-height:30px;">layoutIfNeeded</li>
<li style="line-height:30px;">setNeedsLayout</li>
<li style="line-height:30px;">setNeedsDisplay</li>
<li style="line-height:30px;">drawRect</li>
<li style="line-height:30px;">sizeThatFits</li>
<li style="line-height:30px;">sizeToFit</li>
</ul>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">大概常用的上面几个 ， 具体的应该还有别的。</p>
<h4 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:20px;">layoutSubviews</h4>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">这个方法，默认没有做任何事情，需要子类进行重写 。 系统在很多时候会去调用这个方法：</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">1.初始化不会触发layoutSubviews，但是如果设置了不为CGRectZero的frame的时候就会触发。<br />
2.addSubview会触发layoutSubviews<br />
3.设置view的Frame会触发layoutSubviews，当然前提是frame的值设置前后发生了变化<br />
4.滚动一个UIScrollView会触发layoutSubviews<br />
5.旋转Screen会触发父UIView上的layoutSubviews事件<br />
6.改变一个UIView大小的时候也会触发父UIView上的layoutSubviews事件</p>
<blockquote style="padding:10px 15px;margin:0px 0px 20px;border-left-width:4px;border-left-style:solid;border-left-color:#999999;word-break:break-word;font-size:15px;line-height:30px;background-color:#f5f5f5;"><p style="margin-top:0px;margin-bottom:0px;line-height:1.7;text-align:justify;word-break:break-word;">在苹果的官方文档中强调: You should override this method only if the autoresizing behaviors of the subviews do not offer the behavior you want.layoutSubviews, 当我们在某个类的内部调整子视图位置时，需要调用。反过来的意思就是说：如果你想要在外部设置subviews的位置，就不要重写。</p>
</blockquote>
<h4 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:20px;">setNeedsLayout</h4>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">标记为需要重新布局，不立即刷新，但layoutSubviews一定会被调用<br />
配合layoutIfNeeded立即更新</p>
<h4 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:20px;">layoutIfNeeded</h4>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">如果，有需要刷新的标记，立即调用layoutSubviews进行布局</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">这个动画中有用到 举个栗子🌰 。</p>
<div class="image-package imagebubble" widget="ImageBubble" style="margin:0px auto 20px;text-align:center;"><img src="http://upload-images.jianshu.io/upload_images/954071-43b26489414f3d01.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/954071-43b26489414f3d01.png?imageMogr2/auto-orient/strip%7CimageView2/2" class="imagebubble-image" style="height:auto;vertical-align:middle;border:0px;cursor:-webkit-zoom-in;transition:all 0.25s ease-in-out;-webkit-transition:all 0.25s ease-in-out;" /><br />
</div>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;"><br />
如图 ， 上面有个label ，中间有个按钮 ， label已经被自动布局到左上角 。 然后我们那个left的constraint</p>
<pre class="hljs swift" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="swift" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;">  <span class="hljs-preprocessor" style="color:#cb4b16;">@IBOutlet</span> <span class="hljs-keyword" style="color:#859900;">weak</span> <span class="hljs-keyword" style="color:#859900;">var</span> leftContrain:<span class="hljs-type" style="color:#b58900;">NSLayoutConstraint</span>!</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">在viewDidLoad中声明好，然后在Main.storyboard中进行连线。点击按钮的时候 ，我们把左边的距离改成100 。</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">在按钮的点击事件里加上这句。</p>
<pre class="hljs cpp" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="cpp" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;">leftContrain.constant = <span class="hljs-number" style="color:#2aa198;">100</span></code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">然后我们想要一个动画的效果。<br />
如果这么做</p>
<pre class="hljs cpp" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="cpp" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;">   UIView.animateWithDuration(<span class="hljs-number" style="color:#2aa198;">0.8</span>, delay: <span class="hljs-number" style="color:#2aa198;">0</span>, usingSpringWithDamping: <span class="hljs-number" style="color:#2aa198;">0.5</span>, initialSpringVelocity: <span class="hljs-number" style="color:#2aa198;">0.5</span>, options: UIViewAnimationOptions.AllowAnimatedContent, animations: {
                self.leftContrain.constant = <span class="hljs-number" style="color:#2aa198;">100</span>             }, completion: nil)</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">你会发现然并卵 。其实这句话<code style="padding:2px 4px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:#657b83;border-radius:3px;border:none;white-space:pre-wrap;background-color:#fdf6e3;">self.leftContrain.constant = 100</code>只是执行了<code style="padding:2px 4px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:#657b83;border-radius:3px;border:none;white-space:pre-wrap;background-color:#fdf6e3;">setNeedsLayout</code>&nbsp;标记了需要重新布局，但是没有立即执行。所以我们需要在动画中调用这个方法<code style="padding:2px 4px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:#657b83;border-radius:3px;border:none;white-space:pre-wrap;background-color:#fdf6e3;">layoutIfNeeded</code><br />
所以代码应该这么写</p>
<pre class="hljs cpp" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="cpp" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;">leftContrain.constant = <span class="hljs-number" style="color:#2aa198;">100</span>         UIView.animateWithDuration(<span class="hljs-number" style="color:#2aa198;">0.8</span>, delay: <span class="hljs-number" style="color:#2aa198;">0</span>, usingSpringWithDamping: <span class="hljs-number" style="color:#2aa198;">0.5</span>, initialSpringVelocity: <span class="hljs-number" style="color:#2aa198;">0.5</span>, options: UIViewAnimationOptions.AllowAnimatedContent, animations: {
                self.view.layoutIfNeeded() <span class="hljs-comment" style="color:#93a1a1;">//立即实现布局</span>             }, completion: nil)</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">所以上面不管写多少约束的改变，只需要在动画里动用 一次<code style="padding:2px 4px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:#657b83;border-radius:3px;border:none;white-space:pre-wrap;background-color:#fdf6e3;">self.view.layoutIfNeeded()</code>,所有的都会已动画的方式 。如果一些变化不想动画 。在动画前执行<code style="padding:2px 4px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:#657b83;border-radius:3px;border:none;white-space:pre-wrap;background-color:#fdf6e3;">self.view.layoutIfNeeded()</code></p>
<h3 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:22px;">drawRect</h3>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">这个方法是用来重绘的。</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">drawRect在以下情况下会被调用：<br />
1、如果在UIView初始化时没有设置rect大小，将直接导致drawRect不被自动调用。drawRect调用是在Controller-&gt;loadView, Controller-&gt;viewDidLoad 两方法之后掉用的.所以不用担心在控制器中,这些View的drawRect就开始画了.这样可以在控制器中设置一些值给View(如果这些View draw的时候需要用到某些变量值).<br />
2、该方法在调用sizeToFit后被调用，所以可以先调用sizeToFit计算出size。然后系统自动调用drawRect:方法。3、通过设置contentMode属性值为UIViewContentModeRedraw。那么将在每次设置或更改frame的时候自动调用drawRect:。4、直接调用setNeedsDisplay，或者setNeedsDisplayInRect:触发drawRect:，但是有个前提条件是rect不能为0。以上1,2推荐；而3,4不提倡</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">drawRect方法使用注意点：<br />
1、若使用UIView绘图，只能在drawRect：方法中获取相应的contextRef并绘图。如果在其他方法中获取将获取到一个invalidate的ref并且不能用于画图。drawRect：方法不能手动显示调用，必须通过调用setNeedsDisplay 或者 setNeedsDisplayInRect，让系统自动调该方法。2、若使用calayer绘图，只能在drawInContext: 中（类似于drawRect）绘制，或者在delegate中的相应方法绘制。同样也是调用setNeedDisplay等间接调用以上方法3、若要实时画图，不能使用gestureRecognizer，只能使用touchbegan等方法来掉用setNeedsDisplay实时刷新屏幕</p>
<h3 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:22px;">sizeToFit</h3>
<ul style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;">sizeToFit会自动调用sizeThatFits方法；</li>
<li style="line-height:30px;">sizeToFit不应该在子类中被重写，应该重写sizeThatFits</li>
<li style="line-height:30px;">sizeThatFits传入的参数是receiver当前的size，返回一个适合的size</li>
<li style="line-height:30px;">sizeToFit可以被手动直接调用sizeToFit和sizeThatFits方法都没有递归，对subviews也不负责，只负责自己</li>
</ul>
</div></body></html>