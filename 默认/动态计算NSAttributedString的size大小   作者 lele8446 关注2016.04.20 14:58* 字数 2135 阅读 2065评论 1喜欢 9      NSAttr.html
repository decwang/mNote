<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-03-14T09:23:54Z"/><meta name="updated" content="2017-03-14T09:23:57Z"/><title>动态计算NSAttributedString的size大小   作者 lele8446 关注2016.04.20 14:58* 字数 2135 阅读 2065评论 1喜欢 9      NSAttr</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><h1 class="title" style="box-sizing:border-box;font-size:34px;margin:20px 0px 0px;font-family:-apple-system, 'SF UI Display', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.3;color:#333333;word-break:break-word;font-variant-ligatures:normal;orphans:2;widows:2;">动态计算NSAttributedString的size大小</h1>
<div class="author" style="box-sizing:border-box;margin:30px 0px 40px;color:#333333;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:17px;font-variant-ligatures:normal;orphans:2;widows:2;"><a class="avatar" href="http://www.jianshu.com/u/a97f1b616991" style="box-sizing:border-box;background-color:transparent;color:#333333;text-decoration:none;cursor:pointer;width:48px;height:48px;display:inline-block;vertical-align:middle;"><img src="http://upload.jianshu.io/users/upload_avatars/1429982/27a6d5e7b24a.jpg?imageMogr2/auto-orient/strip|imageView2/1/w/144/h/144" alt="144" style="box-sizing:border-box;border:1px solid #dddddd;vertical-align:middle;width:48px;height:48px;border-radius:50%;" /></a>&nbsp;<div class="info" style="box-sizing:border-box;vertical-align:middle;display:inline-block;margin-left:8px;"><span class="tag" style="box-sizing:border-box;padding:1px 2px;font-size:12px;color:#ea6f5a;border:1px solid #ea6f5a;border-radius:3px;">作者</span>&nbsp;<span class="name" style="box-sizing:border-box;margin-left:3px;margin-right:3px;font-size:16px;vertical-align:middle;"><a href="http://www.jianshu.com/u/a97f1b616991" style="box-sizing:border-box;background-color:transparent;color:#333333;text-decoration:none;cursor:pointer;">lele8446</a></span>&nbsp;<a class="btn btn-success follow" style="box-sizing:border-box;background-color:#42c02e;color:#ffffff;cursor:pointer;display:inline-block;margin-bottom:0px;text-align:center;vertical-align:middle;background-image:none;border:1px solid #42c02e;white-space:nowrap;padding:0px 7px 0px 5px;font-size:12px;line-height:normal;border-top-left-radius:40px;border-top-right-radius:40px;border-bottom-right-radius:40px;border-bottom-left-radius:40px;"><span style="box-sizing:border-box;margin-left:2px;">关注</span></a><div class="meta" style="box-sizing:border-box;margin-top:5px;font-size:12px;color:#969696;"><span class="publish-time" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="最后编辑于 2016.04.20 15:05" style="box-sizing:border-box;padding-right:5px;">2016.04.20 14:58*</span>&nbsp;<span class="wordage" style="box-sizing:border-box;padding-right:5px;">字数 2135</span>&nbsp;<span class="views-count" style="box-sizing:border-box;padding-right:5px;">阅读 2065</span><span class="comments-count" style="box-sizing:border-box;padding-right:5px;">评论 1</span><span class="likes-count" style="box-sizing:border-box;padding-right:5px;">喜欢 9</span></div>
</div>
</div>
<div class="show-content" style="box-sizing:border-box;color:#2f2f2f;word-break:break-word;font-size:16px;line-height:1.7;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;">NSAttributedString（富文本），作为NSString的子类，是一种带有属性的字符串，通过它可以轻松的在一个字符串中表现出多种字体、字号、背景色、下划线等各不相同的风格，还可以对段落进行格式化。下面就来探讨一下动态计算NSAttributedString的size大小实现：</p>
<hr style="box-sizing:content-box;height:0px;margin:0px 0px 20px;border-right-width:0px;border-bottom-width:0px;border-left-width:0px;border-top-style:solid;border-top-color:#dddddd;" />
<ul style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;padding:0px;word-break:break-word;margin-left:22px;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">首先提供一个对NSAttributedString进行封装的函数<br style="box-sizing:border-box;" />
该方法会为NSAttributedString添加默认段落属性以及字体属性(如果不存在的话)<pre class="hljs objectivec" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">/**
 *  return 返回封装后的NSMutableAttributedString,添加了默认NSParagraphStyleAttributeName与NSFontAttributeName属性
 *
 *  @param labelStr  NSString
 *  @param labelDic  属性字典
    @{
       NSFontAttributeName://(字体)
       NSBackgroundColorAttributeName://(字体背景色)
       NSForegroundColorAttributeName://(字体颜色)
       NSParagraphStyleAttributeName://(段落)
       NSLigatureAttributeName://(连字符)
       NSKernAttributeName://(字间距)
       NSStrikethroughStyleAttributeName://NSUnderlinePatternSolid(实线) | NSUnderlineStyleSingle(删除线)
       NSUnderlineStyleAttributeName://(下划线)
       NSStrokeColorAttributeName://(边线颜色)
       NSStrokeWidthAttributeName://(边线宽度)
       NSShadowAttributeName://(阴影)
       NSVerticalGlyphFormAttributeName://(横竖排版)
     }
  *
  *  @return NSMutableAttributedString
  */</span> + (<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMutableAttributedString</span> *)getNSAttributedString:(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSString</span> *)labelStr labelDict:(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSDictionary</span> *)labelDic
{
   <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMutableAttributedString</span> *atrString = [[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMutableAttributedString</span> alloc] initWithString:labelStr];
   <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSRange</span> range = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMakeRange</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, atrString.length);
   <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (labelDic &amp;&amp; labelDic.count &gt; <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>) {
       <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSEnumerator</span> *enumerator = [labelDic keyEnumerator];
       <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">id</span> key;
       <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">while</span> ((key = [enumerator nextObject])) {
           [atrString addAttribute:key value:labelDic[key] range:range];
       }
   }
   <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//段落属性</span>    <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMutableParagraphStyle</span> *paragraphStyle = labelDic[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSParagraphStyleAttributeName</span>];
   <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (!paragraphStyle || <span class="hljs-literal" style="box-sizing:border-box;">nil</span> == paragraphStyle) {
       paragraphStyle = [[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSParagraphStyle</span> defaultParagraphStyle] mutableCopy];
       paragraphStyle.lineSpacing = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0.0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//增加行高</span>        paragraphStyle.headIndent = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//头部缩进，相当于左padding</span>        paragraphStyle.tailIndent = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//相当于右padding</span>        paragraphStyle.lineHeightMultiple = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//行间距是多少倍</span>        paragraphStyle.alignment = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSTextAlignmentLeft</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//对齐方式</span>        paragraphStyle.firstLineHeadIndent = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//首行头缩进</span>        paragraphStyle.paragraphSpacing = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//段落后面的间距</span>        paragraphStyle.paragraphSpacingBefore = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//段落之前的间距</span>        [atrString addAttribute:<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSParagraphStyleAttributeName</span> value:paragraphStyle range:range];
   }
   <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//字体</span>    <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">UIFont</span> *font = labelDic[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSFontAttributeName</span>];
   <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (!font || <span class="hljs-literal" style="box-sizing:border-box;">nil</span> == font) {
       font = [<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">UIFont</span> fontWithName:<span class="hljs-string" style="box-sizing:border-box;color:#2aa198;">@"HelveticaNeue"</span> size:<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">12.0</span>];
       [atrString addAttribute:<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSFontAttributeName</span> value:font range:range];
   }
   <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">return</span> atrString;
}</code></pre></li>
</ul>
<h5 style="box-sizing:border-box;font-family:inherit;line-height:1.7;margin:0px 0px 15px;font-size:18px;text-rendering:optimizelegibility;">使用boundingRectWithSize:options:attributes:context计算</h5>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;">系统提供了<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#657b83;background-color:#f6f6f6;border-radius:4px;padding:2px 4px;border:none;white-space:pre-wrap;">- boundingRectWithSize:options:attributes:context:</code>方法来计算NSAttributedString的size大小,<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#657b83;background-color:#f6f6f6;border-radius:4px;padding:2px 4px;border:none;white-space:pre-wrap;">- sizeWithFont:constrainedToSize:lineBreakMode:</code>已经被废弃了。<br style="box-sizing:border-box;" />
/**</p>
<pre class="hljs objectivec" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;">   *  <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">return</span> 动态返回字符串size大小
   *
   *  @param aString 字符串
   *  @param width   指定宽度
   *  @param height  指定宽度
   *
   *  @return <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSize</span>    */
  + (<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSize</span>)getStringRect:(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSAttributedString</span> *)aString width:(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span>)width height:(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span>)height
  {
     <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSize</span> size = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSizeZero</span>;
     <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMutableAttributedString</span> *atrString = [[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMutableAttributedString</span> alloc] initWithAttributedString:aString];
     <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSRange</span> range = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMakeRange</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, atrString.length);

     <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//获取指定位置上的属性信息，并返回与指定位置属性相同并且连续的字符串的范围信息。</span>      <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSDictionary</span>* dic = [atrString attributesAtIndex:<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span> effectiveRange:&amp;range];
     <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//不存在段落属性，则存入默认值</span>      <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMutableParagraphStyle</span> *paragraphStyle = dic[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSParagraphStyleAttributeName</span>];
     <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (!paragraphStyle || <span class="hljs-literal" style="box-sizing:border-box;">nil</span> == paragraphStyle) {
          paragraphStyle = [[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSParagraphStyle</span> defaultParagraphStyle] mutableCopy];
          paragraphStyle.lineSpacing = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0.0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//增加行高</span>           paragraphStyle.headIndent = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//头部缩进，相当于左padding</span>           paragraphStyle.tailIndent = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//相当于右padding</span>           paragraphStyle.lineHeightMultiple = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//行间距是多少倍</span>           paragraphStyle.alignment = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSTextAlignmentLeft</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//对齐方式</span>           paragraphStyle.firstLineHeadIndent = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//首行头缩进</span>           paragraphStyle.paragraphSpacing = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//段落后面的间距</span>           paragraphStyle.paragraphSpacingBefore = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//段落之前的间距</span>           [atrString addAttribute:<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSParagraphStyleAttributeName</span> value:paragraphStyle range:range];
      }

     <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//设置默认字体属性</span>      <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">UIFont</span> *font = dic[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSFontAttributeName</span>];
     <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (!font || <span class="hljs-literal" style="box-sizing:border-box;">nil</span> == font) {
          font = [<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">UIFont</span> fontWithName:<span class="hljs-string" style="box-sizing:border-box;color:#2aa198;">@"HelveticaNeue"</span> size:<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">12.0</span>];
          [atrString addAttribute:<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSFontAttributeName</span> value:font range:range];
      }

     <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMutableDictionary</span> *attDic = [<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSMutableDictionary</span> dictionaryWithDictionary:dic];
     [attDic setObject:font forKey:<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSFontAttributeName</span>];
     [attDic setObject:paragraphStyle forKey:<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSParagraphStyleAttributeName</span>];

     <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSize</span> strSize = [[aString string] boundingRectWithSize:<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSizeMake</span>(width, height)
                                                options:<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSStringDrawingUsesLineFragmentOrigin</span> | <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSStringDrawingUsesFontLeading</span>                                              attributes:attDic
                                                context:<span class="hljs-literal" style="box-sizing:border-box;">nil</span>].size;

     size = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSizeMake</span>(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat_ceil</span>(strSize.width), <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat_ceil</span>(strSize.height));
     <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">return</span> size;
  }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;">需要注意的是调用时，要选择NSStringDrawingUsesLineFragmentOrigin | NSStringDrawingUsesFontLeading选项，不然计算出来的高度不准确</p>
<h5 style="box-sizing:border-box;font-family:inherit;line-height:1.7;margin:0px 0px 15px;font-size:18px;text-rendering:optimizelegibility;">通过sizeToFit计算</h5>
<pre class="hljs arduino" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="arduino" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;">  <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">/**
   *  返回UILabel自适应后的size
   *
   *  @param aString 字符串
   *  @param width   指定宽度
   *  @param height  指定高度
   *
   *  @return CGSize
   */</span>   + (CGSize)sizeLabelToFit:(NSAttributedString *)aString <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">width</span>:(CGFloat)<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">width</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">height</span>:(CGFloat)<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">height</span> {
     UILabel *tempLabel = [[UILabel alloc]initWithFrame:CGRectMake(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">width</span>, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">height</span>)];
     tempLabel.attributedText = aString;
     tempLabel.numberOfLines = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;
     [tempLabel sizeToFit];
     CGSize <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">size</span> = tempLabel.frame.<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">size</span>;
     <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">size</span> = CGSizeMake(CGFloat_ceil(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">size</span>.<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">width</span>), CGFloat_ceil(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">size</span>.<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">height</span>));
     <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">return</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">size</span>;
  }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;">其实就是通过新建一个临时的UILabel，然后通过sizeToFit方法计算出合适的CGSize。</p>
<h5 style="box-sizing:border-box;font-family:inherit;line-height:1.7;margin:0px 0px 15px;font-size:18px;text-rendering:optimizelegibility;">通过CTFramesetter进行计算</h5>
<ul style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;padding:0px;word-break:break-word;margin-left:22px;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">CTFramesetter<br style="box-sizing:border-box;" />
首先来了解一下CTFramesetter与NSAttributedString的关系。CTFramesetter是CTFrame的创建工厂，NSAttributedString需要通过CTFrame绘制到界面上，得到CTFramesetter后，创建path（绘制路径），然后得到CTFrame，最后通过CTFrameDraw方法绘制到界面上。如图：<div class="image-package" style="box-sizing:border-box;padding-bottom:25px;width:auto !important;margin-left:0px !important;text-align:center;"><img src="https://o44fado6w.qnssl.com/1487070180024086.jpg" data-original-src="https://o44fado6w.qnssl.com/1487070180024086.jpg" style="box-sizing:border-box;border:0px;vertical-align:middle;height:auto;cursor:zoom-in;transition:all 0.25s ease-in-out;-webkit-transition:all 0.25s ease-in-out;" /><br style="box-sizing:border-box;" />
</div>
CTFramesetter关联NSAttributedString，此时CTTypesetter实例将自动创建，它管理了字体。然后使用CTFramesetter 创建您要用于渲染文本的一个或多个帧。当创建帧时，指定一个用于此帧矩形内的子文本范围。Core Text 为每行文本自动创建一个CTLine ，并在CTLine内创建多个 CTRun文本分段，每个CTRun内的文本有着同样的格式。同时每个 CTRun 对象可以采用不同的属性，所以你可以精确的控制字距，连字，宽度，高度等更多属性。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">字符（Character）和字形（Glyphs）<br style="box-sizing:border-box;" />
看一下字形图：<br style="box-sizing:border-box;" />
<div class="image-package" style="box-sizing:border-box;padding-bottom:25px;width:auto !important;margin-left:0px !important;text-align:center;"><img src="https://o44fado6w.qnssl.com/CoreText_3.jpg" data-original-src="https://o44fado6w.qnssl.com/CoreText_3.jpg" style="box-sizing:border-box;border:0px;vertical-align:middle;height:auto;cursor:zoom-in;transition:all 0.25s ease-in-out;-webkit-transition:all 0.25s ease-in-out;" /><br style="box-sizing:border-box;" />
</div>
<ol style="box-sizing:border-box;margin-top:15px;margin-bottom:20px;word-break:break-word;padding:0px;margin-left:22px;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">Bounding Box（边界框 bbox），这是一个假想的框子，它尽可能紧密的装入字形。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">Baseline（基线），一条假想的线,一行上的字形都以此线作为上下位置的参考，在这条线的左侧存在一个点叫做基线的原点。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">Ascent（上行高度）从原点到字体中最高（这里的高深都是以基线为参照线的）的字形的顶部的距离，Ascent是一个正值。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">Descent（下行高度）从原点到字体中最深的字形底部的距离，Descent是一个负值（比如一个字体原点到最深的字形的底部的距离为2，那么Descent就为-2）。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">Linegap（行距），Linegap也可以称作leading（其实准确点讲应该叫做External leading）,行高LineHeight则可以通过 Ascent + |Descent| + Linegap 来计算。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">Origin（每一行的原点），Origin是在图中的baseLine处的。</li>
</ol>
</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">计算行高<br style="box-sizing:border-box;" />
了解了以上知识点我们就来看一下通过CTFramesetter进行计算行高的实现<br style="box-sizing:border-box;" />
方法一，将每一行CTLine的行高相加得到最终高度：</p>
<pre class="hljs objectivec" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> heightValue = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//string 为要计算高的NSAttributedString</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterRef</span> framesetter = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterCreateWithAttributedString</span>((__bridge <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFAttributedStringRef</span>)string);<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//这里的高要设置足够大</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> height = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">10000</span>;<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGRect</span> drawingRect = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGRectMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, width, height);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGMutablePathRef</span> path = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPathCreateMutable</span>();<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPathAddRect</span>(path, <span class="hljs-literal" style="box-sizing:border-box;">NULL</span>, drawingRect);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFrameRef</span> textFrame = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterCreateFrame</span>(framesetter,<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRangeMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>,<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>), path, <span class="hljs-literal" style="box-sizing:border-box;">NULL</span>);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPathRelease</span>(path);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRelease</span>(framesetter);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayRef</span> lines = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFrameGetLines</span>(textFrame);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPoint</span> lineOrigins[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayGetCount</span>(lines)];<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFrameGetLineOrigins</span>(textFrame, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRangeMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>), lineOrigins);<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">/******************
 * 逐行lineHeight累加
 ******************/</span> heightValue = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">for</span> (<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">int</span> i = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>; i &lt; <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayGetCount</span>(lines); i++) {
   <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTLineRef</span> line = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayGetValueAtIndex</span>(lines, i);
   <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> lineAscent;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//上行行高</span>    <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> lineDescent;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//下行行高</span>    <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> lineLeading;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//行距</span>    <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> lineHeight;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//行高</span>    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//获取每行的高度</span>    <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTLineGetTypographicBounds</span>(line, &amp;lineAscent, &amp;lineDescent, &amp;lineLeading);
   lineHeight = lineAscent +  fabs(lineDescent) + lineLeading;
   heightValue = heightValue + lineHeight;
}
heightValue = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat_ceil</span>(heightValue);</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">方法二，最后一行原点y坐标加最后一行高度：</p>
<pre class="hljs objectivec" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> heightValue = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//string 为要计算高的NSAttributedString</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterRef</span> framesetter = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterCreateWithAttributedString</span>((__bridge <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFAttributedStringRef</span>)string);<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//这里的高要设置足够大</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> height = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">10000</span>;<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGRect</span> drawingRect = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGRectMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, width, height);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGMutablePathRef</span> path = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPathCreateMutable</span>();<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPathAddRect</span>(path, <span class="hljs-literal" style="box-sizing:border-box;">NULL</span>, drawingRect);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFrameRef</span> textFrame = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterCreateFrame</span>(framesetter,<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRangeMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>,<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>), path, <span class="hljs-literal" style="box-sizing:border-box;">NULL</span>);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPathRelease</span>(path);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRelease</span>(framesetter);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayRef</span> lines = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFrameGetLines</span>(textFrame);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPoint</span> lineOrigins[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayGetCount</span>(lines)];<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFrameGetLineOrigins</span>(textFrame, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRangeMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>), lineOrigins);<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">/******************
 * 最后一行原点y坐标加最后一行下行行高跟行距
 ******************/</span> heightValue = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> line_y = (<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span>)lineOrigins[<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayGetCount</span>(lines)<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">-1</span>].y;  <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//最后一行line的原点y坐标</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> lastAscent = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//上行行高</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> lastDescent = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//下行行高</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span> lastLeading = <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>;<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//行距</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTLineRef</span> lastLine = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayGetValueAtIndex</span>(lines, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayGetCount</span>(lines)<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">-1</span>);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTLineGetTypographicBounds</span>(lastLine, &amp;lastAscent, &amp;lastDescent, &amp;lastLeading);<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//height - line_y为除去最后一行的字符原点以下的高度，descent + leading为最后一行不包括上行行高的字符高度</span> heightValue = height - line_y + (<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat</span>)(fabs(lastDescent) + lastLeading);
heightValue = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat_ceil</span>(heightValue);</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">方法三，使用CTFramesetterSuggestFrameSizeWithConstraints计算：</p>
<pre class="hljs objectivec" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">static</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">inline</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSize</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterSuggestFrameSizeForAttributedStringWithConstraints</span>(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterRef</span> framesetter, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSAttributedString</span> *attributedString, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSize</span> size, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSUInteger</span> numberOfLines) {
   <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRange</span> rangeToSize = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRangeMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, (<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFIndex</span>)[attributedString length]);
   <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSize</span> constraints = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSizeMake</span>(size.width, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">10000</span>);

   <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (numberOfLines == <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">1</span>) {
       <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">// If there is one line, the size that fits is the full width of the line</span>        constraints = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSizeMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">10000</span>, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">10000</span>);
   } <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">else</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (numberOfLines &gt; <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>) {
       <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">// If the line count of the label more than 1, limit the range to size to the number of lines that have been set</span>        <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGMutablePathRef</span> path = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPathCreateMutable</span>();
       <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPathAddRect</span>(path, <span class="hljs-literal" style="box-sizing:border-box;">NULL</span>, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGRectMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0.0</span>f, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0.0</span>f, constraints.width, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">10000</span>));
       <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFrameRef</span> frame = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterCreateFrame</span>(framesetter, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRangeMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>), path, <span class="hljs-literal" style="box-sizing:border-box;">NULL</span>);
       <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayRef</span> lines = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFrameGetLines</span>(frame);

       <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayGetCount</span>(lines) &gt; <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>) {
           <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">NSInteger</span> lastVisibleLineIndex = MIN((<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFIndex</span>)numberOfLines, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayGetCount</span>(lines)) - <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">1</span>;
           <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTLineRef</span> lastVisibleLine = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFArrayGetValueAtIndex</span>(lines, lastVisibleLineIndex);

           <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRange</span> rangeToLayout = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTLineGetStringRange</span>(lastVisibleLine);
           rangeToSize = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRangeMake</span>(<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>, rangeToLayout.location + rangeToLayout.length);
        }

        <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFRelease</span>(frame);
        <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGPathRelease</span>(path);
   }

   <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSize</span> suggestedSize = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterSuggestFrameSizeWithConstraints</span>(framesetter, rangeToSize, <span class="hljs-literal" style="box-sizing:border-box;">NULL</span>, constraints, <span class="hljs-literal" style="box-sizing:border-box;">NULL</span>);
   <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">return</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSizeMake</span>(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat_ceil</span>(suggestedSize.width), <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGFloat_ceil</span>(suggestedSize.height));
}</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">调用方法：</p>
<pre class="hljs objectivec" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//string 为要计算高的NSAttributedString</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterRef</span> framesetter = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterCreateWithAttributedString</span>((__bridge <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CFAttributedStringRef</span>)string);<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//预设size</span> <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSize</span> size = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSizeMake</span>(width, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">10000</span>);<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CGSize</span> suggestedSize= <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">CTFramesetterSuggestFrameSizeForAttributedStringWithConstraints</span>(framesetter,string,size,<span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">1000</span>);</code></pre></li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">写在最后<br style="box-sizing:border-box;" />
最后说一下，经测试发现，以上说的三种通过CTFramesetter来计算高度的方法，都会存在误差，表现为<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#657b83;background-color:#f6f6f6;border-radius:4px;padding:2px 4px;border:none;white-space:pre-wrap;">UILabel显示时上下会有空白行，且留白范围与所显示内容呈递增关系</code>，具体原因未知，如果有理解的欢迎指正！</p>
</li>
</ul>
</div></body></html>