<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2016-11-22T10:04:37Z"/><meta name="updated" content="2016-11-22T10:04:39Z"/><title>RSWebView(UIWebView和WKWebView的混合框架,UIWebView自动切换到WKWebView)  字数1006 阅读952 评论5 喜欢6  UIWebView和WKWebV</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><h1 class="title" style="margin:10px 0px;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.5;color:#555555;text-rendering:optimizelegibility;font-size:32px;word-break:break-all;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;widows:1;">RSWebView(UIWebView和WKWebView的混合框架,UIWebView自动切换到WKWebView)</h1>
<div class="meta-top" style="font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;margin:20px 0px;color:#555555;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;line-height:20px;widows:1;"><span class="wordage" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">字数1006</span>&nbsp;<span class="views-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">阅读952</span>&nbsp;<span class="comments-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">评论5</span>&nbsp;<span class="likes-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">喜欢6</span></div>
<div class="show-content" style="color:#2f2f2f;font-size:16px;line-height:1.7;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;widows:1;"><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">UIWebView和WKWebView的混合框架,UIWebView自动切换到WKWebView。只要直接把UIWebView换成RSWebView即可，如果UIWebView还有其它特殊的处理，也需要实现WKWebView对应的代理。iOS8以后，苹果推出了新框架Wekkit，提供了替换UIWebView的组件WKWebView。速度更快了，占用内存少了，转为WKWebView是必然的趋势。<a href="https://github.com/air1120/RSWebView" target="_blank" style="color:#4094c7;text-decoration:none;">RSWebView</a>当UIWebView直接使用。</p>
<h2 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:24px;">支持情况说明：</h2>
<ul style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;">UIWebView在iOS8及以后自动切换到WKWebView</li>
<li style="line-height:30px;">带有网页加载进度条</li>
<li style="line-height:30px;">支持设置html, url</li>
<li style="line-height:30px;">可注入js脚本</li>
<li style="line-height:30px;">可修改WebView请求的userAgent</li>
<li style="line-height:30px;">支持忽略ssl验证, 通过&nbsp;<code style="padding:2px 4px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:#657b83;border-radius:3px;border:none;white-space:pre-wrap;background-color:#fdf6e3;">addTrustedDomain</code>&nbsp;添加</li>
<li style="line-height:30px;">支持js交互&nbsp;<a href="https://github.com/marcuswestin/WebViewJavascriptBridge" target="_blank" style="color:#4094c7;text-decoration:none;">WebViewJavascriptBridge</a>，有修改</li>
<li style="line-height:30px;">支持进度条&nbsp;<a href="https://github.com/ninjinkun/NJKWebViewProgress" target="_blank" style="color:#4094c7;text-decoration:none;">NJKWebViewProgress</a>，有修改</li>
<li style="line-height:30px;">支持手势滑动后退，后退时显示上个页面截图（类似safari，wechat）</li>
<li style="line-height:30px;">支持从网页打开其他app，需要判断scheme是否允许</li>
<li style="line-height:30px;">处理&nbsp;<a href="https://github.com/ShingoFukuyama/WKWebViewTips/blob/master/README.md" target="_blank" style="color:#4094c7;text-decoration:none;">WKWebView问题</a>&nbsp;比如打开app store.</li>
<li style="line-height:30px;">WebView加载本地资源(html,css,js,image...)</li>
</ul>
<h2 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:24px;">使用方法：</h2>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">pod加入以下部分：</p>
<pre class="hljs scala" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="scala" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;">pod <span class="hljs-symbol" style="color:#cb4b16;">'RSWebVie</span>w', :git =&gt; <span class="hljs-symbol" style="color:#cb4b16;">'git</span><span class="hljs-annotation">@github</span>.com:air1120/<span class="hljs-type" style="color:#b58900;">RSWebView</span>.git'</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">把UIWebView换成RSWebView即可,支持UIWebView的所有方法和代理不受影响。可以把RSWebView当做UIWebView使用。注意如果在使用RSWebView的ViewController中，如果需要实现了UIWebView的代理方法，也要对应实现WKWebView的代理方法。</p>
<h3 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:22px;">扩展功能：</h3>
<h5 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:18px;">修改userAgent</h5>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;"><span class="hljs-comment" style="color:#93a1a1;">//使用之后，需要通过[RSWebView setUserAgent:nil];来恢复</span> +(<span class="hljs-keyword" style="color:#859900;">void</span>)setUserAgent:(<span class="hljs-built_in" style="color:#268bd2;">NSString</span> *)userAgent;</code></pre><h5 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:18px;">对于POST或GET的扩展请求，headers是字典类型，body是字典或字符串形式，设置即发送请求。</h5>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">设置一：</p>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;">_webView<span class="hljs-variable" style="color:#b58900;">.webSource</span> = [[RSWebSource alloc]initWithUrl:<span class="hljs-string" style="color:#2aa198;">@"http://www.baidu.com"</span> method:<span class="hljs-string" style="color:#2aa198;">@"GET"</span> headers:<span class="hljs-literal">nil</span> body:<span class="hljs-literal">nil</span>];</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">设置二：</p>
<pre class="hljs xml" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="xml" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;">_webView.webSource = [[RSWebSource alloc]initWithHtml:@"<span class="hljs-tag">&lt;<span class="hljs-title" style="color:#268bd2;">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title" style="color:#268bd2;">div</span>&gt;</span>测试<span class="hljs-tag">&lt;/<span class="hljs-title" style="color:#268bd2;">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title" style="color:#268bd2;">html</span>&gt;</span>" baseURL:@""];</code></pre><h5 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:18px;">读取本地文件：</h5>
<pre class="hljs css" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="css" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;"><span class="hljs-tag" style="color:#859900;">-</span>(<span class="hljs-tag" style="color:#859900;">void</span>)<span class="hljs-rule"><span class="hljs-attribute" style="color:#b58900;">loadLocalFile</span>:<span class="hljs-value" style="color:#2aa198;">(NSString *)fileName baseURL:(NSString *)baseURL</span></span>;<span class="hljs-tag" style="color:#859900;">-</span>(<span class="hljs-tag" style="color:#859900;">void</span>)<span class="hljs-rule"><span class="hljs-attribute" style="color:#b58900;">loadLocalFile</span>:<span class="hljs-value" style="color:#2aa198;">(NSString *)fileName</span></span>;</code></pre><h5 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:18px;">WebViewJavascriptBridge的js交互部分：</h5>
<pre class="hljs css" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="css" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;"><span class="hljs-tag" style="color:#859900;">-</span> (<span class="hljs-tag" style="color:#859900;">void</span>)<span class="hljs-rule"><span class="hljs-attribute" style="color:#b58900;">registerHandler</span>:<span class="hljs-value" style="color:#2aa198;">(NSString *)handlerName handler:(WVJBHandler)handler</span></span>;<span class="hljs-tag" style="color:#859900;">-</span> (<span class="hljs-tag" style="color:#859900;">void</span>)<span class="hljs-rule"><span class="hljs-attribute" style="color:#b58900;">callHandler</span>:<span class="hljs-value" style="color:#2aa198;">(NSString *)handlerName</span></span>;<span class="hljs-tag" style="color:#859900;">-</span> (<span class="hljs-tag" style="color:#859900;">void</span>)<span class="hljs-rule"><span class="hljs-attribute" style="color:#b58900;">callHandler</span>:<span class="hljs-value" style="color:#2aa198;">(NSString *)handlerName data:(id)data</span></span>;<span class="hljs-tag" style="color:#859900;">-</span> (<span class="hljs-tag" style="color:#859900;">void</span>)<span class="hljs-rule"><span class="hljs-attribute" style="color:#b58900;">callHandler</span>:<span class="hljs-value" style="color:#2aa198;">(NSString *)handlerName data:(id)data responseCallback:(WVJBResponseCallback)responseCallback</span></span>;</code></pre><h5 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:18px;">添加忽略ssl验证（<a href="http://zhidao.baidu.com/link?url=Mm8g0sKcNjM6FAtx8xuzlOTA2fMKePZbzgLG9rSB8fPE4gepCp-9oDa24lStgvyTeyxQyLG54e5R2YLMNG2aP_" target="_blank" style="color:#4094c7;text-decoration:none;">iOS https请求为什么要忽略证书</a>）</h5>
<pre class="hljs scheme" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="scheme" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;"><span class="hljs-list">[<span class="hljs-keyword" style="color:#859900;">BBWebViewSSLProtocol</span> addTrustedDomain:@<span class="hljs-string" style="color:#2aa198;">"js.com"</span>]<span class="hljs-comment" style="color:#93a1a1;">;</span></span></code></pre><h5 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:18px;">限制外部应用打开</h5>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;"><span class="hljs-comment" style="color:#93a1a1;">//包括获取本地资源，所以file必须要加上</span>     webView<span class="hljs-variable" style="color:#b58900;">.trustedScheme</span> = @[<span class="hljs-string" style="color:#2aa198;">@"file"</span>,<span class="hljs-string" style="color:#2aa198;">@"mqq"</span>];</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">trustedScheme不设置，则不会限制。</p>
<h3 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:22px;">存在的问题：</h3>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">stringByEvaluatingJavaScriptFromString的方法执行alert, comfirm,prompt等关于界面的操作并不能直接返回对应的返回值。由于WKWebView的evaluateJavaScript是异步的，但改为同步执行的过程中出问题，目前仍未解决。其它部分经过测试并无问题。当然您可以选择使用evaluateJavaScript的方法代替stringByEvaluatingJavaScriptFromString的执行是完全没问题的。</p>
<h4 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:20px;">UIWebView代理对应表</h4>
<table style="max-width:100%;border-spacing:0px;width:619px;margin-bottom:20px;border-top-width:1px;border-right-width:1px;border-bottom-width:1px;border-style:solid solid solid none;border-top-color:#dddddd;border-right-color:#dddddd;border-bottom-color:#dddddd;background-color:transparent;"><thead><tr><th style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:bottom;">UIWebView代理</th>
<th style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:bottom;">WKWebView代理</th>
<th style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:bottom;">说明</th>
</tr>
</thead><tbody><tr><td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">-(BOOL)webView:(UIWebView&nbsp;<em>)webView shouldStartLoadWithRequest:(NSURLRequest&nbsp;</em>)request navigationType:(UIWebViewNavigationType)navigationType;</td>
<td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">- (void)webView:(WKWebView&nbsp;<em>)webView didStartProvisionalNavigation:(WKNavigation&nbsp;</em>)navigation;</td>
<td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">页面开始加载时调用</td>
</tr>
<tr><td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">- (void)webViewDidStartLoad:(UIWebView *)webView</td>
<td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">- (void)webView:(WKWebView&nbsp;<em>)webView didCommitNavigation:(WKNavigation&nbsp;</em>)navigation;</td>
<td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">当内容开始返回时调用</td>
</tr>
<tr><td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">- (void)webViewDidFinishLoad:(UIWebView *)webView</td>
<td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">- (void)webView:(WKWebView&nbsp;<em>)webView didFinishNavigation:(WKNavigation&nbsp;</em>)navigation;</td>
<td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">页面加载完成之后调用</td>
</tr>
<tr><td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">- (void)webView:(UIWebView&nbsp;<em>)webView didFailLoadWithError:(NSError&nbsp;</em>)error</td>
<td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">- (void)webView:(WKWebView&nbsp;<em>)webView didFailProvisionalNavigation:(WKNavigation&nbsp;</em>)navigation;</td>
<td style="padding:8px;border-left-width:1px;border-left-style:solid;border-left-color:#dddddd;border-top-width:1px;border-top-style:solid;border-top-color:#dddddd;line-height:20px;vertical-align:top;">页面加载失败时调用</td>
</tr>
</tbody>
</table>
<h1 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:26px;">实现思路及遇到的问题（下面部分可不看，总结用）</h1>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">一些处理思路：<br />
从实际WebView的代理给WebViewJavascriptBridge，WebViewJavascriptBridge回调NJKWebViewProgress的代理方法，NJKWebViewProgress再回调RWWebView的方法，RWWebView再回调对应Controller的方法。</p>
<h3 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:22px;">WebViewJavascriptBridge的完全说明：</h3>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">1.由于WKWebViewJavascriptBridge会截获WKNavigationDelegate的所有响应，所以需要添加事件转发。<br />
2.而事件转发需要提前知道delegate有没有实现对应的方法。所以需要先设置delegate。<br />
3.其实也可以直接重写对应的方法，不过为了尽量保持原有的代理方法，采用了1，2的做法。</p>
<h5 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:18px;">WebViewJavascriptBridge的实现js交互的原理：</h5>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">总结一下：js这边 先把方法名字、参数、处理方法保存成一个字典在转成json字符串，在通过UIWebview调用js中某个方法把这个json字符串传到Native中 去（不是通过url传的，这样太low了），同时把这个处理的方法以key-value形式放到一个js的字典中。UIWebView在收到这个json之后，进行数据处理、还有js的回掉的处理方法（就是那个callbackId）处理完成后也会拼成一个key-value字典通过调用js传回去（可以直接调用js）。js在接到这个json后，根据responseId读取responseCallbacks中处理方法进行处理Native code返回的数据。</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">总结：native将方法名、参数、回到的id放到一个对象中传给js。js根据方法名字调用相应方法，之后将返回数据和responseId拼装，最后通过src 重定向到UIWebview 的delegate。native得到数据后根据responseId调用事先装入_responseCallbacks的block，动态读取调用，从而完成交互。</p>
<ul style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;"><a href="http://www.brighttj.com/ios/ios-wkwebview-new-features-and-use.html" target="_blank" style="color:#4094c7;text-decoration:none;">WKWebView的方法说明</a></li>
<li style="line-height:30px;">WKWebView不支持的情况处理<br />
1.<a href="https://github.com/ShingoFukuyama/WKWebViewTips/blob/master/README.md" target="_blank" style="color:#4094c7;text-decoration:none;">URL Scheme and App Store links won't work</a><br />
需要导入两个文件<a href="https://github.com/bendytree/Objective-C-RegEx-Categories" target="_blank" style="color:#4094c7;text-decoration:none;">RegExCategories</a></li>
</ul>
<h3 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:22px;">兼容情况说明：</h3>
<ol style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;">处理&nbsp;<a href="https://github.com/ShingoFukuyama/WKWebViewTips/blob/master/README.md" target="_blank" style="color:#4094c7;text-decoration:none;">WKWebView</a>不能打开URL Scheme and App Store的问题</li>
<li style="line-height:30px;">webView支持缩放（scalesPageToFit）</li>
</ol>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">一个关于系统版本的技巧，代码如下：</p>
<pre class="hljs cs" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-color:#fdf6e3;background-position:initial initial;background-repeat:initial initial;"><code class="cs" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:none;background-color:transparent;"><span class="hljs-preprocessor" style="color:#cb4b16;">#<span class="hljs-keyword">if</span> (__MAC_OS_X_VERSION_MAX_ALLOWED &gt; __MAC_10_9 || __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= __IPHONE_7_1)</span> <span class="hljs-preprocessor" style="color:#cb4b16;">#<span class="hljs-keyword">define</span> supportsWKWebKit</span> <span class="hljs-preprocessor" style="color:#cb4b16;">#<span class="hljs-keyword">endif</span></span> <span class="hljs-preprocessor" style="color:#cb4b16;">#<span class="hljs-keyword">if</span> defined(supportsWKWebKit )</span> <span class="hljs-comment" style="color:#93a1a1;">//这里写类相关的东西</span> <span class="hljs-preprocessor" style="color:#cb4b16;">#<span class="hljs-keyword">endif</span></span></code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">相关资料查询：</p>
<ul style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;"><p style="margin-top:16px;margin-bottom:16px;word-break:break-word;overflow:visible;"><a href="http://www.jianshu.com/p/8f6d527f13bc" target="_blank" style="color:#4094c7;text-decoration:none;">iOS开发之WKWebView简单使用</a></p>
<p style="margin-top:16px;margin-bottom:16px;word-break:break-word;overflow:visible;">进度条暂时都用了第三方的方法处理，其实有更好的，但是暂时没有处理。WKWebView有estimatedProgress的属性，然后配合UIProgressView设置出来的效果更佳好。</p>
<h3 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:22px;">遇到的一些问题</h3>
</li>
<li style="line-height:30px;"><a href="http://stackoverflow.com/questions/24208229/wkwebview-and-nsurlprotocol-not-working" target="_blank" style="color:#4094c7;text-decoration:none;">处理ssl的时候：WKWebView and NSURLProtocol not working</a></li>
<li style="line-height:30px;">webView 不能使用gcd的主线程方法调用。</li>
<li style="line-height:30px;"><a href="http://stackoverflow.com/questions/24573589/objective-c-catransaction-synchronize-called-within-transaction" target="_blank" style="color:#4094c7;text-decoration:none;">stringByEvaluatingJavaScriptFromString不能在init执行，会报+[CATransaction synchronize] called within transaction错误</a></li>
</ul>
</div></body></html>