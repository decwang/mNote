<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2016-12-07T08:57:48Z"/><meta name="updated" content="2016-12-07T08:57:50Z"/><title>由于苹果规定2017年1月1日以后，所有APP都要使用HTTPS进行网络请求，否则无法上架，因此研究了一下在iOS中使用HTTPS请求的实现。网上搜索了一些比较有用资料,大家可以参考下  苹果强制升</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">由于苹果规定2017年1月1日以后，所有APP都要使用HTTPS进行网络请求，否则无法上架，因此研究了一下在iOS中使用HTTPS请求的实现。网上搜索了一些比较有用资料,大家可以参考下</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">苹果强制升级的HTTPS不仅仅是在接口HTTP上加个S那么简单:</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">它所有满足的是iOS9中新增App Transport Security（简称ATS）特性:</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">那满足ATS我们需要做什么呢</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">1.必须是苹果信任的CA证书机构颁发的证书</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">2.后台传输协议必须满足: TLS1.2 (这很重要, 后面的自制证书满足这个条件是前提)</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">3.签字算法只能是下面的一种:</p>
<pre class="prettyprint hljs nginx" style="padding:0.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:#444444;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:1.5em;line-height:1.5em;word-break:break-all;word-wrap:break-word;background-color:#f6f6f6;border:none;overflow-x:auto;font-variant-ligatures:normal;orphans:2;widows:2;"><span class="hljs-attribute" style="color:#333333;font-weight:700;">TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</span> TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384
TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA
TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256
TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA
TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384
TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256
TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA</pre><p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">4.证书必须使用SHA256或者更好的哈希算法进行签名，要么是2048位或者更长的RSA密钥，要么就是256位或更长的ECC密钥。</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">目前有两种升级到HTTPS得方法:</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">1.第三方认证的颁发CA证书(推荐)</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">2.自己制作证书(这种不知道能不能满足苹果的审核)</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">一: 第三方认证的颁发CA证书</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">证书到底长什么样子呢? 取个栗子:</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">大家请打开&nbsp;<a href="https://www.baidu.com/" target="_blank" rel="nofollow,noindex" style="color:#949494;text-decoration:none;transition:0.25s;outline:none 0px;border-bottom:1px dashed #949494;font-style:italic;font-weight:bold;">https://www.baidu.com</a></p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">然后看到</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;text-align:center;"><img src="http://img1.tuicool.com/zEJFjyV.png!web" class="alignCenter" style="max-width:96%;height:auto;vertical-align:middle;border:0px none;margin:0px auto 10px;display:block;" /></p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">百度的证书分析</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">那些证书机构颁发的证书能用:&nbsp;<a href="https://support.apple.com/zh-cn/HT205205" target="_blank" rel="nofollow,noindex" style="color:#949494;text-decoration:none;transition:0.25s;outline:none 0px;border-bottom:1px dashed #949494;font-style:italic;font-weight:bold;">苹果官方信任证书</a></p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">收费SSL证书: 网上百度一大把, 收费还挺贵的,自己可以多找几个对比一下</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">免费SSL证书: 除了收费的CA证书机构, 你还可以去&nbsp;<a href="https://www.qcloud.com/product/ssl" target="_blank" rel="nofollow,noindex" style="color:#949494;text-decoration:none;transition:0.25s;outline:none 0px;border-bottom:1px dashed #949494;font-style:italic;font-weight:bold;">腾讯云</a>&nbsp;申请免费的SSL证书, 教程&nbsp;<a href="http://www.jianshu.com/p/08f64ff9ed6b/comments/4374507" target="_blank" rel="nofollow,noindex" style="color:#949494;text-decoration:none;transition:0.25s;outline:none 0px;border-bottom:1px dashed #949494;font-style:italic;font-weight:bold;">免费在腾讯云申请SSL证书的方法</a></p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">沃通(WoSign)免费的SSL证书最近被苹果封杀了, 能不能用大家可以看一下苹果的公告: 您的苹果手机轻点“设置”&gt;“通用”&gt;“关于本机”&gt;"证书信任设置"&gt;"进一步了解被信任的证书"去了解</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">检测你的接口是否满足苹果的ATS要求, 有以下两种方法:</p>
<ol style="padding:0px;margin:0px 0px 0.75em 25px;font-size:16px;line-height:1.7em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;"><li style="line-height:1.7em;"><p class="no-text-indent" style="margin-top:0px;margin-bottom:0.75em;line-height:1.7em;">腾讯云提供的检测页面检测</p>
</li>
</ol>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;text-align:center;"><img src="http://img1.tuicool.com/Z7n26by.png!web" class="alignCenter" style="max-width:96%;height:auto;vertical-align:middle;border:0px none;margin:0px auto 10px;display:block;" /></p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">腾讯云的检测页面</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">2 终端输入 nsurl --ats-diagnostics --verbose 你的接口地址</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">大家可以参考这篇文章,里面的说的很明白:</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;"><a href="https://my.oschina.net/vimfung/blog/494687?_t_t_t=0.1896578531749944" target="_blank" rel="nofollow,noindex" style="color:#949494;text-decoration:none;transition:0.25s;outline:none 0px;border-bottom:1px dashed #949494;font-style:italic;font-weight:bold;">关于iOS9中的App Transport Security相关说明及适配(更新于2016.7.1)</a></p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">里面会详细说明你的证书哪点不符合ATS要求</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">当然下面自己制作证书去实现HTTPS的,检测不通过的,所以我觉得审核会被拒</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">这种方法配置好了, 在手机端就什么都不用配置就可以请求了</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">二: 自己制作证书</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;"><a href="https://support.apple.com/zh-cn/HT205205" target="_blank" rel="nofollow,noindex" style="color:#949494;text-decoration:none;transition:0.25s;outline:none 0px;border-bottom:1px dashed #949494;font-style:italic;font-weight:bold;">苹果官方信任证书</a>&nbsp;里说到有三种证书:</p>
<pre class="prettyprint hljs" style="padding:0.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:#444444;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:1.5em;line-height:1.5em;word-break:break-all;word-wrap:break-word;background-color:#f6f6f6;border:none;overflow-x:auto;font-variant-ligatures:normal;orphans:2;widows:2;">1 可信的根证书用于建立信任链，以验证由可信的根签署的其他证书，例如，与 Web 服务器建立安全连接。当 IT 管理员创建 iPhone、iPad 或 iPod touch 的配置描述文件时，无需提供这些可信的根证书。
2 始终询问的证书不受信任，但不受阻止。使用其中一个证书时，系统将提示您选择是否信任该证书。
3 已阻止的证书视为被盗用，将不再受信任。</pre><p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">自制证书我觉得应该就是属于第二种情况, 所以这种方法我也不知道能不能通过苹果的审核, 只是提供一个方法给大家参考, 看到网上有人说可以,有人说不可以, 不到1月1号,自己没试过都不敢说大话</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">这种方式拿到后台的接口用谷歌浏览器打开跟百度的证书是有区别的</p>
<p class="img_text_center" style="margin-top:0px;margin-bottom:0.75em;text-align:center;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;"><img src="http://img2.tuicool.com/IfAvyau.png!web" class="alignCenter" style="max-width:96%;height:auto;vertical-align:middle;border:0px none;margin:0px auto 10px;display:block;" />自己制作证书</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">很明显没有绿锁, 当打开的时候会询问是否连接这个不受信任的连接才会进一步打开, 下面就来一步步的实现(包括怎么制作证书)</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;"><a href="http://www.jianshu.com/p/e6a26ecd84aa" target="_blank" rel="nofollow,noindex" style="color:#949494;text-decoration:none;transition:0.25s;outline:none 0px;border-bottom:1px dashed #949494;font-style:italic;font-weight:bold;">iOS使用自签名证书实现HTTPS请求</a></p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;"><a href="http://www.jianshu.com/p/ec61e5ab6fbb" target="_blank" rel="nofollow,noindex" style="color:#949494;text-decoration:none;transition:0.25s;outline:none 0px;border-bottom:1px dashed #949494;font-style:italic;font-weight:bold;">iOS Https协议 自签证书访问数据</a>&nbsp;参考这个例子的时候,博主自带的Demo AFN框架请求不了数据, 我用了最新AFN版本的成功返回数据</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">还可以参考一下</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;"><a href="http://www.jianshu.com/p/36ddc5b009a7" target="_blank" rel="nofollow,noindex" style="color:#949494;text-decoration:none;transition:0.25s;outline:none 0px;border-bottom:1px dashed #949494;font-style:italic;font-weight:bold;">iOS 10 适配 ATS app支持https通过App Store审核</a></p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">我在利用原生的代码测试时遇到的问题</p>
<pre class="prettyprint hljs objectivec" style="padding:0.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:#444444;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:1.5em;line-height:1.5em;word-break:break-all;word-wrap:break-word;background-color:#f6f6f6;border:none;overflow-x:auto;font-variant-ligatures:normal;orphans:2;widows:2;"><span class="hljs-class"><span class="hljs-keyword" style="color:#333333;font-weight:700;">@interface</span> <span class="hljs-title" style="color:#880000;font-weight:bold;">ViewController</span> () @<span class="hljs-title" style="color:#880000;font-weight:bold;">end</span></span> <span class="hljs-class"><span class="hljs-keyword" style="color:#333333;font-weight:700;">@implementation</span> <span class="hljs-title" style="color:#880000;font-weight:bold;">ViewController</span></span> - (<span class="hljs-keyword" style="color:#333333;font-weight:700;">void</span>)viewDidLoad {
}
- (<span class="hljs-keyword" style="color:#333333;font-weight:700;">void</span>)touchesBegan:(<span class="hljs-built_in" style="color:#397300;">NSSet</span> *)touches withEvent:(<span class="hljs-built_in" style="color:#397300;">UIEvent</span> *)event
{
    <span class="hljs-built_in" style="color:#397300;">NSURLSession</span> *session = [<span class="hljs-built_in" style="color:#397300;">NSURLSession</span> sessionWithConfiguration:[<span class="hljs-built_in" style="color:#397300;">NSURLSessionConfiguration</span> defaultSessionConfiguration] delegate:<span class="hljs-keyword" style="color:#333333;font-weight:700;">self</span> delegateQueue:[<span class="hljs-built_in" style="color:#397300;">NSOperationQueue</span> mainQueue]];
   <span class="hljs-built_in" style="color:#397300;">NSURLSessionDataTask</span> *task =  [session dataTaskWithURL:[<span class="hljs-built_in" style="color:#397300;">NSURL</span> URLWithString:<span class="hljs-string" style="color:#880000;">@"https://www.baidu.com"</span>] completionHandler:^(<span class="hljs-built_in" style="color:#397300;">NSData</span> *data, <span class="hljs-built_in" style="color:#397300;">NSURLResponse</span> *response, <span class="hljs-built_in" style="color:#397300;">NSError</span> *error) {
        <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"%@"</span>, [[<span class="hljs-built_in" style="color:#397300;">NSString</span> alloc] initWithData:data encoding:<span class="hljs-built_in" style="color:#397300;">NSUTF8StringEncoding</span>]);
    }];
   [task resume];
}
- (<span class="hljs-keyword" style="color:#333333;font-weight:700;">void</span>)URLSession:(<span class="hljs-built_in" style="color:#397300;">NSURLSession</span> *)session dataTask:(<span class="hljs-built_in" style="color:#397300;">NSURLSessionDataTask</span> *)dataTask
didReceiveResponse:(<span class="hljs-built_in" style="color:#397300;">NSURLResponse</span> *)response
 completionHandler:(<span class="hljs-keyword" style="color:#333333;font-weight:700;">void</span> (^)(<span class="hljs-built_in" style="color:#397300;">NSURLSessionResponseDisposition</span> disposition))completionHandler {
    <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"接收到服务器响应"</span>);
    <span class="hljs-comment" style="color:#888888;">//注意：这里需要使用completionHandler回调告诉系统应该如何处理服务器返回的数据</span>     <span class="hljs-comment" style="color:#888888;">//默认是取消</span>     <span class="hljs-comment" style="color:#888888;">/**
     NSURLSessionResponseCancel = 0,            默认的处理方式，取消
     NSURLSessionResponseAllow = 1,             接收服务器返回的数据
     NSURLSessionResponseBecomeDownload = 2,    变成一个下载请求
     NSURLSessionResponseBecomeStream           变成一个流
     */</span>     completionHandler(<span class="hljs-built_in" style="color:#397300;">NSURLSessionResponseAllow</span>);
}
- (<span class="hljs-keyword" style="color:#333333;font-weight:700;">void</span>)URLSession:(<span class="hljs-built_in" style="color:#397300;">NSURLSession</span> *)session dataTask:(<span class="hljs-built_in" style="color:#397300;">NSURLSessionDataTask</span> *)dataTask
    didReceiveData:(<span class="hljs-built_in" style="color:#397300;">NSData</span> *)data {
    <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"获取到服务段数据"</span>);
    <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"%@"</span>,[<span class="hljs-keyword" style="color:#333333;font-weight:700;">self</span> jsonToDictionary:data]);
}
- (<span class="hljs-keyword" style="color:#333333;font-weight:700;">void</span>)URLSession:(<span class="hljs-built_in" style="color:#397300;">NSURLSession</span> *)session task:(<span class="hljs-built_in" style="color:#397300;">NSURLSessionTask</span> *)task
didCompleteWithError:(<span class="hljs-keyword" style="color:#333333;font-weight:700;">nullable</span> <span class="hljs-built_in" style="color:#397300;">NSError</span> *)error {
    <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"请求完成%@"</span>, error);
}
- (<span class="hljs-keyword" style="color:#333333;font-weight:700;">void</span>)URLSession:(<span class="hljs-built_in" style="color:#397300;">NSURLSession</span> *)session didReceiveChallenge:(<span class="hljs-built_in" style="color:#397300;">NSURLAuthenticationChallenge</span> *)challenge
 completionHandler:(<span class="hljs-keyword" style="color:#333333;font-weight:700;">void</span> (^)(<span class="hljs-built_in" style="color:#397300;">NSURLSessionAuthChallengeDisposition</span> disposition, <span class="hljs-built_in" style="color:#397300;">NSURLCredential</span> * _Nullable credential))completionHandler {
    <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"证书认证"</span>);
    <span class="hljs-keyword" style="color:#333333;font-weight:700;">if</span> ([[[challenge protectionSpace] authenticationMethod] isEqualToString: <span class="hljs-built_in" style="color:#397300;">NSURLAuthenticationMethodServerTrust</span>]) {
        <span class="hljs-keyword" style="color:#333333;font-weight:700;">do</span>         {
            SecTrustRef serverTrust = [[challenge protectionSpace] serverTrust];
            <span class="hljs-built_in" style="color:#397300;">NSCAssert</span>(serverTrust != <span class="hljs-literal" style="color:#78a960;">nil</span>, <span class="hljs-string" style="color:#880000;">@"serverTrust is nil"</span>);
            <span class="hljs-keyword" style="color:#333333;font-weight:700;">if</span>(<span class="hljs-literal" style="color:#78a960;">nil</span> == serverTrust)
                <span class="hljs-keyword" style="color:#333333;font-weight:700;">break</span>; <span class="hljs-comment" style="color:#888888;">/* failed */</span>             <span class="hljs-comment" style="color:#888888;">/**
             *  导入多张CA证书（Certification Authority，支持SSL证书以及自签名的CA），请替换掉你的证书名称
             */</span>             <span class="hljs-built_in" style="color:#397300;">NSString</span> *cerPath = [[<span class="hljs-built_in" style="color:#397300;">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string" style="color:#880000;">@"ca"</span> ofType:<span class="hljs-string" style="color:#880000;">@"cer"</span>];<span class="hljs-comment" style="color:#888888;">//自签名证书</span>             <span class="hljs-built_in" style="color:#397300;">NSData</span>* caCert = [<span class="hljs-built_in" style="color:#397300;">NSData</span> dataWithContentsOfFile:cerPath];
            <span class="hljs-built_in" style="color:#397300;">NSCAssert</span>(caCert != <span class="hljs-literal" style="color:#78a960;">nil</span>, <span class="hljs-string" style="color:#880000;">@"caCert is nil"</span>);
            <span class="hljs-keyword" style="color:#333333;font-weight:700;">if</span>(<span class="hljs-literal" style="color:#78a960;">nil</span> == caCert)
                <span class="hljs-keyword" style="color:#333333;font-weight:700;">break</span>; <span class="hljs-comment" style="color:#888888;">/* failed */</span>             SecCertificateRef caRef = SecCertificateCreateWithData(<span class="hljs-literal" style="color:#78a960;">NULL</span>, (__bridge <span class="hljs-built_in" style="color:#397300;">CFDataRef</span>)caCert);
            <span class="hljs-built_in" style="color:#397300;">NSCAssert</span>(caRef != <span class="hljs-literal" style="color:#78a960;">nil</span>, <span class="hljs-string" style="color:#880000;">@"caRef is nil"</span>);
            <span class="hljs-keyword" style="color:#333333;font-weight:700;">if</span>(<span class="hljs-literal" style="color:#78a960;">nil</span> == caRef)
                <span class="hljs-keyword" style="color:#333333;font-weight:700;">break</span>; <span class="hljs-comment" style="color:#888888;">/* failed */</span>             <span class="hljs-comment" style="color:#888888;">//可以添加多张证书</span>             <span class="hljs-built_in" style="color:#397300;">NSArray</span> *caArray = @[(__bridge <span class="hljs-keyword" style="color:#333333;font-weight:700;">id</span>)(caRef)];
            <span class="hljs-built_in" style="color:#397300;">NSCAssert</span>(caArray != <span class="hljs-literal" style="color:#78a960;">nil</span>, <span class="hljs-string" style="color:#880000;">@"caArray is nil"</span>);
            <span class="hljs-keyword" style="color:#333333;font-weight:700;">if</span>(<span class="hljs-literal" style="color:#78a960;">nil</span> == caArray)
                <span class="hljs-keyword" style="color:#333333;font-weight:700;">break</span>; <span class="hljs-comment" style="color:#888888;">/* failed */</span>             <span class="hljs-comment" style="color:#888888;">//将读取的证书设置为服务端帧数的根证书</span>             OSStatus status = SecTrustSetAnchorCertificates(serverTrust, (__bridge <span class="hljs-built_in" style="color:#397300;">CFArrayRef</span>)caArray);
            <span class="hljs-built_in" style="color:#397300;">NSCAssert</span>(errSecSuccess == status, <span class="hljs-string" style="color:#880000;">@"SecTrustSetAnchorCertificates failed"</span>);
            <span class="hljs-keyword" style="color:#333333;font-weight:700;">if</span>(!(errSecSuccess == status))
                <span class="hljs-keyword" style="color:#333333;font-weight:700;">break</span>; <span class="hljs-comment" style="color:#888888;">/* failed */</span>             SecTrustResultType result = <span class="hljs-number" style="color:#880000;">-1</span>;
            <span class="hljs-comment" style="color:#888888;">//通过本地导入的证书来验证服务器的证书是否可信</span>             status = SecTrustEvaluate(serverTrust, &amp;result);
            <span class="hljs-keyword" style="color:#333333;font-weight:700;">if</span>(!(errSecSuccess == status))
                <span class="hljs-keyword" style="color:#333333;font-weight:700;">break</span>; <span class="hljs-comment" style="color:#888888;">/* failed */</span>             <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"stutas:%d"</span>,(<span class="hljs-keyword" style="color:#333333;font-weight:700;">int</span>)status);
            <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"Result: %d"</span>, result);
            <span class="hljs-built_in" style="color:#397300;">BOOL</span> allowConnect = (result == kSecTrustResultUnspecified) || (result == kSecTrustResultProceed);
            <span class="hljs-keyword" style="color:#333333;font-weight:700;">if</span> (allowConnect) {
                <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"success"</span>);
            }<span class="hljs-keyword" style="color:#333333;font-weight:700;">else</span> {
                <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"error"</span>);
            }
            <span class="hljs-comment" style="color:#888888;">/* kSecTrustResultUnspecified and kSecTrustResultProceed are success */</span>             <span class="hljs-keyword" style="color:#333333;font-weight:700;">if</span>(! allowConnect)
            {
                <span class="hljs-keyword" style="color:#333333;font-weight:700;">break</span>; <span class="hljs-comment" style="color:#888888;">/* failed */</span>             }<span class="hljs-meta" style="color:#1f7199;">#if 0</span>             <span class="hljs-comment" style="color:#888888;">/* Treat kSecTrustResultConfirm and kSecTrustResultRecoverableTrustFailure as success */</span>             <span class="hljs-comment" style="color:#888888;">/*   since the user will likely tap-through to see the dancing bunnies */</span>             <span class="hljs-keyword" style="color:#333333;font-weight:700;">if</span>(result == kSecTrustResultDeny || result == kSecTrustResultFatalTrustFailure || result == kSecTrustResultOtherError)
                <span class="hljs-keyword" style="color:#333333;font-weight:700;">break</span>; <span class="hljs-comment" style="color:#888888;">/* failed to trust cert (good in this case) */</span> <span class="hljs-meta" style="color:#1f7199;">#endif</span>             <span class="hljs-comment" style="color:#888888;">// The only good exit point</span>             <span class="hljs-built_in" style="color:#397300;">NSLog</span>(<span class="hljs-string" style="color:#880000;">@"信任该证书"</span>);
            <span class="hljs-built_in" style="color:#397300;">NSURLCredential</span> *credential = [<span class="hljs-built_in" style="color:#397300;">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust];
            completionHandler(<span class="hljs-built_in" style="color:#397300;">NSURLSessionAuthChallengeUseCredential</span>,credential);
            <span class="hljs-keyword" style="color:#333333;font-weight:700;">return</span> [[challenge sender] useCredential: credential
                          forAuthenticationChallenge: challenge];
        }
        <span class="hljs-keyword" style="color:#333333;font-weight:700;">while</span>(<span class="hljs-number" style="color:#880000;">0</span>);
    }
    <span class="hljs-comment" style="color:#888888;">// Bad dog</span>     <span class="hljs-built_in" style="color:#397300;">NSURLCredential</span> *credential = [<span class="hljs-built_in" style="color:#397300;">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust];
    completionHandler(<span class="hljs-built_in" style="color:#397300;">NSURLSessionAuthChallengeCancelAuthenticationChallenge</span>,credential);
    <span class="hljs-keyword" style="color:#333333;font-weight:700;">return</span> [[challenge sender] cancelAuthenticationChallenge: challenge];
}
- (<span class="hljs-built_in" style="color:#397300;">NSDictionary</span> *)jsonToDictionary:(<span class="hljs-built_in" style="color:#397300;">NSData</span> *)jsonData {
    <span class="hljs-built_in" style="color:#397300;">NSError</span> *jsonError;
    <span class="hljs-built_in" style="color:#397300;">NSDictionary</span> *resultDic = [<span class="hljs-built_in" style="color:#397300;">NSJSONSerialization</span> JSONObjectWithData:jsonData options:<span class="hljs-built_in" style="color:#397300;">NSJSONReadingMutableLeaves</span> error:&amp;jsonError];
    <span class="hljs-keyword" style="color:#333333;font-weight:700;">return</span> resultDic;
}<span class="hljs-keyword" style="color:#333333;font-weight:700;">@end</span></pre><p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">下面说说我在配置自己制作证书过程中遇到的问题:</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">1.转换证书: 把后台给你的.crt证书转化为.cer后缀</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">终端命令行openssl x509 -in 你的证书.crt -out 你的证书.cer -outform der</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">2.利用系统的方法来不到</p>
<pre class="prettyprint hljs less" style="padding:0.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:#444444;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:1.5em;line-height:1.5em;word-break:break-all;word-wrap:break-word;background-color:#f6f6f6;border:none;overflow-x:auto;font-variant-ligatures:normal;orphans:2;widows:2;"><span class="hljs-selector-tag" style="color:#333333;font-weight:700;">-</span> (void)<span class="hljs-selector-tag" style="color:#333333;font-weight:700;">URLSession</span><span class="hljs-selector-pseudo" style="color:#bc6060;">:(NSURLSession</span> *)<span class="hljs-selector-tag" style="color:#333333;font-weight:700;">session</span> <span class="hljs-selector-tag" style="color:#333333;font-weight:700;">didReceiveChallenge</span><span class="hljs-selector-pseudo" style="color:#bc6060;">:(NSURLAuthenticationChallenge</span> *)<span class="hljs-selector-tag" style="color:#333333;font-weight:700;">challenge</span>  <span class="hljs-selector-tag" style="color:#333333;font-weight:700;">completionHandler</span><span class="hljs-selector-pseudo" style="color:#bc6060;">:(void</span> (^)(NSURLSessionAuthChallengeDisposition disposition, NSURLCredential * _Nullable credential))<span class="hljs-selector-tag" style="color:#333333;font-weight:700;">completionHandler</span> {
    <span class="hljs-selector-tag" style="color:#333333;font-weight:700;">NSLog</span>(@<span class="hljs-string" style="color:#880000;">"证书认证"</span>);
}</pre><p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">这个方法的时候, 是因为后台的传输协议还没升级到TLS1.2, 叫后台升级后就可以来到验证证书的这个方法了.</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">3.拖入证书读取不出证书数据</p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">参考:&nbsp;<a href="http://blog.csdn.net/jia12216/article/details/49204797" target="_blank" rel="nofollow,noindex" style="color:#949494;text-decoration:none;transition:0.25s;outline:none 0px;border-bottom:1px dashed #949494;font-style:italic;font-weight:bold;">https的证书错误，错误码-1012问题及解决方案</a></p>
<p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">SDWebImage: 项目中大家用到AFN请求网络数据, 升级验证SSL证书的方案相信你看完上面的参考文章已经没问题了, 我给出的代码, 自定义网络请求也没问题了, 还有就是SDWebImage框架的请求HTTPS的图片时,大家可以绕过证书验证去加载图片</p>
<pre class="prettyprint hljs groovy" style="padding:0.5em;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;color:#444444;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:1.5em;line-height:1.5em;word-break:break-all;word-wrap:break-word;background-color:#f6f6f6;border:none;overflow-x:auto;font-variant-ligatures:normal;orphans:2;widows:2;">[imageView <span class="hljs-string" style="color:#880000;">sd_setImageWithURL:</span>[NSURL <span class="hljs-string" style="color:#880000;">URLWithString:</span>urlString] <span class="hljs-string" style="color:#880000;">placeholderImage:</span>self.placeholder <span class="hljs-string" style="color:#880000;">options:</span>SDWebImageAllowInvalidSSLCertificates];</pre><p style="margin-top:0px;margin-bottom:0.75em;font-size:16px;line-height:1.7em;text-indent:1em;color:#333333;font-family:'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;background-color:#fefefe;">恩, 这就是这几天升级HTTPS觉得有帮助的参考和总结.希望帮到你。</p></body></html>