<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2016-11-16T06:01:48Z"/><meta name="updated" content="2016-11-16T06:01:51Z"/><title>用Model-View-ViewModel构建iOS App    2016-03-01 17:34 100人阅读 评论(0) 收藏 举报    MVC是构建iOS app的标准模式。本文中，我们将</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div class="article_title" style="margin:5px 0px;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;font-size:20px;line-height:30px;font-family:'Microsoft YaHei';widows:1;"><h1 style="margin:0px;padding:0px;display:inline;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;font-weight:normal;font-size:20px;line-height:30px;vertical-align:middle;"><span class="link_title"><a href="http://blog.csdn.net/muzhenhua/article/details/50774142" style="color:#000000;text-decoration:none;">用Model-View-ViewModel构建iOS App</a></span></h1>
</div>
<div class="article_manage clearfix" style="padding:0px 20px 5px;color:#999999;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;font-size:12px;line-height:22px;font-family:Arial;text-align:right;border-bottom-style:solid;border-bottom-width:1px;border-bottom-color:#ededed;margin:0px -20px;overflow:hidden;widows:1;"><div class="article_r"><span class="link_postdate" style="margin:0px 5px 0px 0px;">2016-03-01 17:34</span>&nbsp;<span class="link_view" title="阅读次数" style="margin:0px 5px;padding:0px 0px 0px 14px;background:url(http://static.blog.csdn.net/images/ico_view.png) 0% 50% no-repeat;">100人阅读</span>&nbsp;<span class="link_comments" title="评论次数" style="margin:0px 5px;padding:0px 0px 0px 14px;background:url(http://static.blog.csdn.net/images/ico_comm.png) 0% 50% no-repeat;"><a href="http://blog.csdn.net/muzhenhua/article/details/50774142#comments" style="color:#6a3906;text-decoration:none;">评论</a>(0)</span>&nbsp;<span class="link_collect tracking-ad" data-mod="popu_171" style="margin:0px 5px;"><a title="收藏" target="_blank" style="color:#6a3906;">收藏</a></span>&nbsp;<span class="link_report" style="margin:0px 5px;"><a href="http://blog.csdn.net/muzhenhua/article/details/50774142#report" title="举报" style="color:#6a3906;text-decoration:none;">举报</a></span></div>
</div>
<div id="article_content" class="article_content" style="margin:20px 0px 0px;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;line-height:26px;font-family:Arial;color:#362e2b;widows:1;"><p class="p1" style="margin-top:0px;margin-bottom:0px;padding-top:0px;padding-bottom:0px;color:#333333;line-height:1.8;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;background-color:#f0f0f0;">MVC是构建iOS app的标准模式。本文中，我们将重温一下MVC是什么，详述它的缺点，并且告诉你一个新的方式来架构你的app：Model-View-ViewModel。</p>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">如果你已经开发一段时间的iOS应用，你一定听说过Model-View-Controller，即MVC。MVC是构建iOS App的标准模式。然而，最近我已经越来越厌倦MVC的一些缺点。在本文，我将重温一下MVC是什么，详述它的缺点，并且告诉你一个新的方式来架构你的App：Model-View-ViewModel。拿出你的流行语bingo card(宾果卡，一种游戏卡片-译者注)，因为我们即将进行一次范式转变。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;"><strong>Model-View-Controller</strong></div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">Model-View-Controller是一个用来组织代码的权威范式。Apple甚至是<a target="_blank" href="https://developer.apple.com/library/ios/documentation/general/conceptual/devpedia-cocoacore/MVC.html" style="color:#666666;text-decoration:none;font-size:12px;line-height:normal;"><span style="color:#0000ff;">这么说的</span></a>。在MVC下，所有的对象被归类为一个model，一个view，或一个controller。Model持有数据，View显示与用户交互的界面，而View Controller调解Model和View之间的交互。</div>
<p><img src="http://img.blog.csdn.net/20160301172416113?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" style="border:none;" /></p>
<p><span style="color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">在上图中，view将用户交互通知给controller。view controller通过更新model来反应状态的改变。model（通常使用Key-Value-Observation）通知controller来更新他们负责的view。大多数iOS应用程序的代码使用这种方式来组织。</span></p>
<p></p>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">模型model的对象通常非常非常的简单。很多时候，他们就是Core Data&nbsp;<a target="_blank" href="https://developer.apple.com/library/ios/documentation/DataManagement/Devpedia-CoreData/managedObject.html#//apple_ref/doc/uid/TP40010398-CH23-SW1" style="color:#666666;text-decoration:none;font-size:12px;line-height:normal;"><span style="color:#0000ff;">managed objects</span></a>，或者避免使用Core Data，就是其他<a target="_blank" href="https://github.com/Mantle/Mantle" style="color:#666666;text-decoration:none;font-size:12px;line-height:normal;"><span style="color:#0000ff;">流行的数据模型层</span></a>。根据Apple的文档，model包括数据和操作数据的业务逻辑。在实践中，model层往往非常薄，不管怎样，model层的业务逻辑被拖入了controller。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">视图view通常是UIKit控件（component，这里根据习惯译为控件）或者编码定义的UIKit控件的集合。进入.xib或者Storyboard会发现一个app、Button、Label都是由这些可视化的和可交互的控件组成。你懂的。View不应该直接引用model，并且仅仅通过IBAction事件引用controller。业务逻辑很明显不归入view，视图本身没有任何业务。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">还有控制器controller。Controller是app的“胶水代码”：协调模型和视图之间的所有交互。控制器负责管理他们所拥有的视图的视图层次结构，还要响应视图的loading、appearing、disappearing等等，同时往往也会充满我们不愿暴露的model的模型逻辑以及不愿暴露给视图的业务逻辑。这引出了第一个关于MVC的问题...</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;"><strong>厚重的View Controller</strong></div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">由于大量的代码被放进view controller，导致他们变的相当臃肿。在iOS中有的view controller里绵延成千上万行代码的事并不是前所未见的。这些超重app的突出情况包括：厚重的View Controller很难维护（由于其庞大的规模）；包含几十个属性，使他们的状态难以管理；遵循许多协议（protocol），导致协议的响应代码和controller的逻辑代码混淆在一起。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">厚重的view controller很难测试，不管是手动测试或是使用单元测试，因为有太多可能的状态。将代码分解成更小的多个模块通常是件好事。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;"><strong>遗失的网络逻辑</strong></div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">苹果使用的MVC的定义是这么说的：所有的对象都可以被归类为一个model，一个view，或是一个controller。就这些。那么把网络代码放哪里？和一个API通信的代码应该放在哪儿？</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">你可能试着把它放在model对象里，但是也会很棘手，因为网络调用应该使用异步，这样如果一个网络请求比持有它的model生命周期更长，事情将变的复杂。显然也不应该把网络代码放在view里，因此只剩下controller了。这同样是个坏主意，因为这加剧了厚重View Controller的问题。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">那么应该放在那里呢？显然MVC的3大组件根本没有适合放这些代码的地方。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;"><strong>较差的可测试性</strong></div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">MVC的另一个大问题是,它不鼓励开发人员编写单元测试。由于view controller混合了视图处理逻辑和业务逻辑，分离这些成分的单元测试成了一个艰巨的任务。大多数人选择忽略这个任务，那就是不做任何测试。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;"><strong>定义模糊的“Manage”</strong></div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">之前我提到了view controller可以管理试图的层次结构；view controller有一个“view”属性，并且可以通过IBOutlet访问视图的任何子视图。当有很多outlet时这样做不易于扩展，在某种意义上，最好不要使用子视图控制器（child view controller）来帮助管理子视图（subview）。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">要点在哪？验证用户输入的业务逻辑应归入controller还是model呢？</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">在这里有多个模糊的标准，似乎没有人能完全达成一致。貌似无论如何，view和对应的controller都紧紧的耦合在一起，总之，还是会把它们当成一个组件来对待。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">Hey！现在有个点子...</div>
<br />
<p></p>
<p></p>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;"><strong>Model-View-ViewModel</strong></div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">在理想的世界里，MVC也许工作的很好。然而，我们生活在真实的世界。既然我们已经详细说明了MVC在典型场景中的问题，那让我们看一看一个可供替换的选择：Model-View-ViewModel。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">在MVVM里，view和view controller正式联系在一起，我们把它们视为一个组件。视图view仍然不能直接引用模型model，当然controller也不能。相反，他们引用视图模型view model。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">view model是一个放置用户输入验证逻辑，视图显示逻辑，发起网络请求和其他各种各样的代码的极好的地方。有一件事情不应归入view model，那就是任何视图本身的引用。view model的概念同时适用于于iOS和OS X。（换句话说，不要在view model中使用 #import UIKit.h）</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">由于展示逻辑（presentation logic）放在了view model中（比如model的值映射到一个格式化的字符串），视图控制器本身就会不再臃肿。当你开始使用MVVM的最好方式是，可以先将一小部分逻辑放入视图模型，然后当你逐渐习惯于使用这个范式的时候再迁移更多的逻辑到视图模型中。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">使用MVVM的iOS app是高度可测试的；因为view model包含了所有的展示逻辑并且不会引用view，所以它可以通过编程方式充分测试。虽然有<a target="_blank" href="http://programming.oreilly.com/2013/05/upward-mobility-unit-testing-core-data.html" style="color:#666666;text-decoration:none;font-size:12px;line-height:normal;"><span style="color:#0000ff;">众多的</span></a><a target="_blank" href="http://www.cimgf.com/2012/05/15/unit-testing-with-core-data/" style="color:#666666;text-decoration:none;font-size:12px;line-height:normal;"><span style="color:#0000ff;">hack技术</span></a><a target="_blank" href="http://stackoverflow.com/questions/1876568/ocmock-with-core-data-dynamic-properties-problem" style="color:#666666;text-decoration:none;font-size:12px;line-height:normal;"><span style="color:#0000ff;">参与到</span></a>测试Core Data模型，但使用MVVM写的app可以进行充分的单元测试。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">以我的经验，使用MVVM会轻微的增加代码量，但总体上减少了代码的复杂性。这是一个划算的交易。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">回过头再来看MVVM的图示，你会注意到我使用了模糊的动词“notify”和“update”，而没有详细说明该怎么做。你可以使用KVO，就像MVC那样，但这很快就会变得难以管理。事实上，<a target="_blank" href="http://www.teehanlax.com/blog/getting-started-with-reactivecocoa/" style="color:#666666;text-decoration:none;font-size:12px;line-height:normal;"><span style="color:#0000ff;">使用ReactiveCocoa</span></a>会是更好的方式来组织各个部分。</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">&nbsp;</div>
<div style="margin:0px;padding:0px;color:#333333;font-family:'Helvetica Neue', Helvetica, STheiti, 微软雅黑, 黑体, Arial, Tahoma, sans-serif, serif;">关于怎么结合ReactiveCocoa来使用MVVM的信息，可以阅读Colin Wheeler的<a target="_blank" href="http://cocoasamurai.blogspot.ca/2013/03/basic-mvvm-with-reactivecocoa.html" style="color:#666666;text-decoration:none;font-size:12px;line-height:normal;"><span style="color:#0000ff;">excellent write-up</span></a>或者看看我写的<a target="_blank" href="https://github.com/AshFurrow/C-41" style="color:#666666;text-decoration:none;font-size:12px;line-height:normal;"><span style="color:#0000ff;">开源app</span></a>。你也可以阅读我的<a target="_blank" href="https://leanpub.com/iosfrp" style="color:#666666;text-decoration:none;font-size:12px;line-height:normal;"><span style="color:#0000ff;">关于ReactiveCocoa和MVVM的书</span></a>。</div>
</div></body></html>