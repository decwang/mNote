<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2016-11-25T01:55:01Z"/><meta name="updated" content="2016-11-25T01:55:04Z"/><title>OC与Lua调用交互（不使用第三方库）  字数1222 阅读237 评论1 喜欢4  研究这块东西的起因  既不是为了当成游戏里的脚本用；也不是为了用lua调用原生控件实现跨平台；只是为了保持和我司</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><h1 class="title" style="margin:10px 0px;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.5;color:#555555;text-rendering:optimizelegibility;font-size:32px;word-break:break-all;font-variant-ligatures:normal;orphans:2;widows:2;">OC与Lua调用交互（不使用第三方库）</h1>
<div class="meta-top" style="font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;margin:20px 0px;color:#555555;font-variant-ligatures:normal;orphans:2;widows:2;"><span class="wordage" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">字数1222</span>&nbsp;<span class="views-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">阅读237</span>&nbsp;<span class="comments-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">评论1</span>&nbsp;<span class="likes-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">喜欢4</span></div>
<div class="show-content" style="color:#2f2f2f;font-size:16px;line-height:1.7;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;"><h2 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:24px;">研究这块东西的起因</h2>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">既不是为了当成游戏里的脚本用；也不是为了用lua调用原生控件实现跨平台；只是为了保持和我司Android端的部分关键算法一致，所以把这部分代码写成了lua。</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">起初查资料，会有wax、cocos2d之类的内容，但是我们并需要这么“重量级”的东西，就一个lua文件，所以最后决定用C和lua交互，自己写。</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">目前这部分东西已经在线上跑了1年+，至少是可以用的。</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">分享一部分有关键代码和最初开发思路。</p>
<h2 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:24px;">达到目标</h2>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">1.正确传参</p>
<ul style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;">基础数据格式：BOOL、Number、NSString</li>
<li style="line-height:30px;">NSArray、NSDictonary等复杂参数传入</li>
</ul>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">2.实现返回数据</p>
<ul style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;">基础数据格式：BOOL、Number、NSString</li>
<li style="line-height:30px;">NSArray、NSDictonary等复杂参数返回值</li>
</ul>
<h2 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:24px;">添加Lua</h2>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;"><a href="http://www.lua.org/download.html" target="_blank" style="color:#4094c7;text-decoration:none;">下载Lua</a>，将src目录改名为lua，拖进项目。删除掉lua.c和luac.c</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">这个时候编译是成功的。</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">我使用的版本是Lua 5.1.4，当初为了与安卓团队的第三方jar包版本保持一致。新版本应该语法有一些改变。</p>
<h2 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:24px;">Lua这边有用的东西</h2>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">这是我在调试lua的table用的print，因为会用到时间戳，所以有个地方判断了数字，lua里的print是不能输出table的格式，可比NSLog不方便多了。于是在网上搜索了下资料，最后对应我们自己的需求做了一点点调整，原网页已经找不回来了，没法放在参考链接里了。</p>
<pre class="hljs sql" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="sql" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">tab = "    "

dateOutput = true

function print_r(t)
    print_table(t, <span class="hljs-operator">0)<span class="hljs-keyword" style="color:#859900;">end</span> <span class="hljs-keyword" style="color:#859900;">function</span> print_table(<span class="hljs-keyword" style="color:#859900;">t</span>, <span class="hljs-keyword" style="color:#859900;">i</span>)
    <span class="hljs-keyword" style="color:#859900;">local</span> indent =<span class="hljs-string" style="color:#2aa198;">""</span> <span class="hljs-comment" style="color:#93a1a1;">-- i缩进，当前调用缩进</span>     <span class="hljs-keyword" style="color:#859900;">for</span> j = <span class="hljs-number" style="color:#2aa198;">0</span>, <span class="hljs-keyword" style="color:#859900;">i</span> <span class="hljs-keyword" style="color:#859900;">do</span>         indent = indent .. tab
    <span class="hljs-keyword" style="color:#859900;">end</span>     <span class="hljs-keyword" style="color:#859900;">for</span> <span class="hljs-keyword" style="color:#859900;">k</span>, v <span class="hljs-keyword" style="color:#859900;">in</span> pairs(<span class="hljs-keyword" style="color:#859900;">t</span>) <span class="hljs-keyword" style="color:#859900;">do</span>         <span class="hljs-keyword" style="color:#859900;">if</span> (<span class="hljs-keyword" style="color:#859900;">type</span>(v) == <span class="hljs-string" style="color:#2aa198;">"table"</span>) <span class="hljs-keyword" style="color:#859900;">then</span> <span class="hljs-comment" style="color:#93a1a1;">-- type(v) 当前类型时否table 如果是，则需要递归，</span>                 <span class="hljs-keyword" style="color:#859900;">local</span> <span class="hljs-keyword" style="color:#859900;">key</span> = <span class="hljs-string" style="color:#2aa198;">""</span>                 <span class="hljs-keyword" style="color:#859900;">if</span> <span class="hljs-keyword" style="color:#859900;">type</span>(<span class="hljs-keyword" style="color:#859900;">k</span>) ~= <span class="hljs-string" style="color:#2aa198;">"number"</span> <span class="hljs-keyword" style="color:#859900;">then</span>                     <span class="hljs-keyword" style="color:#859900;">key</span> = <span class="hljs-keyword" style="color:#859900;">k</span>                     <span class="hljs-keyword" style="color:#859900;">end</span>             print(indent ..<span class="hljs-keyword" style="color:#859900;">key</span>, <span class="hljs-string" style="color:#2aa198;">"{"</span>)
            print_table(v, <span class="hljs-keyword" style="color:#859900;">i</span> + <span class="hljs-number" style="color:#2aa198;">1</span>) <span class="hljs-comment" style="color:#93a1a1;">-- 递归调用</span>             print(indent .. <span class="hljs-string" style="color:#2aa198;">"}"</span>)
        <span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-comment" style="color:#93a1a1;">-- 否则直接输出当前值</span>             <span class="hljs-keyword" style="color:#859900;">if</span> (dateOutput <span class="hljs-keyword" style="color:#859900;">and</span> <span class="hljs-keyword" style="color:#859900;">type</span>(v) == <span class="hljs-string" style="color:#2aa198;">"number"</span> <span class="hljs-keyword" style="color:#859900;">and</span> v &gt; <span class="hljs-number" style="color:#2aa198;">100000</span>) <span class="hljs-keyword" style="color:#859900;">then</span>                 v = os.<span class="hljs-built_in" style="color:#268bd2;">date</span>(<span class="hljs-string" style="color:#2aa198;">"%x"</span>, v)
            <span class="hljs-keyword" style="color:#859900;">end</span>             <span class="hljs-keyword" style="color:#859900;">if</span> <span class="hljs-keyword" style="color:#859900;">type</span>(v)==<span class="hljs-string" style="color:#2aa198;">"boolean"</span> <span class="hljs-keyword" style="color:#859900;">then</span>                 v=(v <span class="hljs-keyword" style="color:#859900;">and</span> <span class="hljs-string" style="color:#2aa198;">"true"</span>) <span class="hljs-keyword" style="color:#859900;">or</span> <span class="hljs-string" style="color:#2aa198;">"false"</span>             <span class="hljs-keyword" style="color:#859900;">end</span>             print(indent  .. <span class="hljs-keyword" style="color:#859900;">k</span> .. <span class="hljs-string" style="color:#2aa198;">"="</span> .. v..<span class="hljs-string" style="color:#2aa198;">","</span>)
        <span class="hljs-keyword" style="color:#859900;">end</span>     <span class="hljs-keyword" style="color:#859900;">end</span> <span class="hljs-keyword" style="color:#859900;">end</span></span></code></pre><h2 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:24px;">Lua测试文件</h2>
<ol style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;">简单测试，在lua端成功print出东西<pre class="hljs bash" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="bash" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;"><span class="hljs-keyword" style="color:#859900;">function</span> <span class="hljs-built_in" style="color:#268bd2;">test</span>()<span class="hljs-built_in" style="color:#268bd2;">print</span>(<span class="hljs-string" style="color:#2aa198;">"成功啦!"</span>)
end</code></pre></li>
<li style="line-height:30px;">向lua传值<pre class="hljs lisp" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="lisp" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">function simpleParam<span class="hljs-list">(<span class="hljs-keyword" style="color:#859900;">value</span>)</span> print<span class="hljs-list">(<span class="hljs-keyword" style="color:#859900;">value</span>)</span> end</code></pre></li>
<li style="line-height:30px;">从lua拿值<pre class="hljs matlab" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="matlab" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;"><span class="hljs-function"><span class="hljs-keyword" style="color:#859900;">function</span> <span class="hljs-title" style="color:#268bd2;">simpleParam</span><span class="hljs-params">()</span></span> <span class="hljs-keyword" style="color:#859900;">return</span> <span class="hljs-number" style="color:#2aa198;">5</span>,<span class="hljs-number" style="color:#2aa198;">9</span> <span class="hljs-keyword" style="color:#859900;">end</span></code></pre></li>
<li style="line-height:30px;">向lua传NSArray或者NSDictionarys<pre class="hljs lisp" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="lisp" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">function complexParam<span class="hljs-list">(<span class="hljs-keyword" style="color:#859900;">value</span>)</span> print_r<span class="hljs-list">(<span class="hljs-keyword" style="color:#859900;">value</span>)</span> end</code></pre></li>
<li style="line-height:30px;">从lua拿值<pre class="hljs bash" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="bash" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;"><span class="hljs-keyword" style="color:#859900;">function</span> complexParam()<span class="hljs-built_in" style="color:#268bd2;">local</span> s1 = {name = <span class="hljs-string" style="color:#2aa198;">"a"</span>, age = <span class="hljs-number" style="color:#2aa198;">20</span>}<span class="hljs-built_in" style="color:#268bd2;">local</span> s2 = {name = <span class="hljs-string" style="color:#2aa198;">"b"</span>, age = <span class="hljs-number" style="color:#2aa198;">19</span>}<span class="hljs-built_in" style="color:#268bd2;">return</span> {s1, s2}
end</code></pre></li>
</ol>
<h2 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:24px;">OC生成Lua的state</h2>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">state = luaL_newstate();
luaL_openlibs(state);
lua_settop(state, <span class="hljs-number" style="color:#2aa198;">0</span>);<span class="hljs-built_in" style="color:#268bd2;">NSString</span> *luaFilePath = [[<span class="hljs-built_in" style="color:#268bd2;">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string" style="color:#2aa198;">@"file"</span> ofType:<span class="hljs-string" style="color:#2aa198;">@"lua"</span>];<span class="hljs-built_in" style="color:#268bd2;">NSString</span> *luaContent = [<span class="hljs-built_in" style="color:#268bd2;">NSString</span> stringWithContentsOfFile:luaFilePath
                                                 encoding:<span class="hljs-built_in" style="color:#268bd2;">NSUTF8StringEncoding</span>                                                     error:<span class="hljs-literal">nil</span>];<span class="hljs-keyword" style="color:#859900;">int</span> err;<span class="hljs-keyword" style="color:#859900;">if</span> (luaContent == <span class="hljs-literal">nil</span> || [luaContent isEqualToString: <span class="hljs-string" style="color:#2aa198;">@""</span>]) {
    <span class="hljs-built_in" style="color:#268bd2;">NSLog</span>(<span class="hljs-string" style="color:#2aa198;">@"Lua_State initial fail，lua file is nil"</span>);
}<span class="hljs-keyword" style="color:#859900;">else</span> {
    err = luaL_loadstring(state, [luaContent cStringUsingEncoding: <span class="hljs-built_in" style="color:#268bd2;">NSUTF8StringEncoding</span>]);
    <span class="hljs-keyword" style="color:#859900;">if</span> (<span class="hljs-number" style="color:#2aa198;">0</span> != err) {
        luaL_error(state, <span class="hljs-string" style="color:#2aa198;">"cannot compile the lua file: %s"</span>,
                   lua_tostring(state, -<span class="hljs-number" style="color:#2aa198;">1</span>));
        <span class="hljs-keyword" style="color:#859900;">return</span>;
    }

    err = lua_pcall(state, <span class="hljs-number" style="color:#2aa198;">0</span>, <span class="hljs-number" style="color:#2aa198;">0</span>, <span class="hljs-number" style="color:#2aa198;">0</span>);
    <span class="hljs-keyword" style="color:#859900;">if</span> (<span class="hljs-number" style="color:#2aa198;">0</span> != err) {
        luaL_error(state, <span class="hljs-string" style="color:#2aa198;">"cannot run the lua file: %s"</span>,
                   lua_tostring(state, -<span class="hljs-number" style="color:#2aa198;">1</span>));
        <span class="hljs-keyword" style="color:#859900;">return</span>;
    }

    <span class="hljs-built_in" style="color:#268bd2;">NSLog</span>(<span class="hljs-string" style="color:#2aa198;">@"Lua_state initial success"</span>);
}</code></pre><h2 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:24px;">OC调用</h2>
<ol style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;">简单测试，在lua端成功print出东西<pre class="hljs perl" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="perl" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">lua_State* <span class="hljs-keyword" style="color:#859900;">state</span> = [[LuaBinding shareBinding] <span class="hljs-keyword" style="color:#859900;">state</span>];
lua_getglobal(<span class="hljs-keyword" style="color:#859900;">state</span>,<span class="hljs-string" style="color:#2aa198;">"test"</span>);
lua_pcall(<span class="hljs-keyword" style="color:#859900;">state</span>, <span class="hljs-number" style="color:#2aa198;">0</span>, <span class="hljs-number" style="color:#2aa198;">0</span>, <span class="hljs-number" style="color:#2aa198;">0</span>);</code></pre></li>
<li style="line-height:30px;">向lua传值<pre class="hljs perl" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="perl" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">lua_State* <span class="hljs-keyword" style="color:#859900;">state</span> = [[LuaBinding shareBinding] <span class="hljs-keyword" style="color:#859900;">state</span>];
lua_getglobal(<span class="hljs-keyword" style="color:#859900;">state</span>,<span class="hljs-string" style="color:#2aa198;">"simpleParam"</span>);
lua_pushnumber(<span class="hljs-keyword" style="color:#859900;">state</span>, <span class="hljs-number" style="color:#2aa198;">7</span>);
lua_pcall(<span class="hljs-keyword" style="color:#859900;">state</span>, <span class="hljs-number" style="color:#2aa198;">1</span>, <span class="hljs-number" style="color:#2aa198;">0</span>, <span class="hljs-number" style="color:#2aa198;">0</span>);</code></pre></li>
<li style="line-height:30px;">从lua拿值<pre class="hljs perl" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="perl" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">lua_State* <span class="hljs-keyword" style="color:#859900;">state</span> = [[LuaBinding shareBinding] <span class="hljs-keyword" style="color:#859900;">state</span>];
lua_getglobal(<span class="hljs-keyword" style="color:#859900;">state</span>,<span class="hljs-string" style="color:#2aa198;">"simpleParam"</span>);
lua_pcall(<span class="hljs-keyword" style="color:#859900;">state</span>, <span class="hljs-number" style="color:#2aa198;">0</span>, <span class="hljs-number" style="color:#2aa198;">2</span>, <span class="hljs-number" style="color:#2aa198;">0</span>);
NSInteger result1 = (NSInteger)lua_tointeger(<span class="hljs-keyword" style="color:#859900;">state</span>, -<span class="hljs-number" style="color:#2aa198;">1</span>);
lua_pop(<span class="hljs-keyword" style="color:#859900;">state</span>, <span class="hljs-number" style="color:#2aa198;">1</span>);
NSInteger result2 = (NSInteger)lua_tointeger(<span class="hljs-keyword" style="color:#859900;">state</span>, -<span class="hljs-number" style="color:#2aa198;">1</span>);
lua_pop(<span class="hljs-keyword" style="color:#859900;">state</span>, <span class="hljs-number" style="color:#2aa198;">1</span>);
NSLog(<span class="hljs-variable" style="color:#b58900;">@"</span><span class="hljs-variable" style="color:#b58900;">%ld</span>,<span class="hljs-variable" style="color:#b58900;">%ld</span><span class="hljs-string" style="color:#2aa198;">", (long)result1,(long)result2);</span></code></pre></li>
<li style="line-height:30px;"><p style="margin-top:16px;margin-bottom:16px;word-break:break-word;overflow:visible;">向lua传NSArray或者NSDictionarys<br />
这里可没有可以直接用的lua_pushXXXX的东西来用了，我现在的处理方式是自己判断类型，做后pushNumber、pushString等等。听说jar包那边的是用lua的userdata之类的东西，我并没有研究了，因为当时开发需求赶，并且我对lua并没有太多兴趣...<br />
虽然我没有userdata，但是最近一次测试，我们传了1外3M的数据文件进去处理，我们只用了0.1s，而安卓的第三方库用了10s...<br />
我唯一担心的是，内存这块的东西，因为确实对C和lua并不熟悉</p>
<p style="margin-top:16px;margin-bottom:16px;word-break:break-word;overflow:visible;">代码参考</p>
<pre class="hljs scala" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="scala" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">- (void)pushObject:(id)<span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">object</span> <span class="hljs-title" style="color:#b58900;">state</span>:</span>(lua_State *)state{
unsigned int outCount = (unsigned int)[<span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">object</span> <span class="hljs-title" style="color:#b58900;">count</span>];</span> <span class="hljs-keyword" style="color:#859900;">if</span> ([<span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">object</span> <span class="hljs-title" style="color:#b58900;">isKindOfClass</span>:</span>[<span class="hljs-type" style="color:#b58900;">NSDictionary</span> <span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">class</span>]]) {</span>    lua_createtable(state, outCount, <span class="hljs-number" style="color:#2aa198;">0</span>);
   <span class="hljs-keyword" style="color:#859900;">for</span> (<span class="hljs-type" style="color:#b58900;">NSString</span>* key in <span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">object</span>) {</span>        id value = <span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">object</span>[</span>key];

       lua_pushstring(state, [key cStringUsingEncoding: <span class="hljs-type" style="color:#b58900;">NSUTF8StringEncoding</span>]);
       <span class="hljs-keyword" style="color:#859900;">if</span> ([value isKindOfClass: [<span class="hljs-type" style="color:#b58900;">NSString</span> <span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">class</span>]]) {</span>            lua_pushstring(state, [value cStringUsingEncoding: <span class="hljs-type" style="color:#b58900;">NSUTF8StringEncoding</span>]);
       } <span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-keyword" style="color:#859900;">if</span>([value isKindOfClass: [<span class="hljs-type" style="color:#b58900;">NSNumber</span> <span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">class</span>]]) {</span>            lua_pushnumber(state, [value doubleValue]);
       } <span class="hljs-keyword" style="color:#859900;">else</span> {
           [self pushObject:value state:state];
       }

       lua_rawset(state, -<span class="hljs-number" style="color:#2aa198;">3</span>);
   }
} <span class="hljs-keyword" style="color:#859900;">else</span> {
   lua_createtable(state, outCount, <span class="hljs-number" style="color:#2aa198;">0</span>);
   <span class="hljs-keyword" style="color:#859900;">for</span> (int i = <span class="hljs-number" style="color:#2aa198;">0</span>; i &lt; outCount; i++) {
       lua_pushinteger(state, i + <span class="hljs-number" style="color:#2aa198;">1</span>);

       id element = <span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">object</span>[</span>i];
       <span class="hljs-keyword" style="color:#859900;">if</span> ([element isKindOfClass: [<span class="hljs-type" style="color:#b58900;">NSString</span> <span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">class</span>]]) {</span>            lua_pushstring(state, [element cStringUsingEncoding: <span class="hljs-type" style="color:#b58900;">NSUTF8StringEncoding</span>]);
       } <span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-keyword" style="color:#859900;">if</span>([element isKindOfClass: [<span class="hljs-type" style="color:#b58900;">NSNumber</span> <span class="hljs-class"><span class="hljs-keyword" style="color:#859900;">class</span>]]) {</span>            lua_pushnumber(state, [element doubleValue]);
       } <span class="hljs-keyword" style="color:#859900;">else</span> {
           [self pushObject:element state:state];
       }

       lua_settable(state, -<span class="hljs-number" style="color:#2aa198;">3</span>);
   }
}
}</code></pre></li>
<li style="line-height:30px;"><p style="margin-top:16px;margin-bottom:16px;word-break:break-word;overflow:visible;">从lua拿NSArray或者NSDictionarys<br />
与第4条一样，没有现成的lua_toXXXX可用。</p>
<p style="margin-top:16px;margin-bottom:16px;word-break:break-word;overflow:visible;">参考代码</p>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">- (<span class="hljs-keyword" style="color:#859900;">id</span>)readLuaTable:(lua_State *)state{<span class="hljs-keyword" style="color:#859900;">int</span> index = lua_gettop(state);
lua_pushnil(state);<span class="hljs-keyword" style="color:#859900;">id</span> info = <span class="hljs-literal">nil</span>;<span class="hljs-keyword" style="color:#859900;">while</span>(lua_next(state, index) != <span class="hljs-number" style="color:#2aa198;">0</span>)
{
   <span class="hljs-keyword" style="color:#859900;">if</span> (info == <span class="hljs-literal">nil</span>) {
       <span class="hljs-keyword" style="color:#859900;">if</span> (lua_type(state, -<span class="hljs-number" style="color:#2aa198;">2</span>) == LUA_TNUMBER) {
           info = [<span class="hljs-built_in" style="color:#268bd2;">NSMutableArray</span> array];
       }<span class="hljs-keyword" style="color:#859900;">else</span> {
           info = [<span class="hljs-built_in" style="color:#268bd2;">NSMutableDictionary</span> dictionary];
       }
   }

   <span class="hljs-keyword" style="color:#859900;">if</span>(lua_isnumber(state, -<span class="hljs-number" style="color:#2aa198;">1</span>)){
       <span class="hljs-keyword" style="color:#859900;">double</span> value = lua_tonumber(state, -<span class="hljs-number" style="color:#2aa198;">1</span>);
       <span class="hljs-keyword" style="color:#859900;">if</span> ([info isKindOfClass: [<span class="hljs-built_in" style="color:#268bd2;">NSMutableDictionary</span> class]]) {
           [info setObject: @(value)
                    forKey: [<span class="hljs-built_in" style="color:#268bd2;">NSString</span> stringWithUTF8String: lua_tostring(state, -<span class="hljs-number" style="color:#2aa198;">2</span>)]];
       }<span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-keyword" style="color:#859900;">if</span> ([info isKindOfClass: [<span class="hljs-built_in" style="color:#268bd2;">NSMutableArray</span> class]]) {
           [info addObject: @(value)];
       }
   }
   <span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-keyword" style="color:#859900;">if</span>(lua_isstring(state, -<span class="hljs-number" style="color:#2aa198;">1</span>)){
       <span class="hljs-keyword" style="color:#859900;">const</span> <span class="hljs-keyword" style="color:#859900;">char</span>* value = lua_tostring(state, -<span class="hljs-number" style="color:#2aa198;">1</span>);
       <span class="hljs-keyword" style="color:#859900;">if</span> ([info isKindOfClass: [<span class="hljs-built_in" style="color:#268bd2;">NSMutableDictionary</span> class]]) {
           [info setObject: [<span class="hljs-built_in" style="color:#268bd2;">NSString</span> stringWithUTF8String: value]
                    forKey: [<span class="hljs-built_in" style="color:#268bd2;">NSString</span> stringWithUTF8String: lua_tostring(state, -<span class="hljs-number" style="color:#2aa198;">2</span>)]];
       }<span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-keyword" style="color:#859900;">if</span> ([info isKindOfClass: [<span class="hljs-built_in" style="color:#268bd2;">NSMutableArray</span> class]]) {
           [info addObject: [<span class="hljs-built_in" style="color:#268bd2;">NSString</span> stringWithUTF8String: value]];
       }
   }
   <span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-keyword" style="color:#859900;">if</span>(lua_isboolean(state, -<span class="hljs-number" style="color:#2aa198;">1</span>)){
       <span class="hljs-built_in" style="color:#268bd2;">BOOL</span> value = lua_toboolean(state, -<span class="hljs-number" style="color:#2aa198;">1</span>);
       <span class="hljs-keyword" style="color:#859900;">if</span> ([info isKindOfClass: [<span class="hljs-built_in" style="color:#268bd2;">NSMutableDictionary</span> class]]) {
           [info setObject: @(value)
                    forKey: [<span class="hljs-built_in" style="color:#268bd2;">NSString</span> stringWithUTF8String: lua_tostring(state, -<span class="hljs-number" style="color:#2aa198;">2</span>)]];
       }<span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-keyword" style="color:#859900;">if</span> ([info isKindOfClass: [<span class="hljs-built_in" style="color:#268bd2;">NSMutableArray</span> class]]) {
           [info addObject: @(value)];
       }
   }
   <span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-keyword" style="color:#859900;">if</span>(lua_istable(state, -<span class="hljs-number" style="color:#2aa198;">1</span>)){
       <span class="hljs-keyword" style="color:#859900;">id</span> value = [<span class="hljs-keyword" style="color:#859900;">self</span> readLuaTable: state];
       <span class="hljs-keyword" style="color:#859900;">if</span> (value != <span class="hljs-literal">nil</span> &amp;&amp; [info isKindOfClass: [<span class="hljs-built_in" style="color:#268bd2;">NSMutableDictionary</span> class]]) {
           [info setObject: value
                    forKey: [<span class="hljs-built_in" style="color:#268bd2;">NSString</span> stringWithUTF8String: lua_tostring(state, -<span class="hljs-number" style="color:#2aa198;">2</span>)]];
       }<span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-keyword" style="color:#859900;">if</span> (value != <span class="hljs-literal">nil</span> &amp;&amp; [info isKindOfClass: [<span class="hljs-built_in" style="color:#268bd2;">NSMutableArray</span> class]]) {
           [info addObject: value];
       }
   }<span class="hljs-keyword" style="color:#859900;">else</span> {
       <span class="hljs-built_in" style="color:#268bd2;">NSLog</span>(<span class="hljs-string" style="color:#2aa198;">@"未识别lua的类型"</span>);
   }

   lua_pop(state, <span class="hljs-number" style="color:#2aa198;">1</span>);
}<span class="hljs-keyword" style="color:#859900;">return</span> info;
}</code></pre><h2 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:24px;">参考</h2>
<p style="margin-top:16px;margin-bottom:16px;word-break:break-word;overflow:visible;"><a href="http://blog.stokedsoftware.com/blog/2012/02/04/scripting-ios-games-with-lua/" target="_blank" style="color:#4094c7;text-decoration:none;">http://blog.stokedsoftware.com/blog/2012/02/04/scripting-ios-games-with-lua/</a></p>
</li>
</ol>
</div></body></html>