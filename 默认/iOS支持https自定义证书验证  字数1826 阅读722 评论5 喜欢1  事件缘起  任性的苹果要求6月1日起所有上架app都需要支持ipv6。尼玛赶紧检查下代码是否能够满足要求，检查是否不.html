<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2016-12-03T06:03:31Z"/><meta name="updated" content="2016-12-03T06:03:33Z"/><title>iOS支持https自定义证书验证  字数1826 阅读722 评论5 喜欢1  事件缘起  任性的苹果要求6月1日起所有上架app都需要支持ipv6。尼玛赶紧检查下代码是否能够满足要求，检查是否不</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div class="article" style="bottom:0px;padding:80px 40px 10px;color:#555555;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;"><div class="preview"><h1 class="title" style="margin:10px 0px;font-family:inherit;line-height:1.5;color:inherit;text-rendering:optimizelegibility;font-size:32px;word-break:break-all;">iOS支持https自定义证书验证</h1>
<div class="meta-top" style="margin:20px 0px;"><span class="wordage" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">字数1826</span>&nbsp;<span class="views-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">阅读722</span>&nbsp;<span class="comments-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">评论5</span>&nbsp;<span class="likes-count" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;">喜欢1</span></div>
<div class="show-content" style="color:#2f2f2f;font-size:16px;line-height:1.7;"><h4 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:20px;">事件缘起</h4>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">任性的苹果要求6月1日起所有上架app都需要支持ipv6。尼玛赶紧检查下代码是否能够满足要求，检查是否不兼容IPv6点击<a href="http://www.cocoachina.com/ios/20160523/16385.html" target="_blank" style="color:#4094c7;text-decoration:none;">这里</a>。结果是一个大大的懵逼啊。项目使用的AFNetworking根本就没升级还停留在2.0阶段，顿时心中策马奔腾啊。果断升级之，本以为很easy，分分钟搞定的事情，结果。。。</p>
<h4 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:20px;">问题</h4>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">AFNetworking 2.0 -&gt;AFNetworking 3.0发生了很大变化，废弃了很多的类的同时，基本构架也发生了很大的变化。<br />
AFNetworking 2.0使用NSURLConnection的基础API。<br />
AFNetworking 3.0现已完全基于NSURLSession的API，这降低了维护的负担，同时支持苹果增强关于NSURLSession提供的任何额外功能。（以后苹果所有基于网络的功能，都会使用NSURLSession来扩展。在NSURLConnection类中也说明&nbsp;<code style="padding:2px 4px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#657b83;border-radius:3px;background-color:#fdf6e3;border:none;white-space:pre-wrap;">DEPRECATED: The NSURLConnection class should no longer be used.  NSURLSession is the replacement for NSURLConnection</code>）为什么要使用NSURLConnection<a href="http://www.jianshu.com/p/5969bbb4af9f" target="_blank" style="color:#4094c7;text-decoration:none;">这里</a>一篇文章从性能方面进行了分析</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">AFNetworking 3.0相对于2.0具体来说</p>
<ul style="padding:0px;margin:0px 0px 20px 25px;text-align:justify;word-break:break-word;"><li style="line-height:30px;">弃用类<pre class="hljs undefined" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">AFURLConnectionOperation
AFHTTPRequestOperation
AFHTTPRequestOperationManager</code></pre></li>
<li style="line-height:30px;">修改的类<br />
下面的类包含基于NSURLConnection的API的内部实现。他们已经被使用NSURLSession重构:<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;"><span class="hljs-built_in" style="color:#268bd2;">UIImageView</span>+AFNetworking<span class="hljs-built_in" style="color:#268bd2;">UIWebView</span>+AFNetworking<span class="hljs-built_in" style="color:#268bd2;">UIButton</span>+AFNetworking</code></pre></li>
</ul>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">3.0和2.0类对比</p>
<div class="image-package imagebubble" widget="ImageBubble" style="margin:0px auto 20px;text-align:center;"><img src="http://upload-images.jianshu.io/upload_images/1101711-2f87d9a3d9d08955.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/1101711-2f87d9a3d9d08955.png?imageMogr2/auto-orient/strip%7CimageView2/2" class="imagebubble-image" style="height:auto;vertical-align:middle;border:0px;cursor:-webkit-zoom-in;transition:all 0.25s ease-in-out;-webkit-transition:all 0.25s ease-in-out;" /><br />
<div class="image-caption" style="min-width:20%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid #d9d9d9;font-size:13px;color:#999999;font-style:italic;line-height:1.7;">AFNetworking2.0</div>
</div>
<div class="image-package imagebubble" widget="ImageBubble" style="margin:0px auto 20px;text-align:center;"><img src="http://upload-images.jianshu.io/upload_images/1101711-072baebd9f966f8b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/1101711-072baebd9f966f8b.png?imageMogr2/auto-orient/strip%7CimageView2/2" class="imagebubble-image" style="height:auto;vertical-align:middle;border:0px;cursor:-webkit-zoom-in;transition:all 0.25s ease-in-out;-webkit-transition:all 0.25s ease-in-out;" /><br />
<div class="image-caption" style="min-width:20%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid #d9d9d9;font-size:13px;color:#999999;font-style:italic;line-height:1.7;">AFNetworking3.0</div>
</div>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;"><br />
检查我们原来的代码实现，发现我们恰恰就使用了废弃的类AFHTTPRequestOperation。我们原来的网络库竟然一直不升级我也是醉了。对此我只能说：让我来。<br />
使用最新的AFURLSessionManager来发送网络请求就是了。</p>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">    <span class="hljs-built_in" style="color:#268bd2;">NSURL</span> *URL = [<span class="hljs-built_in" style="color:#268bd2;">NSURL</span> URLWithString:MyURL];
    <span class="hljs-built_in" style="color:#268bd2;">NSMutableURLRequest</span> *request = [<span class="hljs-built_in" style="color:#268bd2;">NSMutableURLRequest</span> requestWithURL:URL];
    [request setHTTPMethod:<span class="hljs-string" style="color:#2aa198;">@"POST"</span>];
    [request setTimeoutInterval:<span class="hljs-number" style="color:#2aa198;">10</span>];
    [request setHTTPBody:[jsonStr dataUsingEncoding:<span class="hljs-built_in" style="color:#268bd2;">NSUTF8StringEncoding</span>]];
    request<span class="hljs-variable" style="color:#b58900;">.cachePolicy</span> = <span class="hljs-built_in" style="color:#268bd2;">NSURLRequestReturnCacheDataElseLoad</span>;

    <span class="hljs-built_in" style="color:#268bd2;">NSURLSessionConfiguration</span> *config = [<span class="hljs-built_in" style="color:#268bd2;">NSURLSessionConfiguration</span> defaultSessionConfiguration];
    config<span class="hljs-variable" style="color:#b58900;">.HTTPMaximumConnectionsPerHost</span> = <span class="hljs-number" style="color:#2aa198;">1</span>;
    AFURLSessionManager *manager = [[AFURLSessionManager alloc] initWithSessionConfiguration:config];

    <span class="hljs-built_in" style="color:#268bd2;">NSURLSessionDataTask</span> *dataTask = [manager dataTaskWithRequest:request completionHandler:^(<span class="hljs-built_in" style="color:#268bd2;">NSURLResponse</span> * _Nonnull response, <span class="hljs-keyword" style="color:#859900;">id</span>  _Nullable responseObject, <span class="hljs-built_in" style="color:#268bd2;">NSError</span> * _Nullable error) {

        <span class="hljs-keyword" style="color:#859900;">if</span> (error) {
            <span class="hljs-built_in" style="color:#268bd2;">NSLog</span>(<span class="hljs-string" style="color:#2aa198;">@"没有网络--- error---%@"</span>, error);
        } <span class="hljs-keyword" style="color:#859900;">else</span> {
            <span class="hljs-built_in" style="color:#268bd2;">NSLog</span>(<span class="hljs-string" style="color:#2aa198;">@"网络是通的"</span>);
            <span class="hljs-built_in" style="color:#268bd2;">NSDictionary</span>* dict = responseObject;
        }
    }];

    [dataTask resume];</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">发现打印结果：<strong>没有网络 NSURLSession/NSURLConnection HTTP load failed (kCFStreamErrorDomainSSL, -9813)</strong></p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">检查Info.plist中退回到http配置</p>
<pre class="hljs xml" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="xml" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;"><span class="hljs-tag">&lt;<span class="hljs-title" style="color:#268bd2;">key</span>&gt;</span>NSAppTransportSecurity<span class="hljs-tag">&lt;/<span class="hljs-title" style="color:#268bd2;">key</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title" style="color:#268bd2;">dict</span>&gt;</span>     <span class="hljs-tag">&lt;<span class="hljs-title" style="color:#268bd2;">key</span>&gt;</span>NSAllowsArbitraryLoads<span class="hljs-tag">&lt;/<span class="hljs-title" style="color:#268bd2;">key</span>&gt;</span>     <span class="hljs-tag">&lt;<span class="hljs-title" style="color:#268bd2;">true</span>/&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title" style="color:#268bd2;">dict</span>&gt;</span></code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">也增加了。why？<br />
结果：原因是苹果的&nbsp;<a href="https://developer.apple.com/library/prerelease/ios/technotes/App-Transport-Security-Technote/" target="_blank" style="color:#4094c7;text-decoration:none;">官方资料&nbsp;</a>说首先必须要基于TLS 1.2版本协议。然后证书的加密的算法还需要达到SHA256或者更高位的RSA密钥或ECC密钥，如果不符合，请求将被中断并返回nil。原来我们需要验证证书啊。</p>
<h4 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:20px;">解决办法</h4>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">在AFNetworking中，只要通过下面的代码，你就可以使用自签证书来访问HTTPS</p>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">    AFSecurityPolicy *securityPolicy = [AFSecurityPolicy defaultPolicy];
    <span class="hljs-comment" style="color:#93a1a1;">//是否允许不信任的证书（证书无效、证书时间过期）通过验证 ，默认为NO</span>     securityPolicy<span class="hljs-variable" style="color:#b58900;">.allowInvalidCertificates</span> = <span class="hljs-literal">YES</span>;</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">这么做有个问题，就是你无法验证证书是否是你的服务器后端的证书，给中间人攻击留下了漏洞，可以通过重定向路由来分析伪造你的服务器端打开了大门。</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">AFNetworking是允许内嵌证书的，通过内嵌证书，AFNetworking就通过比对服务器端证书、内嵌的证书、站点域名是否一致来验证连接的服务器是否正确。由于CA证书验证是通过站点域名进行验证的，如果你的服务器后端有绑定的域名，这是最方便的。将你的服务器端证书，如果是pem格式的，用下面的命令转成cer格式</p>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">openssl x509 - <span class="hljs-keyword" style="color:#859900;">in</span> &lt;你的服务器证书&gt;<span class="hljs-variable" style="color:#b58900;">.pem</span> -outform der -<span class="hljs-keyword" style="color:#859900;">out</span> test<span class="hljs-variable" style="color:#b58900;">.cer</span></code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">然后将生成的test.cer文件，如果有自建ca，再加上ca的cer格式证书，引入到app的bundle里，然后在网络请求的地方做如下设置</p>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">AFSecurityPolicy *securityPolicy = [AFSecurityPolicy AFSSLPinningModeCertificate];
或者
AFSecurityPolicy *securityPolicy = [AFSecurityPolicy AFSSLPinningModePublicKey];
securityPolicy<span class="hljs-variable" style="color:#b58900;">.allowInvalidCertificates</span> = <span class="hljs-literal">YES</span>;</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">如果app的bundle没有这个证书，会报错：<br />
<code style="padding:2px 4px;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#657b83;border-radius:3px;background-color:#fdf6e3;border:none;white-space:pre-wrap;">In order to validate a domain name for self signed certificates, you MUST use pinning.</code><br />
这个pinning，指的是证书锁定，意思就是只有client包含的证书和服务器的证书一致时，才能通过验证。<br />
查看AFNetworking的源代码,有如下核心方法<br />
<strong>- evaluateServerTrust:forDomain:</strong>详情参考<a href="https://github.com/Draveness/iOS-Source-Code-Analyze/blob/master/AFNetworking/%E9%AA%8C%E8%AF%81%20HTTPS%20%E8%AF%B7%E6%B1%82%E7%9A%84%E8%AF%81%E4%B9%A6%EF%BC%88%E4%BA%94%EF%BC%89.md" target="_blank" style="color:#4094c7;text-decoration:none;">这里</a></p>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">- (<span class="hljs-built_in" style="color:#268bd2;">BOOL</span>)evaluateServerTrust:(SecTrustRef)serverTrust
                  forDomain:(<span class="hljs-built_in" style="color:#268bd2;">NSString</span> *)domain
{
    <span class="hljs-keyword" style="color:#859900;">if</span> (domain &amp;&amp; <span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.allowInvalidCertificates</span> &amp;&amp; <span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.validatesDomainName</span> &amp;&amp; (<span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.SSLPinningMode</span> == AFSSLPinningModeNone || [<span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.pinnedCertificates</span> count] == <span class="hljs-number" style="color:#2aa198;">0</span>)) {
        <span class="hljs-comment" style="color:#93a1a1;">// https://developer.apple.com/library/mac/documentation/NetworkingInternet/Conceptual/NetworkingTopics/Articles/OverridingSSLChainValidationCorrectly.html</span>         <span class="hljs-comment" style="color:#93a1a1;">//  According to the docs, you should only trust your provided certs for evaluation.</span>         <span class="hljs-comment" style="color:#93a1a1;">//  Pinned certificates are added to the trust. Without pinned certificates,</span>         <span class="hljs-comment" style="color:#93a1a1;">//  there is nothing to evaluate against.</span>         <span class="hljs-comment" style="color:#93a1a1;">//</span>         <span class="hljs-comment" style="color:#93a1a1;">//  From Apple Docs:</span>         <span class="hljs-comment" style="color:#93a1a1;">//          "Do not implicitly trust self-signed certificates as anchors (kSecTrustOptionImplicitAnchors).</span>         <span class="hljs-comment" style="color:#93a1a1;">//           Instead, add your own (self-signed) CA certificate to the list of trusted anchors."</span>         <span class="hljs-built_in" style="color:#268bd2;">NSLog</span>(<span class="hljs-string" style="color:#2aa198;">@"In order to validate a domain name for self signed certificates, you MUST use pinning."</span>);
        <span class="hljs-keyword" style="color:#859900;">return</span> <span class="hljs-literal">NO</span>;
    }

    <span class="hljs-built_in" style="color:#268bd2;">NSMutableArray</span> *policies = [<span class="hljs-built_in" style="color:#268bd2;">NSMutableArray</span> array];
    <span class="hljs-keyword" style="color:#859900;">if</span> (<span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.validatesDomainName</span>) {
        [policies addObject:(__bridge_transfer <span class="hljs-keyword" style="color:#859900;">id</span>)SecPolicyCreateSSL(<span class="hljs-literal">true</span>, (__bridge <span class="hljs-built_in" style="color:#268bd2;">CFStringRef</span>)domain)];
    } <span class="hljs-keyword" style="color:#859900;">else</span> {
        [policies addObject:(__bridge_transfer <span class="hljs-keyword" style="color:#859900;">id</span>)SecPolicyCreateBasicX509()];
    }

    SecTrustSetPolicies(serverTrust, (__bridge <span class="hljs-built_in" style="color:#268bd2;">CFArrayRef</span>)policies);

    <span class="hljs-keyword" style="color:#859900;">if</span> (<span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.SSLPinningMode</span> == AFSSLPinningModeNone) {
        <span class="hljs-keyword" style="color:#859900;">return</span> <span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.allowInvalidCertificates</span> || AFServerTrustIsValid(serverTrust);
    } <span class="hljs-keyword" style="color:#859900;">else</span> <span class="hljs-keyword" style="color:#859900;">if</span> (!AFServerTrustIsValid(serverTrust) &amp;&amp; !<span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.allowInvalidCertificates</span>) {
        <span class="hljs-keyword" style="color:#859900;">return</span> <span class="hljs-literal">NO</span>;
    }

    <span class="hljs-keyword" style="color:#859900;">switch</span> (<span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.SSLPinningMode</span>) {
        <span class="hljs-keyword" style="color:#859900;">case</span> AFSSLPinningModeNone:
        <span class="hljs-keyword" style="color:#859900;">default</span>:
            <span class="hljs-keyword" style="color:#859900;">return</span> <span class="hljs-literal">NO</span>;
        <span class="hljs-keyword" style="color:#859900;">case</span> AFSSLPinningModeCertificate: {
            <span class="hljs-built_in" style="color:#268bd2;">NSMutableArray</span> *pinnedCertificates = [<span class="hljs-built_in" style="color:#268bd2;">NSMutableArray</span> array];
            <span class="hljs-keyword" style="color:#859900;">for</span> (<span class="hljs-built_in" style="color:#268bd2;">NSData</span> *certificateData <span class="hljs-keyword" style="color:#859900;">in</span> <span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.pinnedCertificates</span>) {
                [pinnedCertificates addObject:(__bridge_transfer <span class="hljs-keyword" style="color:#859900;">id</span>)SecCertificateCreateWithData(<span class="hljs-literal">NULL</span>, (__bridge <span class="hljs-built_in" style="color:#268bd2;">CFDataRef</span>)certificateData)];
            }
            SecTrustSetAnchorCertificates(serverTrust, (__bridge <span class="hljs-built_in" style="color:#268bd2;">CFArrayRef</span>)pinnedCertificates);

            <span class="hljs-keyword" style="color:#859900;">if</span> (!AFServerTrustIsValid(serverTrust)) {
                <span class="hljs-keyword" style="color:#859900;">return</span> <span class="hljs-literal">NO</span>;
            }

            <span class="hljs-comment" style="color:#93a1a1;">// obtain the chain after being validated, which *should* contain the pinned certificate in the last position (if it's the Root CA)</span>             <span class="hljs-built_in" style="color:#268bd2;">NSArray</span> *serverCertificates = AFCertificateTrustChainForServerTrust(serverTrust);

            <span class="hljs-keyword" style="color:#859900;">for</span> (<span class="hljs-built_in" style="color:#268bd2;">NSData</span> *trustChainCertificate <span class="hljs-keyword" style="color:#859900;">in</span> [serverCertificates reverseObjectEnumerator]) {
                <span class="hljs-keyword" style="color:#859900;">if</span> ([<span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.pinnedCertificates</span> containsObject:trustChainCertificate]) {
                    <span class="hljs-keyword" style="color:#859900;">return</span> <span class="hljs-literal">YES</span>;
                }
            }

            <span class="hljs-keyword" style="color:#859900;">return</span> <span class="hljs-literal">NO</span>;
        }
        <span class="hljs-keyword" style="color:#859900;">case</span> AFSSLPinningModePublicKey: {
            <span class="hljs-built_in" style="color:#268bd2;">NSUInteger</span> trustedPublicKeyCount = <span class="hljs-number" style="color:#2aa198;">0</span>;
            <span class="hljs-built_in" style="color:#268bd2;">NSArray</span> *publicKeys = AFPublicKeyTrustChainForServerTrust(serverTrust);

            <span class="hljs-keyword" style="color:#859900;">for</span> (<span class="hljs-keyword" style="color:#859900;">id</span> trustChainPublicKey <span class="hljs-keyword" style="color:#859900;">in</span> publicKeys) {
                <span class="hljs-keyword" style="color:#859900;">for</span> (<span class="hljs-keyword" style="color:#859900;">id</span> pinnedPublicKey <span class="hljs-keyword" style="color:#859900;">in</span> <span class="hljs-keyword" style="color:#859900;">self</span><span class="hljs-variable" style="color:#b58900;">.pinnedPublicKeys</span>) {
                    <span class="hljs-keyword" style="color:#859900;">if</span> (AFSecKeyIsEqualToKey((__bridge SecKeyRef)trustChainPublicKey, (__bridge SecKeyRef)pinnedPublicKey)) {
                        trustedPublicKeyCount += <span class="hljs-number" style="color:#2aa198;">1</span>;
                    }
                }
            }
            <span class="hljs-keyword" style="color:#859900;">return</span> trustedPublicKeyCount &gt; <span class="hljs-number" style="color:#2aa198;">0</span>;
        }
    }

    <span class="hljs-keyword" style="color:#859900;">return</span> <span class="hljs-literal">NO</span>;
}</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">关于签名证书：AFnetworking默认会去程序中寻找所有cer文件，并找符合要求的。当然我们也可以指定的cer文件名称：</p>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">    <span class="hljs-built_in" style="color:#268bd2;">NSURLSessionConfiguration</span> *config = [<span class="hljs-built_in" style="color:#268bd2;">NSURLSessionConfiguration</span> defaultSessionConfiguration];
    config<span class="hljs-variable" style="color:#b58900;">.HTTPMaximumConnectionsPerHost</span> = <span class="hljs-number" style="color:#2aa198;">1</span>;
    AFURLSessionManager *manager = [[AFURLSessionManager alloc] initWithSessionConfiguration:config];

    AFSecurityPolicy *securityPolicy = [AFSecurityPolicy policyWithPinningMode: AFSSLPinningModeCertificate];
    <span class="hljs-built_in" style="color:#268bd2;">NSString</span> *certificatePath = [[<span class="hljs-built_in" style="color:#268bd2;">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string" style="color:#2aa198;">@"test"</span> ofType:<span class="hljs-string" style="color:#2aa198;">@"cer"</span>];
    <span class="hljs-built_in" style="color:#268bd2;">NSData</span> *certificateData = [<span class="hljs-built_in" style="color:#268bd2;">NSData</span> dataWithContentsOfFile:certificatePath];

    <span class="hljs-built_in" style="color:#268bd2;">NSSet</span> *certificateSet  = [[<span class="hljs-built_in" style="color:#268bd2;">NSSet</span> alloc] initWithObjects:certificateData, <span class="hljs-literal">nil</span>];
    [securityPolicy setPinnedCertificates:certificateSet];
    securityPolicy<span class="hljs-variable" style="color:#b58900;">.allowInvalidCertificates</span> = <span class="hljs-literal">YES</span>;
    securityPolicy<span class="hljs-variable" style="color:#b58900;">.validatesDomainName</span> = <span class="hljs-literal">NO</span>;
    manager<span class="hljs-variable" style="color:#b58900;">.securityPolicy</span> = securityPolicy;</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">至此AFSecurityPolicy就只会比对服务器证书和内嵌证书是否一致，不会再验证证书是否和站点域名一致了。<br />
　　这么做为什么是安全的？了解HTTPS的人都知道，整个验证体系中，最核心的实际上是服务器的私钥。私钥永远，永远也不会离开服务器，或者以任何形式向外传输。私钥和公钥是配对的，如果事先在客户端预留了公钥，只要服务器端的公钥和预留的公钥一致，实际上就已经可以排除中间人攻击了。</p>
<h4 style="margin:0px;font-family:inherit;line-height:1.8;color:inherit;text-rendering:optimizelegibility;font-size:20px;">最后</h4>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">最后完整验证证书代码</p>
<pre class="hljs objectivec" style="padding:9.5px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;color:#657b83;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;margin-top:0px;margin-bottom:20px;line-height:20px;word-break:break-all;word-wrap:normal;background-color:#fdf6e3;border:1px solid rgba(0, 0, 0, 0.14902);overflow:auto;background-position:initial initial;background-repeat:initial initial;"><code class="objectivec" style="padding:0px;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;background-color:transparent;border:none;">    <span class="hljs-built_in" style="color:#268bd2;">NSURL</span> *URL = [<span class="hljs-built_in" style="color:#268bd2;">NSURL</span> URLWithString:URL_FRONT];
    <span class="hljs-built_in" style="color:#268bd2;">NSMutableURLRequest</span> *request = [<span class="hljs-built_in" style="color:#268bd2;">NSMutableURLRequest</span> requestWithURL:URL];
    [request setHTTPMethod:<span class="hljs-string" style="color:#2aa198;">@"POST"</span>];
    [request setTimeoutInterval:<span class="hljs-number" style="color:#2aa198;">10</span>];<span class="hljs-comment" style="color:#93a1a1;">//设置超时</span>     [request setHTTPBody:[jsonStr dataUsingEncoding:<span class="hljs-built_in" style="color:#268bd2;">NSUTF8StringEncoding</span>]];
    request<span class="hljs-variable" style="color:#b58900;">.cachePolicy</span> = <span class="hljs-built_in" style="color:#268bd2;">NSURLRequestReturnCacheDataElseLoad</span>;<span class="hljs-comment" style="color:#93a1a1;">// 设置缓存策略</span>     <span class="hljs-built_in" style="color:#268bd2;">NSURLSessionConfiguration</span> *config = [<span class="hljs-built_in" style="color:#268bd2;">NSURLSessionConfiguration</span> defaultSessionConfiguration];
    config<span class="hljs-variable" style="color:#b58900;">.HTTPMaximumConnectionsPerHost</span> = <span class="hljs-number" style="color:#2aa198;">1</span>;
    AFURLSessionManager *manager = [[AFURLSessionManager alloc] initWithSessionConfiguration:config];

    <span class="hljs-comment" style="color:#93a1a1;">// 安全验证</span>     AFSecurityPolicy *securityPolicy = [AFSecurityPolicy policyWithPinningMode: AFSSLPinningModeCertificate];
    <span class="hljs-built_in" style="color:#268bd2;">NSString</span> *certificatePath = [[<span class="hljs-built_in" style="color:#268bd2;">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string" style="color:#2aa198;">@"test"</span> ofType:<span class="hljs-string" style="color:#2aa198;">@"cer"</span>];
    <span class="hljs-built_in" style="color:#268bd2;">NSData</span> *certificateData = [<span class="hljs-built_in" style="color:#268bd2;">NSData</span> dataWithContentsOfFile:certificatePath];

    <span class="hljs-built_in" style="color:#268bd2;">NSSet</span> *certificateSet  = [[<span class="hljs-built_in" style="color:#268bd2;">NSSet</span> alloc] initWithObjects:certificateData, <span class="hljs-literal">nil</span>];
    [securityPolicy setPinnedCertificates:certificateSet];
    securityPolicy<span class="hljs-variable" style="color:#b58900;">.allowInvalidCertificates</span> = <span class="hljs-literal">YES</span>;
    securityPolicy<span class="hljs-variable" style="color:#b58900;">.validatesDomainName</span> = <span class="hljs-literal">NO</span>;
    manager<span class="hljs-variable" style="color:#b58900;">.securityPolicy</span> = securityPolicy;

    <span class="hljs-built_in" style="color:#268bd2;">NSURLSessionDataTask</span> *dataTask = [manager dataTaskWithRequest:request completionHandler:^(<span class="hljs-built_in" style="color:#268bd2;">NSURLResponse</span> * _Nonnull response, <span class="hljs-keyword" style="color:#859900;">id</span>  _Nullable responseObject, <span class="hljs-built_in" style="color:#268bd2;">NSError</span> * _Nullable error) {

        <span class="hljs-keyword" style="color:#859900;">if</span> (error) {
            <span class="hljs-built_in" style="color:#268bd2;">NSLog</span>(<span class="hljs-string" style="color:#2aa198;">@"没有网络--- error---%@"</span>, error);

        } <span class="hljs-keyword" style="color:#859900;">else</span> {
            <span class="hljs-built_in" style="color:#268bd2;">NSLog</span>(<span class="hljs-string" style="color:#2aa198;">@"网络是通的"</span>);
            <span class="hljs-built_in" style="color:#268bd2;">NSLog</span>(<span class="hljs-string" style="color:#2aa198;">@"%@ %@"</span>, response, responseObject);
        }

    }];

    [dataTask resume];</code></pre><p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">如有错误，欢迎指正！</p>
<p style="margin-top:0px;margin-bottom:25px;text-align:justify;word-break:break-word;">参考：<a href="https://github.com/AFNetworking/AFNetworking/issues/3524" target="_blank" style="color:#4094c7;text-decoration:none;">Use AFN request https #3524</a><br />
<a href="http://swiftcafe.io/2016/04/12/https/" target="_blank" style="color:#4094c7;text-decoration:none;">https</a></p>
</div>
</div>
</div>
<div class="visitor_edit" style="width:620px;margin:0px auto 50px;font-size:12px;color:#d5d5d5;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;"><div id="further-readings" data-user-slug="" data-user-nickname=""><ul id="further-readings-list" class="reading-list unstyled" style="padding:0px;margin:0px 0px 10px;list-style:none;"></ul>
<div id="further-reading-new" class="reading-edit"><a data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in" style="color:#999999;text-decoration:none;">&nbsp;推荐拓展阅读</a><div id="further-reading-form"></div>
</div>
</div>
<div class="pull-right" style="float:right;"><div class="author-copyright pull-right" data-toggle="tooltip" data-html="true" title="" data-original-title="转载请联系作者获得授权，并标注“简书作者”。" style="float:right;margin:-20px 0px 0px 20px;"><a style="color:#999999;">&nbsp;著作权归作者所有</a></div>
</div>
</div>
<div class="support-author" style="padding:25px;margin:0px auto 40px;background-color:#f5f5f5;border-left-width:4px;border-left-style:solid;border-left-color:#f57e42;box-sizing:border-box;box-shadow:#d9d9d9 0px 0px 1px;width:620px;color:#555555;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;"><p style="margin:0px auto 10px;font-size:17px;font-weight:bold;">如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作！</p>
<a class="btn btn-pay" data-toggle="modal" href="http://www.jianshu.com/p/f732749ce786#pay-modal" style="color:white;text-decoration:none;display:inline-block;padding:4px 12px;margin:10px 15px 10px 0px;line-height:20px;text-align:center;vertical-align:middle;cursor:pointer;text-shadow:none;background-color:#f57e42;border:1px solid #f57e42;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;box-shadow:none;background-position:initial initial;background-repeat:initial initial;">¥ 打赏支持</a>&nbsp;<div class="avatar-list" style="display:inline-block;"></div>
</div>
<div class="meta-bottom clearfix" style="width:620px;margin:0px auto 40px;color:#555555;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;"><div class="like " style="float:left;width:163px;height:50px;line-height:50px;overflow:hidden;border:1px solid #e78170;border-top-left-radius:40px;border-top-right-radius:40px;border-bottom-right-radius:40px;border-bottom-left-radius:40px;font-size:18px;text-align:center;"><div class="like-button" style="position:relative;width:60px;height:50px;padding-right:10px;display:inline-block;"><a id="like-note" class="like-content" data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in" style="color:#e78170;text-decoration:none;position:absolute;left:0px;transition:all 0.2s cubic-bezier(0.35, 0.32, 0.4, 1.18);">&nbsp;喜欢</a></div>
&nbsp;<span id="likes-count" data-toggle="tooltip" data-placement="right" title="" data-original-title="查看所有喜欢的用户" style="color:#e78170;position:relative;top:-19px;height:20px;padding-left:15px;border-left:1px solid;cursor:pointer;">1</span></div>
<div class="share-group pull-right" style="float:right;margin-top:16px;"><a data-name="weibo" style="margin-right:8px;font-size:18px;"><span style="margin-left:5px;font-size:14px;">分享到微博</span>&nbsp;</a><a data-toggle="modal" href="http://www.jianshu.com/p/f732749ce786#share-weixin-modal" data-name="weixin" style="color:#555555;text-decoration:none;margin-right:8px;font-size:18px;"><span style="margin-left:5px;font-size:14px;">分享到微信</span>&nbsp;</a><div class="more" style="position:relative;display:inline-block;"><a data-toggle="dropdown">更多分享</a></div>
</div>
</div>
<div id="likes-modal" class="modal modal_new support_list-modal fullscreen hide fade" tabindex="-1" role="dialog" aria-hidden="true" style="transition:opacity 0.3s linear, top 0.3s ease-out;-webkit-transition:opacity 0.3s linear, top 0.3s ease-out;position:fixed;top:0px;left:0px;z-index:1050;width:auto;margin:0px;border:none;border-top-left-radius:6px;border-top-right-radius:6px;border-bottom-right-radius:6px;border-bottom-left-radius:6px;box-shadow:none;-webkit-background-clip:padding-box;background-clip:padding-box;outline:0px;line-height:20px;overflow:hidden;right:0px;bottom:0px;transform:scale(0);text-align:center;color:#555555;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;opacity:1 !important;"><div class="modal-dialog" style="position:relative;width:600px;margin:30px auto;"><div class="modal-content" style="position:relative;background-clip:padding-box;"><div class="modal-header" style="padding:20px;border-bottom:1px solid #eeeeee;"><button type="button" class="close" data-dismiss="modal" aria-hidden="true" style="margin:-4px 0px 0px;font-size:20px;vertical-align:middle;line-height:20px;-webkit-appearance:none;cursor:pointer;font-weight:bold;font-family:Helvetica, Arial, 'Hiragino Sans GB', sans-serif;float:right;color:black;text-shadow:white 0px 1px 0px;opacity:0.2;padding:0px;border:0px;background-position:initial initial;background-repeat:initial initial;">×</button><h3 style="margin:0px;font-family:inherit;line-height:30px;color:inherit;text-rendering:optimizelegibility;font-size:24.5px;">喜欢的用户</h3>
</div>
<div class="modal-body" style="position:relative;overflow-y:auto;max-height:none;padding:30px 10px;"><ul class="unstyled users" style="padding:0px;margin:0px 0px 10px;list-style:none;"><li data-user-id="949324" style="line-height:17px;padding:10px 0px;border:none;overflow:hidden;text-align:left;"><a class="avatar" href="http://www.jianshu.com/users/0908e4a9a4cb" style="color:#555555;text-decoration:none;border-radius:50%;width:30px;height:30px;display:inline-block;margin-right:5px;border:1px solid #d9d9d9;"><img src="http://upload.jianshu.io/users/upload_avatars/949324/410c60028071.jpg?imageMogr/thumbnail/90x90/quality/100" style="height:30px;vertical-align:middle;border:none;width:30px;border-top-left-radius:50%;border-top-right-radius:50%;border-bottom-right-radius:50%;border-bottom-left-radius:50%;box-sizing:border-box;" /></a>&nbsp;<a class="blue-link" href="http://www.jianshu.com/users/0908e4a9a4cb" style="color:#4094c7;text-decoration:none;">devchen</a><span class="time" style="float:right;margin-top:9px;color:#999999;font-size:12px;">2016.10.20 21:22</span></li>
</ul>
</div>
</div>
</div>
</div>
<div id="comments" class="comment-list clearfix" style="width:620px;margin:0px auto 35px;color:#555555;font-family:-apple-system, 'Helvetica Neue', Arial, 'PingFang SC', 'lucida grande', 'lucida sans unicode', lucida, helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;"><div class="comment-head clearfix" style="margin-bottom:25px;border-top-width:1px;border-top-style:solid;border-top-color:#eeeeee;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;color:#999999;font-size:12px;line-height:52px;">5条评论&nbsp;<span class="order">（&nbsp;<a data-order="asc" class="active" style="color:#555555;margin:0px 5px;">按时间正序</a>·&nbsp;<a data-order="desc" style="margin:0px 5px;">按时间倒序</a>·&nbsp;<a data-order="likes_count" style="margin:0px 5px;">按喜欢排序</a>&nbsp;）</span><a class="goto-comment pull-right" data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in" style="color:#999999;text-decoration:none;float:right;margin:0px 5px;">添加新评论</a></div>
<div id="comment-list"><div class="note-comment clearfix" id="comment-5148360" style="margin-bottom:20px;border-bottom:1px solid #eeeeee;font-size:16px;line-height:1.5;"><div class="content"><div class="meta-top" style="margin:0px 0px 10px;padding-top:10px;"><a class="avatar" href="http://www.jianshu.com/users/657a7c77e675" style="color:#555555;text-decoration:none;border-radius:50%;width:35px;height:35px;display:inline-block;margin-right:10px;line-height:0.16px;float:left;"><img src="http://upload.jianshu.io/users/upload_avatars/1626952/17e822aabb32.jpeg?imageMogr/thumbnail/90x90/quality/100" alt="100" style="height:35px;vertical-align:middle;border:none;width:35px;border-top-left-radius:50%;border-top-right-radius:50%;border-bottom-right-radius:50%;border-bottom-left-radius:50%;box-sizing:border-box;" /></a><p style="margin-top:0px;margin-bottom:0px;line-height:1;word-break:break-all;word-wrap:break-word;"><a class="author-name" href="http://www.jianshu.com/users/657a7c77e675" style="color:#4094c7;text-decoration:none;font-size:14px;">糊涂猫until</a></p>
<span class="reply-time" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;margin-top:3px;"><small style="font-size:12px;">2 楼 ·&nbsp;</small><a href="http://www.jianshu.com/p/f732749ce786/comments/5148360#comment-5148360" style="color:#b1b1b1;text-decoration:none;">2016.10.27 17:15</a></span></div>
<p style="margin-top:0px;margin-bottom:10px;word-break:break-all;word-wrap:break-word;">很赞，大谢楼主，虽然不是很清楚，但是依葫芦画瓢，倒是成功了，之后再仔细看<br />
</p>
<div class="comment-footer clearfix text-right" style="text-align:right;margin-bottom:10px;"><a data-id="5148360" class="like pull-left" style="color:#999999;float:left;font-size:13px;margin-top:5px;">喜欢(0)</a><a data-id="5148360" data-nickname="糊涂猫until" class="reply" style="color:#999999;font-size:13px;margin-left:14px;">回复</a></div>
<div class="child-comment-list " style="padding-bottom:30px;margin-top:10px;border-top:1px dashed #eeeeee;"><div class="child-comment" id="comment-5955744" data-id="5955744" style="padding:15px 0px 15px 10px;border-bottom:1px dashed #d9d9d9;border-left:3px solid #d9d9d9;font-size:13px;"><p style="margin-top:0px;margin-bottom:0px;word-break:break-all;word-wrap:break-word;"><a class="blue-link" href="http://www.jianshu.com/users/a3b4b4f29be0" style="color:#4094c7;text-decoration:none;">翀鹰女孩</a>：&nbsp;<a href="http://www.jianshu.com/users/657a7c77e675" class="maleskine-author" target="_blank" data-user-slug="657a7c77e675" style="color:#4094c7;text-decoration:none;">@糊涂猫until</a>&nbsp;我想问下 这个是单项还是双向的?</p>
<div class="child-comment-footer text-right clearfix" style="text-align:right;"><a data-id="5148360" data-nickname="翀鹰女孩" class="reply" style="color:#999999;margin-left:14px;">回复</a><span class="reply-time pull-left" style="float:left;margin-top:3px;font-size:12px;color:#999999;"><a href="http://www.jianshu.com/p/f732749ce786/comments/5955744#comment-5955744" style="color:#b1b1b1;text-decoration:none;">2016.11.26 11:16</a></span></div>
</div>
<div data-state="remaining-child-comments"></div>
<div class="comment-toolbar clearfix" style="padding:20px 0px 15px 10px;border-left:3px solid #d9d9d9;border-bottom:1px dashed #eeeeee;font-size:13px;color:#999999;"><span class="pull-right" style="float:right;"><a data-id="5148360" class="reply" style="color:#555555;">&nbsp;添加新回复</a></span></div>
</div>
</div>
</div>
<div class="note-comment clearfix" id="comment-5349058" style="margin-bottom:20px;border-bottom:1px solid #eeeeee;font-size:16px;line-height:1.5;"><div class="content"><div class="meta-top" style="margin:0px 0px 10px;padding-top:10px;"><a class="avatar" href="http://www.jianshu.com/users/3a5b7d9fed21" style="color:#555555;text-decoration:none;border-radius:50%;width:35px;height:35px;display:inline-block;margin-right:10px;line-height:0.16px;float:left;"><img src="http://upload.jianshu.io/users/upload_avatars/2310679/3f43473b5748.jpg?imageMogr/thumbnail/90x90/quality/100" alt="100" style="height:35px;vertical-align:middle;border:none;width:35px;border-top-left-radius:50%;border-top-right-radius:50%;border-bottom-right-radius:50%;border-bottom-left-radius:50%;box-sizing:border-box;" /></a><p style="margin-top:0px;margin-bottom:0px;line-height:1;word-break:break-all;word-wrap:break-word;"><a class="author-name" href="http://www.jianshu.com/users/3a5b7d9fed21" style="color:#4094c7;text-decoration:none;font-size:14px;">CoderXieLei</a></p>
<span class="reply-time" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;margin-top:3px;"><small style="font-size:12px;">3 楼 ·&nbsp;</small><a href="http://www.jianshu.com/p/f732749ce786/comments/5349058#comment-5349058" style="color:#b1b1b1;text-decoration:none;">2016.11.04 15:00</a></span></div>
<p style="margin-top:0px;margin-bottom:10px;word-break:break-all;word-wrap:break-word;">讲解的很详细，我也是按照这个来的，但是一直报Error Domain=NSURLErrorDomain Code=-999 "cancelled" ，请问这是什么原因</p>
<div class="comment-footer clearfix text-right" style="text-align:right;margin-bottom:10px;"><a data-id="5349058" class="like pull-left" style="color:#999999;float:left;font-size:13px;margin-top:5px;">喜欢(0)</a><a data-id="5349058" data-nickname="CoderXieLei" class="reply" style="color:#999999;font-size:13px;margin-left:14px;">回复</a></div>
<div class="child-comment-list " style="padding-bottom:30px;margin-top:10px;border-top:1px dashed #eeeeee;"><div class="child-comment" id="comment-5350704" data-id="5350704" style="padding:15px 0px 15px 10px;border-bottom:1px dashed #d9d9d9;border-left:3px solid #d9d9d9;font-size:13px;"><p style="margin-top:0px;margin-bottom:0px;word-break:break-all;word-wrap:break-word;"><a class="blue-link" href="http://www.jianshu.com/users/4c436593f10b" style="color:#4094c7;text-decoration:none;">天天想念</a>：&nbsp;<a href="http://www.jianshu.com/users/3a5b7d9fed21" class="maleskine-author" target="_blank" data-user-slug="3a5b7d9fed21" data-original-title="" title="" style="color:#4094c7;text-decoration:none;">@CoderXieLei</a>&nbsp;个人认为还是认证证书出问题了。证书没有认证通过直接取消了请求。建议你debug到AFNetworking的这个方法- (BOOL)evaluateServerTrust:(SecTrustRef)serverTrust forDomain:(NSString *)domain看下哪里出问题了。或者尝试只验证证书的publickey</p>
<div class="child-comment-footer text-right clearfix" style="text-align:right;"><a data-id="5349058" data-nickname="天天想念" class="reply" style="color:#999999;margin-left:14px;">回复</a><span class="reply-time pull-left" style="float:left;margin-top:3px;font-size:12px;color:#999999;"><a href="http://www.jianshu.com/p/f732749ce786/comments/5350704#comment-5350704" style="color:#b1b1b1;text-decoration:none;">2016.11.04 16:11</a></span></div>
</div>
<div data-state="remaining-child-comments"></div>
<div class="comment-toolbar clearfix" style="padding:20px 0px 15px 10px;border-left:3px solid #d9d9d9;border-bottom:1px dashed #eeeeee;font-size:13px;color:#999999;"><span class="pull-right" style="float:right;"><a data-id="5349058" class="reply" style="color:#555555;">&nbsp;添加新回复</a></span></div>
</div>
</div>
</div>
<div class="note-comment clearfix" id="comment-5955735" style="margin-bottom:20px;border-bottom:1px solid #eeeeee;font-size:16px;line-height:1.5;"><div class="content"><div class="meta-top" style="margin:0px 0px 10px;padding-top:10px;"><a class="avatar" href="http://www.jianshu.com/users/a3b4b4f29be0" style="color:#555555;text-decoration:none;border-radius:50%;width:35px;height:35px;display:inline-block;margin-right:10px;line-height:0.16px;float:left;"><img src="http://cdn-qn0.jianshu.io/assets/default_avatar/13-8072fce67829ce128ba5df823205516c.jpg" alt="13" style="height:35px;vertical-align:middle;border:none;width:35px;border-top-left-radius:50%;border-top-right-radius:50%;border-bottom-right-radius:50%;border-bottom-left-radius:50%;box-sizing:border-box;" /></a><p style="margin-top:0px;margin-bottom:0px;line-height:1;word-break:break-all;word-wrap:break-word;"><a class="author-name" href="http://www.jianshu.com/users/a3b4b4f29be0" style="color:#4094c7;text-decoration:none;font-size:14px;">翀鹰女孩</a></p>
<span class="reply-time" style="position:relative;top:1px;margin-right:10px;font-size:12px;color:#999999;margin-top:3px;"><small style="font-size:12px;">4 楼 ·&nbsp;</small><a href="http://www.jianshu.com/p/f732749ce786/comments/5955735#comment-5955735" style="color:#b1b1b1;text-decoration:none;">2016.11.26 11:16</a></span></div>
<p style="margin-top:0px;margin-bottom:10px;word-break:break-all;word-wrap:break-word;">我想知道 这个是单项还是双向的?</p>
</div>
</div>
</div>
</div></body></html>