<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-03-16T05:36:12Z"/><meta name="updated" content="2017-03-16T05:36:16Z"/><title>背景介绍  从事开发到了一定阶段，想要提高就必须搞明白系统的一些工作原理。为什么？因为只有明白了这些，你才能针对平台的特性写出优质的代码。当遇到棘手的问题时，你才能更快速的结合系统原理去寻找最优解决</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><h1 style="box-sizing:border-box;font-size:26px;margin:0px 0px 15px;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">背景介绍</h1>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">从事开发到了一定阶段，想要提高就必须搞明白系统的一些工作原理。为什么？因为只有明白了这些，你才能针对平台的特性写出优质的代码。当遇到棘手的问题时，你才能更快速的结合系统原理去寻找最优解决方案。底层基础决定上层建筑。这个原理在开发中同样适用。我是提倡&nbsp;<span style="box-sizing:border-box;font-weight:700;">回归基础</span>&nbsp;的。高级的功能总是由最基本的元件构成，就好比为数不多的元素构成了我们难以想象的丰富的物质世界一样。<span style="box-sizing:border-box;font-weight:700;">只有掌握了最根本的内容，才能促使你爆发出难以想象的创造力来！</span></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">重视基础，回归基础。回到最初，去探寻灵感。 愿与君共勉✌️！</p>
<h1 style="box-sizing:border-box;font-size:26px;margin:0px 0px 15px;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">一张图明白Activity的启动流程</h1>
<div class="image-package" style="box-sizing:border-box;padding-bottom:25px;width:700px;margin-left:-40px;text-align:center;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><img src="http://upload-images.jianshu.io/upload_images/1869462-882b8e0470adf85a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/1869462-882b8e0470adf85a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2" style="box-sizing:border-box;border:0px;vertical-align:middle;height:auto;cursor:zoom-in;transition:all 0.25s ease-in-out;-webkit-transition:all 0.25s ease-in-out;" /><br style="box-sizing:border-box;" />
<div class="image-caption" style="box-sizing:border-box;min-width:20%;max-width:80%;min-height:22px;display:inline-block;padding:10px;margin:0px auto;border-bottom:1px solid #d9d9d9;font-size:14px;color:#969696;line-height:1.7;">Activity启动流程</div>
</div>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><br style="box-sizing:border-box;" />
本篇主要讲的是从一个App启动，到Activity执行onCreate()的流程。后面关于Activity的生命周期相信大家基本都耳熟能详了。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">上图中我把涉及到的类名方法命均列出来了，你可以看着流程，打开源码跟着过一遍。相信在过完一遍之后，在今后的开发中你会更加自信！</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">上图乍一看可能感觉有些眼花缭乱，但请不要惧怕。其实根本就没什么东西😂，你只需要从蓝色箭头开始看下去，会发现一下就看完了。在结合下面简要的分析，3分钟内你就能搞明白Activity的启动流程。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">关于Activity的启动，我在<a href="http://www.jianshu.com/p/8862bd2b6a29" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#3194d0;text-decoration:none;cursor:pointer;">【惊天秘密！从Thread开始，揭露Android线程通讯的诡计和主线程的阴谋】http://www.jianshu.com/p/8862bd2b6a29</a>&nbsp;一文中有提到过。这篇文章主要讲的是Thread线程到底是个什么东西，以及Android中的消息机制。感兴趣可以点链接看一看。</p>
<h2 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:24px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">一切从main()方法开始</h2>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">Android中，一个应用程序的开始可以说就是从<span style="box-sizing:border-box;font-weight:700;">ActivityThread.java</span>中的main()方法开始的。都是学过Java的人，想必也都知道Java的程序入口就是main()方法。Android其实也就是一个Java程序而已。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">从上图可以看到，main()方法中主要做的事情有：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;word-break:break-word;padding:0px;margin-left:22px;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">初始化主线程的Looper、主Handler。并使主线程进入等待接收Message消息的无限循环状态。关于Android的Handler机制，可以参考一下我上面提到的文章：<br style="box-sizing:border-box;" />
<a href="http://www.jianshu.com/p/8862bd2b6a29" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#3194d0;text-decoration:none;cursor:pointer;">【惊天秘密！从Thread开始，揭露Android线程通讯的诡计和主线程的阴谋】http://www.jianshu.com/p/8862bd2b6a29</a><br style="box-sizing:border-box;" />
下面是main()方法中比较关键的代码：</li>
</ol>
<pre class="hljs arduino" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;"><code class="arduino" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">static</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">void</span> main(<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">String</span>[] args){
    ...
    Looper.prepareMainLooper(); 
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//初始化Looper</span>     ...
    ActivityThread thread = <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">new</span> ActivityThread();
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//实例化一个ActivityThread</span>     thread.<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">attach</span>(false);
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//这个方法最后就是为了发送出创建Application的消息</span>     ... 
    Looper.<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">loop</span>();
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//主线程进入无限循环状态，等待接收消息</span> }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">2.调用attach()方法，主要就是为了发送出初始化Application的消息。这个流程说长不长，说短不短。下文会再捋一捋。</p>
<h2 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:24px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">创建Application的消息是如何发送的呢？</h2>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">上面提到过，ActivityThread的attach()方法最终的目的是发送出一条创建Application的消息——H.BIND_APPLICATION，到主线程的主Handler中。那我们来看看attach()方法干了啥。<br style="box-sizing:border-box;" />
attach()关键代码：</p>
<pre class="hljs aspectj" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;"><code class="aspectj" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> <span class="hljs-function" style="box-sizing:border-box;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">void</span> <span class="hljs-title" style="box-sizing:border-box;color:#268bd2;">attach</span><span class="hljs-params" style="box-sizing:border-box;">(<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">boolean</span> system)</span></span>{
    ...
    <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();  
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//获得IActivityManager实例，下面会看看它是个啥</span>     <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">try</span> {
        mgr.attachApplication(mAppThread);
         <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//看见没？关键啊。mAppThread这个参数下面也会说一下</span>     } <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">catch</span> (RemoteException ex) {
        <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">throw</span> ex.rethrowFromSystemServer();
    }
    ...
}</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">莫慌莫慌，下面看看上面出现的两个对象是个啥。</p>
<h3 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:22px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">IActivityManager mgr是个啥？</h3>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">从上图也可以看到，IActivityManager是一个接口，当我们调用<code style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace;font-size:12px;color:#657b83;background-color:#f6f6f6;border-radius:4px;padding:2px 4px;border:none;white-space:pre-wrap;">ActivityManagerNative.getDefault()</code>获得的实际是一个代理类的实例——<span style="box-sizing:border-box;font-weight:700;">ActivityManagerProxy</span>，这个东西实现了IActivityManager接口。打开源码你会发现，<span style="box-sizing:border-box;font-weight:700;">ActivityManagerProxy</span>是ActivityManagerNative的一个内部类。可以看出，Android团队在设计的过程中是实践了<span style="box-sizing:border-box;font-weight:700;">最小惊异原则</span>的，就是把相关的东西尽量放在一起。那么既然是个代理类，它究竟代理了谁？代码里看看喽😏。<br style="box-sizing:border-box;" />
下面这个代码稍微有点绕啊！老哥，稳住！</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;word-break:break-word;padding:0px;margin-left:22px;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">先看ActivityManagerProxy的构造函数：</p>
<pre class="hljs cpp" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="cpp" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-function" style="box-sizing:border-box;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> <span class="hljs-title" style="box-sizing:border-box;color:#268bd2;">ActivityManagerProxy</span><span class="hljs-params" style="box-sizing:border-box;">(IBinder remote)</span> </span>{
     mRemote = remote;
}</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">这个构造函数非常的简单。首先它需要一个IBinder参数，然后赋值给<span style="box-sizing:border-box;font-weight:700;">mRemote</span>变量。这个<span style="box-sizing:border-box;font-weight:700;">mRemote</span>显然是ActivityManagerNative的成员变量。但对它的操作是由ActivityManagerProxy来代理间接进行的。这样设计的好处是保护了mRemote，并且能够在操作mRemote前执行一些别的事务，并且我们是以IActivityManager的身份来进行这些操作的！这就非常巧妙了👍。</p>
</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">那么这个构造函数是在那调用的呢？</p>
<pre class="hljs cs" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="cs" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-function" style="box-sizing:border-box;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">static</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> IActivityManager <span class="hljs-title" style="box-sizing:border-box;color:#268bd2;">asInterface</span>(<span class="hljs-params" style="box-sizing:border-box;">IBinder obj</span>) </span>{
 <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (obj == <span class="hljs-literal" style="box-sizing:border-box;">null</span>) {
     <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">return</span> <span class="hljs-literal" style="box-sizing:border-box;">null</span>;
 }
 IActivityManager <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">in</span> =
     (IActivityManager)obj.queryLocalInterface(descriptor);
 <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//先检查一下有没有</span>  <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">in</span> != <span class="hljs-literal" style="box-sizing:border-box;">null</span>) {
     <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">return</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">in</span>;
 }
 ...
 <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">return</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">new</span> ActivityManagerProxy(obj);
 <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//这个地方调用了构造函数</span> }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">上面这个方法是ActivityManagerNative中的一个静态方法，它会调用到ActivityManagerProxy的构造方法。然而，这个静态方法也需要一个IBinder作为参数!老夫被绕晕了😂。但是不怕，咱们继续往找！</p>
</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">getDefault()获取到的静态常量gDefault<pre class="hljs aspectj" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="aspectj" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">private</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">static</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">new</span> Singleton&lt;IActivityManager&gt;() {
 <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">protected</span> <span class="hljs-function" style="box-sizing:border-box;">IActivityManager <span class="hljs-title" style="box-sizing:border-box;color:#268bd2;">create</span><span class="hljs-params" style="box-sizing:border-box;">()</span> </span>{
    IBinder b = ServiceManager.getService(<span class="hljs-string" style="box-sizing:border-box;color:#2aa198;">"activity"</span>);
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//重点啊！IBinder实例就是在这里获得的。</span>      ...
     IActivityManager am = asInterface(b);
     <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//调用了上面的方法。</span>      ...
     <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">return</span> am;
 }
};</code></pre>这是ActivityManagerNative的静态常量，它是一个单例。在其中终于获得了前面一直在用的IBinder实例。<pre class="hljs ebnf" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="ebnf" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-attribute" style="box-sizing:border-box;color:#b58900;">IBinder b</span> = ServiceManager.getService(<span class="hljs-string" style="box-sizing:border-box;color:#2aa198;">"activity"</span>);</code></pre>试着在上图中找到对应位置。</li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">这里是通过<span style="box-sizing:border-box;font-weight:700;">ServiceManager</span>获取到<span style="box-sizing:border-box;font-weight:700;">IBinder</span>实例的。如果你以前了解<span style="box-sizing:border-box;font-weight:700;">AIDL</span>通讯流程的话。这可能比较好理解一点，这只是通过另一种方式获取<span style="box-sizing:border-box;font-weight:700;">IBinder</span>实例罢了。获取<span style="box-sizing:border-box;font-weight:700;">IBinder</span>的目的就是为了通过这个<span style="box-sizing:border-box;font-weight:700;">IBinder</span>和<span style="box-sizing:border-box;font-weight:700;">ActivityManager</span>进行通讯，进而<span style="box-sizing:border-box;font-weight:700;">ActivityManager</span>会调度发送<span style="box-sizing:border-box;font-weight:700;">H.BIND_APPLICATION</span>即初始化Application的Message消息。如果之前没接触过<span style="box-sizing:border-box;font-weight:700;">Binder</span>机制的话，只需知道这个目的就行了。我后面会写一篇专门介绍Android中Binder机制的文章。当然，你也可以参考一下罗大的系列文章，写的很详细，非常的很赞！<a href="http://m.blog.csdn.net/article/details?id=6642463" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#3194d0;text-decoration:none;cursor:pointer;">【Android系统进程间通信Binder机制在应用程序框架层的Java接口源代码分析<br style="box-sizing:border-box;" />
】http://m.blog.csdn.net/article/details?id=6642463</a>。</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;word-break:break-word;padding:0px;margin-left:22px;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">再来看看attachApplication(mAppThread)方法。<pre class="hljs lasso" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="lasso" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> <span class="hljs-literal" style="box-sizing:border-box;">void</span> attachApplication(IApplicationThread app){<span class="hljs-params" style="box-sizing:border-box;">...</span> mRemote.transact(ATTACH_APPLICATION_TRANSACTION, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">data</span>, reply, <span class="hljs-number" style="box-sizing:border-box;color:#2aa198;">0</span>);  <span class="hljs-params" style="box-sizing:border-box;">...</span> }</code></pre>这个方法我在上图中也体现出来了。</li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">这个方法中上面这一句是关键。调用了IBinder实例的tansact()方法，并且把参数app(这个参数稍后就会提到)放到了data中，最终传递给ActivityManager。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">现在，我们已经基本知道了IActivityManager是个什么东东了。其实最重要的就是它的一个实现类<span style="box-sizing:border-box;font-weight:700;">ActivityManagerProxy</span>，它主要代理了内核中与<span style="box-sizing:border-box;font-weight:700;">ActivityManager</span>通讯的<span style="box-sizing:border-box;font-weight:700;">Binder</span>实例。下面再看看<span style="box-sizing:border-box;font-weight:700;">ApplicationThread mAppThread</span>。</p>
<h3 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:22px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">ApplicationThread mAppThread又是个啥？</h3>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;word-break:break-word;padding:0px;margin-left:22px;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">在ActivityThread的成员变量中，你能够发现：<pre class="hljs actionscript" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="actionscript" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">final</span> ApplicationThread mAppThread = <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">new</span> ApplicationThread();</code></pre>ApplicationThread是作为ActivityThread中的一个常量出现的。这表明系统不希望这个变量中途被修改，可见这个变量具有特定而十分重要的作用。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">我们看看他是啥。<pre class="hljs scala" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="scala" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">private</span> <span class="hljs-class" style="box-sizing:border-box;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">class</span> <span class="hljs-title" style="box-sizing:border-box;color:#b58900;">ApplicationThread</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">extends</span> <span class="hljs-title" style="box-sizing:border-box;color:#b58900;">ApplicationThreadNative</span></span>{
 ...
}</code></pre>ApplicationThread是ActivityThread中的一个内部类，为什么没有单独出来写在别的地方呢？我觉得这也是对最小惊异原则的实践。因为ApplicationThread是专门真对这里使用的对象。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">它继承自ApplicationThreadNative，我们再看看它是个啥。<pre class="hljs scala" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="scala" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;">public <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">abstract</span> <span class="hljs-class" style="box-sizing:border-box;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">class</span> <span class="hljs-title" style="box-sizing:border-box;color:#b58900;">ApplicationThreadNative</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">extends</span> <span class="hljs-title" style="box-sizing:border-box;color:#b58900;">Binder</span> </span>  implements <span class="hljs-type" style="box-sizing:border-box;color:#b58900;">IApplicationThread</span>{
 ...
 <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//无参构造函数</span>  public <span class="hljs-type" style="box-sizing:border-box;color:#b58900;">ApplicationThreadNative</span>() {
     <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//这是Binder的</span>      attachInterface(<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">this</span>, descriptor);
 }
 ...
}</code></pre>那么很明显，ApplicationThread最终也是一个Binder！同时，由于实现了IApplicationThread接口，所以它也是一个IApplicationThread。以上这系对应关系你都可以在上图中找到。</li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">我们在ActivityThread中看到的ApplicationThread使用的构造函数是无参的，所以看上面无参构造函数都干了啥！</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">Binder的attachInterface(IInterface owner, String descriptor)方法没什么特别的，就是赋值了。</p>
<pre class="hljs cpp" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;"><code class="cpp" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-function" style="box-sizing:border-box;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">void</span> <span class="hljs-title" style="box-sizing:border-box;color:#268bd2;">attachInterface</span><span class="hljs-params" style="box-sizing:border-box;">(IInterface owner, String descriptor)</span> </span>{
    mOwner = owner;
    mDescriptor = descriptor;
}</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">4.那么IApplicationThread又是啥？老铁，走着！我们继续挖。</p>
<pre class="hljs haxe" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;"><code class="haxe" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> <span class="hljs-class" style="box-sizing:border-box;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">interface</span> <span class="hljs-title" style="box-sizing:border-box;color:#b58900;">IApplicationThread</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;"><span class="hljs-keyword" style="box-sizing:border-box;">extends</span> <span class="hljs-type" style="box-sizing:border-box;color:#b58900;">IInterface</span></span> </span>{
    ...
    <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">String</span> descriptor = <span class="hljs-string" style="box-sizing:border-box;color:#2aa198;">"android.app.IApplicationThread"</span>; 
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//留意下这个参数</span>     ...
}</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">好吧，这在上图中没有，挖的有点什么了。但是学习嘛，咱就看看喽。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">IApplicationThread是继承了IInterface的一个接口，我们需要关注一下里面的descriptor参数。后面会用它，它是一个标识，查询的时候很重要。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">好，我们终于知道attach()方法中出现的两个对象是啥了。ApplicationThread作为IApplicationThread的一个实例，承担了最后发送Activity生命周期、及其它一些消息的任务。也就是说，前面绕了一大圈，最后还是回到这个地方来发送消息。我擦！</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">也许你会想，既然在ActivityThread中我们已经创建出了ApllicationThread的了，为什么还要绕这么弯路？😄，当然是为了让系统根据情况来控制这个过程喽，不然为什么要把ApplicationThread传到ActivityManager中呢？</p>
<h3 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:22px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">ActivityManagerService调度发送初始化消息</h3>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">经过上面的辗转，ApplicationThread终于到了ActivityManagerService中了。请在上图中找到对应位置！</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">从上图中可以看到，ActivityManagerService中有一这样的方法：</p>
<pre class="hljs lasso" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;"><code class="lasso" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">private</span> final <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">boolean</span> attachApplicationLocked(IApplicationThread <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">thread</span> , int pid) {
    <span class="hljs-params" style="box-sizing:border-box;">...</span>     <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">thread</span>.bindApplication();
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//注意啦！</span>     <span class="hljs-params" style="box-sizing:border-box;">...</span> }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">ApplicationThread以IApplicationThread的身份到了ActivityManagerService中，经过一系列的操作，最终被调用了自己的bindApplication()方法，发出初始化Applicationd的消息。</p>
<pre class="hljs mipsasm" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;"><code class="mipsasm" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;">public final void <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">bindApplication(String </span>processName, 
    ApplicationInfo appInfo,
    List&lt;ProviderInfo&gt; providers, 
    ComponentName <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">instrumentationName,</span>    ProfilerInfo profilerInfo, 
    <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">Bundle </span><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">instrumentationArgs,</span>    IInstrumentationWatcher <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">instrumentationWatcher,</span>    IUiAutomationConnection <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">instrumentationUiConnection, </span>     int debugMode,
    <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">boolean </span>enableBinderTracking, 
    <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">boolean </span>trackAllocation,
    <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">boolean </span>isRestrictedBackupMode, 
    <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">boolean </span>persistent, 
    Configuration <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">config</span>,
    CompatibilityInfo compatInfo, 
    Map&lt;String, IBinder&gt; services, 
    <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">Bundle </span>coreSettings){

    ...
    sendMessage(H.<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">BIND_APPLICATION, </span>data)<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">;</span> }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">吓屎老纸！这么多参数。这明明很违反参数尽量要少的原则嘛！所以说，有的时候，开发过程中还是很难避免一些参数堆积的情况的。也不能一概而论。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">但是，这个地方，我们只要知道最后发了一条<span style="box-sizing:border-box;font-weight:700;">H.BIND_APPLICATION</span>消息，接着程序开始了。</p>
<h2 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:24px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">收到初始化消息之后的世界</h2>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">上面我们已经找到初始化Applicaitond的消息是在哪发送的了。现在，需要看一看收到消息后都发生了些什么。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">现在上图的H下面找到第一个消息：<span style="box-sizing:border-box;font-weight:700;">H.BIND_APPLICATION</span>。一旦接收到这个消息就开始创建Application了。这个过程是在handleBindApplication()中完成的。看看这个方法。在上图中可以看到对应的方法。</p>
<pre class="hljs lasso" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;"><code class="lasso" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">private</span> <span class="hljs-literal" style="box-sizing:border-box;">void</span> handleBindApplication(AppBindData <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">data</span>) {
    <span class="hljs-params" style="box-sizing:border-box;">...</span>     mInstrumentation = (Instrumentation)
        cl.loadClass(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">data</span>.instrumentationName.getClassName())
        .newInstance();
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//通过反射初始化一个Instrumentation仪表。后面会介绍。</span>     <span class="hljs-params" style="box-sizing:border-box;">...</span>     Application app = <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">data</span>.info.makeApplication(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">data</span>.restrictedBackupMode, <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">null</span>);
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//通过LoadedApp命令创建Application实例</span>     mInitialApplication = app;
    <span class="hljs-params" style="box-sizing:border-box;">...</span>     mInstrumentation.callApplicationOnCreate(app);
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//让仪器调用Application的onCreate()方法</span>     <span class="hljs-params" style="box-sizing:border-box;">...</span> }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">handleBindApplication()是一个很长的方法，但是我为各位看官精选出了上面这几句代码。对于本篇的主题来说，他们是至关重要的。上面短短的代码中出现了几个新对象。下面我会一一道来。</p>
<h3 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:22px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">Instrumentation仪表，什么鬼？</h3>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">1.这个叫Instrumentation仪表的东西十分诡异，姑且翻译为仪器吧。字面上看不出任何它是干什么的线索。但是，我们可以打开文档看看喽。</p>
<blockquote style="box-sizing:border-box;padding:20px;margin:0px 0px 25px;font-size:16px;border-left-width:6px;border-left-style:solid;border-left-color:#b4b4b4;background-color:#f7f7f7;word-break:break-word;line-height:30px;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;word-break:break-word;line-height:1.7;">Instrumentation会在应用程序的任何代码运行之前被实例化，它能够允许你监视应用程序和系统的所有交互。</p>
</blockquote>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">大概就这个意思啦。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">2.但是，从上面的代码我们可以看出，Instrumentation确实是在Application初始化之前就被创建了。那么它是如何实现监视应用程序和系统交互的呢？</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">打开这个类你可以发现，最终Apllication的创建，Activity的创建，以及生命周期都会经过这个对象去执行。简单点说，就是把这些操作包装了一层。通过操作Instrumentation进而实现上述的功能。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">3.那么这样做究竟有什么好处呢？仔细想想。Instrumentation作为抽象，当我们约定好需要实现的功能之后，我们只需要给Instrumentation仪表添加这些抽象功能，然后调用就好。剩下的，不管怎么实现这些功能，都交给Instrumentation仪器的实现对象就好。啊！这是多态的运用。啊！这是依赖抽象，不依赖具体的实践。啊！这是上层提出需求，底层定义接口，即依赖倒置原则的践行。呵！抽象不过如此。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">从代码中可以看到，这里实例化Instrumentation的方法是反射！而反射的ClassName是来自于从ActivityManagerService中传过来的Binder的。套路太深！就是为了隐藏具体的实现对象。但是这样耦合性会很低。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">4.好了，不瞎扯了。既然在说Instrumentation，那就看看最后调的callApplicationOnCreate()方法。</p>
<pre class="hljs cpp" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;"><code class="cpp" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-function" style="box-sizing:border-box;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">void</span> <span class="hljs-title" style="box-sizing:border-box;color:#268bd2;">callApplicationOnCreate</span><span class="hljs-params" style="box-sizing:border-box;">(Application app)</span> </span>{
    app.onCreate();
}</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">你没看错，它啥也没干。只是调用了一下Application的onCreate()方法。这就是为什么它能够起到监控的作用。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">在上图中你能够看到Instrumentation，以及它的交互过程。</p>
<h3 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:22px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">LoadedApk就是data.info哦！</h3>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">关于它是怎么来的本篇就不说了，以后可能会介绍下。本篇就看流程就好。所以直接进去看它的makeApplication()干了啥，就把Application给创建了。</p>
<pre class="hljs lasso" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;"><code class="lasso" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> Application makeApplication(<span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">boolean</span> forceDefaultAppClass,
    Instrumentation instrumentation) {
    <span class="hljs-params" style="box-sizing:border-box;">...</span>     <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">String</span> appClass = mApplicationInfo.className;
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//Application的类名。明显是要用反射了。</span>     <span class="hljs-params" style="box-sizing:border-box;">...</span>     ContextImpl appContext = ContextImpl.createAppContext(mActivityThread
        , this);
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//留意下Context</span>     app = mActivityThread.mInstrumentation
        .newApplication( cl, appClass, appContext);
    <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//通过仪表创建Application</span>     <span class="hljs-params" style="box-sizing:border-box;">...</span> }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">在这个方法中，我们需要知道的就是，在取得Application的实际类名之后，最终的创建工作还是交由Instrumentation去完成，就像前面所说的一样。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">值得留意的是，就像上图所标注的一样，当需要第二次获取Application时，同样只需要调用这个方法就好。“真是方便！”</p>
<h3 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:22px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">现在把目光移回Instrumentation</h3>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">看看newApplication()中是如何完成Application的创建的。</p>
<pre class="hljs haxe" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;"><code class="haxe" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">static</span> <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> Application <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">new</span><span class="hljs-type" style="box-sizing:border-box;color:#b58900;">Application</span>(Class&lt;?&gt; clazz
    , Context context) throws InstantiationException
    , IllegalAccessException
    , ClassNotFoundException {
        Application app = (Application)clazz.<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">new</span><span class="hljs-type" style="box-sizing:border-box;color:#b58900;">Instance</span>();
        <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//反射创建，简单粗暴</span>         app.attach(context);
        <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//关注下这里，Application被创建后第一个调用的方法。</span>         <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//目的是为了绑定Context。</span>         <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">return</span> app;
    }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">我的天，绕了这么多，这Application可算是创建出来了。快给自己一个小红花吧😊！</p>
<h2 style="box-sizing:border-box;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;margin:0px 0px 15px;font-size:24px;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">LaunchActivity</h2>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">当Application初始化完成后，系统会更具Manifests中的配置的启动Activity发送一个Intent去启动相应的Activity。这个过程本篇先不提，下次再说。主要看流程！</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;word-break:break-word;padding:0px;margin-left:22px;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">直接的，H就收到了一条LAUNCH_ACTIVITY的消息。然后开始初始化Activity之旅。收到消息后，真正处理是在ActivityThread中的handleLaunchActivity()中进行的。是不是迫不及待的想要知道发生了啥？快在上图中找到对应的步骤吧！<pre class="hljs lasso" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="lasso" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">private</span> <span class="hljs-literal" style="box-sizing:border-box;">void</span> handleLaunchActivity(ActivityClientRecord r
 , Intent customIntent
 , <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">String</span> reason) {
 <span class="hljs-params" style="box-sizing:border-box;">...</span>  Activity a = performLaunchActivity(r, customIntent);
 <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//妈蛋！又封装到另一个方法中创建了。</span>  <span class="hljs-params" style="box-sizing:border-box;">...</span>  <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (a != <span class="hljs-built_in" style="box-sizing:border-box;color:#268bd2;">null</span>) {
     <span class="hljs-params" style="box-sizing:border-box;">...</span>      handleResumeActivity(r.token
     , <span class="hljs-literal" style="box-sizing:border-box;">false</span>      , r.isForward
     ,!r.activity.mFinished &amp;&amp; !r.startsNotResumed
     , r.lastProcessedSeq, reason);
     <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//Activity创建成功就往onResume()走了！</span>      <span class="hljs-params" style="box-sizing:border-box;">...</span>  }
}</code></pre>从上面的代码中可以看出...好吧，什么都看不出来！</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;">再走一个方法。<pre class="hljs lasso" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="lasso" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">private</span> Activity performLaunchActivity(ActivityClientRecord r
 , Intent customIntent) {
 <span class="hljs-params" style="box-sizing:border-box;">...</span>  activity = mInstrumentation.newActivity(
      cl, component.getClassName(), r.intent);
 <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//通过仪表来创建Activity</span>  <span class="hljs-params" style="box-sizing:border-box;">...</span>   Application app = r.packageInfo.makeApplication(<span class="hljs-literal" style="box-sizing:border-box;">false</span>   , mInstrumentation);
  <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//前面说过，是在获取Application</span>  <span class="hljs-params" style="box-sizing:border-box;">...</span>  activity.attach(appContext
     , this
     , getInstrumentation()
     , r.token
     ,.ident
     , app
     , r.intent
     , r.activityInfo
     , title
     , r.<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">parent</span>      , r.embeddedID
     , r.lastNonConfigurationInstances
     , config
     ,r.<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">referrer</span>      , r.voiceInteractor
     , window);
 <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//方法怪出现！</span>  <span class="hljs-params" style="box-sizing:border-box;">...</span>  <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">if</span> (r.isPersistable()) {
     mInstrumentation.callActivityOnCreate(
       activity, r.state, r.persistentState);
 } <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">else</span> {
     mInstrumentation.callActivityOnCreate(activity, r.state);
 }
 <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//根据是否可持久化选择onCreate()方法。</span>  <span class="hljs-params" style="box-sizing:border-box;">...</span> }</code></pre>这个方法内容较多，我们一个个看。</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><pre class="hljs ebnf" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="ebnf" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-attribute" style="box-sizing:border-box;color:#b58900;">activity</span> = mInstrumentation.newActivity(
      cl, component.getClassName(), r.intent);</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">正如前面所说，Activity、Application的创建及生命周期都被承包给Instrumentation仪表了。所以由它来负责。看看Instrumentation干了啥。</p>
<pre class="hljs haxe" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="haxe" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">public</span> Activity <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">new</span><span class="hljs-type" style="box-sizing:border-box;color:#b58900;">Activity</span>(ClassLoader cl, <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">String</span> className,
         Intent intent)
         throws InstantiationException
         , IllegalAccessException,
         ClassNotFoundException {
     <span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">return</span> (Activity)cl.loadClass(className).<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">new</span><span class="hljs-type" style="box-sizing:border-box;color:#b58900;">Instance</span>();
     <span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//真的没干啥。反射实例化Activity而已</span>  }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">就是反射出一个Activity而已。</p>
</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><pre class="hljs pf" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="pf" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;">if (r.isPersistable()) {
     mInstrumentation.callActivityOnCreate(
       activity, r.<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">state</span>, r.persistentState);
 } else {
     mInstrumentation.callActivityOnCreate(activity, r.<span class="hljs-keyword" style="box-sizing:border-box;color:#859900;">state</span>);
 }</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">根据是否可持久化选择Activity的onCreate()方法。同样是通过Instrumentation仪表来执行onCreate()的。它两分别对应的onCreate()方法为：</p>
<pre class="hljs less" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="less" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-selector-tag" style="box-sizing:border-box;">onCreate</span>(icicle, persistentState);<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//可获得持久化数据</span></code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;">和</p>
<pre class="hljs less" style="box-sizing:border-box;overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;padding:15px;margin-top:0px;margin-bottom:20px;line-height:1.42857;word-break:break-word;word-wrap:normal;color:#657b83;background-color:#f6f6f6;border:1px solid #cccccc;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;background-position:initial initial;background-repeat:initial initial;"><code class="less" style="box-sizing:border-box;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;padding:0px;border:none;"><span class="hljs-selector-tag" style="box-sizing:border-box;">onCreate</span>(icicle);<span class="hljs-comment" style="box-sizing:border-box;color:#93a1a1;">//平时重写的最多的。</span></code></pre></li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">中间两个方法留意一下就好，就不在解释的，感兴趣的点源码看看。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">到此，Activity就跑起来了！怎么样？是不是并不复杂。</p>
<h1 style="box-sizing:border-box;font-size:26px;margin:0px 0px 15px;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">总结</h1>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">本篇就到此结束了。本篇主要流程是从Application创建开始，到第一个Activity onCreate()结束的。这了流程也不算长，关键是结合上面的图来看。重点环节我都用不同的颜色标记出来了。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">看到这里的同学奖励自己一包辣条吧！😄</p>
<h1 style="box-sizing:border-box;font-size:26px;margin:0px 0px 15px;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;line-height:1.7;color:#2f2f2f;text-rendering:optimizelegibility;font-variant-ligatures:normal;orphans:2;widows:2;">参考链接</h1>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;word-break:break-word;padding:0px;margin-left:22px;color:#2f2f2f;font-family:-apple-system, 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;"><li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;"><a href="http://m.blog.csdn.net/article/details?id=6642463" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#3194d0;text-decoration:none;cursor:pointer;">【Android系统进程间通信Binder机制在应用程序框架层的Java接口源代码分析<br style="box-sizing:border-box;" />
】http://m.blog.csdn.net/article/details?id=6642463</a></p>
</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:25px;word-break:break-word;overflow:visible;"><a href="https://developer.android.com/reference/android/app/Instrumentation.html" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#3194d0;text-decoration:none;cursor:pointer;">【Instrumentation API】https://developer.android.com/reference/android/app/Instrumentation.html</a></p>
</li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><a href="http://www.jianshu.com/p/3cf90c633bb1" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#3194d0;text-decoration:none;cursor:pointer;">【Activity启动流程（下）】http://www.jianshu.com/p/3cf90c633bb1</a></li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><a href="http://www.cnblogs.com/bastard/archive/2012/05/25/2517522.html" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#3194d0;text-decoration:none;cursor:pointer;">【Android学习——ActivityManager与Proxy模式的运用】http://www.cnblogs.com/bastard/archive/2012/05/25/2517522.html</a></li>
<li style="box-sizing:border-box;line-height:30px;margin-bottom:10px;"><a href="https://developer.android.com/reference/android/app/ActivityManager.html" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#3194d0;cursor:pointer;outline:0px;">【ActivityManager API】https://developer.android.com/reference/android/app/ActivityManager.html</a></li>
</ol></body></html>