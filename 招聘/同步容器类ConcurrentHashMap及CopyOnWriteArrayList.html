<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-05-15T03:07:18Z"/><meta name="updated" content="2017-05-15T03:07:29Z"/><title>同步容器类ConcurrentHashMap及CopyOnWriteArrayList</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div id="post_detail" style="margin:0px;padding:0px;"><div id="topics" style="margin:0px;padding:0px 0px 10px;width:941.75px;min-height:200px;float:left;text-overflow:ellipsis;overflow:hidden;"><div class="post" style="margin:0px;padding:0px;"><h1 class="postTitle" style="margin:0px 0px 10px;padding:0px 0px 0px 5px;font-size:15.6px;border:0px;float:left;width:941.75px;clear:both;line-height:1.5;"><br />
</h1>
<div class="clear" style="margin:0px;padding:0px;clear:both;"></div>
<div class="postBody" style="margin:0px;padding:0px;line-height:1.7;"><div id="cnblogs_post_body" style="margin:0px 0px 20px;padding:0px;word-break:break-word;"><p style="margin:10px auto;padding:0px;"><strong style="margin:0px;padding:0px;"><span style="margin:0px;padding:0px;font-size:16px;">ConcurrentHashMap</span></strong></p>
<p style="margin:10px auto;padding:0px;">Java5在java.util.concurrent包中提供了多种并发容器类来改进同步容器的性能。其中应用最为广泛的为ConcurrentHashMap，ConcurrentHashMap是一个线程安全的hash表。对于多线程的操作，介于HashMap和HashTable之间。内部采用“锁分段”机制替代HashTable的独占锁，进而提高性能。</p>
<p style="margin:10px auto;padding:0px;">关于ConcurrentHashMap的“锁分段”原理，可以参考http://blog.csdn.net/xuefeng0707/article/details/40834595#comments这篇博客。但是在Java8中，ConConCurrentHashMap内部实现原理为CAS算法。</p>
<p style="margin:10px auto;padding:0px;">java.util.concurrent包还提供了涉及用于多线程上下文中的Collection实现：ConcurrentHashMap、ConcurrentSkipListMap、ConcurrentSkipListSet、CopyOnWriteArrayList和CopyOnWriteArraySet。当期望许多线程访问一个给定conllection时，ConcurrentHashMap通常优于同步的HashMap，ConcurrentSkipListMap通常优于同步的TreeMap。当期望的读数和遍历远远大于列表的更新数时，CopyOnWriteArrayList优于同步的ArrayList。</p>
<p style="margin:10px auto;padding:0px;"><span style="margin:0px;padding:0px;font-size:16px;"><strong style="margin:0px;padding:0px;">CopyOnWriteArrayList</strong></span></p>
<div class="cnblogs_code" style="margin:5px 0px;padding:5px;background-color:#f5f5f5;border:1px solid #cccccc;overflow:auto;font-family:'Courier New' !important;font-size:12px !important;"><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;outline:none;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:700px;border:none !important;" /></a></span></div>
<pre style="margin-top:0px;margin-bottom:0px;padding:0px;white-space:pre-wrap;word-wrap:break-word;font-family:'Courier New' !important;"><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 1</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">package</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> com.ccfdod.juc;</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 2</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 3</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">import</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> java.util.Iterator;</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 4</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">import</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> java.util.concurrent.CopyOnWriteArrayList;</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 5</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 6</span> <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">/**</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 7</span> <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> * CopyOnWriteArrayList/CopyOnWriteArraySet：“写入并复制”</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 8</span> <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;"> * 注意：添加操作多时，效率低，因为每次添加时都会进行复制，开销非常大。并发迭代多时，可以选择使用，提高效率</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;"> 9</span>  <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">*/</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">10</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">class</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> TestCopyOnWriteArrayList {</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">11</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">12</span>     <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> main(String[] args) {</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">13</span>         HelloThread ht = <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> HelloThread();</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">14</span>         <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">15</span>         <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">for</span>(<span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">int</span> i = 0; i &lt; 10; i++<span style="margin:0px;padding:0px;line-height:1.5 !important;">) {</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">16</span>             <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">new</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> Thread(ht).start();</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">17</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">        }</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">18</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">    }</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">19</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">}</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">20</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">21</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">class</span> HelloThread <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">implements</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> Runnable {</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">22</span>     <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">将list改为线程安全的</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">23</span> <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">    private static List&lt;String&gt; list = Collections.synchronizedList(new ArrayList&lt;String&gt;());</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">24</span>     <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">private</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span> CopyOnWriteArrayList&lt;String&gt; list = <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">new</span> CopyOnWriteArrayList&lt;&gt;<span style="margin:0px;padding:0px;line-height:1.5 !important;">();</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">25</span>     <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">26</span>     <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">static</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> {</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">27</span>         list.add("AA"<span style="margin:0px;padding:0px;line-height:1.5 !important;">);</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">28</span>         list.add("BB"<span style="margin:0px;padding:0px;line-height:1.5 !important;">);</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">29</span>         list.add("CC"<span style="margin:0px;padding:0px;line-height:1.5 !important;">);</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">30</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">    }</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">31</span>     <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">32</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">    @Override</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">33</span>     <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">public</span> <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">void</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> run() {</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">34</span>         Iterator&lt;String&gt; it =<span style="margin:0px;padding:0px;line-height:1.5 !important;"> list.iterator();</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">35</span>         <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">36</span>         <span style="margin:0px;padding:0px;color:#0000ff;line-height:1.5 !important;">while</span><span style="margin:0px;padding:0px;line-height:1.5 !important;"> (it.hasNext()) {</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">37</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">            System.out.println(it.next());</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">38</span>             <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">如果使用第18行的代码，因为迭代和添加操作的是同一个数据源，会产生并发修改异常</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">39</span>             <span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">//</span><span style="margin:0px;padding:0px;color:#008000;line-height:1.5 !important;">当然除了21行使用CopyOnWriteArrayList外，使用迭代器的方法对数据进行crud也是可行的</span> <span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">40</span>             list.add("DD"<span style="margin:0px;padding:0px;line-height:1.5 !important;">);</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">41</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">        }</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">42</span> <span style="margin:0px;padding:0px;line-height:1.5 !important;">    }</span><span style="margin:0px;padding:0px;color:#008080;line-height:1.5 !important;">43</span> }</pre><div class="cnblogs_code_toolbar" style="margin:5px 0px 0px;padding:0px;"><span class="cnblogs_code_copy" style="margin:0px;padding:0px 5px 0px 0px;line-height:1.5 !important;"><a title="复制代码" style="margin:0px;padding:0px;outline:none;text-decoration:underline;border:none !important;"><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码" style="margin:0px;padding:0px;max-width:700px;border:none !important;" /></a></span></div>
</div>
<p style="margin:10px auto;padding:0px;">&nbsp;</p>
</div>
</div>
<div><br />
</div>
</div>
</div>
</div>
<a name="!comments" style="margin:0px;padding:0px;outline:none;color:#21759b;"></a><div id="blog-comments-placeholder" style="margin:0px;padding:0px;"></div>
<div id="comment_form" class="commentform" style="margin:0px;padding:0px;"><a name="commentform" style="margin:0px;padding:0px;outline:none;color:#21759b;font-family:'Helvetica Neue', Helvetica, Verdana, Arial, sans-serif;font-size:12px;font-variant-ligatures:normal;orphans:2;widows:2;"></a><div id="divCommentShow" style="margin:0px;padding:0px;font-family:'Helvetica Neue', Helvetica, Verdana, Arial, sans-serif;font-size:12px;font-variant-ligatures:normal;orphans:2;widows:2;"></div>
</div></body></html>