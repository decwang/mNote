<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-04-14T10:11:23Z"/><meta name="updated" content="2017-04-14T10:11:26Z"/><title>本文详细描述了PhxSQL的设计与实现。从MySQL的容灾缺陷开始讲起，接着阐述实现高可用强一致的思路，然后具体分析每个实现环节要注意的要点和解决方案，最后展示了PhxSQL在容灾和性能上的成果。 </title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">本文详细描述了PhxSQL的设计与实现。从MySQL的容灾缺陷开始讲起，接着阐述实现高可用强一致的思路，然后具体分析每个实现环节要注意的要点和解决方案，最后展示了PhxSQL在容灾和性能上的成果。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><span style="box-sizing:border-box;font-weight:700;">设计背景</span></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">互联网应用中账号和金融类关键系统要求和强调强一致性及高可用性。当面临机器损坏、网络分区、主备手工或者自动切换时，传统的MySQL主备难以保证强一致性和高可用性。PhxSQL将MySQL集群构建在一致性完善的Paxos协议基础上，保证了集群内MySQL机器之间数据的强一致性和整个集群的高可用性。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><span style="box-sizing:border-box;font-weight:700;">原生MySQL的容灾缺陷</span></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【MySQL容灾方案】</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">MySQL有两种常见的复制方案，异步复制和半同步复制。</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">异步复制方案&nbsp;<br style="box-sizing:border-box;" />
Master对数据进行commit操作后再将数据异步复制到Slave。&nbsp;<br style="box-sizing:border-box;" />
但数据无法保证成功复制，也就无法保证MySQL主备间的数据一致性，如图1所示。</li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><img title="图1 MySQL异步复制流程" alt="图1 MySQL异步复制流程" src="http://ipad-cms.csdn.net/cms/attachment/201702/58885e141c2a4.jpg" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图1 MySQL异步复制流程</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">半同步复制方案&nbsp;<br style="box-sizing:border-box;" />
Master对数据进行commit操作前将数据复制到Slave，确认复制成功后再对数据进行commit操作。&nbsp;<br style="box-sizing:border-box;" />
绝大多数情况下，半同步复制能保证MySQL主备间的数据一致性，如图2所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图2 MySQL半同步复制流程" alt="图2 MySQL半同步复制流程" src="http://ipad-cms.csdn.net/cms/attachment/201702/58885efddc5f5.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
<center style="box-sizing:border-box;">图2 MySQL半同步复制流程</center></li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【MySQL重启流程】&nbsp;<br style="box-sizing:border-box;" />
半同步方案中的“半”是指Master在等待Slave的ACK失败时将退化成异步复制。同时，MySQL在重启时也不会执行半同步复制。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">如图3中的id(Gtid)=101数据是Master机器中新写入到Binlog File的Binlog数据。但Master在复制数据到Slave的过程中MySQL宕机导致复制失败。MySQL重启时，数据（id=101）会被直接进行commit操作，随后再将数据异步复制到Slave。（下文将已经写入到Binlog File但未进行commit操作的数据（id=101）称为Pending Binlog。）</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><img title="图3 MySQL重启时直接提交Pending Binlog" alt="图3 MySQL重启时直接提交Pending Binlog" src="http://ipad-cms.csdn.net/cms/attachment/201702/58885f61e1c88.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图3 MySQL重启时直接提交Pending Binlog</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">该情况下MySQL容易出现Master-Slave之间数据不一致的情况，官方也描述了该问题。</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;"><a href="http://bugs.mysql.com/bug.php?id=80395" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#337ab7;text-decoration:none;">http://bugs.mysql.com/bug.php?id=80395</a></li>
<li style="box-sizing:border-box;"><a href="https://mariadb.atlassian.net/browse/MDEV-162" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#337ab7;text-decoration:none;">https://mariadb.atlassian.net/browse/MDEV-162</a></li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【MySQL重启缺陷】&nbsp;<br style="box-sizing:border-box;" />
下面将解释MySQL在重启时不执行半同步会产生数据不一致的原因。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">当对上述例子中的Pending Binlog（id=101）进行复制时Master宕机导致复制失败，随后Slave1切换成新Master并开始提供服务（写入id=201的数据）。此后，当旧Master重启时，Pending Binlog（id=101）不会被重新进行复制而直接进行commit操作，从而导致旧Master比新Master多了一条数据，旧Master无法成为新Master的Slave，需要人工处理掉这条数据之后，才能让旧Master作为Slave提供服务，如图4所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图4 MySQL重启缺陷导致主备数据不一致" alt="图4 MySQL重启缺陷导致主备数据不一致" src="http://ipad-cms.csdn.net/cms/attachment/201702/58885f8ad3584.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图4 MySQL重启缺陷导致主备数据不一致</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">上述case只对旧Master的数据造成影响，不会使得MySQL Client读取到错误数据。但当Master连续出现两次宕机后产生Master切换，两次宕机间隔较短使得Pending Binlog未能及时复制到Slave，且期间有查询请求时（Master宕机→Master重启→查询数据→Master宕机→Master切换），MySQL Client会产生如图5所示的幻读（两次读到的结果不一致）。&nbsp;<br style="box-sizing:border-box;" />
<img title="图5 MySQL重启缺陷导致Client产生幻读" alt="图5 MySQL重启缺陷导致Client产生幻读" src="http://ipad-cms.csdn.net/cms/attachment/201702/58885fb925cec.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图5 MySQL重启缺陷导致Client产生幻读</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【MySQL Client分裂】&nbsp;<br style="box-sizing:border-box;" />
当Master出现故障且产生Master切换时，由于原生MySQL缺乏调用端的通知/重定向机制，使得不同的Client可能访问不同的Master，导致数据的错误写入和读取，如图6所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图6 MySQL进行Master导致Client端分裂" alt="图6 MySQL进行Master导致Client端分裂" src="http://ipad-cms.csdn.net/cms/attachment/201702/588860079db18.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图6 MySQL进行Master导致Client端分裂</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【MySQL缺乏自动选主机制】&nbsp;<br style="box-sizing:border-box;" />
由于半同步复制不需要等待所有Slave的ACK，因此当Master出现故障时，需要选有最新Binlog的Slave为新的Master；而MySQL并没有内置这个选主机制，如图7所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图7 MySQL缺少自动选主机制" alt="图7 MySQL缺少自动选主机制" src="http://ipad-cms.csdn.net/cms/attachment/201702/58886039457ac.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图7 MySQL缺少自动选主机制</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【MySQL的容灾缺陷总结】&nbsp;<br style="box-sizing:border-box;" />
MySQL在容灾方面存在的问题：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">Master切换时主备数据不能保证一致：Master重启并切换可能导致MySQL主备间数据不一致。Master重启并切换可能导致MySQL Client产生幻读。</li>
<li style="box-sizing:border-box;">原生MySQL缺乏高可用机制：Master切换导致调用端分裂。缺乏自动选主机制。</li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">对于原生MySQL，在高可用和强一致两个特性中，只能二选一：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">要求MySQL主备间的数据强一致，不做主备自动切换。</li>
<li style="box-sizing:border-box;">借助MHA实现高可用，容忍MySQL主备间的数据不一致。</li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">因此MySQL在容灾上无法同时满足数据强一致和服务高可用两个特性。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><span style="box-sizing:border-box;font-weight:700;">PhxSQL设计思路</span></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【可靠日志存储】&nbsp;<br style="box-sizing:border-box;" />
实现一个以可靠日志存储为中心的架构来解决MySQL数据复制时产生的数据不一致问题。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">Master将Binlog发送到BinlogSvr集群（可靠日志存储），Slave从BinlogSvr集群获取Binlog数据完成数据复制。&nbsp;<br style="box-sizing:border-box;" />
Master在重启时，根据BinlogSvr集群的数据判断Pending Binlog是否已经被复制。如果未被复制则从Binlog File中删除。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">利用BinlogSvr集群（可靠日志存储），使得Master（重启时检查本地Binlog是否和BinlogSvr集群的数据一致）和Slave（从BinlogSvr集群中获取Binlog）的数据保持一致，从而保证了整个集群中的MySQL主备间数据的一致性，如图8所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图8 实现一个可靠日志存储保证各MySQL的数据一致" alt="图8 实现一个可靠日志存储保证各MySQL的数据一致" src="http://ipad-cms.csdn.net/cms/attachment/201702/5888608f59447.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图8 实现一个可靠日志存储保证各MySQL的数据一致</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【请求透传】&nbsp;<br style="box-sizing:border-box;" />
在Master进行切换时，切换操作可能会导致部分MySQL Client仍然访问旧Master并读到旧数据。&nbsp;<br style="box-sizing:border-box;" />
最直观的方法是修改MySQL Client API，在每一次进行查询时，先确认当前Master的位置。但此方法有以下缺点：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">需要维护一个MySQL Client API的私有版本，维护成本高。</li>
<li style="box-sizing:border-box;">所有的调用端需要集成这个私有的MySQL Client API，操作成本很高。</li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">为了避免修改MySQL Client API，可通过增加Proxy进行请求透传来解决上述问题。在每一个MySQL结点上增加一个Proxy，MySQL Client的请求不再直接访问MySQL而直接访问Proxy。Proxy根据Master的位置，将访问Slave机器的请求透传到Master机器，再进行MySQL操作。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">通过增加Proxy进行请求透传，解决了MySQL Client分裂导致有可能读取到旧数据的问题，如图9所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图9 实现一个可靠日志存储保证各MySQL的数据一致" alt="图9 实现一个可靠日志存储保证各MySQL的数据一致" src="http://ipad-cms.csdn.net/cms/attachment/201702/588860c5eb3ad.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图9 实现一个可靠日志存储保证各MySQL的数据一致</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【自动选主】&nbsp;<br style="box-sizing:border-box;" />
多机自动选主最常见的实现方式是由各个参与者发起投票，获得多数派支持的机器为Master，同时把Master信息记录到可靠存储。Master机器定期到可靠存储延长租约；非Master机器定期检查Master租约是否过期，从而决定是否要发起选举自己为Master的投票。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">为了避免修改MySQL代码，在MySQL机器上增加一个Agent，由Agent来替代MySQL发起选主投票和续期租约；可靠存储继续由BinlogSvr承担。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">Agent完成以下功能：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">Master机器的Agent监控本机MySQL是否正常服务；如果正常服务，则定期到可靠存储延长租约，否则停止续约。</li>
<li style="box-sizing:border-box;">非Master机器的Agent定期从可靠存储检查Master租约是否过期；如果过期，再检查本机MySQL是否已经执行了所有Binlog。如果已经执行了所有Binlog，则发起选举自己为Master的投票，如图10所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图10 可靠日志存储和Agent共同实现自动选主机制" alt="图10 可靠日志存储和Agent共同实现自动选主机制" src="http://ipad-cms.csdn.net/cms/attachment/201702/58886103ce0fb.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
<center style="box-sizing:border-box;">图10 可靠日志存储和Agent共同实现自动选主机制</center></li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><span style="box-sizing:border-box;font-weight:700;">PhxSQL架构和实现</span></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">从上述思路可以得出PhxSQL的简单三层架构。对于每一个节点，部署3个模块（PhxSQLProxy，MySQL，PhxBinlogSvr）。多个节点上的PhxBinlogSvr组成一个可靠的日志存储集群和可靠的Master信息存储集群；PhxBinlogSvr同时承担Agent的责任。PhxSQLProxy负责请求的透传。Master结点上的PhxSync负责将MySQL的Binlog发送到PhxBinlogSvr，如图11所示。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><img title="图11 PhxSQL基本架构" alt="图11 PhxSQL基本架构" src="http://ipad-cms.csdn.net/cms/attachment/201702/5888614c477e6.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图11 PhxSQL基本架构</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【Proxy(PhxSQLProxy)】</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">请求透传</li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">请求透传是Proxy主要的功能。主要解决在进行Master切换的时候，MySQL Client会被分裂，不同的Client可能连接到不同的MySQL。导致出现MySQL Client写入数据到错误的Master或者从错误的Master读取到错误的数据。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">Proxy的请求透传分两种：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">读写端口请求透传：Slave节点收到的请求透传给Master节点执行。Master节点收到的请求直接透传给本机MySQL执行。</li>
<li style="box-sizing:border-box;">只读端口请求透传：Master节点收到的请求透传给Slave节点执行。Slave节点收到的请求直接透传给本机MySQL执行，如图12所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图12 Proxy请求透传流程" alt="图12 Proxy请求透传流程" src="http://ipad-cms.csdn.net/cms/attachment/201702/58886195a31f9.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
<center style="box-sizing:border-box;">图12 Proxy请求透传流程</center></li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">高性能：由于Proxy接管了MySQL Client的请求，为了使整个集群的读写性能接近单机MySQL，Proxy使用协程模型提高自身的处理能力。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">Proxy的协程模型使用开源的Libco库。Libco库是微信团队开源的一个高性能协程库，具有以下特点：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">用同步方式写代码，实现异步代码的性能。</li>
<li style="box-sizing:border-box;">支持千万级的并发连接。</li>
<li style="box-sizing:border-box;">项目地址<a href="https://github.com/tencent-wechat/libco" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#337ab7;text-decoration:none;">https://github.com/tencent-wechat/libco</a></li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">完全兼容MySQL：为了已有的应用程序能够不做任何修改就能迁移到PhxSQL，Proxy需兼容MySQL的所有功能。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">兼容MySQL事务&nbsp;<br style="box-sizing:border-box;" />
MySQL事务管理基于连接，同一个事务的所有请求通过同一个连接通信。在事务处理中连接丢失，事务将被rollback（<a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-autocommit-commit-rollback.html" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#337ab7;text-decoration:none;">http://dev.mysql.com/doc/refman/5.6/en/innodb-autocommit-commit-rollback.html</a>）。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">Proxy使用1:1连接模型完全兼容MySQL事务。每当MySQL Client发起一个连接到Proxy，Proxy都会相应地发起一个连接到MySQL。两条连接中，任意一个中断，另外一个也相应断开，对应的事务会被rollback，如图13所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图13 Proxy的1对1事务连接模型" alt="图13 Proxy的1对1事务连接模型" src="http://ipad-cms.csdn.net/cms/attachment/201702/588861f73d1a1.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图13 Proxy的1对1事务连接模型</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">兼容MySQL权限&nbsp;<br style="box-sizing:border-box;" />
MySQL的权限管理基于（用户，源IP）对，源IP是通过socket句柄反查获取。当请求通过Proxy连接到MySQL时，源IP为Proxy本地IP，权限管理会出现异常。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">Proxy利用MySQL协议HEAD保留字段透传真实源IP到MySQ，MySQL再从HEAD保留字段获取正确的源IP进行权限管理，如图14所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图14 Proxy通过修改MySQL协议兼容MySQL权限" alt="图14 Proxy通过修改MySQL协议兼容MySQL权限" src="http://ipad-cms.csdn.net/cms/attachment/201702/588862273d0d5.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图14 Proxy通过修改MySQL协议兼容MySQL权限</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">PhxSync&nbsp;<br style="box-sizing:border-box;" />
PhxSync的功能和MySQL的semisync插件类似。经过调研，对semisync插件的接口做少量的调整，就可以使用这些插件接口来实现PhxSync。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">PhxSync功能主要是：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">正常运行时提交Binlog：MySQL在正常写入或者更新数据时，会调用after_flush接口。PhxSync插件通过实现after_flush接口将MySQL新写入的Binlog提交到本机的BinlogSvr，由本机BinlogSvr通过Paxos协议同步到BinlogSvr集群。</li>
<li style="box-sizing:border-box;">重启时校准本地Binlog：MySQL在重启时通过查询BinlogSvr集群判断本地Pending Binlog的状态。如果Pending Binlog未复制到BinlogSvr集群则从本地删除，保持本地的Binlog数据和BinlogSvr集群的Binlog数据一致。</li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">由于MySQL没有提供在重启时的插件接口，为了后续维护方便，在MySQL代码层抽象出了一个新插件接口before_binlog_init用于校准Binlog。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">上述对after_flush接口的调整，和新增的before_binlog_init接口已经提交补丁给MySQL官方（<a href="http://bugs.mysql.com/bug.php?id=83158" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#337ab7;text-decoration:none;">http://bugs.mysql.com/bug.php?id=83158</a>）。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【PhxBinlogSvr】</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">PhxBinlogSvr主要负责存储Binlog和Master信息的维护。在数据复制阶段，通过Paxos协议保证PhxBinlogSvr各节点的数据一致性（下文称PhxBinlogSvr为BinlogSvr）。</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">PhxPaxos库：BinlogSvr使用PhxPaxos库进行数据的复制。PhxPaxos库是微信团队开源的Paxos类库，具有以下特性：1. 保证各节点的数据一致。</li>
<li style="box-sizing:border-box;">保证集群机器超过一半存活还能服务。</li>
<li style="box-sizing:border-box;">高性能。</li>
<li style="box-sizing:border-box;">功能完善。</li>
<li style="box-sizing:border-box;">稳定性经过大规模验证。</li>
<li style="box-sizing:border-box;">接口方便易用。</li>
<li style="box-sizing:border-box;">项目地址<a href="https://github.com/tencent-wechat/phxpaxos" target="_blank" style="box-sizing:border-box;background-color:transparent;color:#337ab7;text-decoration:none;">https://github.com/tencent-wechat/phxpaxos</a></li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><span style="box-sizing:border-box;font-weight:700;">BinlogSvr异常情况处理</span></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">防止Slave的节点提交数据</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">当旧Master在提交数据时由于网络问题数据包被卡在网络，且新Mater已经成功切换时，或者人为错误直接往Slave节点的MySQL写入数据时，则会出现Slave节点提交数据的情况。多节点同时提交数据会出现BinlogSvr的Binlog数据和MySQL存储的Binlog数据不一致的情况。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">BinlogSvr存储了集群内的Master信息。当其收到MySQL提交的数据时，可根据Master信息拒绝非Master节点的提交，如图15所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图15 BinlogSvr通过Master信息拒绝非Master节点的提交" alt="图15 BinlogSvr通过Master信息拒绝非Master节点的提交" src="http://ipad-cms.csdn.net/cms/attachment/201702/588862a7a7166.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图15 BinlogSvr通过Master信息拒绝非Master节点的提交</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">防止Master提交错误数据</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">在某些情况下，Master可能会重新发送数据或者发送错误数据。譬如在网络不好的情况下Master由于提交数据超时而重发数据。磁盘发生故障或者数据被错误回滚或者修改的时候，Master会提交错误的数据。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">BinlogSvr使用乐观锁机制来防止Master的异常提交。在MySQL提交数据给BinlogSvr时，以本机MySQL已经执行的GTID为乐观锁，提交的内容为（本机MySQL已经执行的最新GTID，本次要提交的Binlog）。BinlogSvr通过检查请求中（本机MySQL已经执行的最新GTID）和自身保存的最新GTID是否匹配来拒绝重新发送或者异常发送的数据，如图16所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图16 BinlogSvr使用乐观锁拒绝Master在数据异常的情况下提交数据" alt="图16 BinlogSvr使用乐观锁拒绝Master在数据异常的情况下提交数据" src="http://ipad-cms.csdn.net/cms/attachment/201702/588862d115f54.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图16 BinlogSvr使用乐观锁拒绝Master在数据异常的情况下提交数据</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;">支持MySQL原生复制协议：为了让Slave能从BinlogSvr获取Binlog，最好的方式就是BinlogSvr支持MySQL原生的复制协议，这样不用对Slave做任何修改，如图17所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图17 BinlogSvr支持MySQL使用原生复制协议获取Binlog数据" alt="图17 BinlogSvr支持MySQL使用原生复制协议获取Binlog数据" src="http://ipad-cms.csdn.net/cms/attachment/201702/5888633020bd8.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;">图17 BinlogSvr支持MySQL使用原生复制协议获取Binlog数据</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;"></p>
</li>
<li style="box-sizing:border-box;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;">Master管理：BinlogSvr除了存储MySQL的Binlog数据，还存储了Master信息。同时还承担了Agent的角色，负责监控MySQL的状态，必要时发起选举自己为Master的投票。</p>
</li>
</ol>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">BinlogSvr通过Paxos协议进行Master选举，选举成功后成为Master并拥有租约。通过Paxos协议选举保证了最终只产生一个Master且每个节点记录了一致的Master信息。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><span style="box-sizing:border-box;font-weight:700;">PhxSQL效果</span></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【PhxSQL数据一致性】</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">通过比较PhxSQL集群中各节点的数据（MySQL Binlog，PhxPaxos，BinlogSvr) 判断各节点数据是否一致，如图18所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图18 PhxSQL 3机数据对比" alt="图18 PhxSQL 3机数据对比" src="http://ipad-cms.csdn.net/cms/attachment/201702/5888635fe68d0.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图18 PhxSQL 3机数据对比</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【Master自动切换】</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">通过观察Master宕机时各节点的流量变化判断Master是否顺利切换。下图中的红线代表流量。当Master宕机时，流量会随之转移，代表Master顺利切换，如图19所示。&nbsp;<br style="box-sizing:border-box;" />
<img title="图19 PhxSQL进行Master切换时各节点的写入流量变化" alt="图19 PhxSQL进行Master切换时各节点的写入流量变化" src="http://ipad-cms.csdn.net/cms/attachment/201702/5888639c11b00.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图19 PhxSQL进行Master切换时各节点的写入流量变化</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">【PhxSQL性能】</p>
<ul style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><li style="box-sizing:border-box;">MySQL版本：Percona 5.6.31-77.0</li>
<li style="box-sizing:border-box;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;">机器信息：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;"><li style="box-sizing:border-box;">CPU ：Intel Xeon CPU E5-2420 0 @ 1.90GHz * 24。</li>
<li style="box-sizing:border-box;">Memory : 32G。</li>
<li style="box-sizing:border-box;">Disk:SSD Raid10。</li>
<li style="box-sizing:border-box;">Ping Costs：Master→Slave:3 ~ 4ms; client→Master :4ms。</li>
</ol>
</li>
<li style="box-sizing:border-box;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;">工具和参数：</p>
<ol style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;"><li style="box-sizing:border-box;">sysbench。</li>
<li style="box-sizing:border-box;">–oltp-tables-count=10 –oltp-table-size=1000000 –num-threads=500。</li>
<li style="box-sizing:border-box;">–max-requests=100000 –report-interval=1 –max-time=200。</li>
</ol>
</li>
</ul>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">PhxSQL的写性能比MySQL的半同步好，读性能由于多了一层Proxy导致比MySQL的半同步稍差。&nbsp;<br style="box-sizing:border-box;" />
<img title="" alt="" src="http://ipad-cms.csdn.net/cms/attachment/201702/58886412ebb7f.png" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
<img title="图20 PhxSQL和MySQL的性能对比" alt="图20 PhxSQL和MySQL的性能对比" src="http://ipad-cms.csdn.net/cms/attachment/201702/588864233fae8.jpg" style="box-sizing:border-box;border:0px;vertical-align:middle;display:table;margin:auto;" /><br style="box-sizing:border-box;" />
</p>
<center style="box-sizing:border-box;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;">图20 PhxSQL和MySQL的性能对比</center><p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;"><span style="box-sizing:border-box;font-weight:700;">成功案例</span></p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:20px;color:#333333;font-family:'microsoft yahei', arial;font-size:16px;font-variant-ligatures:normal;orphans:2;text-align:justify;widows:2;">QQ邮箱（域名邮箱）域名记录服务器：单个集群调用峰值40w/min。写请求平均耗时在20ms以下。读写比为20：1。机器配置：Intel Xeon CPU x3440 @ 2.53ghz 8 core，8GB ram。</p></body></html>