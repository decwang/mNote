<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-04-14T09:07:49Z"/><meta name="updated" content="2017-04-14T09:08:07Z"/><title>Android无埋点数据收集SDK关键技术解析</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div class="article_title" style="margin-bottom:21px;font-family:'microsoft yahei';font-size:12px;font-variant-ligatures:normal;orphans:2;widows:2;">&nbsp;<h1 style="margin:0px;padding:0px;display:inline-block;vertical-align:middle;font-size:18px;"><span class="link_title"><a href="http://blog.csdn.net/qq_29647881/article/details/70148992" style="text-decoration:none;color:#000000;"><span style="color:red;">[置顶]</span>&nbsp;Android无埋点数据收集SDK关键技术解析</a></span></h1>
</div>
<div class="article_manage clearfix" style="color:#999999;font-variant-ligatures:normal;font-variant-position:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;font-size:12px;line-height:22px;font-family:Arial;text-align:right;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#ededed;margin:0px -20px 10px;padding:0px 20px 5px;overflow:hidden;orphans:2;widows:2;"><div class="article_l" style="width:948px;float:left;"><span class="link_categories" style="margin:0px 0px 0px 5px;float:left;">标签：&nbsp;<a href="http://www.csdn.net/tag/android" target="_blank" style="text-decoration:none;display:inline-block;margin-right:10px;color:#c88326;">android</a><a href="http://www.csdn.net/tag/sdk" target="_blank" style="text-decoration:none;display:inline-block;margin-right:10px;color:#c88326;">sdk</a><a href="http://www.csdn.net/tag/%e6%95%b0%e6%8d%ae" target="_blank" style="text-decoration:none;display:inline-block;margin-right:10px;color:#c88326;">数据</a><a href="http://www.csdn.net/tag/%e6%97%a0%e5%9f%8b%e7%82%b9" target="_blank" style="text-decoration:none;display:inline-block;margin-right:10px;color:#c88326;">无埋点</a></span></div>
<div class="article_r"><span class="link_postdate" style="margin:0px 16px 0px 0px;">2017-04-12 23:38</span>&nbsp;<span class="link_view" title="阅读次数" style="margin:0px 16px 0px 5px;padding:0px 0px 0px 24px;background:url(&quot;../images/skin-type-icon.png&quot;) 0px -25px no-repeat;display:inline-block;">1536人阅读</span>&nbsp;<span class="link_comments" title="评论次数" style="margin:0px 16px 0px 5px;padding:0px 0px 0px 17px;background-image:url(&quot;../images/skin-type-icon-yellow.png&quot;) !important;background-position:0px -43px;background-size:initial;background-repeat:no-repeat;background-attachment:initial;background-origin:initial;background-clip:initial;background-color:initial;display:inline-block;"><a href="http://blog.csdn.net/qq_29647881/article/details/70148992#comments" style="text-decoration:none;color:#c88326;">评论</a>(1)</span>&nbsp;<span class="link_collect tracking-ad" data-mod="popu_171" style="margin:0px 16px 0px 5px;display:inline-block;background-image:url(&quot;../images/skin-type-icon-yellow.png&quot;) !important;background-repeat:no-repeat;background-position:0px -62px;padding-left:17px;"><a title="收藏" target="_blank" style="color:#c88326;">收藏</a></span>&nbsp;<span class="link_report" style="margin:0px 16px 0px 5px;display:inline-block;background-image:url(&quot;../images/skin-type-icon-yellow.png&quot;) !important;background-repeat:no-repeat;background-position:0px -81px;padding-left:17px;"><a href="http://blog.csdn.net/qq_29647881/article/details/70148992#report" title="举报" style="text-decoration:none;color:#c88326;">举报</a></span></div>
</div>
<div class="category clearfix" style="margin:0px -20px;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#ededed;padding:5px 20px;font-family:'microsoft yahei';font-size:12px;font-variant-ligatures:normal;orphans:2;widows:2;"><div class="category_l" style="display:inline-block;font-size:14px;color:#333333;width:70px;float:left;line-height:28px;"><img src="http://static.blog.csdn.net/images/category_icon.jpg" style="border:none;vertical-align:middle;" />&nbsp;<span style="display:inline-block;vertical-align:middle;">分类：</span></div>
<div class="category_r" style="display:inline-block;font-size:14px;color:#df3434;float:left;width:853.188px;"><label style="display:inline-block;margin-left:15px;cursor:pointer;line-height:28px;position:relative;">数据收集</label></div>
</div>
<div class="bog_copyright" style="padding:20px 0px;font-family:'microsoft yahei';font-size:12px;font-variant-ligatures:normal;orphans:2;widows:2;"><p class="copyright_p" style="margin-top:0px;margin-bottom:0px;padding:0px 0px 0px 10px;height:14px;line-height:14px;border-left-width:3px;border-left-style:solid;border-left-color:#e41c1e;color:#666666;font-size:14px;">版权声明：本文为博主原创文章，未经博主允许不得转载。</p>
</div>
<div style="font-family:'microsoft yahei';font-size:12px;font-variant-ligatures:normal;orphans:2;widows:2;clear:both;"></div>
<div style="font-family:'microsoft yahei';font-size:12px;font-variant-ligatures:normal;orphans:2;widows:2;border:1px solid #cccccc;background-color:#eeeeee;float:left;min-width:200px;padding:4px 10px;background-position:initial initial;background-repeat:initial initial;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;text-align:right;"><span style="float:left;">目录<a href="http://blog.csdn.net/qq_29647881/article/details/70148992#" title="系统根据文章中H1到H6标签自动生成文章目录" style="text-decoration:none;">(?)</a></span><a href="http://blog.csdn.net/qq_29647881/article/details/70148992#" title="展开" style="text-decoration:none;">[+]</a></p>
</div>
<div style="font-family:'microsoft yahei';font-size:12px;font-variant-ligatures:normal;orphans:2;widows:2;clear:both;"></div>
<div id="article_content" class="article_content" style="margin:35px 0px;font-size:15px;color:#555555;line-height:35px;font-family:'microsoft yahei';font-variant-ligatures:normal;orphans:2;widows:2;"><div class="markdown_views" style="font-size:14px;"><h1 id="前言" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t0" style="box-sizing:border-box;color:#0c89cf;"></a>前言</h1>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　本文基于网易乐得无埋点数据收集SDK，无埋点数据收集SDK用于向大数据平台提供<strong style="box-sizing:border-box;">全量，完整，准确</strong>的客户端数据．&nbsp;<br style="box-sizing:border-box;" />
　　<a href="http://lib.csdn.net/base/15" class="replace_word" title="undefined" target="_blank" style="text-decoration:none;box-sizing:border-box;color:#df3434;font-weight:bold;">Android</a>端无埋点数据收集SDK实现中涉及到比较关键的技术点有：</p>
<ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">用字节码插桩的方式实现Android端的AOP(“Hook”)</li>
<li style="box-sizing:border-box;">唯一定位界面上任何控件的ViewID</li>
<li style="box-sizing:border-box;">Fragment页面的合理划分</li>
<li style="box-sizing:border-box;">自定义数据收集DSL，用于线上配置，即时收集定制的业务数据</li>
</ul>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">关于第一点Android端AOP的实现，之前的一篇文章<a href="http://blog.csdn.net/qq_29647881/article/details/55052237" style="text-decoration:none;box-sizing:border-box;color:#0c89cf;">Android AOP之字节码插桩</a>已经做了详细的阐述。本文接着讲一下关于收集SDK内部<strong style="box-sizing:border-box;">收集逻辑</strong>的一些关键技术（即后面三点）.</p>
<hr style="box-sizing:border-box;margin:2em 0px;border-right-width:0px;border-bottom-width:0px;border-left-width:0px;border-top-style:solid;border-top-color:rgba(128, 128, 128, 0.0980392);" />
<h1 id="一概述" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t1" style="box-sizing:border-box;color:#0c89cf;"></a>一、概述</h1>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　本部分首先简要介绍一下我们的收集方案<strong style="box-sizing:border-box;">目前可以收集到哪些数据</strong>，然后对于本文重点介绍的<strong style="box-sizing:border-box;">三个技术点</strong>进行概述．</p>
<h2 id="11-sdk数据收集能力现状" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t2" style="box-sizing:border-box;color:#0c89cf;"></a>1.1 SDK数据收集能力现状</h2>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　目前我们的SDK进行数据收集时基本有两个能力：</p>
<h3 id="通用数据全量收集" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t3" style="box-sizing:border-box;color:#0c89cf;"></a>通用数据全量收集</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　通用数据指的是与业务无关的用户行为数据，无论是电商应用还是社区应用，接入SDK后通用数据的收集上都是无差的，这些通用数据大致有：</p>
<table style="box-sizing:border-box;width:948px;background-color:transparent;border-spacing:0px;border:1px solid #eeeeee;"><thead style="box-sizing:border-box;"><tr style="box-sizing:border-box;"><th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">事件</th>
<th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">描述</th>
</tr>
</thead><tbody style="box-sizing:border-box;"><tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">冷启动事件</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">App第一次启动时的，版本号、设备ID、渠道、内存使用情况，磁盘使用情况等信息</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">前后台事件</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">App进入前台或者后台</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">页面事件</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">页面（Activity或Fragment）显示（Show）／隐藏（Hide）</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">控件点击事件</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">某个控件（包括页面上控件和弹窗中控件）被用户点击</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">列表浏览事件[可选]</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">某个列表的哪些条目被用户浏览了</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">位置事件[可选]</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">上报用户地理位置信息</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">其它事件</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">省略描述</td>
</tr>
</tbody>
</table>
<h3 id="业务相关数据需求通过下发配置进行无埋点定制收集" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t4" style="box-sizing:border-box;color:#0c89cf;"></a>业务相关数据需求通过下发配置进行无埋点定制收集</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　除了上述通用数据，与具体业务相关的数据收集。拿网易贵金属的首页举个例子：</p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><img title="" alt="图1-1 无埋点收集业务数据示例" src="http://upload-images.jianshu.io/upload_images/1417134-61daa08fd3e81174.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" style="border:none;box-sizing:border-box;max-width:602px;max-height:100%;height:auto;" /></p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　假使需要在用户点击上图红框区域时，把“粤贵银”这个交易品的ID（或者下方显示的指数等，只要在内存中存在的数据都可以）一起报上来。&nbsp;<br style="box-sizing:border-box;" />
　　对于此种需求，数据收集SDK做到了<strong style="box-sizing:border-box;">无需埋点</strong>，<strong style="box-sizing:border-box;">不依赖开发周期</strong>，通过线上<strong style="box-sizing:border-box;">下发一些配置</strong>信息，即可<strong style="box-sizing:border-box;">即时进行数据收集</strong>。具体原理第四节叙述。</p>
<h2 id="12关键技术点概述" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t5" style="box-sizing:border-box;color:#0c89cf;"></a>1.2关键技术点概述</h2>
<h3 id="view的唯一标识id详见本文第二节" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t6" style="box-sizing:border-box;color:#0c89cf;"></a>View的唯一标识（ID）,（详见本文第二节）</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　当我们收集控件数据时碰到的第一个问题就是：如何把界面上的任何一个View与其他View区分开来.</p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">比如：某个Button被点击了&nbsp;<br style="box-sizing:border-box;" />
我们在上报数据的时候需要把这个Button和其他所有控件（比如另一个Button，另一个ImageView等）区分开来，这样这条上报的数据才能表示＂就是那个Button被点击了一下＂.</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　这就需要为界面上的每一个控件生成一个唯一的ID. 此ID除了具有<strong style="box-sizing:border-box;">区分性</strong>，还需要用于<strong style="box-sizing:border-box;">一致性</strong>．<strong style="box-sizing:border-box;">一致性</strong>是同一个View无论界面布局如何动态变化，或者说多次进入同一页面，此ID需要保持不变．</p>
<h3 id="页面的划分详见本文第三节" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t7" style="box-sizing:border-box;color:#0c89cf;"></a>页面的划分，（详见本文第三节）</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　除了Activity有些Fragment也需要看作页面，这就要求：</p>
<ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">在Fragment show/hide时上报相关页面事件．</li>
<li style="box-sizing:border-box;">页面Fragment中发生的用户交互事件也需要归于此Fragment页面，即点击某个View需要上报页面Fragment的信息（从View中怎么获取Fragment信息？）</li>
</ul>
<h3 id="无需埋点轻松收集定制的业务数据详见本文第四节" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t8" style="box-sizing:border-box;color:#0c89cf;"></a>无需埋点轻松收集定制的业务数据，（详见本文第四节）</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　如前面所述，默认情况下数据收集SDK会收集全量的用户交互数据，对于定制的业务收集需求，数据收集SDK也做到了<strong style="box-sizing:border-box;">无需代码埋点</strong>，通过线上下发一些配置进行<strong style="box-sizing:border-box;">即时收集</strong>．</p>
<hr style="box-sizing:border-box;margin:2em 0px;border-right-width:0px;border-bottom-width:0px;border-left-width:0px;border-top-style:solid;border-top-color:rgba(128, 128, 128, 0.0980392);" />
<h1 id="二view的唯一标识id" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t9" style="box-sizing:border-box;color:#0c89cf;"></a>二、View的唯一标识（ID）</h1>
<h2 id="21-调研" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t10" style="box-sizing:border-box;color:#0c89cf;"></a>2.1 调研</h2>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　用于区分界面上每个View的ID? Android系统是否提供给了我们这个ID?</p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">确实,Android系统提供了一个ID,view.getId()即可获得一个int型的id用于区分View,但是这个ID因为以下两个原因却并不能满足我们的需要.</p>
</blockquote>
<ol style="box-sizing:border-box;"><li style="box-sizing:border-box;">有相当一部分view是NO_ID，比如在布局文件中未指定id,或者直接在代码里面new出来view，view.getId()返回的全部都是NO_ID</li>
<li style="box-sizing:border-box;">这个ID是不稳定的，由于这个ID其实就是每次编译产生的R文件中的int常量，因此同一个按钮，两个版本编译出来的ID很可能时不一样的．</li>
</ol>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">因此，我们只能自己动手构建我们的ID喽，怎么构建？答案是<strong style="box-sizing:border-box;">利用所属Page+ViewTree构建ViewID</strong>.</p>
<h2 id="22-利用viewtree构建viewid" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t11" style="box-sizing:border-box;color:#0c89cf;"></a>2.2 利用ViewTree构建ViewID</h2>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　在Android的概念里，每个Window(ActivityWindow/DialogWindow/PopupWindow等)上面都生长着一棵ViewTree.而屏幕中看到的各种控件(ImageView/Button等)都是这棵ViewTree上的节点．&nbsp;<br style="box-sizing:border-box;" />
　　有Android开发环境的同学只需要打开AndroidDeviceMonitor-dump view hierarchy 就可以看到ViewTree的模样，如下图：</p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><img title="" alt="图2-1 ViewTree概念图" src="http://upload-images.jianshu.io/upload_images/1417134-ea43af1b9578b8b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" style="border:none;box-sizing:border-box;max-width:602px;max-height:100%;height:auto;" /></p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">因此，我们萌生出一个想法：</p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">利用Page+ViewTree中的位置构建ViewID.</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">View在ViewTree中的位置主要用两点来确定：</p>
<ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">纵向的深度</li>
<li style="box-sizing:border-box;">横向的index</li>
</ul>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">考虑这两个因素后，我们定义一个ViewPath:</p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">ViewPath：当前view到ViewTree根节点的一条路径，用于在ViewTree中唯一定位当前view。路径中的每个节点包含两部分信息,即节点View类型信息，以及节点View在兄弟中的index。</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">如下图，是一个简单的ViewTree模型（简单到深度只有两层，每层只有两三个控件）</p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><img title="" alt="图2-2 ViewTree模型图" src="http://upload-images.jianshu.io/upload_images/1417134-9d58d73875097e02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" style="border:none;box-sizing:border-box;max-width:602px;max-height:100%;height:auto;" /></p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">按照之前给的定义，上图中控件1，2，3,4的ViewPath如下</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs axapta has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">控件<span class="hljs-number" style="color:#006666;box-sizing:border-box;">1</span>ViewPath: RootView/LinearLayout[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]   <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">index</span>为<span class="hljs-number" style="color:#006666;box-sizing:border-box;">1</span>表示此节点是兄弟节点中第一个控件
控件<span class="hljs-number" style="color:#006666;box-sizing:border-box;">4</span>ViewPath: RootView/LinearLayout[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]/ChildView1[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]
控件<span class="hljs-number" style="color:#006666;box-sizing:border-box;">2</span>ViewPath: RootView/RelativeLayout[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">1</span>]
控件<span class="hljs-number" style="color:#006666;box-sizing:border-box;">3</span>ViewPath: RootView/LinearLayout[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">2</span>]</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">上述给出的ViewPath中，每个节点（除了首节点）有两部分内容：</p>
<ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">LinearLayout,RelativeLayout,ChildView1等ViewType信息（<strong style="box-sizing:border-box;">节点View的类型</strong>）</li>
<li style="box-sizing:border-box;">“[]”内的index信息，此index指示此节点是<strong style="box-sizing:border-box;">兄弟节点的第几个</strong></li>
</ul>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">这是最初的ViewPath,用ViewPath定位view，有两点特别重要：</p>
<ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">一致性： 同一个view的ViewPath在ViewTree的动态变化中应保持不变</li>
<li style="box-sizing:border-box;">区分度： 不同view的ViewPath应该不同</li>
</ul>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">按照这个最初的ViewPath定义在实践中还不能在一致性和区分度上满足我们的需求，后面会对ViewPath进行优化。</p>
<h2 id="23-viewpath的生成" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t12" style="box-sizing:border-box;color:#0c89cf;"></a>2.3 ViewPath的生成</h2>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　上面我们由构建ViewID的需求引出了ViewPath的定义，那么当交互事件（例如：按钮点击）发生时，我们如何生成此控件的ViewPath？&nbsp;<br style="box-sizing:border-box;" />
　　如上一篇文章<a href="http://www.jianshu.com/p/c202853059b4" style="text-decoration:none;box-sizing:border-box;color:#0c89cf;">Android AOP之字节码插桩</a>所述，当用户点击某个按钮时，我们插入OnClickListener.OnClick方法中的如下代码将会被调用：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs mathematica has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">Monitor</span>.onViewClick(view);    </code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">上面，入参view即为当前被点击的view，获取此view的ViewPath伪代码如下：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs cs has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">  <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">public</span> <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">static</span> ViewPath <span class="hljs-title" style="box-sizing:border-box;">getPath</span>(View view) {
    <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">do</span> {
      <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">//1. 构造ViewPath中于view对应的节点:ViewType[index]</span>       ViewType=view.getClass().getSimpleName();
      index=view在兄弟节点中的index;
      ViewPath节点=ViewType[index];
    }<span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">while</span> ((view=view.getParent())instanceof View);<span class="hljs-comment" style="color:#880000;box-sizing:border-box;">//2. 将view指向上一级的节点</span>   }</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
<li style="box-sizing:border-box;padding:0px 5px;">5</li>
<li style="box-sizing:border-box;padding:0px 5px;">6</li>
<li style="box-sizing:border-box;padding:0px 5px;">7</li>
<li style="box-sizing:border-box;padding:0px 5px;">8</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
<li style="box-sizing:border-box;padding:0px 5px;">5</li>
<li style="box-sizing:border-box;padding:0px 5px;">6</li>
<li style="box-sizing:border-box;padding:0px 5px;">7</li>
<li style="box-sizing:border-box;padding:0px 5px;">8</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">构造出来的ViewPath如下面例子所示：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">DecorView/LinearLayout[0]/FrameLayout[0]/ActionBarOverlayLayout[0]/ContentFrameLayout[0]/FrameLayout[0]/LinearLayout[0]/ViewPager[0]/ButtonFragment[0]/AppCompatButton[0]</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><h2 id="24-viewpath的优化" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t13" style="box-sizing:border-box;color:#0c89cf;"></a>2.4 ViewPath的优化</h2>
<h3 id="241一致性优化1" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t14" style="box-sizing:border-box;color:#0c89cf;"></a>2.4.1一致性优化1</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><strong style="box-sizing:border-box;">情景：</strong></p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">在图2-2 ViewTree模型图中，如果像下面图中所示，在控件2和3中动态插入一个FrameLayout呢？</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><img title="" alt="图2-3 Android界面动态性变化情景1" src="http://upload-images.jianshu.io/upload_images/1417134-1b1e73034764f942.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" style="border:none;box-sizing:border-box;max-width:602px;max-height:100%;height:auto;" /></p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">此时按照原始ViewPath的定义，我们来看看控件3的ViewPath发生了哪些变化？</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs http has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-attribute" style="box-sizing:border-box;">ViewTree动态变化前</span>: <span class="hljs-string" style="color:#008800;box-sizing:border-box;">RootView/LinearLayout[2]</span> <span class="hljs-attribute" style="box-sizing:border-box;">ViewTree动态变化后</span>: <span class="hljs-string" style="color:#008800;box-sizing:border-box;">RootView/LinearLayout[3]</span></code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><strong style="box-sizing:border-box;">优化：</strong></p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">ViewPath节点中index的含义从<strong style="box-sizing:border-box;">“兄弟节点的第几个”</strong>优化为:<strong style="box-sizing:border-box;">“相同类型兄弟节点的第几个”</strong></p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">优化后,发生图2-3所示界面布局动态变化时，控件3的ViewPath变化为：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs http has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-attribute" style="box-sizing:border-box;">ViewTree动态变化前</span>: <span class="hljs-string" style="color:#008800;box-sizing:border-box;">RootView/LinearLayout[1]   index为1表示此节点是兄弟节点中第二个LinearLayout</span> <span class="hljs-attribute" style="box-sizing:border-box;">ViewTree动态变化后</span>: <span class="hljs-string" style="color:#008800;box-sizing:border-box;">RootView/LinearLayout[1]</span></code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">可以看出，此处优化使控件3的ViewPath在ViewTree动态插入除了LinearLayout之外其它任何类型时都保持前后一致。</p>
<h3 id="242一致性优化2" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t15" style="box-sizing:border-box;color:#0c89cf;"></a>2.4.2一致性优化2</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><strong style="box-sizing:border-box;">情景：</strong></p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">在图2-2 ViewTree模型图中，如果像下面图中所示，在控件2和3中动态插入一个LinearLayout时，控件3的ViewPath能否继续保持前后一致？</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">按照上述情景，控件3ViewPath的变化如下：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs http has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-attribute" style="box-sizing:border-box;">ViewTree动态变化前</span>: <span class="hljs-string" style="color:#008800;box-sizing:border-box;">RootView/LinearLayout[1]   index为1表示此节点是兄弟节点中第二个LinearLayout</span> <span class="hljs-attribute" style="box-sizing:border-box;">ViewTree动态变化后</span>: <span class="hljs-string" style="color:#008800;box-sizing:border-box;">RootView/LinearLayout[2]   前面插入一个LinearLayout导致此节点变为兄弟节点中第三个LinearLayout了</span></code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><strong style="box-sizing:border-box;">问题</strong>&nbsp;<br style="box-sizing:border-box;" />
上述情景指的其实是一个问题：<strong style="box-sizing:border-box;">ViewTree中同类型兄弟节点动态变化（插入/移除/移位）影响ViewPath的一致性</strong></p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">ViewPath节点中的index，在同类型（ViewType相同，例如都是LinearLayout）兄弟节点动态加入/删除时，当前节点的index无法在变化前后保持一致。</li>
<li style="box-sizing:border-box;">“一致性优化1”中的优化<strong style="box-sizing:border-box;">可以抵御不同类型兄弟节点的影响，却对同类型兄弟节点的影响无可奈何</strong>。</li>
</ul>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">从ViewPath的定义上难以找到在同类型兄弟节点动态变化前后保持一致的方法，但我们可以分析发生此种界面动态变化的情景：</p>
<ol style="box-sizing:border-box;"><li style="box-sizing:border-box;">使用Fragment的动态布局&nbsp;<br style="box-sizing:border-box;" />
　　Android界面的动态布局发生情景中，使用Fragment实现界面动态变化的频率和影响控件数量还是比较大的（相对于直接addView()）</li>
<li style="box-sizing:border-box;">ListView（等可复用View）中同类型的itemViews。&nbsp;<br style="box-sizing:border-box;" />
　　此种情况虽然没有发生在一个itemView前动态插入一个itemView,但是由于itemView的复用，导致itemView**展示的内容和在父节点listView内的index的对应关系动态变化**，因此也归于此类。</li>
</ol>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">2中所说“ListView等可复用View”造成的问题后面会有优化，此处针对1中的情景讨论。1中情景发生时如下图：</p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><img title="" alt="图2-4 使用Fragment造成界面动态性的情景" src="http://upload-images.jianshu.io/upload_images/1417134-9985faaf991dcefb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" style="border:none;box-sizing:border-box;max-width:602px;max-height:100%;height:auto;" /></p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　上图中<strong style="box-sizing:border-box;">FragmentA,FragmentB,FragmentC的顶层视图控件全部是LinearLayout</strong>（<strong style="box-sizing:border-box;">同类型</strong>），此时这三个<strong style="box-sizing:border-box;">Fragment加入的顺序</strong>将造成ViewPath在此处各种不一致，从而导致ViewPath在动态变化前后不能保持一致（如前面：ViewTree动态变化前后控件3ViewPath的变化所示）。&nbsp;<br style="box-sizing:border-box;" />
<strong style="box-sizing:border-box;">优化:</strong></p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">在ViewPath节点中，使用Fragment的名字替换ViewType</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　优化后,发生图2-4所示界面布局动态变化时，控件3的ViewPath变化为：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs http has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-attribute" style="box-sizing:border-box;">ViewTree动态变化前</span>: <span class="hljs-string" style="color:#008800;box-sizing:border-box;">RootView/FragmentB[0]   index为0表示此节点是兄弟节点中第一个FragmentB</span> <span class="hljs-attribute" style="box-sizing:border-box;">ViewTree动态变化后</span>: <span class="hljs-string" style="color:#008800;box-sizing:border-box;">RootView/FragmentB[0]  </span></code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　如上，此次优化使得，在顶层视图ViewType相同的Fragment动态添加／删除到ViewTree时，ViewPath在变化前后保持一致。</p>
<h3 id="243针对可复用view的优化" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t16" style="box-sizing:border-box;color:#0c89cf;"></a>2.4.3针对可复用View的优化</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><strong style="box-sizing:border-box;">情景</strong>&nbsp;<br style="box-sizing:border-box;" />
　　以最常使用的ListView为例，假设有一ListView满屏只显示3个条目，那么此ListView可能只有<strong style="box-sizing:border-box;">3个子控件（ItemView）</strong>,而此ListView上滑之后可以<strong style="box-sizing:border-box;">显示100项内容</strong>。&nbsp;<br style="box-sizing:border-box;" />
　　这3个ItemView与100项内容是一对多的对应关系，而且映射并无可靠规律。&nbsp;<br style="box-sizing:border-box;" />
　　此时，我们希望<strong style="box-sizing:border-box;">ViewPath可以区分这100项显示的内容条目，而非仅仅区分3个ItemView</strong>。&nbsp;<br style="box-sizing:border-box;" />
　　&nbsp;<br style="box-sizing:border-box;" />
上面情景中的问题可用下图表达：&nbsp;<br style="box-sizing:border-box;" />
<img title="" alt="图2-5 可复用View的ViewPath区分性优化" src="http://upload-images.jianshu.io/upload_images/1417134-f73e49e2b5e11425.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" style="border:none;box-sizing:border-box;max-width:602px;max-height:100%;height:auto;" />&nbsp;<br style="box-sizing:border-box;" />
　　如上图中，内容条目1和4都是用itemView1来呈现的，按照之前的ViewPath定义，图2-5中各个内容条目的ViewPath如下：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs axapta has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">内容条目<span class="hljs-number" style="color:#006666;box-sizing:border-box;">1</span>: ListView/ItemView[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]   <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">index</span>为<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>表示此节点是兄弟节点中第一个ItemView
内容条目<span class="hljs-number" style="color:#006666;box-sizing:border-box;">4</span>: ListView/ItemView[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]   
内容条目<span class="hljs-number" style="color:#006666;box-sizing:border-box;">2</span>: ListView/ItemView[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">1</span>]  
内容条目<span class="hljs-number" style="color:#006666;box-sizing:border-box;">3</span>: ListView/ItemView[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">2</span>]  </code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　可以看出内容条目1和4的ViewPath区分不开。此种问题可以总结为：</p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;line-height:1.25;">显示内容与ViewTree中的控件不是一一对应的情况造成基于ViewTree的ViewPath区分度不够</p>
<ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">可复用View,比如：ListView,RecyclerView,Spinner等，呈现出来子View的数目和实际子View的数目未必一致</li>
<li style="box-sizing:border-box;">ViewPager设置缓存页面数为1，第二页显示时，第二个页面顶级View其实是ViewPager的第一个ChildView。此种情况也会造成显示内容（第二页）与ViewTree中的控件（第一个ChildView）不对应的情况。</li>
</ul>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">因此我们对于ViewPath作如下优化：</p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">ViewPath节点的index取内容的第几项，而非第几个ItemView。</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><strong style="box-sizing:border-box;">优化：</strong>&nbsp;<br style="box-sizing:border-box;" />
优化后图2-5中各个内容条目的ViewPath如下：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs axapta has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">内容条目<span class="hljs-number" style="color:#006666;box-sizing:border-box;">1</span>: ListView/ItemView[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]   <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">index</span>为<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>表示此节点是ListView显示的第一个内容条目
内容条目<span class="hljs-number" style="color:#006666;box-sizing:border-box;">4</span>: ListView/ItemView[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">3</span>]   
内容条目<span class="hljs-number" style="color:#006666;box-sizing:border-box;">2</span>: ListView/ItemView[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">1</span>]  
内容条目<span class="hljs-number" style="color:#006666;box-sizing:border-box;">3</span>: ListView/ItemView[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">2</span>]  </code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">可见，之前ViewPath无法区分的内容条目1和4现在可以区分开了。各种可复用View取内容的第几项的代码方法如下：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs brainfuck has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">ListView</span><span class="hljs-string" style="color:#008800;box-sizing:border-box;">,</span><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">Spinner等AdapterView</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">ListView</span><span class="hljs-string" style="color:#008800;box-sizing:border-box;">.</span><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">getPositionForView(itemView)</span> <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">RecyclerView</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">RecyclerView</span><span class="hljs-string" style="color:#008800;box-sizing:border-box;">.</span><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">getChildAdapterPosition(itemView)</span> <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">ViewPager</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-literal" style="color:#006666;box-sizing:border-box;">-</span><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">ViewPager</span><span class="hljs-string" style="color:#008800;box-sizing:border-box;">.</span><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">getCurrentItem()</span></code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
</ul>
</pre><h3 id="244-viewpath起点优化" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t17" style="box-sizing:border-box;color:#0c89cf;"></a>2.4.4 ViewPath起点优化</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　<strong style="box-sizing:border-box;">ViewPath从ContentView为起点，而非DecorView</strong></p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">DecorView : Window上的根视图，ViewTree中的根，最顶层视图</li>
<li style="box-sizing:border-box;">ContentView: 客户端程序员定义的所有视图的父节点，如Actvity中常见的setContentView(view)</li>
</ul>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">一个实际中的ViewPath如下：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">DecorView/LinearLayout[0]/FrameLayout[0]/ActionBarOverlayLayout[0]/ContentFrameLayout[0]/FrameLayout[0]/LinearLayout[0]/ViewPager[0]/ButtonFragment[0]/AppCompatButton[0]</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　上面的<strong style="box-sizing:border-box;">“ContentFrameLayout[0]”</strong>这个节点代表的就是<strong style="box-sizing:border-box;">ContentView</strong>，程序员在xml或者代码里面构建的View都在ContentView中。&nbsp;<br style="box-sizing:border-box;" />
　　从DecorView到“ContentFrameLayout[0]”的这一段Path是Android系统Framework层决定的,理论上应该是一致的，但是由于碎片化等原因可能ViewPath的这一段发生变化．在实践中，我们也发现确实有一些Rom发生了此类情况，但是比率很小．&nbsp;<br style="box-sizing:border-box;" />
　　为了屏蔽这种可能造成同一个View在不同设备上产生ViewPath不同的情况，ViewPath的起点定义在ContentView比较好．如上面的ViewPath可优化为：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs bash has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">ContentView/FrameLayout[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]/LinearLayout[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]/ViewPager[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]/ButtonFragment[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]/AppCompatButton[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]<span class="hljs-comment" style="color:#880000;box-sizing:border-box;">#mybutton</span></code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><strong style="box-sizing:border-box;">做法：</strong>&nbsp;<br style="box-sizing:border-box;" />
　　构造每一个ViewPath节点时可以取view.getId()，看看<strong style="box-sizing:border-box;">id的packageId部分是不是系统的</strong>（系统资源id以16进制的0x01,0x00开头），如果是，生成ViewPath时屏蔽这段即可．</p>
<hr style="box-sizing:border-box;margin:2em 0px;border-right-width:0px;border-bottom-width:0px;border-left-width:0px;border-top-style:solid;border-top-color:rgba(128, 128, 128, 0.0980392);" />
<h1 id="三页面的划分" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t18" style="box-sizing:border-box;color:#0c89cf;"></a>三、页面的划分</h1>
<h2 id="31-合理划分页面的重要性" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t19" style="box-sizing:border-box;color:#0c89cf;"></a>3.1 合理划分页面的重要性</h2>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　页面在Android中对应于Activity和部分Fragment(比如很多app首页多tab的设计，若每个tab是使用Fragment实现的,那么这种tab一般看作一个页面)．页面的划分很重要，因为两点：&nbsp;<br style="box-sizing:border-box;" />
1. 对于页面，需要获取Show/Hide两个时机，在此时机上报页面Show/Hide事件,非页面则不需要&nbsp;<br style="box-sizing:border-box;" />
2. 页面的划分关系着用户交互事件的所属，例如，按钮点击事件上报格式如下：</p>
<table style="box-sizing:border-box;width:948px;background-color:transparent;border-spacing:0px;border:1px solid #eeeeee;"><thead style="box-sizing:border-box;"><tr style="box-sizing:border-box;"><th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">事件名称</th>
<th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">所属页面</th>
<th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">ViewPath</th>
<th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">其他属性</th>
</tr>
</thead><tbody style="box-sizing:border-box;"><tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">ButtonClicked</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">MainActivity</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">XXX</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">省略</td>
</tr>
</tbody>
</table>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　表格中的<strong style="box-sizing:border-box;">＂所属页面＂</strong>即<strong style="box-sizing:border-box;">表示此次按钮点击事件发生在MainActivity中</strong>．将交互事件归属于页面这样对后面无论是进行路径分析还是统计控件点击量分布都有很大的好处．</p>
<h2 id="32-android中的页面" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t20" style="box-sizing:border-box;color:#0c89cf;"></a>3.2 Android中的页面</h2>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　Android中通常需要看作页面的有Activity和Fragment(对于像全屏Dialog或者全屏的View暂不考虑)．对于Activity，上节中提到的两点都很容易办到.</p>
<h3 id="activity页面" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t21" style="box-sizing:border-box;color:#0c89cf;"></a>Activity页面</h3>
<ol style="box-sizing:border-box;"><li style="box-sizing:border-box;">从Application.ActivityLifecycleCallbacks的onActivityResumed／onActivityPaused这两个回调方法就可以分别得到Activity页面Show/Hide的时机，并在此时机上报相应页面事件</li>
<li style="box-sizing:border-box;">交互归属的Activity页面可以通过Context轻松获得，例如上篇文章<a href="http://www.jianshu.com/p/c202853059b4" style="text-decoration:none;box-sizing:border-box;color:#0c89cf;">&lt;</a></li>
</ol>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs mathematica has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">Monitor</span>.onViewClick(view)</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">入参view即为我们点击的view,通过view.getContext()我们一般就可以得到此View所属的Activity,伪代码如下：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs java has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">//从View中利用context获取所属Activity的名字</span> <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">public</span> <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">static</span> String <span class="hljs-title" style="box-sizing:border-box;">getActivityName</span>(View view) {
    Context context = view.getContext();
    <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">if</span> (context <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">instanceof</span> Activity) {
      <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">//context本身是Activity的实例</span>       <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">return</span> context.getClass().getSimpleName().;
    } <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">else</span> <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">if</span> (context <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">instanceof</span> ContextWrapper) {
      <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">//Activity有可能被系统＂装饰＂，看看context.base是不是Activity</span>       Activity activity = getActivityFromContextWrapper((ContextWrapper) context);
      <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">if</span> (activity != <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">null</span>) {
        <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">return</span> activity.getClass().getSimpleName();
      } <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">else</span> {
        <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">//如果从view.getContext()拿不到Activity的信息（比如view的context是Application）,则返回当前栈顶Activity的名字</span>         <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">return</span> currentActivityName;
      }
    }
    <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">return</span> <span class="hljs-string" style="color:#008800;box-sizing:border-box;">""</span>;
  }</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
<li style="box-sizing:border-box;padding:0px 5px;">5</li>
<li style="box-sizing:border-box;padding:0px 5px;">6</li>
<li style="box-sizing:border-box;padding:0px 5px;">7</li>
<li style="box-sizing:border-box;padding:0px 5px;">8</li>
<li style="box-sizing:border-box;padding:0px 5px;">9</li>
<li style="box-sizing:border-box;padding:0px 5px;">10</li>
<li style="box-sizing:border-box;padding:0px 5px;">11</li>
<li style="box-sizing:border-box;padding:0px 5px;">12</li>
<li style="box-sizing:border-box;padding:0px 5px;">13</li>
<li style="box-sizing:border-box;padding:0px 5px;">14</li>
<li style="box-sizing:border-box;padding:0px 5px;">15</li>
<li style="box-sizing:border-box;padding:0px 5px;">16</li>
<li style="box-sizing:border-box;padding:0px 5px;">17</li>
<li style="box-sizing:border-box;padding:0px 5px;">18</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
<li style="box-sizing:border-box;padding:0px 5px;">5</li>
<li style="box-sizing:border-box;padding:0px 5px;">6</li>
<li style="box-sizing:border-box;padding:0px 5px;">7</li>
<li style="box-sizing:border-box;padding:0px 5px;">8</li>
<li style="box-sizing:border-box;padding:0px 5px;">9</li>
<li style="box-sizing:border-box;padding:0px 5px;">10</li>
<li style="box-sizing:border-box;padding:0px 5px;">11</li>
<li style="box-sizing:border-box;padding:0px 5px;">12</li>
<li style="box-sizing:border-box;padding:0px 5px;">13</li>
<li style="box-sizing:border-box;padding:0px 5px;">14</li>
<li style="box-sizing:border-box;padding:0px 5px;">15</li>
<li style="box-sizing:border-box;padding:0px 5px;">16</li>
<li style="box-sizing:border-box;padding:0px 5px;">17</li>
<li style="box-sizing:border-box;padding:0px 5px;">18</li>
</ul>
</pre><h3 id="fragment页面" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t22" style="box-sizing:border-box;color:#0c89cf;"></a>fragment页面</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　相对于Activity，将某些Fragment看作页面的逻辑就要稍微复杂一些了．这里面涉及下面几个问题：</p>
<ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">哪些Fragment可以需要看作页面？&nbsp;<br style="box-sizing:border-box;" />
　　这是需要人工决策的，机器做不了这个决定．&nbsp;<br style="box-sizing:border-box;" />
　　目前我们这个人工干预是交给<strong style="box-sizing:border-box;">用户研究团队</strong>，所有Fragment截图等信息均展示在平台上，由用研同事选择需要看作页面的那些，<strong style="box-sizing:border-box;">用研选择的结果将自动化配置到SDK中</strong>．</li>
<li style="box-sizing:border-box;">如何得到Fragment页面的Show/Hide页面事件？&nbsp;<br style="box-sizing:border-box;" />
　　由于fragment使用场景比较多样，单单依靠OnResume/OnPause两个回调表示fragment Show/Hide是不准确的,比如：&nbsp;<br style="box-sizing:border-box;" />
<strong style="box-sizing:border-box;"><em style="box-sizing:border-box;">场景一</em></strong>：&nbsp;<br style="box-sizing:border-box;" />
　　首页一个Activity承载多个Fragment Tab的情况，此时tab间切换并不会触发Fragment的OnResume/OnPause．<strong style="box-sizing:border-box;">触发的回调函数是onHiddenChanged(boolean hidden)</strong>&nbsp;<br style="box-sizing:border-box;" />
<strong style="box-sizing:border-box;"><em style="box-sizing:border-box;">场景二：</em></strong>&nbsp;<br style="box-sizing:border-box;" />
　　一个ViewPager承载多个页面的Fragment时&nbsp;<br style="box-sizing:border-box;" />
　　　　a.当第一个Fragment1显示时，虽然第二个Fragment2此时尚未显示，但是Fragment2的OnResume却以及执行，处于resumed的状态．&nbsp;<br style="box-sizing:border-box;" />
　　　　b.ViewPager页面切换OnResume/OnPause/onHiddenChanged均未触发，触发的回调是setUserVisibleHint&nbsp;<br style="box-sizing:border-box;" />
　　<strong style="box-sizing:border-box;">此时判断Fragment　Show/Hide应该用setUserVisibleHint，而非OnResume/OnPause</strong>&nbsp;<br style="box-sizing:border-box;" />
　　如前一篇文章XXX,所述，我们通过插桩的方式Hook到了fragment的如下生命周期函数用于包装成为Show/Hide事件：</li>
</ul>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs erlang has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-function" style="box-sizing:border-box;"><span class="hljs-title" style="box-sizing:border-box;">onResume</span><span class="hljs-params" style="color:#660066;box-sizing:border-box;">()</span> <span class="hljs-title" style="box-sizing:border-box;">onPause</span><span class="hljs-params" style="color:#660066;box-sizing:border-box;">()</span> <span class="hljs-title" style="box-sizing:border-box;">onHiddenChanged</span><span class="hljs-params" style="color:#660066;box-sizing:border-box;">(boolean hidden)</span> <span class="hljs-title" style="box-sizing:border-box;">setUserVisibleHint</span><span class="hljs-params" style="color:#660066;box-sizing:border-box;">(boolean is<span class="hljs-variable" style="box-sizing:border-box;">VisibleToUser</span>)</span></span></code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">使用这几个回调包装成适用于各种情景的FragmentShow/Hide事件的伪代码如下：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs livecodeserver has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">//此回调发生，则证明是场景一中使用情景，
  onHiddenChanged(boolean hidden) {
    hidden == <span class="hljs-constant" style="box-sizing:border-box;">true</span> <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">------FragmentShow</span>     hidden == <span class="hljs-constant" style="box-sizing:border-box;">false</span><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">------FragmentHide</span>   }<span class="hljs-comment" style="color:#880000;box-sizing:border-box;"> //场景二中ViewPager页面切换时触发Fragment的此回调，</span>   setUserVisibleHint(boolean isVisibleToUser) {
    <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">if</span> (fragment.isResumed()) <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">{//只有resumed状态的fragment适用此情景</span>       isVisibleToUser == <span class="hljs-constant" style="box-sizing:border-box;">true</span> <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">------FragmentShow</span>       isVisibleToUser == <span class="hljs-constant" style="box-sizing:border-box;">false</span><span class="hljs-comment" style="color:#880000;box-sizing:border-box;">------FragmentHide</span>     }
  }<span class="hljs-comment" style="color:#880000;box-sizing:border-box;"> //上述使用情景之外的一般场景</span>   OnResume/OnPause{<span class="hljs-comment" style="color:#880000;box-sizing:border-box;">　//fragment没有被hide,并且UserVisibleHint为可见的情景</span>     <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">if</span> (!fragment.isHidden() &amp;&amp; fragment.getUserVisibleHint()) {
      OnResume <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">------ FragmentShow</span>       OnPause  <span class="hljs-comment" style="color:#880000;box-sizing:border-box;">------ FragmentHide</span>     }
  }</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
<li style="box-sizing:border-box;padding:0px 5px;">5</li>
<li style="box-sizing:border-box;padding:0px 5px;">6</li>
<li style="box-sizing:border-box;padding:0px 5px;">7</li>
<li style="box-sizing:border-box;padding:0px 5px;">8</li>
<li style="box-sizing:border-box;padding:0px 5px;">9</li>
<li style="box-sizing:border-box;padding:0px 5px;">10</li>
<li style="box-sizing:border-box;padding:0px 5px;">11</li>
<li style="box-sizing:border-box;padding:0px 5px;">12</li>
<li style="box-sizing:border-box;padding:0px 5px;">13</li>
<li style="box-sizing:border-box;padding:0px 5px;">14</li>
<li style="box-sizing:border-box;padding:0px 5px;">15</li>
<li style="box-sizing:border-box;padding:0px 5px;">16</li>
<li style="box-sizing:border-box;padding:0px 5px;">17</li>
<li style="box-sizing:border-box;padding:0px 5px;">18</li>
<li style="box-sizing:border-box;padding:0px 5px;">19</li>
<li style="box-sizing:border-box;padding:0px 5px;">20</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
<li style="box-sizing:border-box;padding:0px 5px;">5</li>
<li style="box-sizing:border-box;padding:0px 5px;">6</li>
<li style="box-sizing:border-box;padding:0px 5px;">7</li>
<li style="box-sizing:border-box;padding:0px 5px;">8</li>
<li style="box-sizing:border-box;padding:0px 5px;">9</li>
<li style="box-sizing:border-box;padding:0px 5px;">10</li>
<li style="box-sizing:border-box;padding:0px 5px;">11</li>
<li style="box-sizing:border-box;padding:0px 5px;">12</li>
<li style="box-sizing:border-box;padding:0px 5px;">13</li>
<li style="box-sizing:border-box;padding:0px 5px;">14</li>
<li style="box-sizing:border-box;padding:0px 5px;">15</li>
<li style="box-sizing:border-box;padding:0px 5px;">16</li>
<li style="box-sizing:border-box;padding:0px 5px;">17</li>
<li style="box-sizing:border-box;padding:0px 5px;">18</li>
<li style="box-sizing:border-box;padding:0px 5px;">19</li>
<li style="box-sizing:border-box;padding:0px 5px;">20</li>
</ul>
</pre><ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">如何将Fragment内部的<strong style="box-sizing:border-box;">交互归属到Fragment页面</strong>，也就是说如何在<strong style="box-sizing:border-box;">交互发生时从view实例拿到Fragment页面的名字</strong>（像之前拿到Activity页面名字一样）？&nbsp;<br style="box-sizing:border-box;" />
　　view可以通过context拿到Activity的信息，但是却没有途径拿到fragment的引用。那么，当某个View交互发生，我们又需要获取Fragment页面名字的情况下，我们只能事先将Fragment页面名写入此View的属性中。&nbsp;<br style="box-sizing:border-box;" />
　　做法大致如下：&nbsp;<br style="box-sizing:border-box;" />
　　　　1. 按照前一篇文章xxx里面的方法，在Fragment.OnCreateView方法的结尾插桩，<strong style="box-sizing:border-box;">拿到return的view（即为此Fragment的顶层视图）</strong>&nbsp;<br style="box-sizing:border-box;" />
　　　　2. 判断此Fragment是否被指定为Fragment页面,如果是，下一步&nbsp;<br style="box-sizing:border-box;" />
　 3. 遍历以Fragment的顶层视图为根节点的ViewTree, 将<strong style="box-sizing:border-box;">Fragment名设置到此ViewTree的每一个view上</strong>。设置方法如下所示：</li>
</ul>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs avrasm has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">view<span class="hljs-preprocessor" style="color:#444444;box-sizing:border-box;">.setTag</span>(<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0xff000001</span>, fragmentName)<span class="hljs-comment" style="color:#880000;box-sizing:border-box;">;</span></code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">注意：<strong style="box-sizing:border-box;">View类有两个名为setTag的方法</strong>：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs java has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">public</span> <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">void</span> <span class="hljs-title" style="box-sizing:border-box;">setTag</span>(<span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">final</span> Object tag)</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　此方法，类内部用一<strong style="box-sizing:border-box;">Object对象存储tag</strong>，protected Object mTag = null;。listAdapter中常用于设置holder。我们此处用的不是这个，<strong style="box-sizing:border-box;">不会于此用法冲突</strong></p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs java has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">public</span> <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">void</span> <span class="hljs-title" style="box-sizing:border-box;">setTag</span>(<span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">int</span> key, <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">final</span> Object tag)</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　此方法，类内部有一<strong style="box-sizing:border-box;">稀疏数组存储tag</strong>，private SparseArray mKeyedTags;&nbsp;<br style="box-sizing:border-box;" />
　　tag的<strong style="box-sizing:border-box;">key官方推荐资源id</strong>，因此我们可以<strong style="box-sizing:border-box;">选用类似0xff000001之类的app用不到的资源id进行tag存储以避免冲突</strong>。&nbsp;<br style="box-sizing:border-box;" />
　　　　4. 当需要使用Fragment名时，如下调用即可获得：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs avrasm has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">view<span class="hljs-preprocessor" style="color:#444444;box-sizing:border-box;">.getTag</span>(<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0xff000001</span>)</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><h2 id="33-页面名组成" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t23" style="box-sizing:border-box;color:#0c89cf;"></a>3.3 页面名组成</h2>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">前面讲了将交互事件（比如点击事件）归属到某一个页面的方法是：</p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">在交互事件中设置一个字段，值为页面名称。</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">页面可以是Activity或者Activity承载的Fragment，我们的页面名称组成如下：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs markdown has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">Activity类名[<span class="hljs-link_label" style="box-sizing:border-box;">Activity别名</span>][<span class="hljs-link_reference" style="box-sizing:border-box;">Fragment类名</span>][<span class="hljs-link_label" style="box-sizing:border-box;">Fragment别名</span>]</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">说明如下：</p>
<ol style="box-sizing:border-box;"><li style="box-sizing:border-box;">“[]”内的组成部分是可选的，可能有可能没有。另外，各个组成部分之间有分隔符分割。</li>
<li style="box-sizing:border-box;">页面名组成中，Activity的描述（类名/别名）是第一层，Fragment的描述（类名/别名）是第二层</li>
<li style="box-sizing:border-box;"><strong style="box-sizing:border-box;">别名的出现是为了解决单纯依赖类名无法精确区分页面的某些情况</strong>，比如：&nbsp;<br style="box-sizing:border-box;" />
在某个电商应用中，“商品详情页”（同一个Activity）用于展示各种商品（iphone,电视等），如果需要把“不同商品的商品详情页“区分成不同页面来统计pv等指标的话，需要设置别名，如：</li>
</ol>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">商品详情页＃iphone
商品详情页＃电视</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">对于别名的设置，需要程序员在业务代码里面（如Activity.OnCreate,Fragment.onCreate等）显式设置.</p>
<hr style="box-sizing:border-box;margin:2em 0px;border-right-width:0px;border-bottom-width:0px;border-left-width:0px;border-top-style:solid;border-top-color:rgba(128, 128, 128, 0.0980392);" />
<h1 id="四无需埋点轻松收集定制的业务数据" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t24" style="box-sizing:border-box;color:#0c89cf;"></a>四、无需埋点轻松收集定制的业务数据</h1>
<h2 id="41-配置示例" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t25" style="box-sizing:border-box;color:#0c89cf;"></a>4.1 配置示例</h2>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　之前提到过，数据收集SDK可以通过配置下发即时收集定制的数据，那么在Android端这个是怎么做到的呢？&nbsp;<br style="box-sizing:border-box;" />
首先，看一下下发的配置样例:</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs r has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">//第一部分：描述
PageName:MainActivity
ViewPath:DecorView/<span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">...</span>/ViewPager[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]/ButtonFragment[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]/AppCompatButton[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]
EventType:ViewClick
//第二部分：数据路径（当描述符合时，按照此路径取数据）
DataPath:this.context.demoList[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">5</span>]</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
<li style="box-sizing:border-box;padding:0px 5px;">5</li>
<li style="box-sizing:border-box;padding:0px 5px;">6</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
<li style="box-sizing:border-box;padding:0px 5px;">5</li>
<li style="box-sizing:border-box;padding:0px 5px;">6</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">上面例子翻译成数据需求就是：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs r has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-number" style="color:#006666;box-sizing:border-box;">1.</span> 当页面(MainActivity)<span class="hljs-number" style="color:#006666;box-sizing:border-box;">2.</span> 中的控件（DecorView/<span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">...</span>/ViewPager[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]/ButtonFragment[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]/AppCompatButton[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">0</span>]）<span class="hljs-number" style="color:#006666;box-sizing:border-box;">3.</span> 发生点击事件（ViewClick）时<span class="hljs-number" style="color:#006666;box-sizing:border-box;">4.</span> 按照路径（this.context.demoList[<span class="hljs-number" style="color:#006666;box-sizing:border-box;">5</span>]）取出数据<span class="hljs-number" style="color:#006666;box-sizing:border-box;">5.</span> 并附加到点击事件上面一起上报</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
<li style="box-sizing:border-box;padding:0px 5px;">5</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
<li style="box-sizing:border-box;padding:0px 5px;">5</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">按照这个描述，我们还可以描述如下等等各种数据需求：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs mathematica has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">当(某页面)发生事件（<span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">Show</span>）时，按照路径（xxx）取出数据，并附加到页面<span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">Show</span>事件上面一起上报</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">总结下描述的组成部分，如下：</p>
<table style="box-sizing:border-box;width:948px;background-color:transparent;border-spacing:0px;border:1px solid #eeeeee;"><thead style="box-sizing:border-box;"><tr style="box-sizing:border-box;"><th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">第一层</th>
<th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">第二层</th>
<th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">含义</th>
</tr>
</thead><tbody style="box-sizing:border-box;"><tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">描述部分</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">页面</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">限定页面</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;"></td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">ViewPath</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">限定按钮</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;"></td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">EventType</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">限定时机（点击/前台/PageShow）</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">数据路径</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;"></td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">一种DSL，指示目标数据在内存中的位置（可理解为“引用路径”）</td>
</tr>
</tbody>
</table>
<h2 id="42-无埋点收集流程" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t26" style="box-sizing:border-box;color:#0c89cf;"></a>4.2 无埋点收集流程</h2>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　上节展示了用于无埋点定制业务数据收集的配置，那么SDK收到这样的一份配置如何最终把想要的数据收集上来呢？&nbsp;<br style="box-sizing:border-box;" />
* 步骤一：<strong style="box-sizing:border-box;">产生原始事件</strong>。比如点击时收集，当点击时会触发我们插桩的代码，并生成原始的点击事件</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs mathematica has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">Monitor</span>.onViewClick(view)</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><ul style="box-sizing:border-box;"><li style="box-sizing:border-box;">步骤二：<strong style="box-sizing:border-box;">匹配配置</strong>&nbsp;<br style="box-sizing:border-box;" />
在onViewClick方法中匹配下发的配置信息，看看Page,ViewPath是否与当前view匹配，EventType是否与当前事件类型匹配，若匹配则进行下一步&nbsp;<br style="box-sizing:border-box;" />
注：<strong style="box-sizing:border-box;"><em style="box-sizing:border-box;">ViewPath的匹配可以有精确匹配和模糊匹配</em></strong>，精确匹配时一个ViewPath精确匹配唯一一个控件．模糊匹配时一个ViewPath可匹配多个控件，例如可以用用一个ViewPath模糊匹配一个列表中的所有条目．</li>
<li style="box-sizing:border-box;">步骤三：按照数据路径（DataPath）<strong style="box-sizing:border-box;">逐级反射</strong>拿到目标数据，并将找到的数据附在原始的点击事件上进行上报。</li>
</ul>
<h2 id="43-数据路径datapath" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t27" style="box-sizing:border-box;color:#0c89cf;"></a>4.3 数据路径（DataPath）</h2>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　上述步骤三进行数据收集主要是按照DataPath的描述进行（例如示例中提到的＂this.context.demoList[5]＂），DataPath是一种我们用于收集定制数据而定义的一种DSL．含义如下：</p>
<h3 id="含义" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t28" style="box-sizing:border-box;color:#0c89cf;"></a>含义</h3>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">DataPath: 指向要收集的目标数据的一条引用路径，解析此路径并逐级反射最终拿到目标数据．</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　DataPath写法中的一些关键字(符)：</p>
<table style="box-sizing:border-box;width:948px;background-color:transparent;border-spacing:0px;border:1px solid #eeeeee;"><thead style="box-sizing:border-box;"><tr style="box-sizing:border-box;"><th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">关键字（符）</th>
<th align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">含义</th>
</tr>
</thead><tbody style="box-sizing:border-box;"><tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">.</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">表示对象所属关系，如：ａ.b 表示实例a中的字段b</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">.()</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">表示公有方法调用，如：ａ.b() 表示调用实例a中的方法b.注意：方法入参可以是DataPath指向的Object</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">[]</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">数组/线性表的index. 注意：此index可以是常量数字，也可以是一个DataPath指向的数字</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">this</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">DataPath字符串的起点，表示起点为当前实例（当前View）</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">item</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">DataPath字符串的起点，表示起点为当前View父节点中AdapterView adapter中当前条目. 常用于列表中的数据获取</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">parent</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">DataPath节点中的关键字，用于表示当前view的parentView.效果同view.getParent(),使用此关键字可减少视图引用中的反射</td>
</tr>
<tr style="box-sizing:border-box;"><td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">childAt(x)</td>
<td align="center" style="box-sizing:border-box;padding:8px;line-height:20px;vertical-align:top;border:1px solid #eeeeee;">DataPath节点中的关键字，用于表示当前view的第x个childView.效果同view.getChildAt(x),使用此关键字可减少视图引用中的反射</td>
</tr>
</tbody>
</table>
<h3 id="应用示例" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t29" style="box-sizing:border-box;color:#0c89cf;"></a>应用示例</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　下面用两个例子说明如何从DataPath找到目标数据．&nbsp;<br style="box-sizing:border-box;" />
　　&nbsp;<br style="box-sizing:border-box;" />
<img title="" alt="图４-1 DataPath示例" src="http://upload-images.jianshu.io/upload_images/1417134-df17372694a3137e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" style="border:none;box-sizing:border-box;max-width:602px;max-height:100%;height:auto;" /></p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><strong style="box-sizing:border-box;"><em style="box-sizing:border-box;">示例１：列表数据获取</em></strong>&nbsp;<br style="box-sizing:border-box;" />
　　上图中显示是一个列表，红框中是列表的第一个条目．那么，如果我们想要在<strong style="box-sizing:border-box;">列表中条目点击时，将列表展示的交易品ID(或者合作方ID)等不在界面上显示而又存在于内存中的数据跟随点击事件上报</strong>．此处DataPath该怎么写？</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs livecodeserver has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">item</span>.productId</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　<em style="box-sizing:border-box;">DataPath解释：</em></p>
<ol style="box-sizing:border-box;"><li style="box-sizing:border-box;">起点定为＂item＂,则表示从此ListView(或者RecylerView)绑定的Adapter中当前数据item为起点取数据．假设此ListView绑定的Adapter如下：</li>
</ol>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs java has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">public</span> <span class="hljs-class" style="box-sizing:border-box;"><span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">class</span> <span class="hljs-title" style="box-sizing:border-box;color:#660066;">DemoAdapter</span> <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">extends</span> <span class="hljs-title" style="box-sizing:border-box;color:#660066;">BaseAdapter</span> {</span>   <span class="hljs-keyword" style="color:#000088;box-sizing:border-box;">private</span> ArrayList&lt;DataItem&gt; mDataItems;
  ......
}</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
<li style="box-sizing:border-box;padding:0px 5px;">4</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">则此处”item”代表的就是mDataItems[x] (x表示当前被点击条目的itemId)&nbsp;<br style="box-sizing:border-box;" />
2. productId是model类DataItem中表示＂交易品ID＂的字段名称．</p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　<em style="box-sizing:border-box;">通过DataPath获取数据：</em></p>
<ol style="box-sizing:border-box;"><li style="box-sizing:border-box;">当第x条目被点击时，如果发现有匹配的配置，对于起点为”item”的DataPath，先通过view.getParent找到上层ListView实例，然后通过listView.getAdapter()获得绑定的Adapter实例，最后通过Adapter.getItem(ListView.getPositionForView(itemView))得到数据中第x个item,即mDataItems[x]</li>
<li style="box-sizing:border-box;">反射获取mDataItems[x]中的productId字段，即可得到第x个条目的＂交易品ID＂,将此ID跟随第x条目的点击事件进行上报即可．</li>
</ol>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><strong style="box-sizing:border-box;"><em style="box-sizing:border-box;">实例２：界面数据获取</em></strong>&nbsp;<br style="box-sizing:border-box;" />
　　同样时图4-1所示，加入我们想在列表中条目点击时，<strong style="box-sizing:border-box;">将条目中展示的”最新价”跟随点击事件上报</strong>．此处DataPath该怎么写？&nbsp;<br style="box-sizing:border-box;" />
　　红框所示ViewTree子树如下：</p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;"><img title="" alt="图4-2 列表Item ViewTree子树结构" src="http://upload-images.jianshu.io/upload_images/1417134-e2c37c582f8ebdc7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" style="border:none;box-sizing:border-box;max-width:602px;max-height:100%;height:auto;" /></p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　如上图，选中部分是列表的ItemView（RelativeLayout）,可见”最新价”是由index为2的TextView所展示，由此可得，列表中条目点击获取”最新价”数据的DataPath如下：</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs avrasm has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;">this<span class="hljs-preprocessor" style="color:#444444;box-sizing:border-box;">.childAt</span>(<span class="hljs-number" style="color:#006666;box-sizing:border-box;">2</span>)<span class="hljs-preprocessor" style="color:#444444;box-sizing:border-box;">.mText</span></code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　<em style="box-sizing:border-box;">DataPath解释：</em></p>
<ol style="box-sizing:border-box;"><li style="box-sizing:border-box;">起点为＂this＂,表示当前被点击的view实例（图4-2中被选中的RelativeLayout）</li>
<li style="box-sizing:border-box;">“childAt(2)”表示RelativeLayout.getChildAt(2),得到图4-2中index为２的TextView</li>
<li style="box-sizing:border-box;">“mText” 表示取出步骤２中得到TextView实例的mText字段（TextView控件显示的文字内容存储在mText字段内）</li>
<li style="box-sizing:border-box;">将取出的界面上显示的”最新价”数据添加到原始点击事件中，一起上报．</li>
</ol>
<h3 id="datapath注意事项" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t30" style="box-sizing:border-box;color:#0c89cf;"></a>DataPath注意事项：</h3>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">１．混淆．&nbsp;<br style="box-sizing:border-box;" />
　　由于DataPath本质上描述的时内存中的＂引用路径＂，并且按照DataPath取数据时用了反射的方法，因此DataPath应该描述的是混淆之后的＂引用路径＂．&nbsp;<br style="box-sizing:border-box;" />
　　虽然DataPath可能受到混淆的影响，但是</p>
<pre class="prettyprint" name="code" style="white-space:nowrap;word-wrap:break-word;box-sizing:border-box;position:relative;overflow-y:hidden;overflow-x:auto;margin-top:0px;margin-bottom:1.1em;font-family:'Source Code Pro', monospace;padding:5px 5px 5px 60px;line-height:1.45;word-break:break-all;color:#333333;background-color:rgba(128, 128, 128, 0.0470588);border:0px solid #888888;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;"><code class="hljs markdown has-numbering" style="display:block;padding:0px;background:transparent;color:inherit;box-sizing:border-box;font-family:&quot;Source Code Pro&quot;, monospace;font-size:inherit;white-space:pre;border-radius:0px;word-wrap:normal;"><span class="hljs-bullet" style="box-sizing:border-box;">* </span>用于存储数据的model类通常是不被混淆的．如我们之前的item关键字直接将起点设置为列表条目的model类对象，不受混淆影响．<span class="hljs-bullet" style="box-sizing:border-box;">* </span>通过关键字parent／childAt(x)可以在视图的引用中不受混淆影响<span class="hljs-bullet" style="box-sizing:border-box;">* </span>接口的方法通常不受混淆影响．因此在DataPath中多用接口方法调用</code><ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
</ul>
<ul class="pre-numbering" style="box-sizing:border-box;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;margin:0px;padding:6px 0px 40px;border-right:1px solid #dddddd;list-style:none;text-align:right;"><li style="box-sizing:border-box;padding:0px 5px;">1</li>
<li style="box-sizing:border-box;padding:0px 5px;">2</li>
<li style="box-sizing:border-box;padding:0px 5px;">3</li>
</ul>
</pre><p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　因此开发在<strong style="box-sizing:border-box;">配置DataPath时应尽量用上述不被混淆影响的字段及方法</strong>．但是，如果真的用到了混淆过的字段怎么办．我们的方案是：</p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">数据报警</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　比如版本１上配置的DataPath “a.b”,在升级新版本２后不再适用，则新版本２按照＂a.b＂收集时将收集不到，产生报警信息到后台．后台收到大量此种信息会提醒开发为新版本配置适用新版本的DataPath．</p>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">２．代码变化导致引用路径变化，从而致使之前配置的DataPath失效．&nbsp;<br style="box-sizing:border-box;" />
　　与代码中埋点相比，线上配置进行收集数据与代码的变化是并行的，无关的．这就有可能造成原有代码修改导致DataPath失效．其实如果客户端架构设计合理，功能迭代更多是在进行代码的扩展，而非修改，这种导致DataPath失效的情况应该会大大降低的．&nbsp;<br style="box-sizing:border-box;" />
　　但是无论如何：</p>
<blockquote style="box-sizing:border-box;margin:0px 0px 1.1em;padding:15px 20px;border-left:10px solid rgba(128, 128, 128, 0.0745098);background-color:rgba(128, 128, 128, 0.0470588);border-radius:0px 5px 5px 0px;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;box-sizing:border-box;line-height:1.25;">配置的DataPath摆脱不了与版本的相关性</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　对于此种问题我们依然是通过前面提到的＂数据报警＂进行监控及避免的．</p>
<h2 id="title" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t31" style="box-sizing:border-box;color:#0c89cf;"></a>　　</h2>
<h1 id="五结语" style="margin:0.8em 0px;padding:0px;box-sizing:border-box;font-weight:100;"><a name="t32" style="box-sizing:border-box;color:#0c89cf;"></a>五、结语</h1>
<p style="margin-top:0px;margin-bottom:1.1em;padding:0px;box-sizing:border-box;">　　综上，本文介绍了数据收集逻辑中３个比较关键的点（ViewID/Page/DataPath），结合上一篇文章的(AOP原理)，Android端无埋点数据收集技术上比较关键的点皆以总结完毕．&nbsp;<br style="box-sizing:border-box;" />
　　当然实现SDK过程中遭遇过很多比较有意思的技术问题，后续也会陆续进行整理．</p>
</div>
</div></body></html>