<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-04-19T03:45:41Z"/><meta name="updated" content="2017-04-19T03:45:43Z"/><title>关于Objective-C，Modules和Autolinking  OC自从Apple接手后，一直在不断改进。随着移动开发带来的OC开发者井喷式增加，客观上也要求Apple需要提供各种良好特性来支</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><h2 style="margin:0px;padding:0px;font-family:Arial;font-variant-ligatures:normal;orphans:2;widows:2;">关于Objective-C，Modules和Autolinking</h2>
<p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">OC自从Apple接手后，一直在不断改进。随着移动开发带来的OC开发者井喷式增加，客观上也要求Apple需要提供各种良好特性来支持这样一个庞大的开发者社区。iOS4时代的GCD，iOS5时代的ARC，iOS6时代的各种简化，每年我们都能看到OC在成为一种先进语言上的努力。基于SmallTalk和runtime，本身是C的超集，如此“根正苗红”的一门语言，在今年也迎来的新的变化。</p>
<p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">今年OC的最大变化就是加入了Modules和Autolinking。</p>
<h3 style="margin:0px;padding:0px;font-family:Arial;font-variant-ligatures:normal;orphans:2;widows:2;"><a name="t1" style="color:#ff9900;"></a>什么是Modules呢</h3>
<p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">在了解Modules之前我们需要先了解一下OC的import机制。<code style="margin:0px;padding:0.1em 0.4em;border:1px solid #c9e1f6;font-family:Consolas, Menlo, Monaco, &quot;Lucida Console&quot;, &quot;Liberation Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, monospace, serif;font-size:0.9em;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:bottom;background-color:#e8f2fb;word-wrap:break-word;">#import &lt;FrameworkFoo/HeaderBar.h&gt;</code>，我相信每个开发者都写过这样的代码，用来引用其他的头文件。熟悉C或者C++的童鞋可能会知道，在C和C++里是没有#import的，只有#include（虽然GCC现在为C和C++做了特殊处理使得import可以被编译），用来包含头文件。#include做的事情其实就是简单的复制粘贴，将目标.h文件中的内容一字不落地拷贝到当前文件中，并替换掉这句include，而#import实质上做的事情和#include是一样的，只不过OC为了避免重复引用可能带来的编译错误（这种情况在引用关系复杂的时候很可能发生，比如B和C都引用了A，D又同时引用了B和C，这样A中定义的东西就在D中被定义了两次，重复了），而加入了#import，从而保证每个头文件只会被引用一次。</p>
<blockquote style="font-variant-ligatures:normal;orphans:2;widows:2;margin:0px 0px 20px;padding:10px 20px;border-width:0px 0px 0px 3px;border-left-style:solid;border-left-color:#bf1827;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:inherit;vertical-align:baseline;quotes:none;color:#666666;"><p style="margin-top:0px;margin-bottom:0px;padding:0px;border:0px;font-family:inherit;font-style:inherit;font-variant-ligatures:inherit;font-variant-position:inherit;font-variant-caps:inherit;font-variant-numeric:inherit;font-variant-alternates:inherit;font-variant-east-asian:inherit;line-height:1.7em;vertical-align:baseline;">如果想深究，import的实现是通过#ifndef一个标志进行判断，然后在引入后#define这个标志，来避免重复引用的</p>
</blockquote>
<p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">实质上import也还是拷贝粘贴，这样就带来一个问题：当引用关系很复杂，或者一个头文件被非常多的实现文件引用时，编译时引用所占的代码量就会大幅上升（因为被引用的头文件在各个地方都被copy了一遍）。为了解决这个问题，C系语言引入了预编译头文件（PreCompiled Header），将公用的头文件放入预编译头文件中预先进行编译，然后在真正编译工程时再将预先编译好的产物加入到所有待编译的Source中去，来加快编译速度。比如iOS开发中Supporting Files组内的.pch文件就是一个预编译头文件，默认情况下，它引用了UIKit和Foundation两个头文件--这是在iOS开发中基本每个实现文件都会用到的东西。</p>
<p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">于是理论上说，想要提高编译速度，可以把所有头文件引用都放到pch中。但是这样面临的问题是在工程中随处可用本来不应该能访问的东西，而编译器也无法准确给出错误或者警告，无形中增加了出错的可能性。</p>
<p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">于是Modules诞生了。Modules相当于将框架进行了封装，然后加入在实际编译之时加入了一个用来存放已编译添加过的Modules列表。如果在编译的文件中引用到某个Modules的话，将首先在这个列表内查找，找到的话说明已经被加载过则直接使用已有的，如果没有找到，则把引用的头文件编译后加入到这个表中。这样被引用到的Modules只会被编译一次，但是在开发时又不会被意外使用到，从而同时解决了编译时间和引用泛滥两方面的问题。</p>
<p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">稍微追根问底，Modules是什么？其实无非是对框架进行了如下封装，拿UIKit为例：</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-style:inherit;font-variant-ligatures:inherit;font-variant-position:inherit;font-variant-caps:inherit;font-variant-numeric:inherit;font-variant-alternates:inherit;font-variant-east-asian:inherit;orphans:2;widows:2;margin-top:0px;margin-bottom:1.3em;padding:1em 15.1406px;border:1px solid #c9e1f6;font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;font-size:0.9em;line-height:1.3em;vertical-align:baseline;background-color:#e8f2fb;overflow:auto;width:575.625px;"><code class="language-objc hljs objectivec" style="display:block;padding:0.5em;background:#ffffff;color:#4d4d4c;margin:0px;border:none;font-family:Consolas, Menlo, Monaco, &quot;Lucida Console&quot;, &quot;Liberation Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, monospace, serif;font-size:0.9em;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:bottom;word-wrap:normal;overflow-x:auto;">framework module <span class="hljs-built_in" style="color:#f5871f;margin:0px;padding:0px;border:0px;font-family:inherit;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:baseline;">UIKit</span> {
    umbrella header <span class="hljs-string" style="color:#718c00;margin:0px;padding:0px;border:0px;font-family:inherit;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:baseline;">"UIKit.h"</span>     module * {<span class="hljs-keyword" style="color:#8959a8;margin:0px;padding:0px;border:0px;font-family:inherit;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:baseline;">export</span> *}
    link framework <span class="hljs-string" style="color:#718c00;margin:0px;padding:0px;border:0px;font-family:inherit;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:baseline;">"UIKit"</span> }</code></pre><p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">这个Module定义了首要头文件（UIKit.h），需要导出的子modules（所有），以及需要link的框架名称（UIKit）。需要指出的是，现在Module还不支持第三方的框架，所以只有SDK内置的框架能够从这个特性中受益。另外，在C++的源代码中，Modules也是被禁用的。</p>
<h3 style="margin:0px;padding:0px;font-family:Arial;font-variant-ligatures:normal;orphans:2;widows:2;"><a name="t2" style="color:#ff9900;"></a>好了，说了那么多，这玩意儿怎么用呢</h3>
<p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">关于普通开发者使用的这个新特性的方法，Apple在LLVM5.0（也就是Xcode5带的最新的编译器前端中）引入了一个新的编译符号<code style="margin:0px;padding:0.1em 0.4em;border:1px solid #c9e1f6;font-family:Consolas, Menlo, Monaco, &quot;Lucida Console&quot;, &quot;Liberation Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, monospace, serif;font-size:0.9em;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:bottom;background-color:#e8f2fb;word-wrap:break-word;">@import</code>，使用@符号将告诉编译器去使用Modules的引用形式，从而获取好处，比如想引用MessageUI，可以写成</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-style:inherit;font-variant-ligatures:inherit;font-variant-position:inherit;font-variant-caps:inherit;font-variant-numeric:inherit;font-variant-alternates:inherit;font-variant-east-asian:inherit;orphans:2;widows:2;margin-top:0px;margin-bottom:1.3em;padding:1em 15.1406px;border:1px solid #c9e1f6;font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;font-size:0.9em;line-height:1.3em;vertical-align:baseline;background-color:#e8f2fb;overflow:auto;width:575.625px;"><code class="language-objc hljs objectivec" style="display:block;padding:0.5em;background:#ffffff;color:#4d4d4c;margin:0px;border:none;font-family:Consolas, Menlo, Monaco, &quot;Lucida Console&quot;, &quot;Liberation Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, monospace, serif;font-size:0.9em;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:bottom;word-wrap:normal;overflow-x:auto;">@import MessageUI;</code></pre><p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">在使用上，这将等价于以前的<code style="margin:0px;padding:0.1em 0.4em;border:1px solid #c9e1f6;font-family:Consolas, Menlo, Monaco, &quot;Lucida Console&quot;, &quot;Liberation Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, monospace, serif;font-size:0.9em;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:bottom;background-color:#e8f2fb;word-wrap:break-word;">#import &lt;MessageUI/MessageUI.h&gt;</code>，但是将使用Modules的特性。如果只想使用某个特性的.h文件，比如<code style="margin:0px;padding:0.1em 0.4em;border:1px solid #c9e1f6;font-family:Consolas, Menlo, Monaco, &quot;Lucida Console&quot;, &quot;Liberation Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, monospace, serif;font-size:0.9em;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:bottom;background-color:#e8f2fb;word-wrap:break-word;">#import &lt;MessageUI/MFMailComposeViewController.h&gt;</code>，对应写作</p>
<pre style="white-space:pre-wrap;word-wrap:break-word;font-style:inherit;font-variant-ligatures:inherit;font-variant-position:inherit;font-variant-caps:inherit;font-variant-numeric:inherit;font-variant-alternates:inherit;font-variant-east-asian:inherit;orphans:2;widows:2;margin-top:0px;margin-bottom:1.3em;padding:1em 15.1406px;border:1px solid #c9e1f6;font-family:Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;font-size:0.9em;line-height:1.3em;vertical-align:baseline;background-color:#e8f2fb;overflow:auto;width:575.625px;"><code class="language-objc hljs objectivec" style="display:block;padding:0.5em;background:#ffffff;color:#4d4d4c;margin:0px;border:none;font-family:Consolas, Menlo, Monaco, &quot;Lucida Console&quot;, &quot;Liberation Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, monospace, serif;font-size:0.9em;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:bottom;word-wrap:normal;overflow-x:auto;">@import MessageUI<span class="hljs-variable" style="color:#c82829;margin:0px;padding:0px;border:0px;font-family:inherit;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:baseline;">.MFMailComposeViewController</span>;</code></pre><p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">当然，如果对于以前的工程，想要使用新的Modules特性，如果要把所有头文件都这样一个一个改成<code style="margin:0px;padding:0.1em 0.4em;border:1px solid #c9e1f6;font-family:Consolas, Menlo, Monaco, &quot;Lucida Console&quot;, &quot;Liberation Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, monospace, serif;font-size:0.9em;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:bottom;background-color:#e8f2fb;word-wrap:break-word;">@import</code>的话，会是很大的一个工作量。Apple自然也考虑到了这一点，于是对于原来的代码，只要使用的是iOS7或者MacOS10.9的SDK，在Build Settings中将Enable Modules(C and Objective-C)打开，然后保持原来的<code style="margin:0px;padding:0.1em 0.4em;border:1px solid #c9e1f6;font-family:Consolas, Menlo, Monaco, &quot;Lucida Console&quot;, &quot;Liberation Mono&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Courier New&quot;, monospace, serif;font-size:0.9em;font-style:inherit;font-variant:inherit;line-height:inherit;vertical-align:bottom;background-color:#e8f2fb;word-wrap:break-word;">#import</code>写法就行了。是的，不需要任何代码上的改变，编译器会在编译的时候自动地把可能的地方换成Modules的写法去编译的。</p>
<p style="margin-top:0px;margin-bottom:1.3em;padding:0px;font-variant-ligatures:normal;orphans:2;widows:2;border:0px;font-family:ff-tisa-web-pro-1, ff-tisa-web-pro-2, 'Lucida Grande', 'Hiragino Sans GB', 'Hiragino Sans GB W3', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif;font-size:16px;line-height:1.7em;vertical-align:baseline;color:#666666;">Autolinking是Modules的附赠小惊喜，因为在module定义的时候指定来link framework，所以在编译module时LLVM会将所涉及到的框架自动帮你写到link里去，不再需要到编译设置里去添加了。</p></body></html>