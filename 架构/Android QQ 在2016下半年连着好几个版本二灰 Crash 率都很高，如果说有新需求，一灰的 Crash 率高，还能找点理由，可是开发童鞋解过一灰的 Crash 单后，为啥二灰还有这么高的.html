<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-04-14T10:36:01Z"/><meta name="updated" content="2017-04-14T10:36:03Z"/><title>Android QQ 在2016下半年连着好几个版本二灰 Crash 率都很高，如果说有新需求，一灰的 Crash 率高，还能找点理由，可是开发童鞋解过一灰的 Crash 单后，为啥二灰还有这么高的</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">Android QQ 在2016下半年连着好几个版本二灰 Crash 率都很高，如果说有新需求，一灰的 Crash 率高，还能找点理由，可是开发童鞋解过一灰的 Crash 单后，为啥二灰还有这么高的 Crash 率，我们还有覆盖全 SNG、不少外 BG 明星产品的终端稳定性测试工具 NewMonkey 随身版（<strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">注</strong>：NewMonkey系腾讯内部研发的测试工具，外部app有兴趣请点击底部“<span style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;color:#0080ff;">阅读原文</span>”填问卷调查申请使用）每天都在跑，更何况大多 Top Crash 都发生在用户使用很普通、很频繁的场景，实在令人匪夷所思，那段时间抄送各老板的运营邮件 Crash 率数据天天标红，项目组人心惶惶，发个版本感觉要烧高香，当时作为 Android NewMonkey 核心成员的我更是压力山大，在这样的背景下，我临危受命，负责研究外网 Top Crash，尽可能找到一些共性问题，在研究过程中，得到开发的大多反馈是：</p>
<ol class="list-paddingleft-2" style="margin:1.2em 0px;padding:0px 0px 0px 2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">问开发：这个 Top Crash 能找到复现场景吗？答：场景就在这里，但就是复现不了</p>
</li>
<li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">这里有个线程安全问题，那我加个同步；这里有个空指针，那我就加个判空</p>
</li>
</ol>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">一时间我也陷入深深的困扰：</strong></p>
<ol class="list-paddingleft-2" style="margin:1.2em 0px;padding:0px 0px 0px 2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">代码是开发写的，开发都复现不了，我更复现不了啊</p>
</li>
<li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">会 Crash 的代码在那，开发就改了，完全是头痛医头脚痛医脚的做法，作为一个测试，我还能做啥呢？</p>
</li>
</ol>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">当时的心情真的是如图所示：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKwl5Rndmq1Y3cWictfVYUh3MhWribXFlMWERZ3pzSX6KamsFUDeVfTiaRA/0?wx_fmt=jpeg" data-ratio="0.7216666666666667" data-w="600" src="http://mmbiz.qpic.cn/mmbiz_jpg/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKwl5Rndmq1Y3cWictfVYUh3MhWribXFlMWERZ3pzSX6KamsFUDeVfTiaRA/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">然而作为一名专项测试，如果只是看到这些表象，是远远不够的，也感谢老大一直对我的激励：“一切你复现不了的 Crash，那都是你没有找到问题的根源。”我当时给自己的目标是“一定要复现，有条件要上，没有条件创造条件也要上。”</p>
<h2 style="margin:1.3em 0px 1em;padding:0px;font-size:1.4em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;box-sizing:border-box !important;word-wrap:break-word !important;">线程安全问题的现状</h2>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=2653578648&amp;idx=1&amp;sn=8fecce896bf881334507e7f3f3486c54&amp;chksm=84b3b79fb3c43e89c98ed2e7f60c3c59f00324f53fef012ed33cb8fc6b37e430e83a52dc5f68&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=2653578648&amp;idx=1&amp;sn=8fecce896bf881334507e7f3f3486c54&amp;chksm=84b3b79fb3c43e89c98ed2e7f60c3c59f00324f53fef012ed33cb8fc6b37e430e83a52dc5f68&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:#607fa6;text-decoration:none;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">《Bugly2016移动应用质量大数据报告》</a>提到：</p>
<blockquote style="margin:1.2em 0px;padding:0px 1em;max-width:100%;border-left-width:4px;border-left-style:solid;border-left-color:#dddddd;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;color:#777777;quotes:none;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">空指针异常在Java代码中最为常见，不出所料，<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">NullPointerException</code>依然是最常见的Java异常，该异常影响面广但容易修复，开发者想快速降低崩溃率可以优先解决此类异常。相较于2015年，<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">IllegalStateException</code>从5%提升至10%，<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">OutOfMemoryError</code>从3%提升至6%。</p>
</blockquote>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">——数据源自腾讯Bugly</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz_jpg/tnZGrhTk4deT79e1NV6de4Viau9WyZQRK0uB5KRyw6gdBepKWLLVOFQ8OJTvY3AnCRWl7djiaFmbwBH2pibXMicmgw/0?wx_fmt=jpeg" data-ratio="0.75" data-w="640" src="http://mmbiz.qpic.cn/mmbiz_jpg/tnZGrhTk4deT79e1NV6de4Viau9WyZQRK0uB5KRyw6gdBepKWLLVOFQ8OJTvY3AnCRWl7djiaFmbwBH2pibXMicmgw/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">IllegalStateException</code>主要是由线程引起的，本篇就线程安全类问题与您一探究竟，我将向您展示研究过程中的乐趣以及最终取得的效果，另外解密我申请的两个线程领域的专利。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">我们先来看一种具有代表性的Crash，这里以一次灰度的Top 1 Crash为例子，至于这个Crash的引入原因，开发童鞋为了修改性能bug，将方法放到了线程中执行，我省去中间几百行代码，抽取出代码梗概。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKoI58ZeYJPibZpyQ8jUgBN7icOAmJQWiarV8hIOmM6vUZwxpo176fy5Uzw/0?wx_fmt=png" data-ratio="0.23061224489795917" data-w="490" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKoI58ZeYJPibZpyQ8jUgBN7icOAmJQWiarV8hIOmM6vUZwxpo176fy5Uzw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">类中声明了一个成员变量<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">mTask</code></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKf06JicvPTI829XWYSlYibX7wSUOgR2ycfp23kMmicMgnFic2FUOuib52VtA/0?wx_fmt=png" data-ratio="0.21689785624211855" data-w="793" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKf06JicvPTI829XWYSlYibX7wSUOgR2ycfp23kMmicMgnFic2FUOuib52VtA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">getDrawable</code>会被多次调用，ThreadManager是Android QQ线程管理组件，用ThreadManager提交了一个Runnable任务，<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">run()</code>里调用<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">decodeBigImage</code>做解码，<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">new</code>一个<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">AsyncTask</code>对象，然后<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">execute</code>。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKaKIyiblLviaqRZPRTsouuAic2OyOlicvDnTmqIEXcX3hAzpVCzbN6JDlicQ/0?wx_fmt=png" data-ratio="0.20949720670391062" data-w="716" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKaKIyiblLviaqRZPRTsouuAic2OyOlicvDnTmqIEXcX3hAzpVCzbN6JDlicQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRK8icA6H7neL7BkoeV5rApwDMB1iasiaM97hVcZLBkuFk2NclR3mQSupagA/0?wx_fmt=png" data-ratio="0.4067524115755627" data-w="622" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRK8icA6H7neL7BkoeV5rApwDMB1iasiaM97hVcZLBkuFk2NclR3mQSupagA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">首先说明同一个<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">AsyncTask</code>实例不能<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">execute</code>多次，否则就会报：</p>
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding:0px;max-width:100%;color:#3e3e3e;font-size:1em;font-variant-ligatures:normal;orphans:2;widows:2;font-family:Consolas, Inconsolata, Courier, monospace;line-height:1.2em;box-sizing:border-box !important;word-wrap:break-word !important;"><code style="margin:0px 0.15em;padding:0.5em 0.7em;max-width:100%;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;background-color:#f8f8f8;overflow:auto;border-top-left-radius:3px;border-top-right-radius:3px;border-bottom-right-radius:3px;border-bottom-left-radius:3px;border:1px solid #cccccc;box-sizing:border-box !important;word-wrap:break-word !important;display:block !important;">java.lang.IllegalStateException: Cannot execute task: the task is already running</code></pre><p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">Top Crash中正是在<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">decodeBigImage</code>方法中<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">mTask.execute</code>那一行报的这个错，开发童鞋的解法，那就很自然了，虽然不知道怎么Crash的，先将<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">decodeBigImage</code>加了同步，反正不会Crash了，况且当时紧急情况下，也容不得多想。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKaKIyiblLviaqRZPRTsouuAic2OyOlicvDnTmqIEXcX3hAzpVCzbN6JDlicQ/0?wx_fmt=png" data-ratio="0.20949720670391062" data-w="716" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:140.363px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:670px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">请您静思几秒，想想上面的代码不加同步可能会有什么问题，这个Top Crash开发、测试同学一度觉得十分诡异，实在想不出哪里会有问题，<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">mTask</code>怎么会执行多次呢？代码里每次都有<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">new</code>对象啊，然后用新建出来的对象<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">execute</code>，怎么会有问题呢？</p>
<h2 style="margin:1.3em 0px 1em;padding:0px;font-size:1.4em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;box-sizing:border-box !important;word-wrap:break-word !important;">问题的剖析</h2>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">问题的分析，分析的一些方法无非就是从日志、代码逻辑、原理上着手了。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">如果您当初像我一样，没啥思路，不妨先做一道笔试题吧：</p>
<blockquote style="margin:1.2em 0px;padding:0px 1em;max-width:100%;border-left-width:4px;border-left-style:solid;border-left-color:#dddddd;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;color:#777777;quotes:none;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">i=0,两个线程分别执行i++，可能的结果有1、2</p>
</blockquote>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">解释</strong>：i++不是原子操作，每次要先把i从内存读取到寄存器，然后++，然后再把寄存器中的值写回到内存中，这需要至少3步。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">可能出现的情况：</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">Case1：</strong></p>
<blockquote style="margin:1.2em 0px;padding:0px 1em;max-width:100%;border-left-width:4px;border-left-style:solid;border-left-color:#dddddd;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;color:#777777;quotes:none;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">thread1 读到0，寄存器加1，写回内存1</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">thread2 读到0，寄存器加1，写回内存1</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">结果：1</p>
</blockquote>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">Case2：</strong></p>
<blockquote style="margin:1.2em 0px;padding:0px 1em;max-width:100%;border-left-width:4px;border-left-style:solid;border-left-color:#dddddd;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;color:#777777;quotes:none;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">thread1 读到0，寄存器加1，写回内存1</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">thread2 读到1，寄存器加1，写回内存2</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">结果：2</p>
</blockquote>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">到这里，您或许有点思路了，因为我们潜意识把decodeBigImage()看成了原子操作，然而真实情况并非如此。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKaKIyiblLviaqRZPRTsouuAic2OyOlicvDnTmqIEXcX3hAzpVCzbN6JDlicQ/0?wx_fmt=png" data-ratio="0.20949720670391062" data-w="716" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:140.363px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:670px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">如果是两个线程同时并发，一共有4种情况，我用图给您展示两种：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-type="gif" data-src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKb93vjCDhXiaRmj9iaWqpNeRWbSjpNSDZ8IoXJ8MCsW3chPX294GFbKcw/0?wx_fmt=gif" data-ratio="0.4253968253968254" data-w="945" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" class=" __bg_gif" data-order="0" style="margin:0px;padding:0px;height:285.016px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:670px !important;" /></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-type="gif" data-src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKfKuCKwVuVDMgDlyaHE7vAASm3sU6KdpIR22mUoZJaCzPdbmYI3ofIQ/0?wx_fmt=gif" data-ratio="0.4253968253968254" data-w="945" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" class=" __bg_gif" data-order="1" style="margin:0px;padding:0px;height:285.016px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:670px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">两个线程在并发的情况下，用排列组合的知识，很容易算出发生Crash的概率是50%，那这个概率还是蛮高的，如果更多数量线程并发，Crash概率更高，那也就不难理解这个Crash是Top 1 Crash了。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">问：那为啥我们复现不了？</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">答：因为我省掉的几百行代码中，随时有if else分支有可能return掉，并且cpu瞬息万变，我们手工很难构造出线程并发的条件。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">如果到这里，对临界资源访问的方法加了同步，这个Crash就算解决了，那下次碰到这类问题，都要等出了问题后，再加同步吗？那这个代价有点太高了，况且Crash 我还没复现出来呢。</p>
<h2 style="margin:1.3em 0px 1em;padding:0px;font-size:1.4em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;box-sizing:border-box !important;word-wrap:break-word !important;">问题可能的解决方案</h2>
<h4 style="margin:1.3em 0px 1em;padding:0px;font-size:1.2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;">1．监控临界资源的变更记录</h4>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">既然问题发生在一个类成员变量有多处对它修改，出现了覆盖写的情况，那监控变量值变更记录，似乎是个有效的监控手段，但请教了专业做静态代码扫描codedog的同学，行业内貌似没有成熟的解决方案，动态执行时做这个变量值监控似乎难度不小。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">那么多变量哪些该监控？怎么判断出值变更有问题的？怎么避免误报？这些都有不小的难度。</p>
<h4 style="margin:1.3em 0px 1em;padding:0px;font-size:1.2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;">2. 在执行语句上暂停</h4>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">既然是给<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">mTask</code>赋值时出现的问题，一个线程执行后，那我们在这条语句上暂停，像调试一样，等其他线程来覆盖第一个线程的赋值结果，那这个Crash就能完整重现了，可这个方案依旧有不小的难度，那么多赋值语句，哪些需要暂停？怎么动态在语句执行时暂停？怎么释放？要解决好这些问题，难度依旧不小。</p>
<h4 style="margin:1.3em 0px 1em;padding:0px;font-size:1.2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;">3. 模拟线程并发</h4>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">既然这类线程安全的问题是在多线程并发时出现问题的概率大，避免发生Crash就加同步，避免线程并发访问临界资源，如果要在事发前发现这类问题，那我们就应该反其道而行之，增大线程并发的概率。由于有hook技术，对方法执行前后能做手脚，似乎有切入点。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">考虑到方案3已是我们能想到最容易实现的一个方案了，最终我们采用了方案3，但依然有不少问题要解决。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">一般线程执行情况是这样的：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-type="gif" data-src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKocPauGR7zSmZrjqYLp1JshqqH0dMPVFnucsV5P4TEozdmg4rxBLWng/0?wx_fmt=gif" data-ratio="0.8418674698795181" data-w="664" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" class=" __bg_gif" data-order="2" style="margin:0px;padding:0px;height:559px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:664px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">3.1、哪些线程需要并发？</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">因为有些线程八竿子打不着，没有竞争关系，根本就没必要让它们并发。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">我们这里先把范围局限在同一个方法启动的多个线程对同一个资源有竞争关系，归为同一类线程；如果是在不同方法里开启多个线程对同一个资源并发访问，这种情况更加复杂，静态分析做检查，都有很高的误报率，动态分析更加难做，暂时不在我们考虑范围内。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">3.2、怎么区分不同类别的线程？</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">应用程序中启动线程的地方不相同，则认为是不同类型的线程，我们用调用堆栈区分不同类型的线程。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">3.3、假设同时想让n个线程并发，怎么让它们在执行前都停住，然后让它们同时执行？</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">找到线程真正执行的地方，在执行前加一种计数器锁，如果计数值达到n后，再释放锁，加计数器锁后效果：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-type="gif" data-src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKsicRbXB4JaPkAmniac05gSLUjFicgd4mDAPv3s7LrF2GRMWFmYjJf7wvw/0?wx_fmt=gif" data-ratio="0.7829131652661064" data-w="714" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" class=" __bg_gif" data-order="3" style="margin:0px;padding:0px;height:524.552px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:670px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">3.4、如果线程请求数达不到n，又如何让已加锁的线程同时执行？</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">加一个倒计时锁，如果等待超过设定时间，则自行释放锁，计数器、倒计时锁同时作用的效果如图所示:</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-type="gif" data-src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKAQEunQlD8xXSC1BcO2clFD8WswCibAiaK0qp6Eicnojswh3Dmy4r45lyA/0?wx_fmt=gif" data-ratio="0.7574525745257452" data-w="738" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" class=" __bg_gif" data-order="4" style="margin:0px;padding:0px;height:507.493px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:670px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">这个方案可能带来的影响：</strong></p>
<ol class="list-paddingleft-2" style="margin:1.2em 0px;padding:0px 0px 0px 2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">性能上，毫无疑问，由于我们暂停了线程的执行，肯定是有影响的</p>
</li>
<li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">兼容性上，由于采用的都是通用的hook技术，并发SDK已集成到NewMonkey随身版中，已稳定运行了好几个月，稳定性得到了保证。</p>
</li>
</ol>
<h2 style="margin:1.3em 0px 1em;padding:0px;font-size:1.4em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;box-sizing:border-box !important;word-wrap:break-word !important;">线程的并发方案</h2>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">Java里新建线程主要有两种方式:通过实现&nbsp;<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Runnable</code>&nbsp;接口；通过继承 Thread 类本身；实现&nbsp;<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Runnable</code>&nbsp;接口也要被Thread封装了然后再去执行，总之两种方式，启动最终都是靠<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Thread.start()</code>，执行都是靠<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Thread.run()</code>，这就好办了，线程的并发方案分两步，如下图所示：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKvsr6JKREkuic4ZVlfBEqOXibRVCg0VBBZzuibKa8qn4GXSwx9nztpW7Aw/0?wx_fmt=png" data-ratio="1.9662162162162162" data-w="296" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:582px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:296px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">Hook start获取调用堆栈，将同一调用堆栈的tid聚在一类。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKP0MKPPfxVy4tamhwL7jpBpnrvibUNR3xpViar3mBxiaicM0CHbRwtKyj0Q/0?wx_fmt=png" data-ratio="1.9454545454545455" data-w="385" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:749px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:385px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">通过上面处理，我们能对拥有同一key值、不同tid的线程加同一个锁</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">到此第一个专利水到渠成：一种模拟线程并发的方法</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">中间踩过一些坑，分享给大家：</p>
<blockquote style="margin:1.2em 0px;padding:0px 1em;max-width:100%;border-left-width:4px;border-left-style:solid;border-left-color:#dddddd;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;color:#777777;quotes:none;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">问题1、为啥不hook Runnable？</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">答：因为Runnable是接口，只能hook类</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">问题2、为啥不hook start来获取调用堆栈时就模拟并发？</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">答：1、线程真正执行时是在run里 2、start是个同步方法，在这里加锁也没法模拟并发</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">问题3、为啥不hook run来获取调用堆栈、并且模拟并发？</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">答：因为被开发者调用的是start()，能拿到app的调用堆栈，以此区分不同类型的thread，hook run获取到的都是系统堆栈，无法做线程特征区分。</p>
</blockquote>
<h2 style="margin:1.3em 0px 1em;padding:0px;font-size:1.4em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;box-sizing:border-box !important;word-wrap:break-word !important;">线程池的并发方案</h2>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">自己写了个Thread的demo，发现并发凑效了，本以为到此就大功告成了，可以模拟出Top Crash了，结果发现并非如此，像手Q这么大的项目是不太允许随便通过new Thread方式新建线程的，Runnable任务大多通过线程池调度来执行。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">由于线程池的原理比线程复杂，我觉得线程池核心思想是最大程度复用了存活的线程，限于篇幅，这里我对线程池不再多做赘述，给大家推荐几篇不错的文章：</p>
<blockquote style="margin:1.2em 0px;padding:0px 1em;max-width:100%;border-left-width:4px;border-left-style:solid;border-left-color:#dddddd;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;color:#777777;quotes:none;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">聊聊并发（三）——JAVA线程池的分析和使用<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" />
<a style="margin:0px;padding:0px;color:#607fa6;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">http://www.infoq.com/cn/articles/java-threadPool</a></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">Java线程池架构原理和源码解析(ThreadPoolExecutor)<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" />
<a style="margin:0px;padding:0px;color:#607fa6;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">http://blog.csdn.net/xieyuooo/article/details/8718741</a></p>
</blockquote>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">我画了一个线程池流程图，以帮助理解下面的hook并发方案</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKia2RkvsnnjCaanKBicgnoicFNwaOPkd2eCYY2RwKQibA1UnQ0mBBZ6unxw/0?wx_fmt=png" data-ratio="1.058011049723757" data-w="724" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:708.867px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:670px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">总之，结论就是：</strong></p>
<ol class="list-paddingleft-2" style="margin:1.2em 0px;padding:0px 0px 0px 2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">开发者通过ThreadPoolExecutor.execute(runnable) 提交Runnable任务</p>
</li>
<li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">runnable任务执行前会执行ThreadPoolExecutor.beforeExecute(Runnable)</p>
</li>
</ol>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">在此不得不感叹老外设计接口时的缜密和深思熟虑。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">我们的线程池模拟并发方案仍然分两步：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRK0jX0kYOYibNQsrgIXyIQ7iajuxz5CrlMIzzEv6K6PNjdC6xxia8Liby9Jg/0?wx_fmt=png" data-ratio="1.9214285714285715" data-w="280" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:538px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:280px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">Hook execute获取调用堆栈，将同一调用堆栈的runnable的hashcode聚在一类。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deT79e1NV6de4Viau9WyZQRKlnHJBWEmhHAnQnRc7R9EgB008C2gTCGPoWKibOTskR2I9AEcGSiajVAQ/0?wx_fmt=png" data-ratio="1.967005076142132" data-w="394" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:775px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:394px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">通过上面处理，我们能对拥有同一key值、不同hash的Runnable加同一个锁</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">您可能一咋眼看上去跟上面那个方案好像很接近，其实有着本质上的区别，正好也可以回答为啥上面hook Thread start run不能解决线程池并发的问题</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">答：原因有两点：</strong></p>
<ol class="list-paddingleft-2" style="margin:1.2em 0px;padding:0px 0px 0px 2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">我通过hook Thread拿不到线程池启动线程的调用堆栈，因为线程池至始至终就没有把Thread暴露给开发者</p>
</li>
<li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">线程池里的Worker(Worker是对Thread的再封装)与Runnable不再具有一一绑定的关系，Worker以领任务的方式去执行Runnable，同一堆栈特征的Runnable究竟由哪个Worker执行的，跟设定线程数量、采用何种缓冲队列、每个Runnable执行耗时、这些Worker的状态都有关系，只能通过Runnable自身加调用堆栈去区分。</p>
</li>
</ol>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">第二个专利因此也水到渠成：一种模拟通过线程池调度的线程并发方案</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">那这个方案能否替换线程并发那个方案呢？不能，由于Thread和Runnable一一绑定，可以将线程并发方案中的线程tid换成Runnable实例的hashcode，但是hook Thread还是必须要做的。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">手Q的线程池基于线程池进一步做了封装，做了很多非常深入、实用的改造，更加强大。</p>
<h2 style="margin:1.3em 0px 1em;padding:0px;font-size:1.4em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;box-sizing:border-box !important;word-wrap:break-word !important;">效果</h2>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">最终，我们将<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">IllegalStateException</code>&nbsp;Crash的占比由Android QQ 6.5.0的8%下降至6.6.0的1%</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">我诚惶诚恐，冠上“经典”二字，是为了博人眼球，文章若有纰漏，欢迎大家指教，两个专利的适用范围我想了下，也不仅仅适用于Android终端，前端、客户端、后台，所有平台应该都适用，大家可以按照自己平台去实现。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">道高一尺魔高一丈，在降Crash率上，依旧任重而道远。</p></body></html>