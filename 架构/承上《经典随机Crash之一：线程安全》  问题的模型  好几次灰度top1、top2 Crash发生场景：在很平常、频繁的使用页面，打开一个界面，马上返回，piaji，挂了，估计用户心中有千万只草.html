<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-04-14T10:35:42Z"/><meta name="updated" content="2017-04-14T10:35:44Z"/><title>承上《经典随机Crash之一：线程安全》  问题的模型  好几次灰度top1、top2 Crash发生场景：在很平常、频繁的使用页面，打开一个界面，马上返回，piaji，挂了，估计用户心中有千万只草</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">承上<a href="http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=2653578882&amp;idx=2&amp;sn=448e12f89436295162a5fa63bd623383&amp;chksm=84b3b485b3c43d93fe5b794f3e0ffbb42704a3fef7d3a0675ee2594b2fb88180ed30695b6d7c&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=2653578882&amp;idx=2&amp;sn=448e12f89436295162a5fa63bd623383&amp;chksm=84b3b485b3c43d93fe5b794f3e0ffbb42704a3fef7d3a0675ee2594b2fb88180ed30695b6d7c&amp;scene=21#wechat_redirect" style="margin:0px;padding:0px;color:#607fa6;text-decoration:none;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">《经典随机Crash之一：线程安全》</a></p>
<h2 style="margin:1.3em 0px 1em;padding:0px;font-size:1.4em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;box-sizing:border-box !important;word-wrap:break-word !important;">问题的模型</h2>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">好几次灰度top1、top2 Crash发生场景：在很平常、频繁的使用页面，打开一个界面，马上返回，piaji，挂了，估计用户心中有千万只草泥马在奔腾，手机QQ究竟怎么呢？</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">找到开发童鞋，还是熟悉的对话：</p>
<ol class="list-paddingleft-2" style="margin:1.2em 0px;padding:0px 0px 0px 2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">请教：这个Crash能复现吗？开发答：场景就在这，就是复现不了啊</p>
</li>
<li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">这里有个空指针，那我就加个判空</p>
</li>
</ol>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">我只好去看下开发童鞋的代码，发现都有一个共性，跟<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">handler postDelayed</code>有关系，这里抽取出Crash代码梗概</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaPibVia956lVBKI9Ba4AAK76700NBLzBo7lsMRy3JRxjaS02FRUoiaXxdQ/0?wx_fmt=png" data-ratio="0.19062027231467474" data-w="661" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaPibVia956lVBKI9Ba4AAK76700NBLzBo7lsMRy3JRxjaS02FRUoiaXxdQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">Post一个匿名<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Runnable</code>，延迟500ms</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaR31e4NNgf8tDPWGx8ZN4fJgjLiaJ2yM8lzTlhicvwCEVwaaIGm0Df6vg/0?wx_fmt=png" data-ratio="0.2379471228615863" data-w="643" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaR31e4NNgf8tDPWGx8ZN4fJgjLiaJ2yM8lzTlhicvwCEVwaaIGm0Df6vg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">跟开发童鞋反复再三确认，<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">mGLVideoView</code>置空的地方只有一处，就在<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">onDestroy()</code>中</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaac7xMaAtoeqxo5377JkYVjahQm6ibzvOticDShHe8NWAD4QB7oic3n0pQ/0?wx_fmt=png" data-ratio="0.27007299270072993" data-w="274" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaac7xMaAtoeqxo5377JkYVjahQm6ibzvOticDShHe8NWAD4QB7oic3n0pQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">开发童鞋一般为了解决内存泄露问题，会在<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">onDestroy</code>中将变量置空，以让系统回收，这么做也理所当然。跟用户反馈的情况也吻合，打开界面，立马返回，会Crash。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">为了搞清这个问题的根源，需要对Android消息机制有一定了解，大家可以搜索一下相关文章。</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaYOTXEeicBXUM0XibVnFyvtibTVickIT2dDSlgseaPoQJO2NIw8SIGj6eSA/0?wx_fmt=png" data-ratio="0.7323135755258127" data-w="523" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaYOTXEeicBXUM0XibVnFyvtibTVickIT2dDSlgseaPoQJO2NIw8SIGj6eSA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">不按套路出牌，碉堡了的用户是这样的，如图所示</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-type="gif" data-src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqabe2qianIQalJmECE8Aregfwf9PoIBfb1EOMyrCjzmjhCUhzTqPqD6oQ/0?wx_fmt=gif" data-ratio="0.5823068309070548" data-w="893" src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqabe2qianIQalJmECE8Aregfwf9PoIBfb1EOMyrCjzmjhCUhzTqPqD6oQ/0?wx_fmt=gif&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" class=" __bg_gif" data-order="0" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">弱爆了的我是这样的，如图所示</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-type="gif" data-src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqa1gFwBuEdw5oQKrT2lmwkIQROQUOibZdL48j4e3nmdqD3nVgbSIjdE9Q/0?wx_fmt=gif" data-ratio="0.5823068309070548" data-w="893" src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqa1gFwBuEdw5oQKrT2lmwkIQROQUOibZdL48j4e3nmdqD3nVgbSIjdE9Q/0?wx_fmt=gif&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" class=" __bg_gif" data-order="1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">那接下来的事情就好办了，寻找腾讯手速最快的人，要在500ms之内打开界面，返回，要是他都复现不了，那就真的复现不了，虽然是开个玩笑，但这确实已经不是个概率性问题了，在我们手速不够快的情况下，这类型Crash确实是复现不了，但很显然这不是解决问题的正确姿势。</p>
<h2 style="margin:1.3em 0px 1em;padding:0px;font-size:1.4em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;box-sizing:border-box !important;word-wrap:break-word !important;">解决问题的思路</h2>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">事后手段：</p>
<ol class="list-paddingleft-2" style="margin:1.2em 0px;padding:0px 0px 0px 2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">加判空</p>
</li>
<li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">这里给大家推荐这篇文章：</p>
<blockquote style="margin:1.2em 0px;padding:0px 1em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;border-left:4px solid #dddddd;color:#777777;quotes:none;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">Android handler.removeCallbacksAndMessages(null)的妙用<br style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;" />
<a style="margin:0px;padding:0px;color:#607fa6;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">http://www.snowdream.tech/2016/02/18/handler-removeCallbacksAndMessages/</a></p>
</blockquote>
</li>
</ol>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">好处有</strong>：非静态匿名内部类<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Runnable</code>持有外部类会导致内存泄露，<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">remove</code>掉以较少内存泄露；消除这类空指针Crash的隐患；减少主线程消息队列的任务，还能提升点性能</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">然而这些都不能做到事前发现，今天我们就一起来探讨下一些事前的手段，并解密一个我申请的有利于发现同类问题的专利。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">请教了做静态检查的同学，在没有任何上下文环境的情况下直接使用一个变量，这种空指针检查很难搞，我们主要从动态角度上分析。</p>
<h4 style="margin:1.3em 0px 1em;padding:0px;font-size:1.2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;">1、 在<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">activity onDestroy</code>之后<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">handler.post</code></h4>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">监控<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Activity onDestroy</code>&nbsp;、<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">handler post</code>操作，强制在<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">onDestroy</code>之后再<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">post</code>，就能100%复现这个Crash了</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">那首先需要寻找Activity与handler之间的联系，监控<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">onDestroy</code>，可以用hook或者类似LeakCanary的方式，注册<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">ActivityLifecycleCallbacks</code>来监听，但难点在怎么把<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">handler post</code>跟<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Activity onDestroy</code>建立起联系，从开发者的角度来说，这两个模块没有联系，Activity完全不用handler也是可以的，在Activity的生命周期方法中，没有哪个需要带上handler，Activity中会不会默认隐藏着handler了？</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">抱着这样的疑问，我去看了下Activity的源码（以Android5.0为准）</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">果真Activity中会有一个<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">mHandler</code></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqatibjWA6HG3Hian1TpkA80xVLGQLTCwCcJcs2zu9rXhEwW0NWvYW1a1mg/0?wx_fmt=png" data-ratio="0.30700778642936594" data-w="899" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqatibjWA6HG3Hian1TpkA80xVLGQLTCwCcJcs2zu9rXhEwW0NWvYW1a1mg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">看了下这个<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">mHandler</code>在什么地方会被用到</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaP733JvVKdibXag7yQMa5nZN8jWhZia8N54N4ten9wDsOHnVD4N9tsjjg/0?wx_fmt=png" data-ratio="0.3051224944320713" data-w="449" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaP733JvVKdibXag7yQMa5nZN8jWhZia8N54N4ten9wDsOHnVD4N9tsjjg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">只有在<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">runOnUiThread</code>中会被用到，但开发者自己绑定<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">MainLooper</code>的<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">handler</code>跟这个<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">mHandler</code>没有关系。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">这种方法需要对<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Activity Handler</code>两大核心模块找到一种关联，并做一种高精度的手术，限于本人能力有限，一时陷入了困境。</p>
<h4 style="margin:1.3em 0px 1em;padding:0px;font-size:1.2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;">2、 控制消息的时机</h4>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">既然没法找到<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Activity Handler</code>的关联，就只好从消息机制本身着手。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">刚开始我们想到的方法，把这种消息从消息队列里取出来，等待时机，然后再重新插入消息队列</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">那第一步就需要把这种消息取出来，我们先来看看源码是怎么做的</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaia4RhgT1DJQPY7kEhcNiak2yMQjPrxiaozibQlSlA8AjFQ1jGJ9A2FE1JQ/0?wx_fmt=png" data-ratio="0.9281115879828327" data-w="932" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaia4RhgT1DJQPY7kEhcNiak2yMQjPrxiaozibQlSlA8AjFQ1jGJ9A2FE1JQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">在<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">loop()</code>中会通过<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">next()</code>获取一个消息，如果能获取到，则通过<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">dispatchMessage()</code>分发消息，接下来我们看看next()是怎么获取消息的</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaC8EEQA4ZKiaiaLrV5vWsyicVBEPBibEATqibMrIQ0jQ7eibhFjIKtmwtvXfw/0?wx_fmt=png" data-ratio="0.7174571140262361" data-w="991" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaC8EEQA4ZKiaiaLrV5vWsyicVBEPBibEATqibMrIQ0jQ7eibhFjIKtmwtvXfw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaIDLyib8ziaW9bj0EB98dFYvrEn6Jiae0true7bSxjJjib4icdVXY3wrV7sg/0?wx_fmt=png" data-ratio="0.5455445544554456" data-w="1010" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaIDLyib8ziaW9bj0EB98dFYvrEn6Jiae0true7bSxjJjib4icdVXY3wrV7sg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">在<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">next</code>获取了当前系统时间，若到了消息执行时间，则返回消息</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">这里一定会有疑问，<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">msg.when</code>是怎么设置的？消息是如何插入队列的？</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">next()</code>从消息队列获取一个消息，无法精准到具体的消息，其实我们还可以参考<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">removeMessages</code>的实现，通过反射来取出消息，如果<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">remove</code>的时机过晚，也会导致这个消息已经被消费了，如果<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">remove</code>错了，导致丢消息，篓子就捅大了。总之，我们必须搞清楚消息入队列的过程。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">发送消息主要有sendXXX，postXXX两大类方法，由于Runnable也会被封装成Message</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaGPTyEpgCNjYBakrUwMKjKaAL9hQF7GiawL3zoukQ131h7W3iaowibCW0Q/0?wx_fmt=png" data-ratio="0.21946564885496184" data-w="524" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaGPTyEpgCNjYBakrUwMKjKaAL9hQF7GiawL3zoukQ131h7W3iaowibCW0Q/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqasX7uDSBL5oDarYQgL3TgVic4ySHt5hEibDeCB4hRb4WuKW3MxuL2US1A/0?wx_fmt=png" data-ratio="0.24048096192384769" data-w="499" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqasX7uDSBL5oDarYQgL3TgVic4ySHt5hEibDeCB4hRb4WuKW3MxuL2US1A/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">其实这里面也会有个坑：Callback类型Message的what是0，大家有兴趣也可以学习下</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">看过<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">post (runnable)</code>、<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">sendMessage</code>过程后，我画了一个postXXX、sendXXX调用关系图</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqayu3kC4V89t43bLMIlHsZlBbw1LVnoe5lic6AibHOD1f3E7viaQB56VnHg/0?wx_fmt=png" data-ratio="0.3587033121916843" data-w="1419" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqayu3kC4V89t43bLMIlHsZlBbw1LVnoe5lic6AibHOD1f3E7viaQB56VnHg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">根据上面的图，可以看出<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">sendMessageDelayed</code>和<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">sendMessageAtTime</code>是非常重要的两个环节，我们来看下这两个方法究竟做了啥</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaMIibiap1GtvQqme9XBX30ZV6IvmNsg0Lia8OvJPdrN5yNVu7AAQCma6Mg/0?wx_fmt=png" data-ratio="0.19258373205741627" data-w="836" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaMIibiap1GtvQqme9XBX30ZV6IvmNsg0Lia8OvJPdrN5yNVu7AAQCma6Mg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">在<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">sendMessageDelayed</code>中会用系统开机总时间<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">+dalayMillis</code>，所以传入<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">sendMessageAtTime</code>的值是相对于系统启动的绝对值</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaucLXLiajCQBTjf4WcaxtBO5uHDcX7LNcjiaamNx4F1drX70JmrL3wLUA/0?wx_fmt=png" data-ratio="0.32829046898638425" data-w="661" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:217px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:661px !important;" /></p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaaQe4vPE2HBibBwPqIaXNHFVOmpLsBuTq9foJ5xuESY0svxK3fbCXDpQ/0?wx_fmt=png" data-ratio="0.16363636363636364" data-w="990" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:109.636px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:670px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">再来看<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">queue.enqueueMessage</code>的过程</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaFAkzGaickbLaUgr3j5MickpCibzBLkyERhOoIuvcIS3NvQ14ge3mFsJeg/0?wx_fmt=png" data-ratio="0.8888888888888888" data-w="873" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:595.556px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:670px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">when</code>赋值给了<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">msg.when</code>，这下能解释<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">next()</code>中<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">msg.when</code>是如何得来的问题，到这里，您应该清楚了，原来插入消息队列的顺序是根据<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">msg.when</code>大小来插入的。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">前面说到<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">when</code>传入的是一个绝对值，那上面为啥有<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">when==0</code>的判断，那什么时候<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">when</code>会为0呢？当把一个消息强制插入到队列首的位置，会传入0</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqaL4sdfz0HDfhWodwER8NSH1vPiauaoSLbtrNSUhH7Zx9sLhdbMahkcibg/0?wx_fmt=png" data-ratio="0.324812030075188" data-w="665" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="margin:0px;padding:0px;height:216px !important;box-sizing:border-box !important;word-wrap:break-word !important;width:665px !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">如果我们要延迟那个消息的处理时机，只需改动这个绝对值就可以了，我们决定通过<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">hook sendMessageDelayed</code>，将延迟时间<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">delayMillis</code>改长，如果您看到这里，是不是觉得方案其实很简单？确实是的，如果我一上来就告诉您这么做，那这个问题就很简单了，其实中间也是踩了一些坑，然而知道为什么要这么做，似乎更重要，也更有趣。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">到此，您已经清楚Android是如何插入消息的了，您要是愿意，完全可以把全部消息hook住了，随意改<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">uptimeMillis</code>，那您已经掌握了玩弄消息顺序于股掌之中的技术。</p>
<h2 style="margin:1.3em 0px 1em;padding:0px;font-size:1.4em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;box-sizing:border-box !important;word-wrap:break-word !important;">问题的解决方案</h2>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">最终综合安全性、稳定性等方面的考虑，我们采用了将<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">delayMillis</code>时间改长的方案</p>
<ol class="list-paddingleft-2" style="margin:1.2em 0px;padding:0px 0px 0px 2em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;box-sizing:border-box !important;word-wrap:break-word !important;"><li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">考虑到主线程做了很多事情，比如需处理绘制UI等一些系统消息，而开发者一般把延时操作都放在了<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Runnable</code>里，这里我们只延迟<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Runnable</code>经过封装的消息，并根据调用堆栈做了过滤</p>
</li>
<li style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0.5em !important;margin-bottom:0.5em !important;box-sizing:border-box !important;word-wrap:break-word !important;">考虑到这种Crash容易发生在post短时间内，如果开发者本来设置的延迟时间就比较大，如果再加大延迟，会让消息得不到及时处理，所以我们对需要加大延迟的时间做了阈值判断</p>
</li>
</ol>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">最终实现的流程图如下图所示：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqao0H7kib5vKsib51jxoiafUd9JeNcRNHic2fUcq1DzvNciajefyJXskmSdBw/0?wx_fmt=png" data-ratio="2.4741935483870967" data-w="310" src="http://mmbiz.qpic.cn/mmbiz_png/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqao0H7kib5vKsib51jxoiafUd9JeNcRNHic2fUcq1DzvNciajefyJXskmSdBw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">因此，这个专利水到渠成：一种延迟消息分发模拟Crash的方法</strong></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">最终要达到的效果下图所示：</p>
<p style="margin-top:0px;margin-bottom:0px;padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;text-align:center;box-sizing:border-box !important;word-wrap:break-word !important;"><img data-type="gif" data-src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqadMTNlSHYeYgam0UcjicgrnZpvm2X0anSWETkTpBdibnSqLRHenTRQOsQ/0?wx_fmt=gif" data-ratio="0.5823068309070548" data-w="893" src="http://mmbiz.qpic.cn/mmbiz_gif/tnZGrhTk4deJaRApQTVXW5ibt8OzIfQqadMTNlSHYeYgam0UcjicgrnZpvm2X0anSWETkTpBdibnSqLRHenTRQOsQ/0?wx_fmt=gif&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" class=" __bg_gif" data-order="2" data-fail="0" style="margin:0px;padding:0px;height:auto !important;box-sizing:border-box !important;word-wrap:break-word !important;width:auto !important;visibility:visible !important;" /></p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">众里寻他千百度，蓦然回首，那人却在，灯火阑珊处。延迟一个小时，我完全可以出去吃个饭、遛个弯，再回来复现这个Crash了。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">问：跟当前主线程卡顿监控方案是否有冲突？</strong></p>
<blockquote style="margin:1.2em 0px;padding:0px 1em;max-width:100%;border-left-width:4px;border-left-style:solid;border-left-color:#dddddd;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;color:#777777;quotes:none;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">答：主线程卡顿监控主要是计算<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">dispatchMessage</code>，<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Dispatching</code>、<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Finished</code>之间的耗时，我们对<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">dispatchMessage</code>没做任何手脚，只是延迟了消息的处理时机。</p>
</blockquote>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;">问：会不会造成卡顿？</strong></p>
<blockquote style="margin:1.2em 0px;padding:0px 1em;max-width:100%;border-left-width:4px;border-left-style:solid;border-left-color:#dddddd;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;color:#777777;quotes:none;box-sizing:border-box !important;word-wrap:break-word !important;"><p style="padding:0px;max-width:100%;clear:both;min-height:1em;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">答：UI上的不流畅主要是掉帧，每个消息具体耗时多少，还是取决于消息本身在做什么，我们跟开发者自己把<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">delayMillis</code>改长并没什么区别。</p>
</blockquote>
<h2 style="margin:1.3em 0px 1em;padding:0px;font-size:1.4em;max-width:100%;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-variant-ligatures:normal;orphans:2;widows:2;border-bottom-width:1px;border-bottom-style:solid;border-bottom-color:#eeeeee;box-sizing:border-box !important;word-wrap:break-word !important;">效果</h2>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">延迟消息分发SDK已加入NewMonkey随身版挑战者模式中，能做到无场景延迟<code style="margin:0px 0.15em;padding:0px 0.3em;max-width:100%;box-sizing:border-box !important;word-wrap:break-word !important;font-size:0.85em;font-family:Consolas, Inconsolata, Courier, monospace;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:#eaeaea;background-color:#f8f8f8;border-radius:3px;display:inline;">Runnable</code>类型消息的分发，功能上线短短1天内，就发现了Android QQ 4个Crash，都得到了开发同学的迅速fix。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">由于本人能力、精力有限，对Android消息机制远未啃透，若有纰漏，欢迎斧正，对其他平台的消息机制更是一窍不通，若对您有所启发，深感荣幸。</p>
<p style="padding:0px;max-width:100%;clear:both;min-height:1em;color:#3e3e3e;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;font-variant-ligatures:normal;orphans:2;widows:2;margin-top:0px !important;margin-bottom:1.2em !important;box-sizing:border-box !important;word-wrap:break-word !important;">道高一尺魔高一丈，在降Crash率上，依旧任重而道远。</p></body></html>