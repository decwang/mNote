<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2016-10-25T09:46:06Z"/><meta name="updated" content="2016-10-25T09:46:58Z"/><title> JNI DETECTED ERROR IN APPLICATION解决记录     2015-08-13 14:23 7323人阅读 评论(1) 收藏 举报     分类：  Android（9）</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div class="article_title" style="margin:5px 0px;font-size:20px;line-height:30px;font-family:'Microsoft YaHei';">&nbsp;<h1 style="margin:0px;padding:0px;display:inline;font-weight:normal;font-size:20px;line-height:30px;vertical-align:middle;"><span class="link_title"><a href="http://blog.csdn.net/huntcode/article/details/47611245" style="color:#000000;text-decoration:none;">JNI DETECTED ERROR IN APPLICATION解决记录&nbsp;</a></span></h1>
</div>
<div class="article_manage clearfix" style="padding:0px 20px 5px;color:#999999;font-size:12px;line-height:22px;font-family:Arial;text-align:right;border-bottom-style:solid;border-bottom-width:1px;border-bottom-color:#ededed;margin:0px -20px;overflow:hidden;"><div class="article_r"><span class="link_postdate" style="margin:0px 5px 0px 0px;">2015-08-13 14:23</span>&nbsp;<span class="link_view" title="阅读次数" style="margin:0px 5px;padding:0px 0px 0px 14px;background-image:url(http://static.blog.csdn.net/images/ico_view.png);background-position:0% 50%;background-repeat:no-repeat no-repeat;">7323人阅读</span>&nbsp;<span class="link_comments" title="评论次数" style="margin:0px 5px;padding:0px 0px 0px 14px;background-image:url(http://static.blog.csdn.net/images/ico_comm.png);background-position:0% 50%;background-repeat:no-repeat no-repeat;"><a href="http://blog.csdn.net/huntcode/article/details/47611245#comments" style="color:#336699;text-decoration:none;">评论</a>(1)</span>&nbsp;<span class="link_collect tracking-ad" data-mod="popu_171" style="margin:0px 5px;"><a title="收藏" target="_blank" style="color:#336699;">收藏</a></span>&nbsp;<span class="link_report" style="margin:0px 5px;"><a href="http://blog.csdn.net/huntcode/article/details/47611245#report" title="举报" style="color:#336699;text-decoration:none;">举报</a></span></div>
</div>
<div class="category clearfix" style="margin:0px -20px;border-bottom-style:solid;border-bottom-width:1px;border-bottom-color:#ededed;padding:5px 20px;color:#333333;font-family:Arial, Console, Verdana, 'Courier New';font-size:12px;"><div class="category_l" style="display:inline-block;font-size:14px;width:70px;float:left;line-height:28px;"><img src="http://static.blog.csdn.net/images/category_icon.jpg" style="border:none;vertical-align:middle;" />&nbsp;<span style="display:inline-block;vertical-align:middle;">分类：</span></div>
<div class="category_r" style="display:inline-block;font-size:14px;color:#df3434;float:left;width:637.1875px;"><label style="display:inline-block;margin-left:15px;cursor:pointer;line-height:28px;position:relative;">Android（9）&nbsp;<img class="arrow-down" src="http://static.blog.csdn.net/images/arrow_triangle%20_down.jpg" style="border:none;display:inline;" /></label>&nbsp; <label style="display:inline-block;margin-left:15px;cursor:pointer;line-height:28px;position:relative;">JNI（1）&nbsp;<img class="arrow-down" src="http://static.blog.csdn.net/images/arrow_triangle%20_down.jpg" style="border:none;display:inline;" /></label></div>
</div>
<div class="bog_copyright" style="padding:20px 0px;color:#333333;font-family:Arial, Console, Verdana, 'Courier New';font-size:12px;"><p class="copyright_p" style="height:14px;line-height:14px;border-left-style:solid;border-left-width:3px;border-left-color:#e41c1e;padding-left:10px;color:#666666;font-size:14px;">版权声明：本文为博主原创文章，未经博主允许不得转载。</p>
</div>
<div id="article_content" class="article_content" style="margin:20px 0px 0px;line-height:26px;font-family:Arial;color:#333333;"><p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp;最近遇到一个JNI的问题，同一套代码在Android4.4版本前的设备上运行是OK的，但是在Android5.0之后的设备上就会崩溃，查看logcat发现报<span style="color:#ff0000;">JNI DETECTED ERROR IN APPLICATION</span>错误。</span></p>
<p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; （1）第一个错误：</span></p>
<p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color:#ff0000;">JNI DETECTED ERROR IN APPLICATION: calling static method xxxx with CallxxxxMethodV in call to CallxxxxMethodV</span></span></p>
<p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp;有过JNI编程经验的就会知道，调用方法分static和非static两种，分别会用到</span></p>
<p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color:#000099;">GetStaticMethodID</span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color:#336666;">GetMethodID&nbsp;&nbsp; &nbsp;</span></span></p>
<p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color:#000099;">CallStatic&lt;type&gt;Method</span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color:#336666;">Call&lt;type&gt;Method</span></span></p>
<p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 其中&lt;type&gt;指Int, Long, Char等类型</span></p>
<p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp;问题的原因就是编写JNI代码的同事混用了这两种方式，先用了GetStaticMethodID，然后又用的非static的CallIntMethod方法，Android4.4之前版本JNI检查机制没有Android5.0之后的版本严格，所以没有报错，程序也不会崩溃，但正确的方式应该是GetMethodID+Call&lt;type&gt;Method，GetStaticMethodID+CallStatic&lt;type&gt;Method，这个问题解决后又接着又报出了下面的错误。</span></p>
<p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; （2）第二个错误：</span></p>
<p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color:#ff0000;">JNI DETECTED ERROR IN APPLICATION: native code passing in reference to invalid stack indirect reference table or invalid reference: 0xfff5f1b0<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;in call to CallVoidMethod</span>&nbsp;&lt;==这一行报错是问题的切入点</span></p>
<p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp;这个错误显示是CallVoidMethod的参数非法引用，网上找了一些相关问题的帖子，结合本地代码，发现最有可能的就是线程间不能直接传递JNIEnv和jobject这类线程专属属性值导致，要知道JavaVM是属于java进程的，每个进程只有一个JavaVM，而这个JavaVM可以被多线程共享，但是JNIEnv和jobject是属于线程私有的，不能共享，那有什么办法解决呢？这里我们不讲JNIEnv的线程间传递，有兴趣的网上可以找到相关帖子，而jobject可以用全局引用的方式在多线程间使用，举个简单的例子：</span></p>
<div class="dp-highlighter bg_cpp" style="font-family:Consolas, 'Courier New', Courier, mono, serif;font-size:12px;background-color:#e7e5dc;width:700.90625px;overflow-y:hidden;overflow-x:auto;padding-top:1px;position:relative;margin:18px 0px !important;"><div class="bar" style="padding-left:45px;"><div class="tools" style="padding:3px 8px 10px 10px;font-size:9px;line-height:normal;font-family:Verdana, Geneva, Arial, Helvetica, sans-serif;color:silver;background-color:#f8f8f8;border-left-width:3px;border-left-style:solid;border-left-color:#6ce26c;"><b>[cpp]</b>&nbsp;<a href="http://blog.csdn.net/huntcode/article/details/47611245#" class="ViewSource" title="view plain" style="color:#a0a0a0;text-decoration:none;background-image:url(http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_plain.gif);background-color:inherit;border:none;padding:1px;margin:0px 10px 0px 0px;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-position:0% 0%;background-repeat:no-repeat no-repeat;">view plain</a><span data-mod="popu_168">&nbsp;<a href="http://blog.csdn.net/huntcode/article/details/47611245#" class="CopyToClipboard" title="copy" style="color:#a0a0a0;text-decoration:none;background-image:url(http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/images/default/ico_copy.gif);background-color:inherit;border:none;padding:1px;margin:0px 10px 0px 0px;display:inline-block;width:16px;height:16px;text-indent:-2000px;background-position:0% 0%;background-repeat:no-repeat no-repeat;">copy</a><div style="position:absolute;left:588px;top:1270px;width:18px;height:18px;z-index:99;"><embed id="ZeroClipboardMovie_1" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="18" height="18" name="ZeroClipboardMovie_1" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=1&amp;width=18&amp;height=18" wmode="transparent" /></div>
</span></div>
</div>
<ol start="1" class="dp-cpp" style="padding:0px;border:none;list-style-position:initial;list-style-image:initial;background-color:#ffffff;color:#5c5c5c;margin:0px 0px 1px 45px !important;"><li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;"><span class="preprocessor" style="margin:0px;padding:0px;border:none;color:gray;background-color:inherit;">#Include&nbsp;&lt;jni.h&gt;</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;&nbsp;</span></span></li>
<li class="" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;background-color:#f8f8f8;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;"><span class="preprocessor" style="margin:0px;padding:0px;border:none;color:gray;background-color:inherit;">#include&nbsp;&lt;pthread.h&gt;</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;&nbsp;</span></span></li>
<li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">pthread_t&nbsp;pthread;&nbsp;&nbsp;</span></li>
<li class="" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;background-color:#f8f8f8;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">jobject&nbsp;object;&nbsp;&nbsp;</span></li>
<li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">JavaVM*&nbsp;jvm;&nbsp;&nbsp;</span></li>
<li class="" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;background-color:#f8f8f8;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;"><span class="keyword" style="margin:0px;padding:0px;border:none;color:#006699;background-color:inherit;font-weight:bold;">void</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;*run(</span><span class="keyword" style="margin:0px;padding:0px;border:none;color:#006699;background-color:inherit;font-weight:bold;">void</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;*arg)&nbsp;&nbsp;</span></span></li>
<li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">{&nbsp;&nbsp;</span></li>
<li class="" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;background-color:#f8f8f8;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;JNIEnv&nbsp;*&nbsp;jenv;&nbsp;&nbsp;</span></li>
<li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;jvm-&gt;AttachCurrentThread(&amp;jenv,&nbsp;NULL);&nbsp;&nbsp;</span></li>
<li class="" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;background-color:#f8f8f8;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;jenv-&gt;CallVoidMethod(object,&nbsp;jnv-&gt;GetMethodID(jnv-&gt;GetObjectClass(object),&nbsp;<span class="string" style="margin:0px;padding:0px;border:none;color:blue;background-color:inherit;">"foo"</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">,&nbsp;</span><span class="string" style="margin:0px;padding:0px;border:none;color:blue;background-color:inherit;">"()V"</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">));&nbsp;&nbsp;</span></span></li>
<li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;jenv-&gt;DeleteGlobalRef(object);&nbsp;&nbsp;</span></li>
<li class="" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;background-color:#f8f8f8;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;jvm-&gt;DetachCurrentThread();&nbsp;&nbsp;</span></li>
<li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" style="margin:0px;padding:0px;border:none;color:#006699;background-color:inherit;font-weight:bold;">return</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;NULL;&nbsp;&nbsp;</span></span></li>
<li class="" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;background-color:#f8f8f8;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">}&nbsp;&nbsp;&nbsp;&nbsp;</span></li>
<li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">&nbsp;&nbsp;</span></li>
<li class="" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;background-color:#f8f8f8;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;"><span class="keyword" style="margin:0px;padding:0px;border:none;color:#006699;background-color:inherit;font-weight:bold;">void</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;Java_com_program_Initialize(JNIEnv*jenv,&nbsp;jobject&nbsp;caller)&nbsp;&nbsp;</span></span></li>
<li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">{&nbsp;&nbsp;&nbsp;<span class="comment" style="margin:0px;padding:0px;border:none;color:#008200;background-color:inherit;">/*要想在新线程中使用对象caller，就必须以全局引用方式保存，否则caller只是局部引用，本方法返回后就会销毁*/</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">&nbsp;&nbsp;</span></span></li>
<li class="" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;background-color:#f8f8f8;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;object&nbsp;=&nbsp;jnv-&gt;NewGlobalRef(caller);&nbsp;&nbsp;&nbsp;</span></li>
<li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;jenv-&gt;GetJavaVM(&amp;jvm);&nbsp;&nbsp;</span></li>
<li class="" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;background-color:#f8f8f8;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">&nbsp;&nbsp;&nbsp;&nbsp;pthread_create(&amp;<span class="keyword" style="margin:0px;padding:0px;border:none;color:#006699;background-color:inherit;font-weight:bold;">thread</span><span style="margin:0px;padding:0px;border:none;background-color:inherit;">,&nbsp;NULL,&nbsp;run,&nbsp;NULL);&nbsp;&nbsp;</span></span></li>
<li class="alt" style="border-style:none none none solid;border-left-width:3px;border-left-color:#6ce26c;list-style:decimal-leading-zero outside;color:inherit;line-height:18px;margin:0px !important;padding:0px 3px 0px 10px !important;"><span style="margin:0px;padding:0px;border:none;color:black;background-color:inherit;">}&nbsp;&nbsp;</span></li>
</ol>
</div>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="font-size:18px;">再回到前面的问题，按照这个线索，我在本地JNI代码里发现在pthread_create创建新线程之前，仅仅将jobject保存在了一个全局变量里面，而没有使用全局引用，以上面的代码为例，即本地JNI代码里进行了类似object = caller;的赋值，这显然是没有用的，一旦函数返回，caller就会被GC回收销毁，object指向的就是一个非法地址，最终导致上面的JNI错误。</span></div></body></html>