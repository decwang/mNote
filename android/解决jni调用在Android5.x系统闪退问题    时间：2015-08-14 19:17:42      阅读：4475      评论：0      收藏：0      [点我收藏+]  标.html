<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2016-10-25T09:46:16Z"/><meta name="updated" content="2016-10-25T09:46:58Z"/><title>解决jni调用在Android5.x系统闪退问题    时间：2015-08-14 19:17:42      阅读：4475      评论：0      收藏：0      [点我收藏+]  标</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div class="detailtitle divtextaligncenter divborderbottomdotted" style="font-family:Arial, Helvetica, sans-serif;padding:15px 0px;font-size:16px;color:#023e9a;text-align:center;border-bottom-width:1px;border-bottom-color:#dadada;border-bottom-style:dotted;font-weight:bold;"><h1 id="Htitle" class="detailtitle" style="padding:15px 0px;font-size:16px;">解决jni调用在Android5.x系统闪退问题</h1>
</div>
<div class="detail1 divtextaligncenter" style="font-family:Arial, Helvetica, sans-serif;padding:0px;font-size:12px;color:#3f3f3f;text-align:center;margin:20px 0px;">时间：<span id="Label2" class="colorlv" style="padding:0px;">2015-08-14 19:17:42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 阅读：<span id="Label1" class="colorCheng" style="padding:0px;">4475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 评论：<span id="lblcommentcount" class="colorCheng" style="padding:0px;">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 收藏：<span id="lblfavorite" class="colorCheng" style="padding:0px;">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="infofavorite" class="acursorpointer" style="padding:0px;color:#333333;cursor:pointer;">[点我收藏+]</a></div>
<div class="detailcontennt" style="font-family:Arial, Helvetica, sans-serif;padding:0px;font-size:12px;color:#3f3f3f;margin:20px 0px;line-height:30px;word-wrap:break-word;"><span id="Label3" style="padding:0px;"><p style="padding:0px;font-size:14px;line-height:30px;">标签：<a href="http://www.mamicode.com/so/1/android5-x" title="android5-x" style="padding:0px;color:#333333;text-decoration:none;">android5-x</a>&nbsp;&nbsp;&nbsp;<a href="http://www.mamicode.com/so/1/jni" title="jni" style="padding:0px;color:#333333;text-decoration:none;">jni</a>&nbsp;&nbsp;&nbsp;<a href="http://www.mamicode.com/so/1/%e9%97%aa%e9%80%80" title="闪退" style="padding:0px;color:#333333;text-decoration:none;">闪退</a>&nbsp;&nbsp;&nbsp;</p>
<div class="markdown_views" style="padding:0px;font-size:14px;line-height:30px;"><p style="padding:0px;line-height:30px;">日志信息如下：&nbsp;<br style="padding:0px;" />
08-14 15:48:41.127: A/art(5526): art/runtime/check_jni.cc:70] JNI DETECTED ERROR IN APPLICATION: illegal class name ‘xxx.xxx.xxx’&nbsp;<br style="padding:0px;" />
08-14 15:48:41.127: A/art(5526): art/runtime/check_jni.cc:70] (should be of the form ‘package/Class’, [Lpackage/Class;’ or ‘[[B’)&nbsp;<br style="padding:0px;" />
08-14 15:48:41.127: A/art(5526): art/runtime/check_jni.cc:70] in call to FindClass&nbsp;<br style="padding:0px;" />
<br style="padding:0px;" />
</p>
<p style="padding:0px;line-height:30px;">check_jni.cc源码地址：<a href="https://android.googlesource.com/platform/art/+/kitkat-dev/runtime/check_jni.cc" target="_blank" style="padding:0px;color:#333333;text-decoration:none;"><code style="font-family:Arial, Helvetica, sans-serif;padding:0px;">https://android.googlesource.com/platform/art/+/kitkat-dev/runtime/check_jni.cc</code></a></p>
<p style="padding:0px;line-height:30px;">看日志是在调用FindClass是出错的。在FindClass的时候会调用CheckClassName方法检查类名是否合法。CheckClasName方法源码如下：</p>
<pre class="prettyprint" style="font-family:Consolas, Monaco, 'Bitstream Vera Sans Mono', 'Courier New', Courier, monospace;padding:0.5em;background-color:#e9f5fc;border-width:0px 0px 0px 3px;border-left-style:solid;border-left-color:#cccccc;table-layout:fixed;word-break:break-all;word-wrap:break-word;font-size:15.399999618530273px;"><code class="language-cpp hljs " style="font-family:Arial, Helvetica, sans-serif;padding:0px;"><span class="pln" style="padding:0px;color:#000000;">  </span><span class="hljs-comment" style="padding:0px;"><span class="com" style="padding:0px;color:#880000;">// Checks that ‘class_name‘ is a valid "fully-qualified" JNI class name, like "java/lang/Thread"</span></span><span class="pln" style="padding:0px;color:#000000;">   </span><span class="hljs-comment" style="padding:0px;"><span class="com" style="padding:0px;color:#880000;">// or "[Ljava/lang/Object;". A ClassLoader can actually normalize class names a couple of</span></span><span class="pln" style="padding:0px;color:#000000;">   </span><span class="hljs-comment" style="padding:0px;"><span class="com" style="padding:0px;color:#880000;">// times, so using "java.lang.Thread" instead of "java/lang/Thread" might work in some</span></span><span class="pln" style="padding:0px;color:#000000;">   </span><span class="hljs-comment" style="padding:0px;"><span class="com" style="padding:0px;color:#880000;">// circumstances, but this is incorrect.</span></span><span class="pln" style="padding:0px;color:#000000;">   </span><span class="hljs-keyword" style="padding:0px;"><span class="kwd" style="padding:0px;color:#000088;">void</span></span><span class="pln" style="padding:0px;color:#000000;"> </span><span class="typ" style="padding:0px;color:#660066;">CheckClassName</span><span class="pun" style="padding:0px;color:#666600;">(</span><span class="hljs-keyword" style="padding:0px;"><span class="kwd" style="padding:0px;color:#000088;">const</span></span><span class="pln" style="padding:0px;color:#000000;"> </span><span class="hljs-keyword" style="padding:0px;"><span class="kwd" style="padding:0px;color:#000088;">char</span></span><span class="pun" style="padding:0px;color:#666600;">*</span><span class="pln" style="padding:0px;color:#000000;"> class_name</span><span class="pun" style="padding:0px;color:#666600;">)</span><span class="pln" style="padding:0px;color:#000000;"> </span><span class="pun" style="padding:0px;color:#666600;">{</span><span class="pln" style="padding:0px;color:#000000;">     </span><span class="hljs-keyword" style="padding:0px;"><span class="kwd" style="padding:0px;color:#000088;">if</span></span><span class="pln" style="padding:0px;color:#000000;"> </span><span class="pun" style="padding:0px;color:#666600;">(!</span><span class="typ" style="padding:0px;color:#660066;">IsValidJniClassName</span><span class="pun" style="padding:0px;color:#666600;">(</span><span class="pln" style="padding:0px;color:#000000;">class_name</span><span class="pun" style="padding:0px;color:#666600;">))</span><span class="pln" style="padding:0px;color:#000000;"> </span><span class="pun" style="padding:0px;color:#666600;">{</span><span class="pln" style="padding:0px;color:#000000;">       </span><span class="typ" style="padding:0px;color:#660066;">JniAbortF</span><span class="pun" style="padding:0px;color:#666600;">(</span><span class="pln" style="padding:0px;color:#000000;">function_name_</span><span class="pun" style="padding:0px;color:#666600;">,</span><span class="pln" style="padding:0px;color:#000000;">                 </span><span class="hljs-string" style="padding:0px;"><span class="str" style="padding:0px;color:#008800;">"illegal class name ‘%s‘\n"</span></span><span class="pln" style="padding:0px;color:#000000;">                 </span><span class="hljs-string" style="padding:0px;"><span class="str" style="padding:0px;color:#008800;">"    (should be of the form ‘package/Class‘, [Lpackage/Class;‘ or ‘[[B‘)"</span></span><span class="pun" style="padding:0px;color:#666600;">,</span><span class="pln" style="padding:0px;color:#000000;">                 class_name</span><span class="pun" style="padding:0px;color:#666600;">);</span><span class="pln" style="padding:0px;color:#000000;">     </span><span class="pun" style="padding:0px;color:#666600;">}</span><span class="pln" style="padding:0px;color:#000000;">   </span><span class="pun" style="padding:0px;color:#666600;">}</span></code></pre><p style="padding:0px;line-height:30px;"><br style="padding:0px;" />
<br style="padding:0px;" />
在CheckClassName方法中调用了IsValidJniClassName方法，通过google搜索”IsValidJniClassName site:android.googlesource.com”，发现IsValidJniClassName方法的声明在utils.h中，实现在utils.cc中。&nbsp;<br style="padding:0px;" />
<img alt="技术分享" src="http://img.blog.csdn.net/20150814161741758" title="" style="padding:0px;max-width:680px;overflow:hidden;" /></p>
<p style="padding:0px;line-height:30px;"><br style="padding:0px;" />
<br style="padding:0px;" />
下面是utils.h和utils.cc的链接地址：&nbsp;<br style="padding:0px;" />
<a href="https://android.googlesource.com/platform/art/+/master/runtime/utils.h" target="_blank" style="padding:0px;color:#333333;text-decoration:none;"><code style="font-family:Arial, Helvetica, sans-serif;padding:0px;">https://android.googlesource.com/platform/art/+/master/runtime/utils.h</code></a>&nbsp;<br style="padding:0px;" />
<a href="https://android.googlesource.com/platform/art/+/kitkat-release/runtime/utils.cc" target="_blank" style="padding:0px;color:#333333;text-decoration:none;"><code style="font-family:Arial, Helvetica, sans-serif;padding:0px;">https://android.googlesource.com/platform/art/+/kitkat-release/runtime/utils.cc</code></a></p>
<p style="padding:0px;line-height:30px;">IsValidJniClassName方法实现如下：&nbsp;<br style="padding:0px;" />
<img alt="技术分享" src="http://img.blog.csdn.net/20150814162241629" title="" style="padding:0px;max-width:680px;overflow:hidden;" />&nbsp;<br style="padding:0px;" />
他调用了IsValidClassName方法，注意第三个参数是<code style="font-family:Arial, Helvetica, sans-serif;padding:0px;">‘/‘</code>，这是类名的分隔符，而我这里调用FindClass时类名是使用了<code style="font-family:Arial, Helvetica, sans-serif;padding:0px;">‘.‘</code>分隔，改成<code style="font-family:Arial, Helvetica, sans-serif;padding:0px;">‘/‘</code>，问题就解决了。</p>
</div>
<div style="padding:20px 0px 0px;font-size:14px;line-height:30px;"></div>
</span></div></body></html>