<?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content=mNote Mac 2.5.11"/><meta name="created" content="2017-04-11T11:00:03Z"/><meta name="updated" content="2017-04-11T11:00:06Z"/><title>React-native Android 在Jenkins上配置自动打包方案  作者：xujinyang1234  使用jenkins来实现自动化构建，可以简化开发测试的流程，原来debug包都不会</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><h1 style="box-sizing:border-box;margin:30px 0px 0px;font-size:22px;font-family:'Microsoft Yahei';font-weight:400;line-height:1.5em;color:#305786;padding:0px;background-image:none;text-align:center;font-variant-ligatures:normal;orphans:2;widows:2;background-position:initial initial;background-repeat:initial initial;">React-native Android 在Jenkins上配置自动打包方案</h1>
<p class="author" style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;padding:30px 0px 0px;line-height:1.5em;color:#5592c1;text-align:center;font-family:'Microsoft Yahei';font-variant-ligatures:normal;orphans:2;widows:2;"><span style="box-sizing:border-box;color:#999999;">作者：</span><a href="http://my.csdn.net/xujinyang1234" target="_blank" style="box-sizing:border-box;background:transparent;color:#5592c1;text-decoration:none;">xujinyang1234</a></p>
<div class="divtexts" style="box-sizing:border-box;margin:30px 0px 0px;padding:0px;line-height:1.8;color:#565f69;position:relative;overflow:hidden;font-family:'Microsoft Yahei';font-variant-ligatures:normal;orphans:2;widows:2;max-height:100%;"><ul style="box-sizing:border-box;margin:0px;padding:0px;line-height:1.5em;list-style:none;"><li style="box-sizing:border-box;margin:0px;padding:0px;line-height:1.5em;">使用jenkins来实现自动化构建，可以简化开发测试的流程，原来debug包都不会做混淆，现在用了jenkins会自动的打混淆包，除了环境不一样，其他配置debug和release包都一样，这样就可以避免代码混淆带来的问题，早日发现早日治疗。推荐大家在废弃的电脑上搭建一个Jenkins。具体的搭建流程见<a href="http://my.oschina.net/u/930967/blog/299058" style="box-sizing:border-box;background:transparent;color:#2b91e8;text-decoration:none;">这里</a></li>
</ul>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">这里介绍一下我在项目中使用了React-native之后的jenkins配置，默认已经在jenkins上已经搭建好了普通Android的打包环境，如果想打带有React-native的apk，首先在React官方的<a href="https://facebook.github.io/react-native/docs/signed-apk-android.html#content" style="box-sizing:border-box;background:transparent;color:#2b91e8;text-decoration:none;">Generating Signed APK</a>中有bundle命令来生成index.android.bundle</p>
<pre style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:13px;white-space:pre-wrap;padding:0px;margin-top:0px;margin-bottom:0px;line-height:1.5em;color:#333333;word-break:break-all;word-wrap:break-word;background-color:#f5f5f5;border:1px solid #cccccc;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;"><code style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:inherit;padding:0px;color:inherit;white-space:pre;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:0px;line-height:1.5em;word-wrap:normal;">$ react-native bundle --platform android --dev false --entry-file index.android.js \
  --bundle-output android/app/src/main/assets/index.android.bundle \
  --assets-dest android/app/src/main/res/</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">所以我们在Android打包之前首先要执行这个命令，明确了这个区别，就开始动手了。</p>
<ul style="box-sizing:border-box;margin:0px;padding:0px;line-height:1.5em;list-style:none;"><li style="box-sizing:border-box;margin:0px;padding:0px;line-height:1.5em;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">首先在jenkins服务器上升级buildToolsVersion，compileSdkVersion 到23&nbsp;<br style="box-sizing:border-box;" />
<img src="http://img.blog.csdn.net/20151128142442620" alt="这里我全部升级完了" title="" style="box-sizing:border-box;border:0px;vertical-align:middle;" /><br style="box-sizing:border-box;" />
如果下载慢，建议换成sdk.gdgshanghai.com的镜像&nbsp;<br style="box-sizing:border-box;" />
<img src="http://img.blog.csdn.net/20151128142526224" alt="sdk.gdgshanghai.com" title="" style="box-sizing:border-box;border:0px;vertical-align:middle;" /></p>
</li>
<li style="box-sizing:border-box;margin:0px;padding:0px;line-height:1.5em;"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">接下来在服务器上搭建react-native环境</p>
</li>
</ul>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">不做重复的事情，很多文章已经写的很清楚，具体搭建步骤参考下面的博客<a href="http://www.race604.com/react-native-for-android-start/" style="box-sizing:border-box;background:transparent;color:#2b91e8;text-decoration:none;">http://www.race604.com/react-native-for-android-start/</a></p>
<pre style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:13px;white-space:pre-wrap;padding:0px;margin-top:0px;margin-bottom:0px;line-height:1.5em;color:#333333;word-break:break-all;word-wrap:break-word;background-color:#f5f5f5;border:1px solid #cccccc;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;"><code style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:inherit;padding:0px;color:inherit;white-space:pre;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:0px;line-height:1.5em;word-wrap:normal;">    注意一点，很多同学搭建换成后，执行
    react-native init AwesomeProject
    会发现卡了半天还是没有成功，这个时候建议你使用
    npm config set registry=https://registry.npm.taobao.org
    将npm的源换成淘宝镜像</code></pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">- 测试环境安装成功之后，开始配置我们的Jenkins</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">我们是通过jenkins Invoke Gradle script执行assembleQa –stacktrace task来打包的，&nbsp;<br style="box-sizing:border-box;" />
<img src="http://img.blog.csdn.net/20151128143605795" alt="Invoke Gradle script" title="" style="box-sizing:border-box;border:0px;vertical-align:middle;" /><br style="box-sizing:border-box;" />
如果我们希望在执行这个task之前让React-native 生成index.android.bundle，那么我们可以在build.gradle写这样的task，但是这里我介绍一个更简单的方式，在jenkins中增加构建步骤-&gt;windows系统选择Execute windows batch command ||mac系统选择Excute shell&nbsp;<br style="box-sizing:border-box;" />
<img src="http://img.blog.csdn.net/20151128143748789" alt="选择Excute shell" title="" style="box-sizing:border-box;border:0px;vertical-align:middle;" /></p>
<h1 id="关键的步骤来了" style="box-sizing:border-box;margin:0px 0px 5px;font-size:20px;font-weight:400;line-height:1.5em;color:#333333;padding:0px;background-image:none;background-position:initial initial;background-repeat:initial initial;">关键的步骤来了！！！！！</h1>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">我们按住Execute shell的右上角，将它拖动到 Invoke Gradle script的前面，这样就可以先执行Execute shell中的命令</p>
<ul style="box-sizing:border-box;margin:0px;padding:0px;line-height:1.5em;list-style:none;"><li style="box-sizing:border-box;margin:0px;padding:0px;line-height:1.5em;">接下来开始写Execute shell中的命令</li>
</ul>
<pre class="prettyprint" style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:13px;white-space:nowrap;padding:5px 5px 5px 60px;margin-top:0px;margin-bottom:0px;line-height:1.5em;color:#333333;word-break:break-all;word-wrap:break-word;background-color:#f5f5f5;border:1px solid #cccccc;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;position:relative;overflow-y:hidden;overflow-x:auto;"><code class="hljs lasso has-numbering" style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:inherit;padding:0px;color:inherit;white-space:pre;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:0px;line-height:1.5em;word-wrap:normal;">react<span class="hljs-attribute" style="box-sizing:border-box;">-native</span> bundle <span class="hljs-subst" style="box-sizing:border-box;">--</span>platform android <span class="hljs-subst" style="box-sizing:border-box;">--</span>dev <span class="hljs-literal" style="box-sizing:border-box;">false</span> <span class="hljs-subst" style="box-sizing:border-box;">--</span>entry<span class="hljs-attribute" style="box-sizing:border-box;">-file</span> react<span class="hljs-attribute" style="box-sizing:border-box;">-native</span>/index<span class="hljs-built_in" style="box-sizing:border-box;">.</span>android<span class="hljs-built_in" style="box-sizing:border-box;">.</span>js <span class="hljs-subst" style="box-sizing:border-box;">\</span>  <span class="hljs-subst" style="box-sizing:border-box;">--</span>bundle<span class="hljs-attribute" style="box-sizing:border-box;">-output</span> app/src/main/assets/index<span class="hljs-built_in" style="box-sizing:border-box;">.</span>android<span class="hljs-built_in" style="box-sizing:border-box;">.</span>bundle <span class="hljs-subst" style="box-sizing:border-box;">\</span>  <span class="hljs-subst" style="box-sizing:border-box;">--</span>assets<span class="hljs-attribute" style="box-sizing:border-box;">-dest</span> app/src/main/res<span class="hljs-subst" style="box-sizing:border-box;">/</span></code><ul class="pre-numbering" style="box-sizing:border-box;margin:0px;padding:6px 0px 40px;line-height:1.5em;list-style:none;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;border-right:1px solid #dddddd;text-align:right;"><li style="box-sizing:border-box;margin:0px;padding:0px 5px;line-height:1.5em;">1</li>
<li style="box-sizing:border-box;margin:0px;padding:0px 5px;line-height:1.5em;">2</li>
<li style="box-sizing:border-box;margin:0px;padding:0px 5px;line-height:1.5em;">3</li>
</ul>
</pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">测试一下，失败，报react-native: command not found&nbsp;<br style="box-sizing:border-box;" />
google一下，React-native jenkins，发现没有任何相关的记录，菊花一紧，每当Stack Overflow上国外友人还没有踩过坑的时候，我就有一种使命感，难道我已经走在了全世界码农的前面？难道我就要这样走向人生颠覆了么，这样的幻觉让我像疯狗一样查资料誓要把这个问题解决，给全世界人民带来福利。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">打了一针鸡血，发现jenkins的shell命令是跑在自己的Shell中的，这意味着什么？需要我们指定绝对路径，好吧，更换一成绝对路径。</p>
<pre class="prettyprint" style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:13px;white-space:nowrap;padding:5px 5px 5px 60px;margin-top:0px;margin-bottom:0px;line-height:1.5em;color:#333333;word-break:break-all;word-wrap:break-word;background-color:#f5f5f5;border:1px solid #cccccc;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;position:relative;overflow-y:hidden;overflow-x:auto;"><code class="hljs java has-numbering" style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:inherit;padding:0px;color:inherit;white-space:pre;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:0px;line-height:1.5em;word-wrap:normal;">which react-<span class="hljs-keyword" style="box-sizing:border-box;">native</span></code><ul class="pre-numbering" style="box-sizing:border-box;margin:0px;padding:6px 0px 40px;line-height:1.5em;list-style:none;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;border-right:1px solid #dddddd;text-align:right;"><li style="box-sizing:border-box;margin:0px;padding:0px 5px;line-height:1.5em;">1</li>
</ul>
</pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">获取react-native的绝对路径,文件路径也一并换掉，整个命令变成了</p>
<pre class="prettyprint" style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:13px;white-space:nowrap;padding:5px 5px 5px 60px;margin-top:0px;margin-bottom:0px;line-height:1.5em;color:#333333;word-break:break-all;word-wrap:break-word;background-color:#f5f5f5;border:1px solid #cccccc;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;position:relative;overflow-y:hidden;overflow-x:auto;"><code class="hljs lasso has-numbering" style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:inherit;padding:0px;color:inherit;white-space:pre;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:0px;line-height:1.5em;word-wrap:normal;">/usr/<span class="hljs-built_in" style="box-sizing:border-box;">local</span>/bin/react<span class="hljs-attribute" style="box-sizing:border-box;">-native</span> bundle <span class="hljs-subst" style="box-sizing:border-box;">--</span>platform android <span class="hljs-attribute" style="box-sizing:border-box;">-dev</span> <span class="hljs-literal" style="box-sizing:border-box;">false</span> <span class="hljs-subst" style="box-sizing:border-box;">--</span>entry<span class="hljs-attribute" style="box-sizing:border-box;">-file</span> /Users/jenkins<span class="hljs-subst" style="box-sizing:border-box;">/</span><span class="hljs-built_in" style="box-sizing:border-box;">.</span>jenkins/jobs/testAndroid<span class="hljs-attribute" style="box-sizing:border-box;">-qa</span>/workspace/react<span class="hljs-attribute" style="box-sizing:border-box;">-native</span>/index<span class="hljs-built_in" style="box-sizing:border-box;">.</span>android<span class="hljs-built_in" style="box-sizing:border-box;">.</span>js <span class="hljs-subst" style="box-sizing:border-box;">\</span>  <span class="hljs-subst" style="box-sizing:border-box;">--</span>bundle<span class="hljs-attribute" style="box-sizing:border-box;">-output</span> /Users/jenkins<span class="hljs-subst" style="box-sizing:border-box;">/</span><span class="hljs-built_in" style="box-sizing:border-box;">.</span>jenkins/jobs/testAndroid<span class="hljs-attribute" style="box-sizing:border-box;">-qa</span>/workspace/app/src/main/assets/index<span class="hljs-built_in" style="box-sizing:border-box;">.</span>android<span class="hljs-built_in" style="box-sizing:border-box;">.</span>bundle <span class="hljs-subst" style="box-sizing:border-box;">\</span>  <span class="hljs-subst" style="box-sizing:border-box;">--</span>assets<span class="hljs-attribute" style="box-sizing:border-box;">-dest</span> /Users/jenkins<span class="hljs-subst" style="box-sizing:border-box;">/</span><span class="hljs-built_in" style="box-sizing:border-box;">.</span>jenkins/jobs/testAndroid<span class="hljs-attribute" style="box-sizing:border-box;">-qa</span>/workspace/app/src/main/res<span class="hljs-subst" style="box-sizing:border-box;">/</span></code><ul class="pre-numbering" style="box-sizing:border-box;margin:0px;padding:6px 0px 40px;line-height:1.5em;list-style:none;position:absolute;width:50px;background-color:#eeeeee;top:0px;left:0px;border-right:1px solid #dddddd;text-align:right;"><li style="box-sizing:border-box;margin:0px;padding:0px 5px;line-height:1.5em;">1</li>
<li style="box-sizing:border-box;margin:0px;padding:0px 5px;line-height:1.5em;">2</li>
<li style="box-sizing:border-box;margin:0px;padding:0px 5px;line-height:1.5em;">3</li>
</ul>
</pre><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">再来构建-&gt;成功。</p>
<p style="box-sizing:border-box;margin-top:0px;margin-bottom:0.5em;padding:0px;line-height:2;">看一下我的构建历史&nbsp;<br style="box-sizing:border-box;" />
<img src="http://img.blog.csdn.net/20151128150252868" alt="这里写图片描述" title="" style="box-sizing:border-box;border:0px;vertical-align:middle;" /></p>
<pre style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:13px;white-space:pre-wrap;padding:0px;margin-top:0px;margin-bottom:0px;line-height:1.5em;color:#333333;word-break:break-all;word-wrap:break-word;background-color:#f5f5f5;border:1px solid #cccccc;border-top-left-radius:4px;border-top-right-radius:4px;border-bottom-right-radius:4px;border-bottom-left-radius:4px;"><code style="box-sizing:border-box;font-family:Monaco, Menlo, Consolas, 'Courier New', monospace;font-size:inherit;padding:0px;color:inherit;white-space:pre;background-color:transparent;border-top-left-radius:0px;border-top-right-radius:0px;border-bottom-right-radius:0px;border-bottom-left-radius:0px;margin:0px;line-height:1.5em;word-wrap:normal;">    不断的失败，
    不断的解决，
    我为全世界人民踩坑，
    我为全世界人民探路，
    我活在自我陶醉的程序员世界。</code></pre></div></body></html>